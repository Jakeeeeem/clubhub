<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ClubHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="org-switcher.css">
    <script src="api-service.js"></script>
    <script src="workspace-manager.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav container">
            <div class="logo" onclick="window.location.href='index.html'">
                <img src="images/logo.png" alt="ClubHub Logo" class="logo-image">
                <span class="logo-text neon-text">ClubHub</span>
            </div>

            <div class="user-info">
                <!-- Organization Switcher -->
                <div id="org-switcher-container"></div>

                <span id="adminNameDisplay">Hello, Admin!</span>
                <div class="user-avatar" id="adminAvatar">A</div>
                <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
            </div>
        </nav>
    </header>

    <main class="main">
        <div class="dashboard container dashboard-container">
            <div class="dashboard-header">
                <div>
                    <h1 class="neon-text display-org-name">Admin Dashboard</h1>
                    <p style="color: var(--text-muted);">Manage your organization with complete control and insights</p>
                </div>
                <div class="stripe-access">
                    <button class="btn btn-stripe" onclick="accessStripeAccount()">Access Stripe Dashboard</button>
                    <button class="btn btn-primary" onclick="generateShareableInviteLink()">üîó Generate Invite
                        Link</button>
                </div>
            </div>

            <!-- Dashboard Navigation -->
            <div class="dashboard-nav">
                <button class="active" onclick="showSection('overview')">Overview</button>
                <button onclick="showSection('club-profile')" data-roles="owner, admin">Profile</button>
                <button onclick="showSection('players')" data-roles="owner, admin, coach">Players</button>
                <button onclick="showSection('teams')" data-roles="owner, admin, coach">Teams</button>
                <button onclick="showSection('staff')" data-roles="owner, admin">Staff</button>
                <button onclick="showSection('events')" data-roles="owner, admin, coach">Events</button>
                <button onclick="showSection('finances')" data-roles="owner, admin, staff">Finances</button>
                <button onclick="showSection('listings')" data-roles="owner, admin">Listings</button>
                <button onclick="showSection('item-shop')" data-roles="owner, admin, staff">Shop</button>
                <button onclick="showSection('marketing-hub')" data-roles="owner, admin, staff">Marketing</button>
                <button onclick="showSection('tactical')" data-roles="owner, admin, coach">Tactical</button>

                <div class="nav-divider"
                    style="width: 1px; height: 30px; background: var(--border-color); margin: 0 10px;"></div>

                <button onclick="window.location.href='venue-booking.html'" class="btn-special">üèüÔ∏è Venues</button>
                <button onclick="window.location.href='league-management.html'" class="btn-special">üèÜ Leagues</button>
                <button onclick="window.location.href='training-manager.html'" class="btn-special">üéØ Training</button>
                <button onclick="window.location.href='tournament-manager.html'" class="btn-special">‚öîÔ∏è
                    Tournaments</button>
                <button onclick="window.location.href='email-campaigns.html'" class="btn-special">üìß Email</button>
            </div>

            <div class="dashboard-content">
                <!-- Overview Section -->
                <div id="overview" class="dashboard-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="totalPlayers">0</span>
                            <span class="stat-label">Total Players</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalStaff">0</span>
                            <span class="stat-label">Staff Members</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalEvents">0</span>
                            <span class="stat-label">Active Events</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalRevenue">¬£0</span>
                            <span class="stat-label">Monthly Revenue</span>
                        </div>
                    </div>

                    <div class="card-grid">
                        <div class="card">
                            <h3>üìà Recent Activity</h3>
                            <div id="recentActivity">
                                <!-- Populated by JavaScript from database -->
                            </div>
                        </div>

                        <div class="card">
                            <h3>üìÖ Upcoming Events</h3>
                            <div id="upcomingEvents">
                                <!-- Populated by JavaScript from database -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Club Profile Section -->
                <div id="club-profile" class="dashboard-section">
                    <div class="card">
                        <h3>üè¢ Club Profile</h3>
                        <p style="color: var(--text-muted); margin-bottom: 2rem;">Manage your organization's information
                            and branding</p>

                        <form id="clubProfileForm">
                            <div class="form-group">
                                <label for="clubName">Club Name *</label>
                                <input type="text" id="clubName" name="name" required placeholder="Enter club name">
                            </div>

                            <div class="form-group">
                                <label for="clubDescription">Description</label>
                                <textarea id="clubDescription" name="description" rows="4"
                                    placeholder="Tell us about your club..."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="clubLocation">Location</label>
                                <input type="text" id="clubLocation" name="location" placeholder="e.g., London, UK">
                            </div>

                            <div class="form-group">
                                <label for="clubSport">Sport</label>
                                <select id="clubSport" name="sport">
                                    <option value="">Select a sport</option>
                                    <option value="Football">Football</option>
                                    <option value="Basketball">Basketball</option>
                                    <option value="Rugby">Rugby</option>
                                    <option value="Cricket">Cricket</option>
                                    <option value="Tennis">Tennis</option>
                                    <option value="Hockey">Hockey</option>
                                    <option value="Athletics">Athletics</option>
                                    <option value="Swimming">Swimming</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="clubWebsite">Website</label>
                                <input type="url" id="clubWebsite" name="website" placeholder="https://yourclub.com">
                            </div>

                            <div class="form-group">
                                <label for="clubPhilosophy">Club Philosophy</label>
                                <textarea id="clubPhilosophy" name="philosophy" rows="3"
                                    placeholder="Your club's values and philosophy..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Club Pictures (Max 3-5)</label>
                                <div class="file-upload-area" id="clubPicturesArea"
                                    style="border: 2px dashed var(--border-color); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; background: rgba(255, 255, 255, 0.03);">
                                    <input type="file" id="clubPictures" name="pictures" accept="image/*" multiple
                                        style="display: none;">
                                    <div class="upload-placeholder">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="2" style="margin: 0 auto;">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                        <p style="margin: 1rem 0 0.5rem; color: var(--text-main);">üì∑ Drag and drop
                                            images here or click to upload</p>
                                        <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">PNG, JPG or
                                            WEBP (max 5MB each)</p>
                                    </div>
                                    <div id="clubPicturesPreview" style="display: none; margin-top: 1rem;"></div>
                                </div>
                            </div>

                            <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 2rem;">
                                <button type="submit" class="btn btn-primary">üíæ Save Club Profile</button>
                                <button type="button" class="btn btn-secondary" onclick="loadClubProfile()">üîÑ
                                    Reset</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Enhanced Players Section -->
                <div id="players" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <h3>üë• Player Management</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="invitePlayerRBAC()">üìß Invite Player</button>
                            </div>
                        </div>

                        <!-- Enhanced Player Filters -->
                        <div class="player-filters"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                            <div class="filter-group">
                                <label>View Type</label>
                                <select id="playerListFilter" onchange="loadPlayers()">
                                    <option value="all">Full List</option>
                                    <option value="on-plan">On Plan</option>
                                    <option value="not-on-plan">No Plan</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Team</label>
                                <select id="teamFilter" onchange="loadPlayers()">
                                    <option value="">All Teams</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Sport</label>
                                <select id="sportFilter" onchange="loadPlayers()">
                                    <option value="">All Sports</option>
                                    <option value="Football">Football</option>
                                    <option value="Basketball">Basketball</option>
                                    <option value="Tennis">Tennis</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Location</label>
                                <input type="text" id="locationFilter" placeholder="London..." onkeyup="loadPlayers()">
                            </div>
                            <div class="filter-group" style="display: flex; gap: 0.5rem; flex-direction: column;">
                                <label>Age Range</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="minAgeFilter" placeholder="Min" style="width: 60px;"
                                        onchange="loadPlayers()">
                                    <input type="number" id="maxAgeFilter" placeholder="Max" style="width: 60px;"
                                        onchange="loadPlayers()">
                                </div>
                            </div>
                            <div class="filter-buttons" style="display: flex; align-items: flex-end; gap: 0.5rem;">
                                <button class="btn btn-secondary btn-small"
                                    onclick="resetPlayerFilters()">Reset</button>
                                <button class="btn btn-primary btn-small" onclick="exportPlayers()">üìä Export</button>
                            </div>
                        </div>

                        <!-- Enhanced Player Cards -->
                        <div id="playersContainer">
                            <!-- Players will be loaded from database via JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Teams Section with Clickable Names -->
                <div id="teams" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>‚öΩ Team Management</h3>
                            <button class="btn btn-primary" onclick="showModal('addTeamModal')">‚ûï Create
                                Team</button>
                        </div>

                        <div class="card-grid" id="teamsContainer">
                            <!-- Team cards with clickable names will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Staff Section with Invite Links -->
                <div id="staff" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üë®‚Äçüíº Staff Management</h3>
                            <button class="btn btn-primary" onclick="showModal('inviteStaffModal')">üìß
                                Invite
                                Staff</button>
                        </div>

                        <div class="invite-section">
                            <h3>üìé Staff Invite System</h3>
                            <p>Generate invite links for coaches with specific team assignments. Coaches can
                                only view
                                their assigned teams:</p>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="generateStaffInvite('coach')">Invite
                                    Coach</button>
                                <button class="btn btn-warning" onclick="generateStaffInvite('assistant')">Invite
                                    Assistant</button>
                                <button class="btn btn-primary" onclick="generateStaffInvite('admin')">Invite
                                    Administrator</button>
                            </div>
                        </div>

                        <div id="staffContainer">
                            <!-- Staff cards will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Events Section -->
                <div id="events" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üìÖ Event Management</h3>
                            <button class="btn btn-primary" onclick="showModal('addEventModal')">‚ûï Create
                                Event</button>
                        </div>

                        <div class="card-grid" id="eventsContainer">
                            <!-- Events will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Finances Section with Payment Plans -->
                <div id="finances" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üí∞ Financial Management</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-stripe" onclick="accessStripeAccount()">Access
                                    Stripe</button>
                                <button class="btn btn-primary" onclick="showModal('createPaymentPlanModal')">‚ûï Create
                                    Payment Plan</button>
                            </div>
                        </div>

                        <div class="finance-overview">
                            <div class="finance-card">
                                <span class="finance-amount" id="monthlyRevenue">¬£0</span>
                                <span class="finance-label">Monthly Revenue</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="overdueAmount">¬£0</span>
                                <span class="finance-label">Outstanding</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="pendingAmount">¬£0</span>
                                <span class="finance-label">Pending</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="totalMembers">0</span>
                                <span class="finance-label">Paying Members</span>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üí≥ Payment Plans</h3>
                            <p>Players should be assigned to payment plans for easier workflow management:
                            </p>
                            <div id="paymentPlansContainer">
                            </div>
                        </div>

                        <div class="card">
                            <h3>üìä Recent Transactions</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Player</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <!-- Payments will be loaded from database -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Listings Section with Indeed-like Interface -->
                <div id="listings" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üìã Club Listings & Applications</h3>
                            <button class="btn btn-primary" onclick="showModal('createListingModal')">‚ûï
                                Create
                                Listing</button>
                        </div>

                        <div class="card">
                            <h3>üìù Active Listings</h3>
                            <div id="activeListingsContainer">
                                <!-- Active listings will be loaded from database -->
                            </div>
                        </div>

                        <div class="card">
                            <h3>üìã Application Management (Indeed-like Interface)</h3>
                            <p>Once applicants come, manage them with shortlist, reject, and invite options:
                            </p>

                            <div id="applicationsContainer">
                                <!-- Applications will be loaded from database -->
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Item Shop Section -->
                <div id="item-shop" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>üõí Item Shop Management</h3>
                            <button class="btn btn-primary" onclick="showModal('addProductModal')">‚ûï Add
                                Product</button>
                        </div>
                        <div id="productsContainer" class="card-grid">
                            <!-- Products will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Marketing Hub Section -->
                <div id="marketing-hub" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>üì¢ Marketing Hub</h3>
                            <button class="btn btn-primary" onclick="showModal('createCampaignModal')">üì£
                                New
                                Campaign</button>
                        </div>
                        <div class="card">
                            <h3>‚úâÔ∏è Active Campaigns</h3>
                            <div id="campaignsContainer">
                                <!-- Campaigns will be loaded from database -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Detail Section -->
                <div id="team-details" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <button class="btn btn-secondary btn-small" onclick="showSection('teams')">‚Üê Back to
                                    Teams</button>
                                <h3 style="margin: 0;" id="teamDetailName">Team Name</h3>
                            </div>
                            <div class="team-meta-badges" id="teamDetailStats">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Team Tabs -->
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTeamTab('roster')">üë• Roster</button>
                            <button class="tab-btn" onclick="switchTeamTab('events')">üìÖ Events</button>
                            <button class="tab-btn" onclick="switchTeamTab('availability')">‚úÖ Availability</button>
                        </div>

                        <!-- Roster Tab -->
                        <div id="team-tab-roster" class="team-tab-content active">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                                <h4>Players</h4>
                                <button class="btn btn-primary btn-small" onclick="openAddTeamPlayerModal()">‚ûï Add
                                    Player</button>
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Player</th>
                                            <th>Position</th>
                                            <th>Age</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teamRosterBody">
                                        <!-- Populated via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Events Tab -->
                        <div id="team-tab-events" class="team-tab-content" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                                <h4>Team Events</h4>
                                <button class="btn btn-primary btn-small" onclick="showModal('addEventModal')">‚ûï Plan
                                    Event</button>
                            </div>
                            <div id="teamEventsContainer" class="card-grid">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                        <!-- Availability Tab (Spond-like) -->
                        <div id="team-tab-availability" class="team-tab-content" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                                <h4>Availability Tracker</h4>
                                <div class="legend" style="display: flex; gap: 1rem; font-size: 0.9rem;">
                                    <span style="color: var(--success-color);">‚úÖ Going</span>
                                    <span style="color: var(--danger-color);">‚ùå No</span>
                                    <span style="color: var(--warning-color);">‚ùì Maybe</span>
                                    <span style="opacity: 0.5;">‚ö™ No Response</span>
                                </div>
                            </div>
                            <div class="availability-grid" id="availabilityGrid"
                                style="overflow-x: auto; background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <!-- Spond-like grid -->
                                <p style="text-align: center; opacity: 0.7;">Select an upcoming event to view
                                    availability.</p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Talent ID Manager Tab -->
                <div id="talent-id" class="dashboard-section">
                    <div class="section-header">
                        <h2>Talent ID Manager</h2>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="exportTalentCSV()">Export CSV</button>
                            <button class="btn btn-primary" onclick="showGenerateBibsModal()">+ Generate Bibs</button>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h3>Active Event Dashboard</h3>
                        <div class="form-group">
                            <label>Select Event</label>
                            <select id="talentEventSelect" onchange="loadTalentDashboard(this.value)">
                                <option value="">Select an event...</option>
                                <!-- Populated via JS -->
                            </select>
                        </div>

                        <div class="stats-grid" id="talentStats">
                            <div class="stat-card">
                                <h3>Registrants</h3>
                                <p class="stat-number" id="totalRegistrants">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Bibs Available</h3>
                                <p class="stat-number" id="bibsAvailable">0</p>
                            </div>
                            <div class="stat-card">
                                <h3>Groups</h3>
                                <p class="stat-number" id="totalGroups">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Left Col: Schedule & Bibs -->
                        <div>
                            <div class="card">
                                <h3>Day Schedule</h3>
                                <div id="scheduleList" class="item-list">
                                    <p class="empty-state">No schedule items yet.</p>
                                </div>
                                <button class="btn btn-secondary btn-small" style="width:100%; margin-top:1rem;"
                                    onclick="showAddScheduleModal()">+ Add Activity</button>
                            </div>

                            <div class="card" style="margin-top: 2rem;">
                                <h3>Bib Inventory</h3>
                                <div id="bibsList" class="item-list">
                                    <!-- Bib ranges -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Groups & Auto Assign -->
                        <div>
                            <div class="card">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <h3>Groups</h3>
                                    <button class="btn btn-primary btn-small" onclick="autoAssignBibs()">‚ú® Auto-Assign
                                        Bibs</button>
                                </div>
                                <p style="font-size:0.9rem; opacity:0.7; margin-bottom:1rem;">Automatically assign bibs
                                    to unassigned players.</p>

                                <div id="groupsList">
                                    <!-- Groups rendered here -->
                                </div>

                                <button class="btn btn-secondary btn-small" style="width:100%; margin-top:1rem;"
                                    onclick="showCreateGroupModal()">+ Create Group</button>
                            </div>
                        </div>
                    </div>
                </div> <!-- End talent-id -->

                <!-- Tournament Manager Tab -->
                <div id="tournaments" class="dashboard-section">
                    <div class="section-header">
                        <h2>Tournament Manager</h2>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="exportTournamentCSV()">Export CSV</button>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h3>Tournament Overview</h3>
                        <div class="form-group">
                            <label>Select Tournament</label>
                            <select id="tournamentSelect" onchange="loadTournamentDashboard(this.value)">
                                <option value="">Select a tournament...</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-container" style="grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <!-- Teams Column -->
                        <div class="card">
                            <h3>Registered Teams</h3>
                            <div id="tournamentTeamsList" class="item-list"></div>
                        </div>

                        <!-- Fixtures Column -->
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>Fixtures / Bracket</h3>
                                <div>
                                    <button class="btn btn-small btn-secondary"
                                        onclick="generateFixtures('regular')">League</button>
                                    <button class="btn btn-small btn-primary"
                                        onclick="generateFixtures('knockout')">Knockout</button>
                                </div>
                            </div>
                            <div id="tournamentMatchesList" class="item-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Specialized Polls Section -->
                <div id="polls-section" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>üó≥Ô∏è Voting & Polls</h3>
                            <button class="btn btn-primary" onclick="showModal('createPollModal')">‚ûï Create
                                Poll</button>
                        </div>
                        <div id="pollsContainer" class="card-grid">
                            <!-- Polls will be loaded here -->
                        </div>
                    </div>
                </div>
            </div> <!-- End dashboard-content -->
        </div>
    </main>

    <!-- Enhanced Modals -->

    <!-- Invite Player Modal -->
    <div id="invitePlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìß Invite Player</h2>
                <button class="close" onclick="closeModal('invitePlayerModal')">&times;</button>
            </div>
            <form id="invitePlayerForm">
                <div class="form-group">
                    <label for="inviteEmail">Email Address</label>
                    <input type="email" id="inviteEmail" required>
                </div>
                <div class="form-group">
                    <label for="inviteFirstName">First Name</label>
                    <input type="text" id="inviteFirstName" required>
                </div>
                <div class="form-group">
                    <label for="inviteLastName">Last Name</label>
                    <input type="text" id="inviteLastName" required>
                </div>
                <div class="form-group">
                    <label for="inviteRole">Role</label>
                    <select id="inviteRole" required>
                        <option value="player">Player</option>
                        <option value="parent">Parent (Adult Account)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="inviteTeam">Assign to Team (Optional)</label>
                    <select id="inviteTeam">
                        <option value="">No team assignment</option>
                        <!-- Populated from database -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="inviteMessage">Personal Message</label>
                    <textarea id="inviteMessage" rows="3"
                        placeholder="Welcome to our club! We're excited to have you join our team..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üìß Send Invite</button>
            </form>
        </div>
    </div>

    <!-- Invite Staff Modal -->
    <div id="inviteStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìß Invite Team Member</h2>
                <button class="close" onclick="closeModal('inviteStaffModal')">&times;</button>
            </div>
            <form id="inviteStaffForm" onsubmit="handleNewInvite(event)">
                <div class="form-group">
                    <label for="staffInviteEmail">Email Address *</label>
                    <input type="email" id="staffInviteEmail" required placeholder="member@example.com">
                </div>

                <div class="form-group">
                    <label for="staffInviteRole">Role *</label>
                    <select id="staffInviteRole" required>
                        <option value="">Select Role</option>
                        <option value="admin">Administrator</option>
                        <option value="coach">Coach</option>
                        <option value="assistant_coach">Assistant Coach</option>
                        <option value="staff">Staff Member</option>
                        <option value="player">Player</option>
                        <option value="parent">Parent/Guardian</option>
                        <option value="viewer">Viewer (Read-only)</option>
                    </select>
                    <small style="display: block; margin-top: 0.5rem; opacity: 0.7;">
                        This determines what features they can access
                    </small>
                </div>

                <div class="form-group">
                    <label for="inviteMessage">Personal Message (Optional)</label>
                    <textarea id="inviteMessage" rows="3"
                        placeholder="Welcome to our team! We're excited to have you join us."></textarea>
                </div>

                <div
                    style="background: rgba(220, 67, 67, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                    <strong>üìã Role Permissions:</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; opacity: 0.9;">
                        <li><strong>Admin:</strong> Full management access</li>
                        <li><strong>Coach:</strong> Team & player management</li>
                        <li><strong>Staff:</strong> Financial & shop access</li>
                        <li><strong>Player:</strong> Personal dashboard only</li>
                    </ul>
                </div>

                <button type="submit" class="btn btn-primary">üìß Send Invitation</button>
            </form>
        </div>
    </div>

    <!-- Add Player Modal (Enhanced) -->
    <div id="addPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Add New Player</h2>
                <button class="close" onclick="closeModal('addPlayerModal')">&times;</button>
            </div>
            <form id="addPlayerForm">
                <div class="form-group">
                    <label for="playerFirstName">First Name</label>
                    <input type="text" id="playerFirstName" required>
                </div>
                <div class="form-group">
                    <label for="playerLastName">Last Name</label>
                    <input type="text" id="playerLastName" required>
                </div>
                <div class="form-group">
                    <label for="playerEmail">Email (for account linking)</label>
                    <input type="email" id="playerEmail" placeholder="Link to existing user account">
                </div>
                <div class="form-group">
                    <label for="playerPhone">Phone</label>
                    <input type="tel" id="playerPhone">
                </div>
                <div class="form-group">
                    <label for="playerDOB">Date of Birth</label>
                    <input type="date" id="playerDOB" required>
                </div>
                <div class="form-group">
                    <label for="playerSport">Sport</label>
                    <select id="playerSport" onchange="updatePositionPlaceholder()">
                        <option value="">Select Sport...</option>
                        <option value="Football">Football</option>
                        <option value="Basketball">Basketball</option>
                        <option value="Tennis">Tennis</option>
                        <option value="Rugby">Rugby</option>
                        <option value="Cricket">Cricket</option>
                        <option value="Hockey">Hockey</option>
                        <option value="Volleyball">Volleyball</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="playerGender">Gender</label>
                    <select id="playerGender">
                        <option value="">Select Gender...</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>
                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="playerPosition">Position</label>
                        <input type="text" id="playerPosition" placeholder="e.g., Midfielder, Forward">
                    </div>
                    <div class="form-group">
                        <label for="playerLocation">Location</label>
                        <input type="text" id="playerLocation" placeholder="e.g., London, UK">
                    </div>
                </div>
                <div class="form-group">
                    <label for="playerBio">Bio / Achievements</label>
                    <textarea id="playerBio" rows="3"
                        placeholder="Tell us about the player's history and highlights..."></textarea>
                </div>
                <div class="form-group">
                    <label for="playerTeam">Assign to Team</label>
                    <select id="playerTeam">
                        <option value="">No team assignment</option>
                        <!-- Populated from database -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="playerPaymentPlan">Payment Plan</label>
                    <select id="playerPaymentPlan">
                        <option value="">No payment plan</option>
                        <!-- Populated from database -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="playerFee">Monthly Fee (¬£)</label>
                    <input type="number" id="playerFee" step="0.01" min="0" placeholder="e.g., 45">
                </div>
                <button type="submit" class="btn btn-primary">‚ûï Add Player</button>
            </form>
        </div>

        <!-- Edit Player Modal -->
        <div id="editPlayerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úèÔ∏è Edit Player Details</h2>
                    <button class="close" onclick="closeModal('editPlayerModal')">&times;</button>
                </div>
                <form id="editPlayerForm">
                    <input type="hidden" id="editPlayerId">
                    <div class="form-group">
                        <label for="editPlayerFirstName">First Name *</label>
                        <input type="text" id="editPlayerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerLastName">Last Name *</label>
                        <input type="text" id="editPlayerLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerEmail">Email</label>
                        <input type="email" id="editPlayerEmail">
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPhone">Phone</label>
                        <input type="tel" id="editPlayerPhone">
                    </div>
                    <div class="form-group">
                        <label for="editPlayerDOB">Date of Birth *</label>
                        <input type="date" id="editPlayerDOB" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPosition">Position</label>
                        <input type="text" id="editPlayerPosition" placeholder="e.g., Striker, Point Guard">
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPaymentStatus">Payment Status</label>
                        <select id="editPlayerPaymentStatus">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Poll Modal -->
    <div id="createPollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üó≥Ô∏è Create New Poll</h2>
                <button class="close" onclick="closeModal('createPollModal')">&times;</button>
            </div>
            <form id="createPollForm">
                <div class="form-group">
                    <label for="pollTitle">Poll Question / Title</label>
                    <input type="text" id="pollTitle" placeholder="e.g. What color should our new kit be?" required>
                </div>
                <div class="form-group">
                    <label for="pollDescription">Description (Optional)</label>
                    <textarea id="pollDescription" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Options (One per line)</label>
                    <textarea id="pollOptions" rows="4" placeholder="Red\nBlue\nGreen" required></textarea>
                </div>
                <div class="form-group">
                    <label for="pollExpires">Expiration Date (Optional)</label>
                    <input type="datetime-local" id="pollExpires">
                </div>
                <button type="submit" class="btn btn-primary">üöÄ Launch Poll</button>
            </form>
        </div>
    </div>

    <!-- Add Team Modal (Enhanced) -->
    <div id="addTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öΩ Create New Team</h2>
                <button class="close" onclick="closeModal('addTeamModal')">&times;</button>
            </div>
            <form id="addTeamForm">
                <div class="form-group">
                    <label for="teamName">Team Name *</label>
                    <input type="text" id="teamName" required>
                </div>
                <div class="form-group">
                    <label for="teamAgeGroup">Age Group</label>
                    <select id="teamAgeGroup">
                        <option value="">Select age group...</option>
                        <option value="U8">Under 8</option>
                        <option value="U10">Under 10</option>
                        <option value="U12">Under 12</option>
                        <option value="U14">Under 14</option>
                        <option value="U16">Under 16</option>
                        <option value="U18">Under 18</option>
                        <option value="Senior">Senior</option>
                        <option value="Veterans">Veterans</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="teamSport">Sport *</label>
                    <select id="teamSport" required>
                        <option value="">Select sport...</option>
                        <option value="football">Football</option>
                        <option value="basketball">Basketball</option>
                        <option value="tennis">Tennis</option>
                        <option value="rugby">Rugby</option>
                        <option value="cricket">Cricket</option>
                        <option value="hockey">Hockey</option>
                        <option value="volleyball">Volleyball</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="teamDescription">Description</label>
                    <textarea id="teamDescription" rows="3" placeholder="Brief description of the team..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">‚öΩ Create Team</button>
            </form>
        </div>
    </div>

    <!-- Add Event Modal (Enhanced) -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Create New Event</h2>
                <button class="close" onclick="closeModal('addEventModal')">&times;</button>
            </div>
            <form id="addEventForm">
                <div class="form-group">
                    <label for="eventTitle">Event Title</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label for="eventType">Event Type</label>
                    <select id="eventType" required>
                        <option value="">Select Type</option>
                        <option value="training">Training Session</option>
                        <option value="match">Match</option>
                        <option value="tournament">Tournament</option>
                        <option value="camp">Training Camp</option>
                        <option value="social">Social Event</option>
                        <option value="trial">Trial Session</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="eventDate">Date</label>
                    <input type="date" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventTime">Time</label>
                    <input type="time" id="eventTime" required>
                </div>
                <div class="form-group">
                    <label for="eventLocation">Location</label>
                    <input type="text" id="eventLocation" placeholder="Event venue">
                </div>
                <div class="form-group">
                    <label for="eventPrice">Price (¬£)</label>
                    <input type="number" id="eventPrice" step="0.01" min="0" value="0">
                    <small>Set to 0 for free events</small>
                </div>
                <div class="form-group">
                    <label for="eventCapacity">Capacity</label>
                    <input type="number" id="eventCapacity" min="1">
                    <small>Leave empty for unlimited capacity</small>
                </div>
                <div class="form-group">
                    <label for="eventDescription">Description</label>
                    <textarea id="eventDescription" rows="3" placeholder="Event details and information..."></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="notifyPlayers" checked> üì® Notify all players via
                        email/app</label>
                </div>
                <button type="submit" class="btn btn-primary">üìÖ Create Event</button>
            </form>
        </div>
    </div>

    <!-- Create Payment Plan Modal -->
    <div id="createPaymentPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Create Payment Plan</h2>
                <button class="close" onclick="closeModal('createPaymentPlanModal')">&times;</button>
            </div>
            <form id="createPaymentPlanForm">
                <div class="form-group">
                    <label for="planName">Plan Name</label>
                    <input type="text" id="planName" required placeholder="e.g., Monthly Membership">
                </div>
                <div class="form-group">
                    <label for="planAmount">Amount (¬£)</label>
                    <input type="number" id="planAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="planFrequency">Frequency</label>
                    <select id="planFrequency" required>
                        <option value="">Select Frequency</option>
                        <option value="month">Monthly</option>
                        <option value="week">Weekly</option>
                        <option value="year">Annually</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planDescription">Description</label>
                    <textarea id="planDescription" rows="3"
                        placeholder="Plan details and what's included..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üí≥ Create Plan</button>
            </form>
        </div>
    </div>

    <!-- Edit Payment Plan Modal -->
    <div id="editPaymentPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Payment Plan</h2>
                <button class="close" onclick="closeModal('editPaymentPlanModal')">&times;</button>
            </div>
            <form id="editPaymentPlanForm">
                <input type="hidden" id="editPlanId">
                <div class="form-group">
                    <label for="editPlanName">Plan Name</label>
                    <input type="text" id="editPlanName" required>
                </div>
                <div class="form-group">
                    <label for="editPlanAmount">Amount (¬£)</label>
                    <input type="number" id="editPlanAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editPlanFrequency">Frequency</label>
                    <select id="editPlanFrequency" required>
                        <option value="month">Monthly</option>
                        <option value="week">Weekly</option>
                        <option value="year">Annually</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPlanDescription">Description</label>
                    <textarea id="editPlanDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Create Listing Modal -->
    <div id="createListingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Create Club Listing</h2>
                <button class="close" onclick="closeModal('createListingModal')">&times;</button>
            </div>
            <form id="createListingForm">
                <div class="form-group">
                    <label for="listingTitle">Listing Title</label>
                    <input type="text" id="listingTitle" required placeholder="e.g., U16 Midfielder Wanted">
                </div>
                <div class="form-group">
                    <label for="listingType">Listing Type</label>
                    <select id="listingType" required>
                        <option value="">Select Type</option>
                        <option value="player-wanted">Player Wanted</option>
                        <option value="trial-announcement">Trial Announcement</option>
                        <option value="camp-promotion">Camp Promotion</option>
                        <option value="club-promotion">Club Promotion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="listingPosition">Position (if applicable)</label>
                    <input type="text" id="listingPosition" placeholder="e.g., Goalkeeper, Midfielder">
                </div>
                <div class="form-group">
                    <label for="listingAgeGroup">Age Group</label>
                    <select id="listingAgeGroup">
                        <option value="">Any Age</option>
                        <option value="U8">Under 8</option>
                        <option value="U10">Under 10</option>
                        <option value="U12">Under 12</option>
                        <option value="U14">Under 14</option>
                        <option value="U16">Under 16</option>
                        <option value="U18">Under 18</option>
                        <option value="Senior">Senior</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="listingDescription">Requirements & Details</label>
                    <textarea id="listingDescription" rows="3"
                        placeholder="Tell applicants what you're looking for..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üìã Create Listing</button>
            </form>
        </div>
    </div>

    <!-- Edit Listing Modal -->
    <div id="editListingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Club Listing</h2>
                <button class="close" onclick="closeModal('editListingModal')">&times;</button>
            </div>
            <form id="editListingForm">
                <input type="hidden" id="editListingId">
                <div class="form-group">
                    <label for="editListingTitle">Listing Title</label>
                    <input type="text" id="editListingTitle" required>
                </div>
                <div class="form-group">
                    <label for="editListingType">Listing Type</label>
                    <select id="editListingType" required>
                        <option value="player-wanted">Player Wanted</option>
                        <option value="trial-announcement">Trial Announcement</option>
                        <option value="camp-promotion">Camp Promotion</option>
                        <option value="club-promotion">Club Promotion</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editListingPosition">Position (if applicable)</label>
                    <input type="text" id="editListingPosition">
                </div>
                <div class="form-group">
                    <label for="editListingAgeGroup">Age Group</label>
                    <select id="editListingAgeGroup">
                        <option value="">Any Age</option>
                        <option value="U8">Under 8</option>
                        <option value="U10">Under 10</option>
                        <option value="U12">Under 12</option>
                        <option value="U14">Under 14</option>
                        <option value="U16">Under 16</option>
                        <option value="U18">Under 18</option>
                        <option value="Senior">Senior</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editListingDescription">Requirements & Details</label>
                    <textarea id="editListingDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Team Management Modal -->
    <div id="teamManagementModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="teamManagementTitle">‚öΩ Team Management</h2>
                <button class="close" onclick="closeModal('teamManagementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Team management tabs -->
                <div
                    style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid rgba(220, 67, 67, 0.2); padding-bottom: 1rem;">
                    <button class="btn btn-primary btn-small active" onclick="showTeamTab('games')">üèüÔ∏è
                        Games</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('trainings')">üèãÔ∏è
                        Trainings</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('players')">üë•
                        Players</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('votes')">üìä
                        Votes</button>
                </div>

                <!-- Tab content will be populated by JavaScript -->
                <div id="teamTabContent">
                    <!-- Content based on selected tab -->
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div id="applicationDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="applicationDetailsTitle">üë§ Application Details</h2>
                <button class="close" onclick="closeModal('applicationDetailsModal')">&times;</button>
            </div>
            <div id="applicationDetailsContent">
                <!-- Application details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Add New Product</h2>
                <button class="close" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="productName">Product Name *</label>
                    <input type="text" id="productName" required placeholder="e.g., Club Hoodie">
                </div>
                <div class="form-group">
                    <label for="productPrice">Price (¬£) *</label>
                    <input type="number" id="productPrice" step="0.01" required placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="productStock">Stock Quantity</label>
                    <input type="number" id="productStock" placeholder="Leave empty for unlimited">
                </div>
                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Custom Questions (e.g., Size, Initials)</label>
                    <div id="customQuestionsContainer"
                        style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                        <!-- Dynamic question inputs -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addQuestionField()"
                        style="margin-top: 0.5rem;">+ Add Question</button>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">‚ûï Add
                    Product</button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Product</h2>
                <button class="close" onclick="closeModal('editProductModal')">&times;</button>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="editProductName">Product Name *</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">Price (¬£) *</label>
                    <input type="number" id="editProductPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editProductStock">Stock Quantity</label>
                    <input type="number" id="editProductStock">
                </div>
                <div class="form-group">
                    <label for="editProductDescription">Description</label>
                    <textarea id="editProductDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="createCampaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì£ Create Marketing Campaign</h2>
                <button class="close" onclick="closeModal('createCampaignModal')">&times;</button>
            </div>
            <form id="createCampaignForm">
                <div class="form-group">
                    <label for="campaignTitle">Campaign Title *</label>
                    <input type="text" id="campaignTitle" required placeholder="e.g., Summer Trial Recruitment">
                </div>
                <div class="form-group">
                    <label for="campaignSubject">Email Subject *</label>
                    <input type="text" id="campaignSubject" required placeholder="Don't miss out!">
                </div>
                <div class="form-group">
                    <label for="campaignTarget">Target Audience</label>
                    <select id="campaignTarget">
                        <option value="all">All Members</option>
                        <option value="players">Current Players</option>
                        <option value="applicants">Club Applicants</option>
                        <option value="staff">Staff Members</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="campaignMessage">Message Content (HTML Supported)</label>
                    <textarea id="campaignMessage" rows="8" required
                        placeholder="Write your message here..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üì® Create & Send Campaign</button>
            </form>
        </div>
    </div>

    <!-- Record Match Result Modal -->
    <div id="recordResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öΩ Record Match Result</h2>
                <button class="close" onclick="closeModal('recordResultModal')">&times;</button>
            </div>
            <form id="recordResultForm">
                <input type="hidden" id="resultGameId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="homeScore">Our Score</label>
                        <input type="number" id="homeScore" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="awayScore">Opponent Score</label>
                        <input type="number" id="awayScore" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="matchSummary">Match Summary</label>
                    <textarea id="matchSummary" rows="3" placeholder="Notes about the performance..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-block">üíæ Save Result</button>
            </form>
        </div>
    </div>

    <!-- JavaScript Integration -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="stripe-service.js"></script>
    <script src="script.js"></script>
    <script src="enhanced-invite-system.js"></script>

    <script>
        // üîí AUTHENTICATION GUARD - Prevent unauthorized access
        (function () {
            const token = localStorage.getItem('authToken');
            const currentUser = localStorage.getItem('currentUser');

            if (!token || !currentUser) {
                console.warn('üö´ No authentication found, redirecting to login...');
                window.location.href = 'index.html';
                return;
            }

            try {
                const user = JSON.parse(currentUser);
                if (user.account_type !== 'admin' && user.account_type !== 'organization') {
                    console.warn('üö´ User is not an admin, redirecting to appropriate dashboard...');
                    // Redirect to correct dashboard based on account type
                    if (user.account_type === 'player' || user.account_type === 'parent' || user.account_type === 'adult') {
                        window.location.href = 'player-dashboard.html';
                    } else if (user.account_type === 'coach') {
                        window.location.href = 'coach-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                console.log('‚úÖ Admin authentication verified');
            } catch (error) {
                console.error('‚ùå Failed to parse user data:', error);
                localStorage.clear();
                window.location.href = 'index.html';
                return;
            }
        })();

        function hydrateAddPlayerPlanSelect() {
            const sel = document.getElementById('playerPaymentPlan');
            if (!sel) return;

            const current = sel.value;
            const plans = AppState.paymentPlans || [];

            sel.innerHTML = `
                <option value="">No payment plan</option>
                ${plans.map(plan => {
                const priceNum = Number(plan.price ?? plan.amount ?? 0);
                const interval = (plan.interval ?? plan.frequency ?? '').toString();
                return `<option value="${plan.id}">${plan.name} - ¬£${priceNum.toFixed(2)}/${interval}</option>`;
            }).join('')}
            `;

            // Keep previous selection if it still exists
            if ([...sel.options].some(o => o.value === current)) {
                sel.value = current;
            } else {
                sel.value = '';
            }
        }

        function initAddPlayerFeeField() {
            const planSelect = document.getElementById('playerPaymentPlan');
            const feeInput = document.getElementById('playerFee');
            const feeLabel = document.querySelector('label[for="playerFee"]');
            if (!planSelect || !feeInput) return;

            if (feeLabel) feeLabel.textContent = 'Custom Plan Price (¬£) (optional)';

            function syncFeeInputState() {
                const hasPlan = !!planSelect.value;
                feeInput.disabled = !hasPlan;
                if (!hasPlan) {
                    feeInput.value = '';
                    feeInput.placeholder = 'Select a plan first';
                } else {
                    feeInput.placeholder = 'Leave blank to use plan default';
                }
            }

            syncFeeInputState();
            planSelect.addEventListener('change', syncFeeInputState);
        }

        function initAddPlayerModalControls() {
            hydrateAddPlayerPlanSelect();
            initAddPlayerFeeField();
        }
        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = AppState.activeClubId || (AppState.clubs?.[0]?.id);
                const products = await apiService.getProducts(clubId);

                if (!products || products.length === 0) {
                    container.innerHTML = `
                <div style="text-align: center; padding: 2rem; opacity: 0.8; grid-column: 1/-1;">
                    <p>No products added to the shop yet</p>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showModal('addProductModal')">Add Your First Product</button>
                </div>
            `;
                    return;
                }

                AppState.products = products;

                container.innerHTML = products.map(product => `
            <div class="card product-card">
                <div style="height: 150px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 3rem;">üì¶</span>
                </div>
                <h4>${product.name}</h4>
                <p style="color: #dc4343; font-weight: bold; font-size: 1.2rem; margin: 0.5rem 0;">¬£${parseFloat(product.price).toFixed(2)}</p>
                <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">${product.description || 'No description available'}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 0.8rem; opacity: 0.6;">Stock: ${product.stock_quantity !== null ? product.stock_quantity : 'Unlimited'}</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-small btn-secondary" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
                    </div>
                </div>
            </div>
        `).join('');

            } catch (error) {
                console.error('Failed to load products:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load products</p>';
            } finally {
                showLoading(false);
            }
        }

        function addQuestionField() {
            const container = document.getElementById('customQuestionsContainer');
            if (!container) return;
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '0.5rem';
            div.innerHTML = `
                <input type="text" class="custom-question-input" placeholder="e.g. Size" style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove()" style="background: #444; border: none; align-self: stretch;">√ó</button>
            `;
            container.appendChild(div);
        }

        async function handleAddProduct(e) {
            if (e) e.preventDefault();

            const customFields = Array.from(document.querySelectorAll('.custom-question-input'))
                .map(input => input.value.trim())
                .filter(val => val !== '');

            const payload = {
                name: document.getElementById('productName').value.trim(),
                price: parseFloat(document.getElementById('productPrice').value),
                stock_quantity: document.getElementById('productStock').value ? parseInt(document.getElementById('productStock').value) : null,
                description: document.getElementById('productDescription').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id),
                custom_fields: customFields
            };

            try {
                showLoading(true);
                await apiService.createProduct(payload);
                showNotification('Product added successfully!', 'success');
                closeModal('addProductModal');
                document.getElementById('addProductForm').reset();
                await loadProducts();
            } catch (error) {
                console.error('Failed to add product:', error);
                showNotification('Failed to add product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editProduct(id) {
            const product = AppState.products?.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock_quantity;
            document.getElementById('editProductDescription').value = product.description || '';

            showModal('editProductModal');
        }

        async function handleUpdateProduct(e) {
            if (e) e.preventDefault();

            const productId = document.getElementById('editProductId').value;
            const payload = {
                name: document.getElementById('editProductName').value.trim(),
                price: parseFloat(document.getElementById('editProductPrice').value),
                stock_quantity: document.getElementById('editProductStock').value ? parseInt(document.getElementById('editProductStock').value) : null,
                description: document.getElementById('editProductDescription').value.trim()
            };

            try {
                showLoading(true);
                await apiService.updateProduct(productId, payload);
                showNotification('Product updated successfully!', 'success');
                closeModal('editProductModal');
                await loadProducts();
            } catch (error) {
                console.error('Failed to update product:', error);
                showNotification('Failed to update product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                showLoading(true);
                await apiService.deleteProduct(id);
                showNotification('Product deleted successfully!', 'success');
                await loadProducts();
            } catch (error) {
                console.error('Failed to delete product:', error);
                showNotification('Failed to delete product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadCampaigns() {
            const container = document.getElementById('campaignsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = AppState.activeClubId || (AppState.clubs?.[0]?.id);
                const campaigns = await apiService.getCampaigns(clubId);

                if (!campaigns || campaigns.length === 0) {
                    container.innerHTML = `
                <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                    <p>No marketing campaigns created yet</p>
                </div>
            `;
                    return;
                }

                container.innerHTML = campaigns.map(campaign => `
            <div class="card campaign-card" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h4>${campaign.name}</h4>
                        <p style="font-size: 0.9rem; opacity: 0.7;">Subject: ${campaign.subject}</p>
                        <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 0.5rem;">Target: ${campaign.target_group} | Created: ${new Date(campaign.created_at).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <span class="status-badge status-${campaign.status || 'draft'}">${campaign.status || 'Draft'}</span>
                        <button class="btn btn-small btn-primary" onclick="sendCampaign('${campaign.id}')" ${campaign.status === 'sent' ? 'disabled' : ''}>Send Now</button>
                    </div>
                </div>
            </div>
        `).join('');

            } catch (error) {
                console.error('Failed to load campaigns:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load campaigns</p>';
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateCampaign(e) {
            if (e) e.preventDefault();

            const payload = {
                name: document.getElementById('campaignTitle').value.trim(),
                subject: document.getElementById('campaignSubject').value.trim(),
                target_group: document.getElementById('campaignTarget').value,
                content: document.getElementById('campaignMessage').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                const created = await apiService.createCampaign(payload);
                showNotification('Campaign created and queued for sending!', 'success');
                closeModal('createCampaignModal');
                document.getElementById('createCampaignForm').reset();
                await loadCampaigns();
            } catch (error) {
                console.error('Failed to create campaign:', error);
                showNotification('Failed to create campaign: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function sendCampaign(campaignId) {
            if (!confirm('Are you sure you want to send this campaign email to all targeted members?')) return;

            try {
                showLoading(true);
                await apiService.sendCampaignEmail(campaignId);
                showNotification('Campaign sent successfully!', 'success');
                await loadCampaigns();
            } catch (error) {
                console.error('Failed to send campaign:', error);
                showNotification('Failed to send campaign: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editProduct(productId) {
            showNotification('Product editing coming soon!', 'info');
        }



        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üè¢ Enhanced Admin Dashboard Loading...');

            // Populate user info
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                const nameDisplay = document.getElementById('adminNameDisplay');
                const avatarDisplay = document.getElementById('adminAvatar');
                if (nameDisplay) nameDisplay.innerText = `Hello, ${user.firstName || user.first_name || 'Admin'}!`;
                if (avatarDisplay) avatarDisplay.innerText = (user.firstName || user.first_name || 'A').charAt(0).toUpperCase();
            }

            // Hide any loading indicators
            const hideAllLoading = () => {
                const loadingElements = document.querySelectorAll('.loading, [data-loading="true"]');
                loadingElements.forEach(el => {
                    el.style.display = 'none';
                    el.remove();
                });
                document.body.classList.remove('loading');
                AppState.isLoading = false;
            };

            try {
                const dashboardData = await apiService.getAdminDashboardData();

                if (dashboardData) {
                    AppState.clubs = dashboardData.clubs || [];
                    AppState.activeClubId = await getActiveClubId();
                    AppState.players = dashboardData.players || [];
                    AppState.staff = dashboardData.staff || [];
                    AppState.events = dashboardData.events || [];
                    AppState.teams = dashboardData.teams || [];
                    AppState.payments = dashboardData.payments || [];
                    updateDashboardStats(dashboardData.statistics);

                    // Initial Gallery Load
                    const activeClub = AppState.clubs.find(c => c.id == AppState.activeClubId);
                    if (activeClub && activeClub.images) {
                        displayClubImages(activeClub.images);
                    }
                }

                // ‚úÖ Load payment plans first so we can enrich players
                await loadPaymentPlans();

                // then render the rest
                loadDashboardStats();
                await loadPlayers();        // ‚Üê now after plans
                loadTeams();
                loadEvents();
                loadFinances();
                initAddPlayerModalControls();
                checkAndConfigureStripe();

                console.log('‚úÖ Admin Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load dashboard:', error);
                showNotification('Failed to load dashboard data: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                // Always hide loading, even if there's an error
                hideAllLoading();
            }

            setupEnhancedEventListeners();
        });

        async function checkAndConfigureStripe() {
            try {
                const status = await apiService.makeRequest('/payments/stripe/connect/status');
                if (status.stripeAccountId && status.details_submitted) {
                    console.log('üí≥ Stripe connected, ensuring monthly payout schedule (1st of month)');
                    await apiService.makeRequest(`/stripe-payouts/configure-payout/${status.stripeAccountId}`, {
                        method: 'POST'
                    });
                }
            } catch (err) {
                // Silently skip if not onboarded
                console.log('Stripe configuration check skipped or failed');
            }
        }


        // Enhanced Event Listeners
        function setupEnhancedEventListeners() {
            // Player form
            const addPlayerForm = document.getElementById('addPlayerForm');
            if (addPlayerForm) {
                addPlayerForm.addEventListener('submit', handleAddPlayer);
            }

            const editPlayerForm = document.getElementById('editPlayerForm');
            if (editPlayerForm) {
                editPlayerForm.addEventListener('submit', handleEditPlayer);
            }

            // Team form  
            const addTeamForm = document.getElementById('addTeamForm');
            if (addTeamForm) {
                addTeamForm.addEventListener('submit', handleAddTeam);
            }

            // Event form
            const addEventForm = document.getElementById('addEventForm');
            if (addEventForm) {
                addEventForm.addEventListener('submit', handleAddEvent);
            }

            // Payment plan form
            const createPaymentPlanForm = document.getElementById('createPaymentPlanForm');
            if (createPaymentPlanForm) {
                createPaymentPlanForm.addEventListener('submit', handleCreatePaymentPlan);
            }

            const editPaymentPlanForm = document.getElementById('editPaymentPlanForm');
            if (editPaymentPlanForm) {
                editPaymentPlanForm.addEventListener('submit', handleUpdatePaymentPlan);
            }

            // Staff invite form
            const inviteStaffForm = document.getElementById('inviteStaffForm');
            if (inviteStaffForm) {
                inviteStaffForm.addEventListener('submit', handleStaffInvite);
            }

            // Club profile form
            const clubProfileForm = document.getElementById('clubProfileForm');
            if (clubProfileForm) {
                clubProfileForm.addEventListener('submit', handleClubProfileUpdate);
            }

            // Item Shop form
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', handleAddProduct);
            }

            const editProductForm = document.getElementById('editProductForm');
            if (editProductForm) {
                editProductForm.addEventListener('submit', handleUpdateProduct);
            }

            // Marketing Hub form
            const createCampaignForm = document.getElementById('createCampaignForm');
            if (createCampaignForm) {
                createCampaignForm.addEventListener('submit', handleCreateCampaign);
            }

            const createListingForm = document.getElementById('createListingForm');
            if (createListingForm) {
                createListingForm.addEventListener('submit', handleCreateListing);
            }

            const editListingForm = document.getElementById('editListingForm');
            if (editListingForm) {
                editListingForm.addEventListener('submit', handleUpdateListing);
            }

            // Results form
            const recordResultForm = document.getElementById('recordResultForm');
            if (recordResultForm) {
                recordResultForm.addEventListener('submit', handleRecordResult);
            }

            // Assign Plan Form
            const assignPlanForm = document.getElementById('assignPlanForm');
            if (assignPlanForm) {
                assignPlanForm.addEventListener('submit', handleAssignPlanSubmit);
            }
        }

        // Enhanced Player Filtering Functions
        async function filterPlayersByView() {
            const view = document.getElementById('playerListFilter').value;
            console.log('Filtering players by view:', view);

            showLoading(true);
            try {
                const clubId = await getActiveClubId(); // must exist; see earlier snippet
                let filteredPlayers;

                if (view === 'all') {
                    filteredPlayers = await apiService.getPlayers(clubId);
                } else {
                    filteredPlayers = await apiService.getFilteredPlayers(view, clubId);
                }

                displayFilteredPlayers(filteredPlayers, view);
            } catch (error) {
                console.error('Failed to filter players:', error);
                showNotification('Failed to filter players: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayFilteredPlayers(players, filterType) {
            const container = document.getElementById('playersContainer');
            if (!container) return;

            if (!players || players.length === 0) {
                const filterNames = {
                    'all': 'players',
                    'on-plan': 'players on payment plans',
                    'not-on-plan': 'players not on payment plans',
                    'assigned': 'players assigned to teams',
                    'not-assigned': 'players not assigned to teams',
                    'overdue': 'players with overdue payments'
                };
                container.innerHTML = `
      <div class="empty-state" style="text-align: center; padding: 2rem;">
        <h4>No ${filterNames[filterType] || 'players'} found</h4>
        <p>Try a different filter or add some players to your club</p>
      </div>
    `;
                return;
            }

            container.innerHTML = players.map(player => {
                const hasTeamAssignment = Boolean(player.team_assignments?.length || player.team_name);
                const hasPaymentPlan = hasPlan(player);
                const isOverdue = (player.overdue_count || 0) > 0 || player.payment_status === 'overdue';

                const onPlan = hasPaymentPlan;
                const rawFee = onPlan ? (player.plan_price ?? player.payment_plan?.price ?? player.payment_plan?.amount) : null;
                const hasRawFee = onPlan && rawFee !== undefined && rawFee !== null && rawFee !== '';
                const fee = hasRawFee ? Number(rawFee) : NaN;
                const feeHtml = (onPlan && Number.isFinite(fee)) ? `¬£${fee.toFixed(2)}` : '‚Äî';

                return `
      <div class="player-card ${isOverdue ? 'overdue' : ''} ${!hasTeamAssignment ? 'not-assigned' : ''}">
        <div class="player-header">
          <div class="player-info">
            <h4>${player.first_name} ${player.last_name}</h4>
            ${hasPaymentPlan ? `<span class="payment-plan-badge">On Payment Plan</span>` : `<span class="no-plan-badge">No Plan Set</span>`}
          </div>
          <div class="player-status">
            <span class="status-badge status-${player.payment_status || 'pending'}">
              ${player.payment_status || 'Pending'}
            </span>
          </div>
        </div>
        <div class="player-meta">
          <span><strong>Age:</strong> ${calculateAge(player.date_of_birth)} years</span>
          <span><strong>Team:</strong> ${player.team_name || (player.team_assignments?.[0]?.team_name || 'Not assigned')}</span>
          <span><strong>Email:</strong> ${player.email || 'No email'}</span>
          <span><strong>Phone:</strong> ${player.phone || 'No phone'}</span>
          <span><strong>Monthly Fee:</strong> ${feeHtml}</span>
        </div>
        <div class="player-actions">
          <button class="btn btn-small btn-secondary" onclick="editPlayer('${player.id}')">Edit</button>
          ${!hasPaymentPlan ? `<button class="btn btn-small btn-warning" onclick="assignPaymentPlan('${player.id}')">Assign Plan</button>` : ''}
          ${!hasTeamAssignment ? `<button class="btn btn-small btn-primary" onclick="showPlayerTeamAssignment('${player.id}')">Assign Team</button>` : ''}
          <button class="btn btn-small btn-danger" onclick="removePlayer('${player.id}')">Remove</button>
        </div>
      </div>
    `;
            }).join('');
        }

        async function assignPaymentPlan(userId) {
            console.log('Assigning plan to user:', userId);

            // Populate hidden userId
            document.getElementById('assignPlanUserId').value = userId;

            // Load plans into select
            const select = document.getElementById('assignPlanSelect');
            select.innerHTML = '<option value="">Select a plan...</option>';

            try {
                // Use cached plans or fetch
                let plans = AppState.paymentPlans;
                if (!plans) {
                    plans = await apiService.getPaymentPlans(await getActiveClubId());
                    AppState.paymentPlans = plans;
                }

                plans.forEach(plan => {
                    const price = plan.price || plan.amount || 0;
                    select.innerHTML += `<option value="${plan.id}">${plan.name} (¬£${Number(price).toFixed(2)})</option>`;
                });

                showModal('assignPlanModal');

            } catch (error) {
                console.error('Failed to load plans for assignment:', error);
                showNotification('Failed to load payment plans', 'error');
            }
        }

        async function handleAssignPlanSubmit(e) {
            e.preventDefault();

            const userId = document.getElementById('assignPlanUserId').value;
            const planId = document.getElementById('assignPlanSelect').value;
            const startDate = document.getElementById('assignPlanStartDate').value;

            if (!userId || !planId) return;

            try {
                showLoading(true);
                // Use bulk-assign (which handles single user too via our wrapper)
                await apiService.assignPlanToPlayer(userId, planId, startDate);

                showNotification('Payment plan assigned successfully!', 'success');
                closeModal('assignPlanModal');
                await loadPlayers(); // Refresh list to show badge
            } catch (error) {
                console.error('Failed to assign plan:', error);
                showNotification('Failed to assign plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        // Enhanced Team Management Functions
        async function openTeamManagement(teamId, teamName) {
            const modal = document.getElementById('teamManagementModal');
            if (modal) modal.remove();

            const newModal = document.createElement('div');
            newModal.id = 'teamManagementModal';
            newModal.className = 'modal';
            newModal.style.display = 'block';

            newModal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>‚öΩ ${teamName} Management</h2>
                <button class="close" onclick="closeModal('teamManagementModal')">&times;</button>
            </div>
            <div class="team-management-tabs">
                <button class="active" onclick="showTeamTab('games', '${teamId}', event)">üèüÔ∏è Games</button>
                <button onclick="showTeamTab('trainings', '${teamId}', event)">üèãÔ∏è Trainings</button>
                <button onclick="showTeamTab('players', '${teamId}', event)">üë• Players</button>
                <button onclick="showTeamTab('votes', '${teamId}', event)">üìä Votes</button>
                <button onclick="showTeamTab('tactical', '${teamId}', event)">üìã Tactical Board</button>
            </div>
                
                <div id="teamTabContent">
                    <div class="spinner"></div> Loading team data...
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(newModal);

            // Load initial tab
            showTeamTab('games', teamId);
        }

        async function showTeamTab(tabName, teamId, ev) {
            const tabButtons = document.querySelectorAll('.team-management-tabs button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            if (ev && ev.currentTarget) {
                ev.currentTarget.classList.add('active');
            } else {
                // when called programmatically, select the matching button
                const btn = Array.from(tabButtons).find(b => b.getAttribute('onclick')?.includes(`'${tabName}'`));
                if (btn) btn.classList.add('active');
            }

            const tabContent = document.getElementById('teamTabContent');
            if (!tabContent) return;

            tabContent.innerHTML = '<div class="spinner"></div> Loading...';

            try {
                if (tabName === 'games') await loadTeamGames(teamId, tabContent);
                else if (tabName === 'trainings') await loadTeamTrainings(teamId, tabContent);
                else if (tabName === 'players') await loadTeamPlayers(teamId, tabContent);
                else if (tabName === 'votes') await loadTeamVotes(teamId, tabContent);
                else if (tabName === 'tactical') await loadTeamTacticalBoard(teamId, tabContent);
            } catch (error) {
                console.error(`Failed to load team ${tabName}:`, error);
                tabContent.innerHTML = `<p style="color: #dc3545;">Failed to load ${tabName}</p>`;
            }
        }

        async function loadTeamGames(teamId, container) {
            const games = await apiService.getTeamEvents(teamId, 'match');

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üèüÔ∏è Team Games & Matches</h4>
            <button class="btn btn-primary" onclick="createTeamGame('${teamId}')">‚ûï Create Game</button>
        </div>
        
        <div id="teamGames">
            ${games.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No games scheduled yet</p>' :
                    games.map(game => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${game.title}</h5>
                            <p><strong>Date:</strong> ${new Date(game.event_date).toLocaleDateString()}</p>
                            <p><strong>Opponent:</strong> ${game.opponent || 'TBA'}</p>
                            <p><strong>Location:</strong> ${game.location || 'TBA'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-success" onclick="openRecordResult('${game.id}')">üèÜ Result</button>
                            <button class="btn btn-small btn-secondary" onclick="editTeamEvent('${game.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTeamEvent('${game.id}')">Delete</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        function openRecordResult(gameId) {
            const hiddenInput = document.getElementById('resultGameId');
            if (hiddenInput) hiddenInput.value = gameId;
            showModal('recordResultModal');
        }

        async function handleRecordResult(e) {
            if (e) e.preventDefault();
            const gameId = document.getElementById('resultGameId').value;
            const payload = {
                score: {
                    home: parseInt(document.getElementById('homeScore').value),
                    away: parseInt(document.getElementById('awayScore').value)
                },
                summary: document.getElementById('matchSummary').value
            };

            try {
                showLoading(true);
                await apiService.submitGameResult(gameId, payload);
                showNotification('Match result recorded!', 'success');
                closeModal('recordResultModal');
                // Could refresh games tab if we store teamId somewhere
            } catch (error) {
                showNotification('Failed to save result: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadTeamTrainings(teamId, container) {
            const trainings = await apiService.getTeamEvents(teamId, 'training');

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üèãÔ∏è Training Sessions</h4>
            <button class="btn btn-primary" onclick="createTeamTraining('${teamId}')">‚ûï Create Training</button>
        </div>
        
        <div id="teamTrainings">
            ${trainings.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No training sessions scheduled</p>' :
                    trainings.map(training => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${training.title}</h5>
                            <p><strong>Date:</strong> ${new Date(training.event_date).toLocaleDateString()}</p>
                            <p><strong>Time:</strong> ${training.event_time || 'TBA'}</p>
                            <p><strong>Location:</strong> ${training.location || 'TBA'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-secondary" onclick="editTeamEvent('${training.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTeamEvent('${training.id}')">Delete</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        async function loadTeamPlayers(teamId, container) {
            const teamDetails = await apiService.getTeamDetails(teamId);
            const players = teamDetails.players || [];

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üë• Team Players (${players.length})</h4>
            <button class="btn btn-primary" onclick="addPlayerToTeam('${teamId}')">‚ûï Add Player</button>
        </div>
        
        <div id="teamPlayers">
            ${players.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No players assigned to this team yet</p>' :
                    players.map(player => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${player.first_name} ${player.last_name}</h5>
                            <p><strong>Position:</strong> ${player.team_position || 'Not set'}</p>
                            <p><strong>Jersey:</strong> ${player.jersey_number || 'Not assigned'}</p>
                            <p><strong>Email:</strong> ${player.email || 'No email'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-secondary" onclick="editPlayerTeamInfo('${teamId}', '${player.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="removePlayerFromTeam('${teamId}', '${player.id}')">Remove</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        async function loadTeamVotes(teamId, container) {
            try {
                const votes = await apiService.getTeamVotes(teamId);
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h4>üìä Team Availability Votes</h4>
                    </div>
                    <div id="teamVotes">
                        ${votes.length === 0 ?
                        '<p style="text-align: center; opacity: 0.8;">No availability votes yet.</p>' :
                        votes.map(v => `
                                <div class="event-item">
                                    <div class="event-info">
                                        <h5>${v.player_name || 'Player'}</h5>
                                        <p><strong>Status:</strong> ${v.available ? '‚úÖ Available' : '‚ùå Unavailable'}</p>
                                        <p><strong>Event:</strong> ${v.event_title || 'Upcoming Event'}</p>
                                    </div>
                                </div>
                            `).join('')
                    }
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:red">Failed to load votes.</p>';
            }
        }

        async function loadTeamTacticalBoard(teamId, container) {
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h4>üìã Team Tactical Board</h4>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <select id="adminFormationSelect" class="btn btn-small btn-secondary" style="width: auto; padding: 0.3rem 1rem;" onchange="setAdminFormation()">
                            <option value="4-4-2">4-4-2</option>
                            <option value="4-3-3">4-3-3</option>
                            <option value="3-5-2">3-5-2</option>
                            <option value="4-2-3-1">4-2-3-1</option>
                        </select>
                        <button class="btn btn-small btn-secondary" onclick="clearAdminBoard()">üßπ Clear</button>
                    </div>
                </div>
                
                <div id="adminTacticalBoard" class="tactical-board" style="height: 500px; position: relative; margin-bottom: 2rem;">
                    <div style="position: absolute; top: 0; left: 25%; width: 50%; height: 15%; border: 2px solid white; border-top: none;"></div>
                    <div style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 15%; border: 2px solid white; border-bottom: none;"></div>
                    <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 0; border-top: 2px solid white;"></div>
                    <div style="position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                </div>

                <div class="card">
                    <h5>üë• Players to Assign</h5>
                    <div id="adminAvailablePlayers" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
                    </div>
                </div>
            `;

            window.selectedAdminPosition = undefined;
            setTimeout(() => {
                setAdminFormation();
                loadAdminAvailablePlayers(teamId);
            }, 50);
        }

        function setAdminFormation() {
            const formation = document.getElementById('adminFormationSelect')?.value || '4-4-2';
            const board = document.getElementById('adminTacticalBoard');
            if (!board) return;

            const markers = board.querySelectorAll('.player-position');
            markers.forEach(m => m.remove());

            const formations = {
                '4-4-2': [
                    { x: 50, y: 85 }, { x: 20, y: 65 }, { x: 40, y: 65 }, { x: 60, y: 65 }, { x: 80, y: 65 },
                    { x: 25, y: 45 }, { x: 45, y: 45 }, { x: 55, y: 45 }, { x: 75, y: 45 }, { x: 40, y: 25 }, { x: 60, y: 25 }
                ],
                '4-3-3': [
                    { x: 50, y: 85 }, { x: 20, y: 65 }, { x: 40, y: 65 }, { x: 60, y: 65 }, { x: 80, y: 65 },
                    { x: 30, y: 45 }, { x: 50, y: 45 }, { x: 70, y: 45 }, { x: 25, y: 25 }, { x: 50, y: 25 }, { x: 75, y: 25 }
                ]
            };

            const positions = formations[formation] || formations['4-4-2'];
            positions.forEach((pos, i) => {
                const el = document.createElement('div');
                el.className = 'player-position';
                el.style.left = `${pos.x}%`;
                el.style.top = `${pos.y}%`;
                el.textContent = i + 1;
                el.onclick = () => {
                    document.querySelectorAll('.player-position').forEach(p => p.classList.remove('selected'));
                    el.classList.add('selected');
                    window.selectedAdminPosition = i;
                };
                board.appendChild(el);
            });
        }

        async function loadAdminAvailablePlayers(teamId) {
            const container = document.getElementById('adminAvailablePlayers');
            if (!container) return;

            try {
                const team = await apiService.getTeamDetails(teamId);
                const players = team.players || [];

                if (players.length === 0) {
                    container.innerHTML = '<p style="opacity:0.6; font-size:0.9rem;">No players assigned to this team yet.</p>';
                    return;
                }

                container.innerHTML = players.map(p => `
                    <div class="available-player" onclick="assignPlayerToBoard('${p.id}', '${p.first_name[0]}${p.last_name[0]}')" 
                        style="padding: 0.5rem 1rem; background: rgba(0,0,0,0.05); border-radius: 20px; cursor: pointer; border: 1px solid rgba(220,67,67,0.2); font-size: 0.85rem;">
                        ${p.first_name} ${p.last_name}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load players for tactical board:', err);
            }
        }

        function assignPlayerToBoard(playerId, initials) {
            if (window.selectedAdminPosition === undefined) {
                return showNotification('Select a position on the board first!', 'warning');
            }

            const markers = document.querySelectorAll('.player-position');
            const target = markers[window.selectedAdminPosition];
            if (target) {
                target.textContent = initials;
                target.classList.add('assigned');
                target.classList.remove('selected');
                window.selectedAdminPosition = undefined;
                showNotification('Player assigned to position!', 'success');
            }
        }

        function clearAdminBoard() {
            setAdminFormation();
            showNotification('Board cleared', 'info');
        }

        function saveAdminFormation() {
            showNotification('Tactical layout saved!', 'success');
        }

        // Enhanced Staff Invite Functions
        function generateStaffInvite(role) {
            console.log('üìß Generating staff invite for role:', role);

            // Pre-fill the invite form based on role
            const roleSelect = document.getElementById('staffInviteRole');
            if (roleSelect) {
                if (role === 'coach') {
                    roleSelect.value = 'coach';
                } else if (role === 'assistant') {
                    roleSelect.value = 'assistant-coach';
                } else if (role === 'admin') {
                    roleSelect.value = 'administrator';
                }
            }

            showModal('inviteStaffModal');
        }

        async function loadPaymentPlans() {
            const container = document.getElementById('paymentPlansContainer');
            if (!container) return;

            try {
                showLoading(true);
                const plans = await apiService.listPaymentPlans();

                if (!plans || plans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                            <p>No payment plans created yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Create your first payment plan to start managing player subscriptions</p>
                            <button class="btn btn-primary" onclick="showModal('createPaymentPlanModal')" style="margin-top: 1rem;">Create Your First Plan</button>
                        </div>
                    `;
                    AppState.paymentPlans = [];
                    return;
                }

                container.innerHTML = plans.map(plan => {
                    const amountNum = Number(plan.amount ?? plan.price ?? 0);
                    const interval = (plan.interval ?? plan.frequency ?? '').toString();
                    return `
                        <div class="card" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4>${plan.name}</h4>
                                    <p><strong>¬£${amountNum.toFixed(2)}</strong> per ${interval || '‚Äî'}</p>
                                    <p style="opacity: 0.8; font-size: 0.9rem;">${plan.description || 'No description'}</p>
                                    <p style="font-size: 0.8rem; opacity: 0.6;">Created: ${new Date(plan.created_at || plan.createdAt || Date.now()).toLocaleDateString()}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="btn btn-small btn-secondary" onclick="editPaymentPlan('${plan.id}')">Edit</button>
                                    <button class="btn btn-small btn-warning" onclick="bulkAssignPlan('${plan.id}')">Bulk Assign</button>
                                    <button class="btn btn-small btn-danger" onclick="deletePaymentPlan('${plan.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                AppState.paymentPlans = plans;
            } catch (error) {
                console.error('Failed to load payment plans:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <p>Failed to load payment plans</p>
                        <button class="btn btn-primary" onclick="loadPaymentPlans()" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        async function loadFinances() {
            try {
                const clubId = AppState.clubs?.[0]?.id;
                if (!clubId) return;

                // Load payments for financial overview
                const payments = await apiService.getPayments({ clubId });

                // Calculate financial statistics
                const monthlyRevenue = payments
                    .filter(p => p.payment_status === 'paid')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const overdueAmount = payments
                    .filter(p => p.payment_status === 'overdue')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const pendingAmount = payments
                    .filter(p => p.payment_status === 'pending')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const totalMembers = payments.length;

                // Update finance overview
                document.getElementById('monthlyRevenue').textContent = `¬£${monthlyRevenue.toFixed(2)} `;
                document.getElementById('overdueAmount').textContent = `¬£${overdueAmount.toFixed(2)} `;
                document.getElementById('pendingAmount').textContent = `¬£${pendingAmount.toFixed(2)} `;
                document.getElementById('totalMembers').textContent = totalMembers;

                // Load recent payments table
                const paymentsTableBody = document.getElementById('paymentsTableBody');
                if (paymentsTableBody) {
                    paymentsTableBody.innerHTML = payments.slice(0, 10).map(payment => `
                        <tr>
                            <td>${payment.player_first_name} ${payment.player_last_name}</td>
                            <td>¬£${parseFloat(payment.amount || 0).toFixed(2)}</td>
                            <td><span class="status-badge status-${payment.payment_status}">${payment.payment_status}</span></td>
                            <td>${new Date(payment.due_date).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-small btn-secondary" onclick="editPayment('${payment.id}')">Edit</button>
                                <button class="btn btn-small btn-primary" onclick="generatePaymentLink('${payment.id}')">Link</button>
                            </td>
                        </tr>
                    `).join('');
                }

            } catch (error) {
                console.error('Failed to load finances:', error);
            }
        }

        async function bulkAssignPlan(planId) {
            try {
                // Get all players not on plans
                const playersWithoutPlans = AppState.players.filter(p => !hasPlan(p));

                if (playersWithoutPlans.length === 0) {
                    showNotification('All players already have payment plans assigned', 'info');
                    return;
                }

                const confirmed = confirm(`Assign this payment plan to ${playersWithoutPlans.length} players without plans ? `);
                if (!confirmed) return;

                showLoading(true);

                const playerIds = playersWithoutPlans.map(p => p.id);
                await apiService.makeRequest('/payments/bulk-assign-plan', {
                    method: 'POST',
                    body: JSON.stringify({
                        playerIds,
                        planId,
                        startDate: new Date().toISOString().split('T')[0]
                    })
                });

                showNotification(`Payment plan assigned to ${playerIds.length} players!`, 'success');
                loadPlayers(); // Reload to show updated status

            } catch (error) {
                console.error('Failed to bulk assign plans:', error);
                showNotification('Failed to assign payment plans: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const existingLoader = document.querySelector('.global-loader');

            if (show) {
                if (!existingLoader) {
                    const loader = document.createElement('div');
                    loader.className = 'global-loader';
                    loader.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2rem; border-radius: 8px; z-index: 10000; text-align: center;">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    `;
                    document.body.appendChild(loader);
                }
            } else {
                if (existingLoader) {
                    existingLoader.remove();
                }
            }
        }

        // Enhanced Listings Functions
        async function loadListings() {
            const container = document.getElementById('activeListingsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const listings = await apiService.getListings(clubId);

                AppState.listings = listings;

                if (!listings || listings.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.8;"><p>No active listings. Create one to reach more players!</p></div>';
                    return;
                }

                container.innerHTML = listings.map(listing => `
                    <div class="card listing-card fade-in" style="border-left: 4px solid var(--accent-color);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: var(--text-main);">${listing.title}</h4>
                                <span class="status-badge" style="font-size: 0.7rem; margin-top: 0.2rem; display: inline-block;">${listing.listing_type}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small btn-secondary" onclick="editListing('${listing.id}')" title="Edit Listing">‚úèÔ∏è</button>
                                <button class="btn btn-small btn-danger" onclick="deleteListing('${listing.id}')" title="Delete Listing">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">
                            <p style="margin: 0.2rem 0;"><strong>Position:</strong> ${listing.position || 'N/A'}</p>
                            <p style="margin: 0.2rem 0;"><strong>Applicants:</strong> ${listing.application_count || 0}</p>
                        </div>
                        <button class="btn btn-primary btn-small btn-block" onclick="viewListingApplications('${listing.id}')">View Applications</button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load listings:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load listings</p>';
            } finally {
                showLoading(false);
            }
        }

        async function viewListingApplications(listingId) {
            const container = document.getElementById('applicationsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const applications = await apiService.getApplications(listingId);

                if (!applications || applications.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.8;"><p>No applications received for this listing yet.</p></div>';
                    return;
                }

                container.innerHTML = applications.map(app => `
                    <div class="application-item fade-in" data-status="${app.status}">
                        <div>
                            <h4>${app.first_name || 'Applicant'} ${app.last_name || ''}</h4>
                            <p><strong>Applied for:</strong> ${app.listing_title || 'This position'}</p>
                            <p><strong>Age:</strong> ${app.dob ? calculateAge(app.dob) : 'N/A'}</p>
                            <div class="contact-details" id="contact-${app.id}" style="${app.status === 'accepted' ? 'display: block; margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.05); border-radius: 4px;' : 'display: none;'}">
                                <p><strong>Email:</strong> ${app.email}</p>
                                <p><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
                                <p><strong>Experience:</strong> ${app.experience || 'Not provided'}</p>
                            </div>
                        </div>
                        <div class="application-actions">
                            ${app.status !== 'accepted' ? `<button class="btn btn-small btn-success" onclick="acceptApplicant('${app.id}')" title="Accept & Unlock Contact">‚≠ê Accept & Invite</button>` : ''}
                            ${app.status !== 'rejected' && app.status !== 'accepted' ? `<button class="btn btn-small btn-danger" onclick="rejectApplicant('${app.id}')" title="Reject with message">‚ùå Reject</button>` : ''}
                            <button class="btn btn-small btn-primary" onclick="viewApplicantDetails('${app.id}')">üëÅÔ∏è Details</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load applications:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load applications</p>';
            } finally {
                showLoading(false);
            }
        }

        async function acceptApplicant(applicationId) {
            if (!confirm('Accepting this applicant will reveal their contact details and send an invitation. Proceed?')) return;
            try {
                showLoading(true);
                await apiService.acceptApplicant(applicationId);
                showNotification('Applicant accepted! Contact details unlocked.', 'success');
                // Refresh applications view or state
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicationId}"])`);
                if (appItem) {
                    const contact = appItem.querySelector('.contact-details');
                    if (contact) contact.style.display = 'block';
                    appItem.setAttribute('data-status', 'accepted');
                    const btn = appItem.querySelector('.btn-success');
                    if (btn) btn.remove();
                }
            } catch (error) {
                showNotification('Action failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function rejectApplicant(applicationId) {
            const reason = prompt('Please provide a reason for rejection (this will be emailed to the candidate):');
            if (reason === null) return;

            try {
                showLoading(true);
                await apiService.rejectApplicant(applicationId, reason);
                showNotification('Applicant rejected and notified.', 'info');
                // Refresh view or state
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicationId}"])`);
                if (appItem) {
                    appItem.setAttribute('data-status', 'rejected');
                    const actions = appItem.querySelector('.application-actions');
                    if (actions) {
                        actions.querySelectorAll('.btn-success, .btn-danger').forEach(b => b.remove());
                    }
                }
            } catch (error) {
                showNotification('Action failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateListing(e) {
            if (e) e.preventDefault();
            const clubId = await getActiveClubId();
            if (!clubId) return showNotification('No club context found', 'error');

            const payload = {
                title: document.getElementById('listingTitle').value,
                listing_type: document.getElementById('listingType').value,
                position: document.getElementById('listingPosition').value,
                age_group: document.getElementById('listingAgeGroup').value,
                description: document.getElementById('listingDescription').value,
                requirements: document.getElementById('listingRequirements').value,
                clubId: clubId
            };

            try {
                showLoading(true);
                await apiService.createListing(payload);
                showNotification('Listing created successfully!', 'success');
                closeModal('createListingModal');
                loadListings();
            } catch (error) {
                showNotification('Failed to create listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function getActiveClubId() {
            if (AppState.activeClubId) return AppState.activeClubId;
            if (AppState.clubs && AppState.clubs.length > 0) return AppState.clubs[0].id;
            return null;
        }

        async function viewApplicantDetails(applicationId) {
            const content = document.getElementById('applicationDetailsContent');
            if (!content) return;

            showModal('applicationDetailsModal');
            content.innerHTML = `
                < div class="application-detail" >
                    <h4>üë§ Applicant Details</h4>
                    <p><strong>Application ID:</strong> ${applicationId}</p>
                    <p>Status: Under Review</p>
                    <hr style="margin: 1rem 0; opacity: 0.1;">
                    <p>Detailed profile information and contact details are automatically revealed once the applicant is accepted.</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="closeModal('applicationDetailsModal')">Close</button>
                    </div>
                </div>
            `;
        }

        async function shortlistApplicant(applicantId) {
            try {
                showLoading(true);
                await apiService.makeRequest(`/applications/${applicantId}/shortlist`, { method: 'POST' });
                showNotification('Applicant shortlisted!', 'success');

                // Update UI
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicantId}"])`);
                if (appItem) {
                    appItem.classList.add('shortlisted');
                    appItem.style.background = 'rgba(255, 215, 0, 0.05)';
                }
            } catch (error) {
                showNotification('Failed to shortlist: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function inviteToSession(applicantId) {
            const sessionDetails = prompt('Enter trial session details (date, time, location):');
            if (!sessionDetails) return;

            try {
                showLoading(true);
                await apiService.makeRequest(`/applications/${applicantId}/invite`, {
                    method: 'POST',
                    body: JSON.stringify({ sessionDetails })
                });
                showNotification('Invitation to trial session sent!', 'success');
            } catch (error) {
                showNotification('Failed to send invitation: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleStaffInvite(e) {
            if (e) e.preventDefault();

            const payload = {
                email: document.getElementById('staffInviteEmail').value.trim(),
                firstName: document.getElementById('staffInviteFirstName').value.trim(),
                lastName: document.getElementById('staffInviteLastName').value.trim(),
                role: document.getElementById('staffInviteRole').value,
                teamId: document.getElementById('staffInviteTeam').value || null,
                permissions: Array.from(document.querySelectorAll('input[name="staffPermissions"]:checked')).map(cb => cb.value)
            };

            try {
                showLoading(true);
                // In demo session, just simulate success
                if (localStorage.getItem('isDemoSession') === 'true') {
                    await new Promise(r => setTimeout(r, 800));
                    showNotification(`Demo: Staff invite sent to ${payload.email}`, 'success');
                } else {
                    await apiService.generateClubInvite({
                        email: payload.email,
                        firstName: payload.firstName,
                        lastName: payload.lastName,
                        clubRole: payload.role,
                        message: `You have been invited to join our staff as a ${payload.role}.`,
                        sendEmail: true
                    });
                    showNotification('Staff invitation sent successfully!', 'success');
                }
                closeModal('inviteStaffModal');
                document.getElementById('inviteStaffForm').reset();
            } catch (error) {
                console.error('Failed to invite staff:', error);
                showNotification('Failed to send invitation: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateListing(e) {
            if (e) e.preventDefault();

            const payload = {
                title: document.getElementById('listingTitle').value.trim(),
                listing_type: document.getElementById('listingType').value,
                position: document.getElementById('listingPosition').value.trim(),
                description: document.getElementById('listingDescription').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                await apiService.createListing(payload);
                showNotification('Listing created successfully!', 'success');
                closeModal('createListingModal');
                document.getElementById('createListingForm').reset();
                await loadListings();
            } catch (error) {
                console.error('Failed to create listing:', error);
                showNotification('Failed to create listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editListing(listingId) {
            const listing = AppState.listings?.find(l => l.id === listingId);
            if (!listing) return;

            document.getElementById('editListingId').value = listing.id;
            document.getElementById('editListingTitle').value = listing.title;
            document.getElementById('editListingType').value = listing.listing_type;
            document.getElementById('editListingPosition').value = listing.position || '';
            document.getElementById('editListingDescription').value = listing.description || '';

            showModal('editListingModal');
        }

        async function handleUpdateListing(e) {
            if (e) e.preventDefault();

            const listingId = document.getElementById('editListingId').value;
            const payload = {
                title: document.getElementById('editListingTitle').value.trim(),
                listing_type: document.getElementById('editListingType').value,
                position: document.getElementById('editListingPosition').value.trim(),
                description: document.getElementById('editListingDescription').value.trim()
            };

            try {
                showLoading(true);
                await apiService.updateListing(listingId, payload);
                showNotification('Listing updated successfully!', 'success');
                closeModal('editListingModal');
                await loadListings();
            } catch (error) {
                console.error('Failed to update listing:', error);
                showNotification('Failed to update listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteListing(listingId) {
            if (!confirm('Are you sure you want to delete this listing?')) return;

            try {
                showLoading(true);
                await apiService.deleteListing(listingId);
                showNotification('Listing deleted successfully!', 'success');
                await loadListings();
            } catch (error) {
                console.error('Failed to delete listing:', error);
                showNotification('Failed to delete listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editPayment(paymentId) {
            console.log('Editing payment:', paymentId);
            showNotification('Payment editing coming soon!', 'info');
        }

        async function generatePaymentLink(paymentId) {
            try {
                const response = await apiService.generatePaymentLink(paymentId);

                navigator.clipboard.writeText(response.paymentLink);
                showNotification('Payment link copied to clipboard!', 'success');

            } catch (error) {
                console.error('Failed to generate payment link:', error);
                showNotification('Failed to generate payment link: ' + error.message, 'error');
            }
        }

        async function editPlayer(playerId) {
            console.log('Editing player:', playerId);
            showNotification('Player editing coming soon!', 'info');
        }

        async function removePlayer(playerId) {
            if (confirm('Are you sure you want to remove this player?')) {
                try {
                    showLoading(true);
                    await apiService.deletePlayer(playerId);
                    showNotification('Player removed successfully!', 'success');
                    loadPlayers();
                } catch (error) {
                    console.error('Failed to remove player:', error);
                    showNotification('Failed to remove player: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }

        async function showPlayerTeamAssignment(playerId) {
            console.log('Assigning team to player:', playerId);
            showNotification('Team assignment coming soon!', 'info');
        }

        async function editTeam(teamId) {
            console.log('Editing team:', teamId);
            showNotification('Team editing coming soon!', 'info');
        }

        async function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this team?')) {
                try {
                    showLoading(true);
                    await apiService.deleteTeam(teamId);
                    showNotification('Team deleted successfully!', 'success');
                    loadTeams();
                } catch (error) {
                    console.error('Failed to delete team:', error);
                    showNotification('Failed to delete team: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }



        async function editPaymentPlan(planId) {
            const plan = AppState.paymentPlans?.find(p => p.id === planId);
            if (!plan) return;

            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanName').value = plan.name;
            document.getElementById('editPlanAmount').value = Number(plan.amount ?? plan.price ?? 0);
            document.getElementById('editPlanFrequency').value = plan.interval ?? plan.frequency ?? 'month';
            document.getElementById('editPlanDescription').value = plan.description || '';

            showModal('editPaymentPlanModal');
        }

        async function handleUpdatePaymentPlan(e) {
            if (e) e.preventDefault();

            const planId = document.getElementById('editPlanId').value;
            const name = document.getElementById('editPlanName').value.trim();
            const amount = parseFloat(document.getElementById('editPlanAmount').value);
            const interval = document.getElementById('editPlanFrequency').value;
            const description = document.getElementById('editPlanDescription').value.trim();

            if (!name || isNaN(amount)) {
                showNotification('Name and amount are required', 'error');
                return;
            }

            try {
                showLoading(true);
                await apiService.updatePaymentPlan(planId, { name, amount, frequency: interval, description });
                showNotification('Payment plan updated successfully!', 'success');
                closeModal('editPaymentPlanModal');
                await loadPaymentPlans();
                hydrateAddPlayerPlanSelect();
            } catch (error) {
                console.error('Failed to update payment plan:', error);
                showNotification('Failed to update plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deletePaymentPlan(planId) {
            if (confirm('Are you sure you want to delete this payment plan?')) {
                try {
                    showLoading(true);
                    await apiService.deletePaymentPlan(planId);
                    showNotification('Payment plan deleted successfully!', 'success');
                    loadPaymentPlans();
                } catch (error) {
                    console.error('Failed to delete payment plan:', error);
                    showNotification('Failed to delete payment plan: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }
        async function assignPaymentPlan(playerId) {
            try {
                // Load available payment plans
                const plans = await apiService.listPaymentPlans();

                if (!plans || plans.length === 0) {
                    showNotification('No payment plans available. Create a payment plan first.', 'error');
                    return;
                }

                // Remove existing modal if it exists
                const existingModal = document.getElementById('assignPlanModal');
                if (existingModal) existingModal.remove();

                // Create selection modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'assignPlanModal';

                modal.innerHTML = `
                < div class="modal-content" >
        <div class="modal-header">
          <h2>Assign Payment Plan</h2>
          <button class="close" onclick="closeModal('assignPlanModal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="selectPlan">Choose Payment Plan</label>
            <select id="selectPlan" required>
  <option value="">Select a plan...</option>
  ${plans.map(plan => {
                    const amt = Number(plan.amount ?? plan.price ?? 0).toFixed(2);
                    const intv = (plan.interval ?? plan.frequency ?? '').toString();
                    return `<option value="${plan.id}">${plan.name} - ¬£${amt}/${intv}</option>`;
                }).join('')}
</select>
          </div>
          <div class="form-group">
  <label for="planCustomPrice">Custom Price (¬£) (optional)</label>
  <input type="number" id="planCustomPrice" step="0.01" min="0" placeholder="Leave blank to use plan default">
</div>
          <div class="form-group">
            <label for="planStartDate">Start Date</label>
            <input type="date" id="planStartDate" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="confirmPlanAssignment('${playerId}')">Assign Plan</button>
            <button class="btn btn-secondary" onclick="closeModal('assignPlanModal')">Cancel</button>
          </div>
        </div>
      </div >
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('Failed to load payment plans:', error);
                showNotification('Failed to load payment plans', 'error');
            }
        }

        async function confirmPlanAssignment(playerId) {
            const planId = document.getElementById('selectPlan').value;
            const startDate = document.getElementById('planStartDate').value || new Date().toISOString().split('T')[0];
            const priceVal = (document.getElementById('planCustomPrice')?.value || '').trim();
            const customPrice = priceVal !== '' ? parseFloat(priceVal) : null;
            const clubId = AppState.activeClubId || AppState.clubs?.[0]?.id || null;

            if (!planId) {
                showNotification('Please select a payment plan', 'error');
                return;
            }

            try {
                showLoading(true);

                // Call the (now robust) API function
                await apiService.assignPlayerToPaymentPlan(playerId, planId, startDate, customPrice, clubId);

                // Optimistic local update so UI flips immediately
                const p = (AppState.players || []).find(x => String(x.id) === String(playerId));
                if (p) {
                    p.has_payment_plan = true;
                    p.payment_plan_id = planId;
                    p.plan_price = (customPrice != null ? customPrice : null);

                    const selectedPlan = (AppState.paymentPlans || []).find(pl => String(pl.id) === String(planId));
                    if (selectedPlan) p.payment_plan = selectedPlan;

                    p.payment_status = p.payment_status || 'active';
                    delete p.monthly_fee;
                }

                closeModal('assignPlanModal');
                showNotification('Payment plan assigned successfully!', 'success');

                // üîÅ Force a fresh fetch so it persists after refresh/new filters
                await loadPaymentPlans();   // ensure we have latest plans
                await loadPlayers();        // re-fetch players so server‚Äôs saved state is reflected
            } catch (error) {
                console.error('Failed to assign payment plan:', error);
                showNotification('Failed to assign payment plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        function filterPlayersByTeam() {
            const teamId = document.getElementById('teamFilter').value;
            console.log('üîç Filtering players by team:', teamId);
            // Implement team filtering logic
        }

        function filterPlayersByPayment() {
            const status = document.getElementById('paymentStatusFilter').value;
            console.log('üîç Filtering players by payment:', status);
            // Implement payment status filtering logic
        }

        function resetPlayerFilters() {
            document.getElementById('playerListFilter').value = 'all';
            document.getElementById('teamFilter').value = '';
            if (document.getElementById('sportFilter')) document.getElementById('sportFilter').value = '';
            if (document.getElementById('locationFilter')) document.getElementById('locationFilter').value = '';
            if (document.getElementById('minAgeFilter')) document.getElementById('minAgeFilter').value = '';
            if (document.getElementById('maxAgeFilter')) document.getElementById('maxAgeFilter').value = '';

            if (typeof loadPlayers === 'function') {
                loadPlayers();
            }
        }

        function exportPlayers() {
            console.log('üìä Exporting players data...');
            showNotification('Export functionality coming soon!', 'info');
        }

        // Enhanced Form Handlers
        async function handleAddPlayer(e) {
            e.preventDefault();

            const payment_plan_id = document.getElementById('playerPaymentPlan').value || null;
            const feeRaw = (document.getElementById('playerFee').value || '').trim();
            const plan_price = (payment_plan_id && feeRaw !== '' && Number.isFinite(Number(feeRaw)))
                ? Number(feeRaw)
                : null;

            const club_id = await getActiveClubId();

            const payload = {
                first_name: document.getElementById('playerFirstName').value.trim(),
                last_name: document.getElementById('playerLastName').value.trim(),
                email: (document.getElementById('playerEmail').value || '').trim() || null,
                phone: (document.getElementById('playerPhone').value || '').trim() || null,
                date_of_birth: document.getElementById('playerDOB').value,
                sport: document.getElementById('playerSport').value || null,
                gender: document.getElementById('playerGender').value || null,
                position: (document.getElementById('playerPosition').value || '').trim() || null,
                location: (document.getElementById('playerLocation').value || '').trim() || null,
                bio: (document.getElementById('playerBio').value || '').trim() || null,
                club_id,
                ...(payment_plan_id ? { payment_plan_id } : {}),
                ...(plan_price != null ? { plan_price } : {})
            };

            try {
                showLoading(true);
                await apiService.createPlayer(payload);
                showNotification('Player added successfully!', 'success');
                closeModal('addPlayerModal');
                document.getElementById('addPlayerForm').reset();
                await loadPlayers();
            } catch (error) {
                console.error('Failed to add player:', error);
                showNotification('Failed to add player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle real team creation
        async function handleAddTeam(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('teamName').value,
                ageGroup: document.getElementById('teamAgeGroup').value,
                sport: document.getElementById('teamSport').value,
                description: document.getElementById('teamDescription').value,
                clubId: AppState.clubs[0]?.id
            };

            try {
                showLoading(true);
                const response = await apiService.createTeam(formData);
                showNotification('Team created successfully!', 'success');
                closeModal('addTeamModal');
                document.getElementById('addTeamForm').reset();
                loadTeams(); // Reload teams
            } catch (error) {
                console.error('Failed to create team:', error);
                showNotification('Failed to create team: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle real event creation with capacity tracking
        async function handleAddEvent(e) {
            e.preventDefault();

            const formData = {
                title: document.getElementById('eventTitle').value,
                eventType: document.getElementById('eventType').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value,
                price: parseFloat(document.getElementById('eventPrice').value) || 0,
                capacity: parseInt(document.getElementById('eventCapacity').value) || null,
                description: document.getElementById('eventDescription').value,
                clubId: AppState.clubs[0]?.id
            };

            try {
                showLoading(true);
                const eventResult = await apiService.createEvent(formData);
                showNotification('Event created successfully!', 'success');

                // Automated notifications logic
                const shouldNotify = document.getElementById('notifyPlayers')?.checked;
                if (shouldNotify && eventResult && eventResult.id) {
                    try {
                        await apiService.sendEventNotification(eventResult.id);
                        showNotification('Notification emails sent to all players!', 'success');
                    } catch (notifyErr) {
                        console.error('Failed to send automated notification:', notifyErr);
                        showNotification('Event created, but notifications failed to send.', 'warning');
                    }
                }

                closeModal('addEventModal');
                document.getElementById('addEventForm').reset();
                loadEvents(); // Reload events
            } catch (error) {
                console.error('Failed to create event:', error);
                showNotification('Failed to create event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleClubProfileUpdate(e) {
            e.preventDefault();

            const form = e.currentTarget;

            const profileData = {
                name: form.querySelector('#clubName')?.value?.trim(),
                description: form.querySelector('#clubDescription')?.value?.trim(),
                location: form.querySelector('#clubLocation')?.value?.trim(),
                philosophy: form.querySelector('#clubPhilosophy')?.value?.trim(),
                website: form.querySelector('#clubWebsite')?.value?.trim(),
            };

            try {
                if (typeof apiService !== 'undefined' && apiService.updateClubProfile) {
                    await apiService.updateClubProfile(profileData);
                }

                showNotification('‚úÖ Club profile saved successfully!', 'success');
            } catch (err) {
                console.error('Failed to save club profile:', err);
                showNotification('‚ùå Failed to save club profile: ' + err.message, 'error');
            }
        }

        async function handleCreatePaymentPlan(e) {
            if (e) e.preventDefault();

            const name = document.getElementById('planName')?.value?.trim();
            const amount = Number(document.getElementById('planAmount')?.value);   // ‚Üê use amount
            const interval = document.getElementById('planFrequency')?.value;      // ‚Üê interval stays interval
            const description = document.getElementById('planDescription')?.value?.trim();
            const clubId = AppState.activeClubId || AppState.clubs?.[0]?.id || null;

            if (!name || !interval || !Number.isFinite(amount)) {
                showNotification('Please fill in all required fields.', 'error');
                return;
            }
            if (amount < 0.30) {
                showNotification('Minimum amount is ¬£0.30', 'error');
                return;
            }

            try {
                showLoading(true);

                const payload = { name, amount, interval, description, clubId };
                const created = await apiService.createPaymentPlan(payload);

                showNotification('Payment plan created successfully!', 'success');
                closeModal('createPaymentPlanModal');
                document.getElementById('createPaymentPlanForm')?.reset();

                if (!AppState.paymentPlans) AppState.paymentPlans = [];
                AppState.paymentPlans.push(created.plan || created);

                await loadPaymentPlans();
                hydrateAddPlayerPlanSelect();
            } catch (err) {
                console.error('Failed to create payment plan:', err);
                showNotification('Failed to create payment plan: ' + (err.message || err), 'error');
            } finally {
                showLoading(false);
            }
        }



        // Stripe Integration
        async function accessStripeAccount() {
            console.log('üí≥ Initiating Stripe dashboard access...');
            try {
                showLoading(true);
                // Try to get dynamic management link first
                const response = await apiService.getStripeManageLink();
                if (response && response.url) {
                    console.log('‚úÖ Found dynamic Stripe management link:', response.url);
                    window.open(response.url, '_blank');
                } else {
                    console.warn('‚ö†Ô∏è No dynamic link found, falling back to standard Stripe dashboard');
                    window.open('https://dashboard.stripe.com/', '_blank');
                }
            } catch (error) {
                console.error('‚ùå Failed to get dynamic Stripe link:', error);
                console.log('‚ÑπÔ∏è Falling back to standard Stripe dashboard URL');
                window.open('https://dashboard.stripe.com/', '_blank');
            } finally {
                showLoading(false);
            }
        }




        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = AppState.clubs?.[0]?.id;
                const events = await apiService.getEvents(clubId);

                if (events.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                            <p>No events created yet</p>
                            <button class="btn btn-primary" onclick="showModal('addEventModal')">Create Your First Event</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(event => `
                        <div class="card event-card">
                            <div class="card-body">
                                <h4>${event.title}</h4>
                                <p><strong>Type:</strong> ${event.event_type}</p>
                                <p><strong>Date:</strong> ${new Date(event.event_date).toLocaleDateString()}</p>
                                <p><strong>Location:</strong> ${event.location || 'TBA'}</p>
                                <div class="event-actions" style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn btn-small btn-primary" onclick="notifyEventMembers('${event.id}')">Notify Members</button>
                                    <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Edit</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteEvent('${event.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                        `).join('');

                AppState.events = events;

            } catch (error) {
                console.error('Failed to load events:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load events</p>';
            } finally {
                showLoading(false);
            }
        }

        async function notifyEventMembers(eventId) {
            if (!confirm('Send a notification to all members associated with this event?')) return;

            try {
                showLoading(true);
                const response = await apiService.sendEventNotification(eventId);
                showNotification(response.message || 'Notifications sent successfully!', 'success');
            } catch (error) {
                console.error('Failed to send event notifications:', error);
                showNotification('Failed to send notifications: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) return;

            try {
                showLoading(true);
                await apiService.deleteEvent(eventId);
                showNotification('Event deleted successfully!', 'success');
                await loadEvents();
            } catch (error) {
                console.error('Failed to delete event:', error);
                showNotification('Failed to delete event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editEvent(eventId) {
            showNotification('Event editing feature coming soon!', 'info');
        }

        // Fallback data loading
        async function loadDashboardStats() {
            try {
                const stats = AppState.clubs?.[0] ? await apiService.getAdminDashboardData() : null;

                if (stats && stats.statistics) {
                    document.getElementById('totalPlayers').textContent = stats.statistics.total_players || '0';
                    document.getElementById('totalStaff').textContent = stats.statistics.total_staff || '0';
                    document.getElementById('totalEvents').textContent = stats.statistics.total_events || '0';
                    document.getElementById('totalRevenue').textContent = `¬£${stats.statistics.monthly_revenue || 0} `;
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        // Add this function after updateDashboardStats
        function updateDashboardStats(statistics) {
            if (statistics) {
                document.getElementById('totalPlayers').textContent = statistics.total_players || '0';
                document.getElementById('totalStaff').textContent = statistics.total_staff || '0';
                document.getElementById('totalEvents').textContent = statistics.total_events || '0';
                document.getElementById('totalRevenue').textContent = `¬£${statistics.monthly_revenue || 0} `;
            }
        }

        async function loadPlayers() {
            const container = document.getElementById('playersContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();

                if (!clubId) {
                    container.innerHTML = '<p>No club found. Please create a club first.</p>';
                    return;
                }

                // Collect advanced filters
                const filters = {
                    clubId,
                    viewType: document.getElementById('playerListFilter')?.value || 'all',
                    teamId: document.getElementById('teamFilter')?.value || null,
                    sport: document.getElementById('sportFilter')?.value || null,
                    location: document.getElementById('locationFilter')?.value || null,
                    minAge: document.getElementById('minAgeFilter')?.value || null,
                    maxAge: document.getElementById('maxAgeFilter')?.value || null
                };

                const players = await apiService.getPlayers(filters);

                // üëá attach plan objects & normalize flags so hasPlan() works on reload
                const plansById = Object.fromEntries((AppState.paymentPlans || []).map(pl => [String(pl.id), pl]));

                players.forEach(p => {
                    const planId =
                        p.payment_plan_id ??
                        p.plan_id ??
                        p.payment_plan?.id ??
                        p.plan?.id;

                    if (planId != null && String(planId).trim() !== '' && String(planId) !== '0') {
                        p.payment_plan = p.payment_plan || p.plan || plansById[String(planId)] || undefined;
                        p.has_payment_plan = true; // normalize truthy flag for hasPlan()
                    }
                });

                if (!players || players.length === 0) {
                    container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                        <p>No players found</p>
                        <button class="btn btn-primary" onclick="showModal('addPlayerModal')">Add Your First Player</button>
                    </div>
                `;
                    return;
                }

                container.innerHTML = players.map(player => {
                    const hasTeamAssignment = Boolean(player.team_assignments?.length || player.team_name);
                    const hasPaymentPlan = hasPlan(player);
                    const isOverdue = (player.overdue_count || 0) > 0 || player.payment_status === 'overdue';

                    // feeHtml logic (no auto-¬£45)
                    const onPlan = hasPaymentPlan;
                    const rawFee = onPlan
                        ? (player.plan_price ?? player.payment_plan?.price ?? player.payment_plan?.amount)
                        : null;
                    const hasRawFee = onPlan && rawFee !== undefined && rawFee !== null && rawFee !== '';
                    const fee = hasRawFee ? Number(rawFee) : NaN;
                    const feeHtml = (onPlan && Number.isFinite(fee)) ? `¬£${fee.toFixed(2)} ` : '‚Äî';

                    return `
                        <div class="player-card ${isOverdue ? 'overdue' : ''} ${!hasTeamAssignment ? 'not-assigned' : ''}">
                            <div class="player-header">
                                <div class="player-info">
                                    <h4>${player.first_name} ${player.last_name}</h4>
                                    ${hasPaymentPlan
                            ? `<span class="payment-plan-badge">On Payment Plan</span>`
                            : `<span class="no-plan-badge">No Plan Set</span>`}
                                </div>
                                <div class="player-status">
                                    <span class="status-badge status-${player.payment_status || 'pending'}">
                                        ${player.payment_status || 'Pending'}
                                    </span>
                                </div>
                            </div>
                            <div class="player-meta">
                                <span><strong>Age:</strong> ${calculateAge(player.date_of_birth)} years</span>
                                <span><strong>Team:</strong> ${player.team_name || (player.team_assignments?.[0]?.team_name || 'Not assigned')}</span>
                                <span><strong>Email:</strong> ${player.email || 'No email'}</span>
                                <span><strong>Phone:</strong> ${player.phone || 'No phone'}</span>
                                <span><strong>Monthly Fee:</strong> ${feeHtml}</span>
                            </div>
                            <div class="player-actions">
                                <button class="btn btn-small btn-secondary" onclick="editPlayer('${player.id}')">Edit</button>
                                ${!hasPaymentPlan ? `<button class="btn btn-small btn-warning" onclick="assignPaymentPlan('${player.id}')">Assign Plan</button>` : ''}
                                ${!hasTeamAssignment ? `<button class="btn btn-small btn-primary" onclick="showPlayerTeamAssignment('${player.id}')">Assign Team</button>` : ''}
                                <button class="btn btn-small btn-danger" onclick="removePlayer('${player.id}')">Remove</button>
                            </div>
                        </div>
                        `;
                }).join('');

                AppState.players = players;
            } catch (error) {
                console.error('Failed to load players:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load players: ' + (error?.message || error) + '</p>';
            } finally {
                showLoading(false);
            }
        }

        async function loadTeams() {
            const container = document.getElementById('teamsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = AppState.clubs?.[0]?.id;
                const teams = await apiService.getTeams(clubId);

                if (teams.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                            <p>No teams created yet</p>
                            <button class="btn btn-primary" onclick="showModal('addTeamModal')">Create Your First Team</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = teams.map(team => `
                        <div class="team-card" onclick="openTeamManagement('${team.id}', '${team.name}')">
                            <h4>${team.name}</h4>
                            <div class="team-stats">
                                <div>
                                    <span class="team-stat-number">${team.player_count}</span>
                                    <span class="team-stat-label">Players</span>
                                </div>
                                <div>
                                    <span class="team-stat-number">${team.wins || 0}</span>
                                    <span class="team-stat-label">Wins</span>
                                </div>
                                <div>
                                    <span class="team-stat-number">${team.losses || 0}</span>
                                    <span class="team-stat-label">Losses</span>
                                </div>
                                <div>
                                    <span class="team-stat-number">${team.draws || 0}</span>
                                    <span class="team-stat-label">Draws</span>
                                </div>
                            </div>
                            <p><strong>Coach:</strong> ${team.coach_first_name ? `${team.coach_first_name} ${team.coach_last_name}` : 'No coach assigned'}</p>
                            <p><strong>Sport:</strong> ${team.sport}</p>
                            <div class="player-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-small btn-primary" onclick="openTeamManagement('${team.id}', '${team.name}')">Manage</button>
                                <button class="btn btn-small btn-secondary" onclick="editTeam('${team.id}')">Edit</button>
                                <button class="btn btn-small btn-danger" onclick="deleteTeam('${team.id}')">Delete</button>
                            </div>
                        </div>
                        `).join('');

                AppState.teams = teams;

            } catch (error) {
                console.error('Failed to load teams:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load teams</p>';
            } finally {
                showLoading(false);
            }
        }

        // Club Gallery Functions
        async function handlePictureUpload(input) {
            if (!input.files || input.files.length === 0) return;

            const files = Array.from(input.files);
            const clubId = await getActiveClubId();

            if (!clubId) {
                showNotification('No active organization/club found. Please select or create one first.', 'error');
                input.value = '';
                return;
            }

            // Get current images to check limit
            const currentSection = document.getElementById('uploadedPictures');
            const currentImagesCount = currentSection.querySelectorAll('.gallery-item').length;

            if (currentImagesCount + files.length > 5) {
                showNotification(`Maximum 5 images allowed. You already have ${currentImagesCount}.`, 'error');
                input.value = '';
                return;
            }

            try {
                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                for (const file of files) {
                    try {
                        const result = await apiService.uploadClubImage(clubId, file);
                        if (result.images) {
                            displayClubImages(result.images);
                        }
                        successCount++;
                    } catch (err) {
                        console.error('File upload failed:', file.name, err);
                        failCount++;
                    }
                }

                if (successCount > 0) {
                    showNotification(`${successCount} image(s) uploaded successfully!`, 'success');
                }
                if (failCount > 0) {
                    showNotification(`${failCount} image(s) failed to upload.`, 'error');
                }

                // Final refresh to be sure
                await loadClubProfileImages();

            } catch (error) {
                console.error('Upload process failed:', error);
                showNotification('Upload failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
                input.value = ''; // Reset input
            }
        }

        function displayClubImages(images) {
            const container = document.getElementById('uploadedPictures');
            if (!container) return;

            if (!images || images.length === 0) {
                container.innerHTML = '<p style="opacity:0.6; font-style:italic;">No images uploaded yet.</p>';
                return;
            }

            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
            container.style.gap = '15px';
            container.style.marginTop = '15px';

            container.innerHTML = images.map(imgUrl => `
                <div class="gallery-item" style="position: relative; width: 100%; aspect-ratio: 1/1; overflow: visible;">
                    <img src="${imgUrl}" style="height: 100%; width: 100%; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color, #444);">
                    <button onclick="deleteClubImage('${imgUrl}')" style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 5;">&times;</button>
                </div>
            `).join('');
        }

        async function deleteClubImage(imgUrl) {
            if (!confirm('Delete this image?')) return;

            const clubId = await getActiveClubId();
            try {
                showLoading(true);
                const result = await apiService.deleteClubImage(clubId, imgUrl);
                showNotification('Image deleted', 'success');
                displayClubImages(result.images);
            } catch (e) {
                showNotification('Failed to delete: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadClubProfileImages() {
            const clubId = await getActiveClubId();
            try {
                const clubs = await apiService.getAdminDashboardData(); // or simpler endpoint?
                // Actually dashboard data has clubs.
                // Or verify current club
                // Use the latest clubs data from dashboard
                const activeClubId = await getActiveClubId();
                const dashboardData = await apiService.getAdminDashboardData();
                const club = dashboardData.clubs?.find(c => c.id == activeClubId);
                if (club && club.images) {
                    displayClubImages(club.images);
                }
            } catch (e) {
                console.warn('Failed to load images', e);
            }
        }

        // Expose new functions
        window.deleteClubImage = deleteClubImage;



        function calculateAge(dob) {
            if (!dob) return 'N/A';
            const birth = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function hasPlan(player) {
            const flag = player?.has_payment_plan;
            const flagTrue =
                flag === true ||
                flag === 1 ||
                flag === '1' ||
                (typeof flag === 'string' && flag.toLowerCase() === 'true');

            const id =
                player?.payment_plan_id ??
                player?.plan_id ??
                player?.payment_plan?.id ??
                player?.plan?.id;

            const hasId = id != null && String(id).trim() !== '' && String(id) !== '0';
            const hasObj = !!player?.payment_plan || !!player?.plan;

            return flagTrue || hasId || hasObj;
        }

        // Utility Functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';

                // Focus first input
                const firstInput = modal.querySelector('input[type="email"], input[type="text"]');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';

                // Clear form if it exists
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#007bff'
            };

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: ${colors[type] || colors.info};
                        color: white;
                        padding: 16px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        font-size: 14px;
                        z-index: 10000;
                        max-width: 400px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                        transform: translateX(100%);
                        transition: transform 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        `;

            notification.innerHTML = `
                        <span>${icons[type] || icons.info}</span>
                        <span>${message}</span>
                        <button onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    margin-left: auto;
                    padding: 0;
                    opacity: 0.8;
                ">√ó</button>
                        `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Auto remove
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // Enhanced showSection function
        function showSection(sectionId) {
            console.log('üìç Switching to section:', sectionId);

            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(section => section.classList.remove('active'));

            const navButtons = document.querySelectorAll('.dashboard-nav button');
            navButtons.forEach(button => button.classList.remove('active'));

            const targetSection = document.getElementById(sectionId);
            if (targetSection) targetSection.classList.add('active');

            // Set active button
            const clickedButton = document.querySelector(`.dashboard-nav button[onclick*="${sectionId}"]`);
            if (clickedButton) clickedButton.classList.add('active');

            // Handle data loading for specific sections
            switch (sectionId) {
                case 'overview':
                    if (typeof loadDashboardStats === 'function') loadDashboardStats();
                    break;
                case 'players':
                    if (typeof loadPlayers === 'function') loadPlayers();
                    break;
                case 'teams':
                    if (typeof loadTeams === 'function') loadTeams();
                    break;
                case 'events':
                    if (typeof loadEvents === 'function') loadEvents();
                    break;
                case 'club-profile':
                    if (typeof loadClubProfile === 'function') loadClubProfile();
                    if (typeof loadClubProfileImages === 'function') loadClubProfileImages();
                    break;
                case 'finances':
                    if (typeof loadFinances === 'function') loadFinances();
                    if (typeof loadPaymentPlans === 'function') loadPaymentPlans();
                    break;
                case 'item-shop':
                    if (typeof loadProducts === 'function') loadProducts();
                    break;
                case 'marketing-hub':
                    if (typeof loadCampaigns === 'function') loadCampaigns();
                    break;
                case 'polls-section':
                    if (typeof loadPolls === 'function') loadPolls();
                    break;
            }
        }

        // Make functions globally available
        window.showSection = showSection;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.showNotification = showNotification;
        window.openTeamManagement = openTeamManagement;
        window.showTeamTab = showTeamTab;
        window.generateStaffInvite = generateStaffInvite;
        window.shortlistApplicant = shortlistApplicant;
        window.viewApplicantDetails = viewApplicantDetails;
        window.inviteToSession = inviteToSession;
        window.rejectApplicant = rejectApplicant;
        window.accessStripeAccount = accessStripeAccount;
        window.handlePictureUpload = handlePictureUpload;
        window.filterPlayersByView = filterPlayersByView;
        window.filterPlayersByTeam = filterPlayersByTeam;
        window.filterPlayersByPayment = filterPlayersByPayment;
        window.resetPlayerFilters = resetPlayerFilters;
        window.exportPlayers = exportPlayers;
        window.logout = logout;
        window.loadListings = loadListings;
        window.viewListingApplications = viewListingApplications;
        window.removePlayer = removePlayer;
        window.editPlayer = editPlayer;
        window.assignPaymentPlan = assignPaymentPlan;
        window.showPlayerTeamAssignment = showPlayerTeamAssignment;
        window.editTeam = editTeam;
        window.deleteTeam = deleteTeam;
        window.loadProducts = loadProducts;
        window.loadCampaigns = loadCampaigns;
        window.sendCampaign = sendCampaign;
        window.editProduct = editProduct;

        // Team Management Functions
        let currentTeamId = null;

        async function openTeamManagement(teamId, teamName) {
            currentTeamId = teamId;
            document.getElementById('teamDetailName').textContent = teamName;

            showSection('team-details');
            await loadTeamDetails(teamId);
        }

        async function loadTeamDetails(teamId) {
            try {
                showLoading(true);
                // We reuse getTeams but maybe we need a specific getTeamDetails endpoint?
                // For now, let's assume we fetch the full team object or find it in AppState
                // But typically we want fresh data including roster.
                // Using existing /api/teams/:id endpoint (lines 139 in backend)

                const team = await apiService.makeRequest(`/teams/${teamId}`);
                console.log('Team Details Loaded:', team);

                // Populate Stats
                const statsContainer = document.getElementById('teamDetailStats');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <span class="status-badge" style="background:#4caf50; color:white;">${team.wins || 0} Wins</span>
                        <span class="status-badge" style="background:#f44336; color:white;">${team.losses || 0} Losses</span>
                        <span class="status-badge" style="background:#ff9800; color:white;">${team.draws || 0} Draws</span>
                    `;
                }

                // Populate Roster
                renderRoster(team.players || []);

                // Populate Events (if returned, or fetch separately)
                // Backend returns upcoming_events
                renderTeamEvents(team.upcoming_events || []);

                // Initialize Availability (Placeholder for now)

            } catch (error) {
                console.error('Failed to load team details:', error);
                showNotification('Failed to load team details', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderRoster(players) {
            const tbody = document.getElementById('teamRosterBody');
            if (!tbody) return;

            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">No players in this team yet.</td></tr>';
                return;
            }

            tbody.innerHTML = players.map(p => `
                <tr>
                    <td>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:bold;">${p.first_name} ${p.last_name}</span>
                            <span style="font-size:0.8rem; opacity:0.7;">#${p.jersey_number || '-'}</span>
                        </div>
                    </td>
                    <td>${p.team_position || p.position || '-'}</td>
                    <td>${calculateAge(p.date_of_birth)}</td>
                    <td>
                        <span class="status-badge status-${p.payment_status || 'pending'}">
                            ${p.payment_status || 'Active'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="removePlayerFromTeam('${p.id}', '${currentTeamId}')">
                            ‚ùå Remove
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTeamEvents(events) {
            const container = document.getElementById('teamEventsContainer');
            if (!container) return;

            if (events.length === 0) {
                container.innerHTML = '<p style="padding:1rem;">No upcoming events scheduled.</p>';
                return;
            }

            container.innerHTML = events.map(e => `
                <div class="card event-card" style="border-left: 4px solid var(--accent-color);">
                    <h4>${e.title}</h4>
                    <p>üìÖ ${new Date(e.event_date).toLocaleDateString()} at ${e.event_time}</p>
                    <p>üìç ${e.location || 'TBA'}</p>
                    <button class="btn btn-small btn-secondary_outline" onclick="viewEventAvailability('${e.id}')">View Availability</button>
                </div>
            `).join('');
        }

        // Feature: Switch Tabs
        window.switchTeamTab = function (tabName) {
            document.querySelectorAll('.team-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            document.getElementById(`team-tab-${tabName}`).style.display = 'block';

            // Find the button (hacky way or add IDs to buttons)
            const buttons = document.querySelectorAll('.tab-btn');
            // assuming text content matches or order matches... 
            // Better: update the onclicks to pass 'this'
            if (tabName === 'roster') buttons[0].classList.add('active');
            if (tabName === 'events') buttons[1].classList.add('active');
            if (tabName === 'availability') buttons[2].classList.add('active');
        };

        // Feature: Remove Player from Team (Fixing the reported broken X)
        async function removePlayerFromTeam(playerId, teamId) {
            if (!confirm('Are you sure you want to remove this player from the team roster?')) return;

            try {
                showLoading(true);
                // Call the new backend endpoint we verified
                await apiService.makeRequest(`/teams/${teamId}/players/${playerId}`, {
                    method: 'DELETE'
                });

                showNotification('Player removed from team', 'success');
                // Refresh data
                await loadTeamDetails(teamId);
            } catch (error) {
                console.error('Failed to remove player from team:', error);
                showNotification('Failed to remove player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }


        async function loadTeamAvailability(teamId) {
            try {
                const data = await apiService.makeRequest(`/teams/${teamId}/availability`);
                renderAvailabilityGrid(data);
            } catch (error) {
                console.error('Failed to load availability:', error);
                document.getElementById('availabilityGrid').innerHTML = '<p style="color:red">Failed to load availability data</p>';
            }
        }

        function renderAvailabilityGrid(data) {
            const container = document.getElementById('availabilityGrid');
            if (!container) return;

            const { events, players, responses } = data;

            if (events.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No upcoming events found.</p>';
                return;
            }

            // Create Grid Table
            let html = `
                <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #444; position: sticky; left: 0; background: var(--bg-secondary); z-index: 2;">Player</th>
                            ${events.map(e => `
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #444; min-width: 80px;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">${new Date(e.event_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.6;">${e.event_time ? e.event_time.slice(0, 5) : ''}</div>
                                    <div style="font-size: 1.2rem;" title="${e.title}">
                                        ${e.event_type === 'match' ? '‚öΩ' : e.event_type === 'training' ? 'üèãÔ∏è' : 'üìÖ'}
                                    </div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            players.forEach(player => {
                html += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #444; position: sticky; left: 0; background: var(--bg-secondary); z-index: 1;">
                            <div style="font-weight: 500;">${player.first_name} ${player.last_name}</div>
                            <div style="font-size: 0.7rem; opacity: 0.6;">#${player.jersey_number || '-'}</div>
                        </td>
                        ${events.map(event => {
                    const response = responses.find(r => r.event_id === event.id && r.player_id === player.id);
                    const status = response ? response.availability : 'none';
                    const icon = {
                        'yes': '‚úÖ',
                        'no': '‚ùå',
                        'maybe': '‚ùì',
                        'none': '‚ö™'
                    }[status];

                    return `
                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #444; cursor: pointer; border-left: 1px solid #444;" 
                                    onclick="toggleAvailability('${event.id}', '${player.id}', '${status}')"
                                    title="${response?.notes || status}">
                                    <span style="font-size: 1.2rem;">${icon}</span>
                                </td>
                            `;
                }).join('')}
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function toggleAvailability(eventId, playerId, currentStatus) {
            // Admin override logic (simple cycle: yes -> no -> maybe -> none)
            // Ideally should be a modal, but cycling is faster for admin
            const newStatus = {
                'yes': 'no',
                'no': 'maybe',
                'maybe': 'yes', // Skip 'none' for override, keep people accounted for? Or maybe -> yes
                'none': 'yes'
            }[currentStatus] || 'yes';

            // For now, we only have player-facing endpoint. 
            // We probably need an Admin Override endpoint in Backend.
            // Using placeholder logic since we didn't add the POST override endpoint yet.
            console.log(`Toggling availability for P:${playerId} E:${eventId} to ${newStatus}`);
            showNotification('Admin override coming soon', 'info');
        }

        async function viewEventAvailability(eventId) {
            switchTeamTab('availability');
        }

        window.handleRecordResult = handleRecordResult;
        window.setAdminFormation = setAdminFormation;
        window.clearAdminBoard = clearAdminBoard;
        window.saveAdminFormation = saveAdminFormation;
        window.assignPlayerToBoard = assignPlayerToBoard;

        // Dashboard section switching

        // Close modal when clicking outside
        window.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        console.log('‚úÖ Admin Dashboard Ready!');

        // Dynamic Sport Fields Logic
        function initAddPlayerModalControls() {
            const sportSelect = document.getElementById('playerSport');
            if (sportSelect) {
                sportSelect.addEventListener('change', updatePositionPlaceholder);
            }
        }

        function updatePositionPlaceholder() {
            const sport = document.getElementById('playerSport').value;
            const posInput = document.getElementById('playerPosition');
            if (!posInput) return;

            const placeholders = {
                'Football': 'e.g., Striker, Goalkeeper, Midfielder',
                'Basketball': 'e.g., Point Guard, Center',
                'Rugby': 'e.g., Fly Half, Prop',
                'Cricket': 'e.g., Bowler, Wicket Keeper',
                'Tennis': 'e.g., Right-Handed',
                'Hockey': 'e.g., Forward, Goalie',
                'Volleyball': 'e.g., Setter, Libero'
            };

            posInput.placeholder = placeholders[sport] || 'e.g., Position';
        }

        // Initialize controls once script runs (or add to DOMContentLoaded if needed, but this works if elements exist)
        // Ideally should be in DOMContentLoaded, but we can just call it here as well if script is at end of body
        setTimeout(initAddPlayerModalControls, 1000);

        // Team Player Management
        async function openAddTeamPlayerModal() {
            showModal('addTeamPlayerModal');
            document.getElementById('teamPlayerSearchResults').innerHTML = '';
            document.getElementById('teamPlayerSearch').value = '';
            // Load available players immediately
            searchTeamPlayers();
        }

        async function searchTeamPlayers() {
            const query = document.getElementById('teamPlayerSearch').value.toLowerCase();
            const container = document.getElementById('teamPlayerSearchResults');
            container.innerHTML = '<p>Searching...</p>';

            try {
                // Fetch all club players (filtered)
                const players = await apiService.getClubPlayers(AppState.activeClubId || (AppState.clubs && AppState.clubs[0] ? AppState.clubs[0].id : null));

                // Fetch current team roster to filter out
                // Using global currentTeamId set in openTeamManagement
                if (!currentTeamId) {
                    console.error('No current team ID');
                    return;
                }

                // Ideally we should cache team data or fetch just the roster IDs to be efficient
                // For now, let's just make a quick request or rely on what we might have in memory if we stored it in loadTeamDetails
                const teamData = await apiService.makeRequest(`/teams/${currentTeamId}`);
                const teamPlayerIds = new Set((teamData.players || []).map(p => p.id));

                const available = players.filter(p => !teamPlayerIds.has(p.id) &&
                    (p.first_name.toLowerCase().includes(query) || p.last_name.toLowerCase().includes(query) || p.email.toLowerCase().includes(query))
                );

                if (available.length === 0) {
                    container.innerHTML = '<p style="opacity:0.7;">No matching players found available.</p>';
                    return;
                }

                container.innerHTML = available.map(p => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #444;">
                        <div>
                            <div style="font-weight: bold;">${p.first_name} ${p.last_name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">${p.email}</div>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="addExistingPlayerToTeam('${p.id}')">Add</button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Search failed:', error);
                container.innerHTML = '<p style="color: red;">Search failed</p>';
            }
        }

        async function addExistingPlayerToTeam(playerId) {
            const position = prompt("Enter Position (optional):") || "";
            const number = prompt("Enter Jersey Number (optional):") || "";

            try {
                showLoading(true);
                await apiService.makeRequest(`/teams/${currentTeamId}/players`, {
                    method: 'POST',
                    body: JSON.stringify({ playerId, position, jerseyNumber: number ? parseInt(number) : null })
                });
                showNotification('Player added to team!', 'success');
                closeModal('addTeamPlayerModal');
                loadTeamDetails(currentTeamId); // Refresh
            } catch (error) {
                showNotification('Failed to add player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle Quick Add Form
        const addTeamPlayerForm = document.getElementById('addTeamPlayerForm');
        if (addTeamPlayerForm) {
            addTeamPlayerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentTeamId) return;

                const email = document.getElementById('newTeamPlayerEmail').value;
                const position = document.getElementById('newTeamPlayerPosition').value;
                const number = document.getElementById('newTeamPlayerNumber').value;

                try {
                    showLoading(true);
                    await apiService.makeRequest(`/teams/${currentTeamId}/players`, {
                        method: 'POST',
                        body: JSON.stringify({ playerEmail: email, position, jerseyNumber: number ? parseInt(number) : null })
                    });
                    showNotification('Player added/invited to team!', 'success');
                    closeModal('addTeamPlayerModal');
                    loadTeamDetails(currentTeamId); // Refresh
                } catch (error) {
                    showNotification('Failed to add player: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
        }

        window.openAddTeamPlayerModal = openAddTeamPlayerModal;
        window.searchTeamPlayers = searchTeamPlayers;
        window.addExistingPlayerToTeam = addExistingPlayerToTeam;

        // Payment Plans & Stripe Logic
        async function accessStripeAccount() {
            try {
                showLoading(true);
                const result = await apiService.getStripeManageLink();
                if (result && result.url) {
                    window.open(result.url, '_blank');
                } else {
                    showNotification('Could not generate Stripe Dashboard link', 'error');
                }
            } catch (error) {
                console.error('Access Stripe error:', error);
                showNotification('Failed to access Stripe: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreatePaymentPlan(e) {
            e.preventDefault();
            const name = document.getElementById('planName').value;
            const amount = document.getElementById('planAmount').value;
            const interval = document.getElementById('planInterval').value;
            const description = document.getElementById('planDescription').value;

            try {
                showLoading(true);
                await apiService.createPaymentPlan({
                    name,
                    amount,
                    interval,
                    description,
                    clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
                });
                showNotification('Payment Plan created successfully!', 'success');
                closeModal('createPaymentPlanModal');
                document.getElementById('createPaymentPlanForm').reset();
                loadPaymentPlans(); // Refresh list
            } catch (error) {
                console.error('Create Plan Error:', error);
                showNotification('Failed to create plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editPaymentPlan(planId) {
            console.log('Editing plan:', planId);
            // Implement edit modal later if needed
            showNotification('Plan editing coming soon', 'info');
        }

        async function deletePaymentPlan(planId) {
            if (!confirm('Are you sure you want to delete this payment plan?')) return;
            try {
                showLoading(true);
                await apiService.deletePaymentPlan(planId);
                showNotification('Payment plan deleted', 'success');
                loadPaymentPlans();
            } catch (error) {
                showNotification('Failed to delete plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Wire up listener
        const createPlanForm = document.getElementById('createPaymentPlanForm');
        if (createPlanForm) {
            createPlanForm.addEventListener('submit', handleCreatePaymentPlan);
        }

        window.accessStripeAccount = accessStripeAccount;
        window.handleCreatePaymentPlan = handleCreatePaymentPlan;
        window.editPaymentPlan = editPaymentPlan;
        window.deletePaymentPlan = deletePaymentPlan;


        // Shop & Event Custom Logic
        function handleEventTypeChange() {
            const type = document.getElementById('eventType').value;
            const opponentGroup = document.getElementById('eventOpponentGroup');
            if (type === 'match') {
                opponentGroup.style.display = 'block';
                document.getElementById('eventOpponent').setAttribute('required', 'true');
            } else {
                opponentGroup.style.display = 'none';
                document.getElementById('eventOpponent').removeAttribute('required');
                document.getElementById('eventOpponent').value = '';
            }
        }

        function addCustomFieldInput() {
            const container = document.getElementById('productCustomFieldsList');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'custom-field-row';
            div.style.marginBottom = '0.5rem';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '2fr 1fr auto';
            div.style.gap = '0.5rem';
            div.innerHTML = `
                <input type="text" class="field-label" placeholder="Question Label (e.g. Size)" required>
                <select class="field-type">
                    <option value="text">Text</option>
                    <option value="select">Selection</option>
                    <option value="number">Number</option>
                </select>
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">X</button>
                <input type="text" class="field-options" placeholder="Options if selection (comma separated: S,M,L)" style="grid-column: 1 / -1; display: none;">
            `;

            // Show options input if 'select' is chosen
            const typeSelect = div.querySelector('.field-type');
            const optionsInput = div.querySelector('.field-options');
            typeSelect.onchange = () => {
                optionsInput.style.display = typeSelect.value === 'select' ? 'block' : 'none';
                if (typeSelect.value === 'select') optionsInput.setAttribute('required', 'true');
                else optionsInput.removeAttribute('required');
            };

            container.appendChild(div);
        }

        async function handleAddProduct(e) {
            e.preventDefault();

            // Collect Custom Fields
            const customFields = [];
            document.querySelectorAll('#productCustomFieldsList .custom-field-row').forEach(row => {
                const label = row.querySelector('.field-label').value;
                const type = row.querySelector('.field-type').value;
                const options = row.querySelector('.field-options').value;

                if (label) {
                    customFields.push({
                        label,
                        type,
                        options: type === 'select' ? options.split(',').map(s => s.trim()) : null
                    });
                }
            });

            const payload = {
                name: document.getElementById('productName').value,
                price: document.getElementById('productPrice').value,
                stock_quantity: document.getElementById('productStock').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                custom_fields: customFields,
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                // Call API (assumed existing or generic)
                await apiService.makeRequest('/products', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showNotification('Product created successfully!', 'success');
                closeModal('addProductModal');
                // Refresh shop
                if (window.loadShopProducts) window.loadShopProducts();
                else showNotification('Refresh to see new product.', 'info');
            } catch (error) {
                console.error('Create product error:', error);
                showNotification('Failed to create product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateEvent(e) {
            e.preventDefault();

            const payload = {
                title: document.getElementById('eventTitle').value,
                event_type: document.getElementById('eventType').value,
                event_date: document.getElementById('eventDate').value,
                event_time: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value,
                latitude: document.getElementById('eventLat').value || null,
                longitude: document.getElementById('eventLng').value || null,
                description: document.getElementById('eventDescription').value,
                team_id: document.getElementById('eventTeam').value || null,
                opponent: document.getElementById('eventOpponent').value || null,
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                await apiService.createEvent(payload);
                showNotification('Event created successfully!', 'success');
                closeModal('addEventModal');
                if (window.loadEvents) window.loadEvents();
            } catch (error) {
                console.error('Create event error:', error);
                showNotification('Failed to create event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Wire up listeners
        window.handleEventTypeChange = handleEventTypeChange;
        window.addCustomFieldInput = addCustomFieldInput;
        window.handleAddProduct = handleAddProduct;

        const addProdForm = document.getElementById('addProductForm');
        if (addProdForm) addProdForm.addEventListener('submit', handleAddProduct);

        const createEventForm = document.getElementById('createEventForm');
        if (createEventForm) createEventForm.addEventListener('submit', handleCreateEvent);
    </script>

    <!-- Assign Payment Plan Modal -->
    <div id="assignPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Assign Payment Plan</h2>
                <button class="close" onclick="closeModal('assignPlanModal')">&times;</button>
            </div>
            <form id="assignPlanForm">
                <input type="hidden" id="assignPlanUserId">
                <div class="form-group">
                    <label for="assignPlanSelect">Select Plan</label>
                    <select id="assignPlanSelect" required class="form-control">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignPlanStartDate">Start Date</label>
                    <input type="date" id="assignPlanStartDate" class="form-control" required>
                    <script>
                        document.getElementById('assignPlanStartDate').value = new Date().toISOString().split('T')[0];
                    </script>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('assignPlanModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Plan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Team Player Modal -->
    <div id="addTeamPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Add Player to Team</h2>
                <button class="close" onclick="closeModal('addTeamPlayerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Option 1: Existing Player -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3>Find Existing Player</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Search for a player in your club
                        who isn't in this team yet.</p>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="teamPlayerSearch" placeholder="Search by name or email..."
                            style="flex:1;">
                        <button class="btn btn-primary" onclick="searchTeamPlayers()">Search</button>
                    </div>
                    <div id="teamPlayerSearchResults" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                        <!-- Results -->
                    </div>
                </div>

                <!-- Option 2: Quick Invite -->
                <div class="card">
                    <h3>Or Quick Add New Player</h3>
                    <form id="addTeamPlayerForm">
                        <div class="form-group">
                            <label for="newTeamPlayerEmail">Email Address</label>
                            <input type="email" id="newTeamPlayerEmail" placeholder="Player's email" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="newTeamPlayerPosition">Position</label>
                                <input type="text" id="newTeamPlayerPosition" placeholder="e.g. Striker">
                            </div>
                            <div class="form-group">
                                <label for="newTeamPlayerNumber">Jersey Number</label>
                                <input type="number" id="newTeamPlayerNumber" min="0" max="99">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-secondary">Add to Roster</button>
                    </form>
                </div>
            </div>
        </div>
        <!-- Create Payment Plan Modal -->
        <div id="createPaymentPlanModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Create Payment Plan</h2>
                    <button class="close" onclick="closeModal('createPaymentPlanModal')">&times;</button>
                </div>
                <form id="createPaymentPlanForm">
                    <div class="form-group">
                        <label for="planName">Plan Name *</label>
                        <input type="text" id="planName" required placeholder="e.g. Annual Membership 2025">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="planAmount">Amount (¬£) *</label>
                            <input type="number" id="planAmount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="planInterval">Billing Frequency *</label>
                            <select id="planInterval" required>
                                <option value="month">Monthly</option>
                                <option value="year">Yearly</option>
                                <option value="week">Weekly</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="planDescription">Description</label>
                        <textarea id="planDescription" rows="3" placeholder="What does this plan cover?"></textarea>
                    </div>
                    <!-- Future: Plan benefits / duration -->
                    <button type="submit" class="btn btn-primary">üíæ Create Plan</button>
                </form>
            </div>
        </div>
        <!-- Add Product Modal with Custom Fields -->
        <div id="addProductModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Add Shop Product</h2>
                    <button class="close" onclick="closeModal('addProductModal')">&times;</button>
                </div>
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" required placeholder="e.g. Club Training Kit">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="productPrice">Price (¬£)</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Quantity</label>
                            <input type="number" id="productStock" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <select id="productCategory">
                            <option value="apparel">Apparel</option>
                            <option value="equipment">Equipment</option>
                            <option value="accessory">Accessory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="2"></textarea>
                    </div>

                    <!-- Custom Fields Builder -->
                    <div class="form-group" style="border: 1px solid #333; padding: 1rem; border-radius: 8px;">
                        <label style="margin-bottom: 0.5rem; display: block;">Customization Fields (e.g. Size,
                            Initials)</label>
                        <div id="productCustomFieldsList">
                            <!-- Dynamic fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addCustomFieldInput()"
                            style="margin-top: 0.5rem;">+ Add Field</button>
                        <p style="font-size: 0.8rem; color: #aaa; margin-top: 0.5rem;">These are questions players must
                            answer when buying.</p>
                    </div>

                    <div class="form-group">
                        <label>Product Image</label>
                        <input type="file" id="productImageFile" accept="image/*">
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Save Product</button>
                </form>
            </div>
        </div>

        <!-- Create Event Modal with Dynamic Type Logic -->
        <div id="addEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÖ Create New Event</h2>
                    <button class="close" onclick="closeModal('addEventModal')">&times;</button>
                </div>
                <form id="createEventForm">
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" required placeholder="e.g. Weekly Training">
                    </div>
                    <div class="form-group">
                        <label for="eventType">Event Type</label>
                        <select id="eventType" required onchange="handleEventTypeChange()">
                            <option value="training">Training Session</option>
                            <option value="match">Match / Game</option>
                            <option value="tournament">Tournament</option>
                            <option value="camp">Camp</option>
                            <option value="social">Social Event</option>
                            <option value="talent-id">Talent ID / Trial</option>
                        </select>
                    </div>

                    <!-- Dynamic Field: Opponent (Match only) -->
                    <div class="form-group" id="eventOpponentGroup" style="display: none;">
                        <label for="eventOpponent">Opponent Name</label>
                        <input type="text" id="eventOpponent" placeholder="e.g. Manchester City U15">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventTime">Time</label>
                            <input type="time" id="eventTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="eventLocation">Location Name</label>
                        <input type="text" id="eventLocation" required placeholder="e.g. Training Ground Pitch 1">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="eventLat">Latitude (for Geofencing)</label>
                            <input type="number" id="eventLat" step="any" placeholder="e.g. 51.5074">
                        </div>
                        <div class="form-group">
                            <label for="eventLng">Longitude (for Geofencing)</label>
                            <input type="number" id="eventLng" step="any" placeholder="e.g. -0.1278">
                        </div>
                    </div>

                    <!-- Dynamic Field: Team Selection -->
                    <div class="form-group">
                        <label for="eventTeam">Assign to Team</label>
                        <select id="eventTeam">
                            <option value="">All Club (No Specific Team)</option>
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eventDescription">Description / Notes</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">üìÖ Create Event</button>
                </form>
            </div>
        </div>
        <script>
            // Tournament Logic
            async function loadTournamentDashboard(eventId) {
                if (!eventId) return;
                try {
                    const data = await apiService.makeRequest(`/tournaments/${eventId}/dashboard`);
                    const teamsList = document.getElementById('tournamentTeamsList');
                    const matchesList = document.getElementById('tournamentMatchesList');

                    // Render Teams
                    teamsList.innerHTML = data.teams.map(t => `
                <div class="item-list-item">
                    <div class="item-info">
                        <h4>${t.team_name}</h4>
                        <p>${t.contact_email}</p>
                    </div>
                    <button class="btn btn-small ${t.status === 'checked_in' ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="toggleTeamCheckIn('${t.id}', '${t.status}')">
                        ${t.status === 'checked_in' ? 'Checked In' : 'Check In'}
                    </button>
                </div>
            `).join('');

                    // Render Matches
                    matchesList.innerHTML = data.matches.map(m => {
                        const homeName = data.teams.find(t => t.id === m.home_team_id)?.team_name || 'TBD';
                        const awayName = data.teams.find(t => t.id === m.away_team_id)?.team_name || 'TBD';
                        return `
                <div class="item-list-item" style="border-left: 4px solid ${m.status === 'completed' ? '#4caf50' : '#ffa000'};">
                    <div class="item-info">
                        <h4>${homeName} vs ${awayName}</h4>
                        <p>${m.stage_id ? 'Stage Match' : 'Match'}</p>
                    </div>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <input type="number" style="width:50px; padding:4px;" value="${m.home_score}" id="score_home_${m.id}">
                        <span>-</span>
                        <input type="number" style="width:50px; padding:4px;" value="${m.away_score}" id="score_away_${m.id}">
                        <button class="btn btn-small btn-primary" onclick="updateMatchResult('${m.id}')">Save</button>
                    </div>
                </div>
            `}).join('');

                } catch (err) {
                    console.error(err);
                }
            }

            async function toggleTeamCheckIn(teamId, currentStatus) {
                const newStatus = currentStatus === 'checked_in' ? 'approved' : 'checked_in';
                await apiService.makeRequest(`/tournaments/teams/${teamId}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status: newStatus })
                });
                loadTournamentDashboard(document.getElementById('tournamentSelect').value);
            }

            async function generateFixtures(type) {
                const eventId = document.getElementById('tournamentSelect').value;
                if (!eventId) return;
                if (!confirm(`Generate ${type} fixtures? This cannot be undone.`)) return;

                await apiService.makeRequest(`/tournaments/${eventId}/generate-fixtures`, {
                    method: 'POST',
                    body: JSON.stringify({ type })
                });
                loadTournamentDashboard(eventId);
            }

            async function updateMatchResult(matchId) {
                const home = document.getElementById(`score_home_${matchId}`).value;
                const away = document.getElementById(`score_away_${matchId}`).value;
                await apiService.makeRequest(`/tournaments/matches/${matchId}/result`, {
                    method: 'POST',
                    body: JSON.stringify({ homeScore: home, awayScore: away })
                });
                loadTournamentDashboard(document.getElementById('tournamentSelect').value);
            }

            // ========================================
            // PLAYER FILTERS - WIRED UP ‚úÖ
            // ========================================
            async function loadPlayers() {
                try {
                    const filter = document.getElementById('playerListFilter')?.value || 'all';
                    const teamFilter = document.getElementById('teamFilter')?.value || '';
                    const sportFilter = document.getElementById('sportFilter')?.value || '';
                    const locationFilter = document.getElementById('locationFilter')?.value || '';
                    const minAge = document.getElementById('minAgeFilter')?.value || '';
                    const maxAge = document.getElementById('maxAgeFilter')?.value || '';

                    const context = await apiService.getContext();
                    const clubId = context?.currentOrganization?.id;

                    // Build query string
                    let queryParams = `clubId=${clubId}`;
                    if (sportFilter) queryParams += `&sport=${sportFilter}`;
                    if (locationFilter) queryParams += `&location=${locationFilter}`;
                    if (minAge) queryParams += `&minAge=${minAge}`;
                    if (maxAge) queryParams += `&maxAge=${maxAge}`;

                    // Use filtered endpoint
                    const players = await apiService.makeRequest(
                        `/players/filtered/${filter}?${queryParams}`
                    );

                    displayPlayers(players);

                } catch (error) {
                    console.error('Load players error:', error);
                    document.getElementById('playersContainer').innerHTML =
                        '<p>Error loading players. Please try again.</p>';
                }
            }

            function displayPlayers(players) {
                const container = document.getElementById('playersContainer');

                if (!players || players.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No players found matching your filters.</p>';
                    return;
                }

                container.innerHTML = players.map(player => `
                    <div class="player-card" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${player.first_name} ${player.last_name}</h4>
                                <p style="color: var(--text-muted); margin: 0.25rem 0;">
                                    ${player.position || 'No position'} ‚Ä¢ Age ${player.age || 'N/A'}
                                </p>
                                <p style="color: var(--text-muted); margin: 0.25rem 0; font-size: 0.875rem;">
                                    ${player.email || 'No email'} ‚Ä¢ ${player.location || 'No location'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small btn-secondary" onclick="editPlayer('${player.id}')">Edit</button>
                                <button class="btn btn-small btn-danger" onclick="deletePlayer('${player.id}')">Delete</button>
                            </div>
                        </div>
                        ${player.has_payment_plan ?
                        '<span style="display: inline-block; background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; margin-top: 0.5rem;">On Payment Plan</span>' :
                        '<span style="display: inline-block; background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; margin-top: 0.5rem;">No Plan</span>'
                    }
                        ${player.team_name ?
                        `<span style="display: inline-block; background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; margin-top: 0.5rem; margin-left: 0.5rem;">${player.team_name}</span>` :
                        ''
                    }
                    </div>
                `).join('');
            }

            function resetPlayerFilters() {
                document.getElementById('playerListFilter').value = 'all';
                document.getElementById('teamFilter').value = '';
                document.getElementById('sportFilter').value = '';
                document.getElementById('locationFilter').value = '';
                document.getElementById('minAgeFilter').value = '';
                document.getElementById('maxAgeFilter').value = '';
                loadPlayers();
            }

            async function deletePlayer(playerId) {
                if (!confirm('Are you sure you want to remove this player? This action cannot be undone.')) {
                    return;
                }

                try {
                    await apiService.makeRequest(`/players/${playerId}`, {
                        method: 'DELETE'
                    });

                    showNotification('Player removed successfully', 'success');
                    loadPlayers();
                } catch (error) {
                    console.error('Delete player error:', error);
                    showNotification('Failed to delete player: ' + error.message, 'error');
                }
            }

            async function editPlayer(playerId) {
                try {
                    showLoading(true);
                    const player = await apiService.makeRequest(`/players/${playerId}`);

                    document.getElementById('editPlayerId').value = player.id;
                    document.getElementById('editPlayerFirstName').value = player.first_name;
                    document.getElementById('editPlayerLastName').value = player.last_name;
                    document.getElementById('editPlayerEmail').value = player.email || '';
                    document.getElementById('editPlayerPhone').value = player.phone || '';
                    document.getElementById('editPlayerDOB').value = player.date_of_birth ? player.date_of_birth.split('T')[0] : '';
                    document.getElementById('editPlayerPosition').value = player.position || '';
                    document.getElementById('editPlayerPaymentStatus').value = player.payment_status || 'pending';

                    showModal('editPlayerModal');
                } catch (error) {
                    console.error('Fetch player error:', error);
                    showNotification('Failed to load player data', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function handleEditPlayer(e) {
                e.preventDefault();
                const playerId = document.getElementById('editPlayerId').value;

                const payload = {
                    firstName: document.getElementById('editPlayerFirstName').value.trim(),
                    lastName: document.getElementById('editPlayerLastName').value.trim(),
                    email: document.getElementById('editPlayerEmail').value.trim(),
                    phone: document.getElementById('editPlayerPhone').value.trim(),
                    dateOfBirth: document.getElementById('editPlayerDOB').value,
                    position: document.getElementById('editPlayerPosition').value.trim(),
                    paymentStatus: document.getElementById('editPlayerPaymentStatus').value,
                    clubId: AppState.currentOrganization?.id || (AppState.clubs?.[0]?.id)
                };

                try {
                    showLoading(true);
                    await apiService.makeRequest(`/players/${playerId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });

                    showNotification('Player updated successfully', 'success');
                    closeModal('editPlayerModal');
                    loadPlayers();
                } catch (error) {
                    console.error('Update player error:', error);
                    showNotification('Failed to update player: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            function exportPlayers() {
                try {
                    const players = PlayerDashboardState?.players || [];

                    if (players.length === 0) {
                        showNotification('No players to export', 'warning');
                        return;
                    }

                    // Create CSV header
                    const headers = ['First Name', 'Last Name', 'Email', 'Position', 'Age', 'Location', 'Sport', 'Status'];
                    const csvRows = [headers.join(',')];

                    // Add player data
                    players.forEach(player => {
                        const row = [
                            player.first_name || '',
                            player.last_name || '',
                            player.email || '',
                            player.position || '',
                            player.age || '',
                            player.location || '',
                            player.sport || '',
                            player.has_payment_plan ? 'On Plan' : 'No Plan'
                        ];
                        csvRows.push(row.map(field => `"${field}"`).join(','));
                    });

                    // Create and download CSV
                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `players_export_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);

                    showNotification('Players exported successfully!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('Failed to export players', 'error');
                }
            }

            // ========================================
            // POLLS & VOTING ‚úÖ
            // ========================================
            async function loadPolls() {
                try {
                    const orgId = AppState.currentOrganization?.id;
                    const polls = await apiService.makeRequest(`/polls?organizationId=${orgId}`);
                    displayPolls(polls);
                } catch (error) {
                    console.error('Load polls error:', error);
                    document.getElementById('pollsContainer').innerHTML = '<p>Error loading polls.</p>';
                }
            }

            function displayPolls(polls) {
                const container = document.getElementById('pollsContainer');
                if (!polls || polls.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No active polls found.</p>';
                    return;
                }

                container.innerHTML = polls.map(poll => {
                    const options = JSON.parse(poll.options);
                    const totalVotes = poll.results.reduce((sum, r) => sum + parseInt(r.count), 0);

                    return `
                        <div class="card" style="border: 1px solid var(--border-color);">
                            <h4>${poll.title}</h4>
                            <p style="opacity: 0.7; font-size: 0.9rem;">${poll.description || ''}</p>
                            <div class="poll-options" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                ${options.map(opt => {
                        const voteData = poll.results.find(r => r.selection === opt);
                        const count = voteData ? parseInt(voteData.count) : 0;
                        const percent = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
                        const isUserVote = poll.userVote === opt;

                        return `
                                        <div class="poll-option-row" onclick="voteOnPoll('${poll.id}', '${opt}')" 
                                             style="cursor: pointer; position: relative; background: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid ${isUserVote ? 'var(--primary)' : 'transparent'};">
                                            <div class="poll-bar" style="position: absolute; left: 0; top: 0; bottom: 0; width: ${percent}%; background: rgba(220, 67, 67, 0.1);"></div>
                                            <div style="position: relative; z-index: 1; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                                                <span>${isUserVote ? '‚óè ' : ''}${opt}</span>
                                                <span style="font-weight: bold;">${Math.round(percent)}% (${count})</span>
                                            </div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.5;">Total Votes: ${totalVotes} ‚Ä¢ Status: ${poll.status}</p>
                        </div>
                    `;
                }).join('');
            }

            async function createPoll(e) {
                e.preventDefault();
                const title = document.getElementById('pollTitle').value;
                const description = document.getElementById('pollDescription').value;
                const optionsRaw = document.getElementById('pollOptions').value;
                const expiresAt = document.getElementById('pollExpires').value;

                const options = optionsRaw.split('\n').map(o => o.trim()).filter(o => o.length > 0);

                if (options.length < 2) {
                    alert('Please provide at least 2 options.');
                    return;
                }

                try {
                    await apiService.makeRequest('/polls', {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            description,
                            options,
                            expiresAt: expiresAt || null,
                            organizationId: AppState.currentOrganization.id
                        })
                    });

                    closeModal('createPollModal');
                    document.getElementById('createPollForm').reset();
                    loadPolls();
                    showNotification('Poll launched successfully!', 'success');
                } catch (error) {
                    console.error('Create poll error:', error);
                    alert('Failed to launch poll: ' + error.message);
                }
            }

            async function voteOnPoll(pollId, selection) {
                try {
                    await apiService.makeRequest(`/polls/${pollId}/vote`, {
                        method: 'POST',
                        body: JSON.stringify({ selection })
                    });
                    loadPolls();
                } catch (error) {
                    console.error('Vote error:', error);
                    showNotification(error.message, 'error');
                }
            }

            // Bind forms
            document.getElementById('createPollForm')?.addEventListener('submit', createPoll);

            // Expose globally
            window.loadPolls = loadPolls;
            window.voteOnPoll = voteOnPoll;

            // Updated showSection switcher for Polls
            const originalShowSection = window.showSection;
            window.showSection = function (sectionId) {
                if (originalShowSection) originalShowSection(sectionId);
                if (sectionId === 'polls-section') loadPolls();
            };

            // Expose functions globally
            window.deletePlayer = deletePlayer;
            window.editPlayer = editPlayer;
            window.exportPlayers = exportPlayers;

            // ============================================================================
            // NEW RBAC INVITATION SYSTEM
            // ============================================================================

            /**
             * Handle new role-based invitation
             */
            async function handleNewInvite(e) {
                e.preventDefault();

                const email = document.getElementById('staffInviteEmail').value.trim();
                const role = document.getElementById('staffInviteRole').value;
                const message = document.getElementById('inviteMessage').value.trim();

                if (!email || !role) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }

                try {
                    showLoading(true);

                    // Get current organization ID
                    const context = await apiService.getContext();
                    const orgId = context?.currentOrganization?.id;

                    if (!orgId) {
                        throw new Error('No organization context found');
                    }

                    // Send invitation via new API
                    const response = await apiService.sendInvitation(orgId, {
                        email,
                        role,
                        message: message || `You've been invited to join our organization as a ${role}.`
                    });

                    if (response.success) {
                        showNotification(`‚úÖ Invitation sent to ${email}!`, 'success');
                        closeModal('inviteStaffModal');
                        document.getElementById('inviteStaffForm').reset();

                        // Show invite link for manual sharing
                        if (response.inviteLink) {
                            const fullLink = `${window.location.origin}${response.inviteLink}`;
                            console.log('üìß Invitation link:', fullLink);

                            // Optional: Show copy link dialog
                            if (confirm('Invitation sent! Would you like to copy the invite link to share manually?')) {
                                navigator.clipboard.writeText(fullLink).then(() => {
                                    showNotification('Invite link copied to clipboard!', 'success');
                                });
                            }
                        }
                    } else {
                        throw new Error(response.error || 'Failed to send invitation');
                    }
                } catch (error) {
                    console.error('Failed to send invitation:', error);
                    showNotification(`Failed to send invitation: ${error.message}`, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Expose globally
            window.handleNewInvite = handleNewInvite;

            /**
             * Quick invite helpers - Pre-fill modal with specific role
             */
            function invitePlayerRBAC() {
                document.getElementById('staffInviteRole').value = 'player';
                showModal('inviteStaffModal');
            }

            function quickInvite(role) {
                document.getElementById('staffInviteRole').value = role;
                showModal('inviteStaffModal');
            }

            // Expose globally
            window.invitePlayerRBAC = invitePlayerRBAC;
            window.quickInvite = quickInvite;

            // ============================================================================
            // CLUB PROFILE MANAGEMENT
            // ============================================================================

            async function loadClubProfile() {
                try {
                    const context = await apiService.getContext();
                    const org = context.currentOrganization;

                    if (!org) {
                        console.warn('No organization found');
                        return;
                    }

                    // Populate form fields
                    document.getElementById('clubName').value = org.name || '';
                    document.getElementById('clubDescription').value = org.description || '';
                    document.getElementById('clubLocation').value = org.location || '';
                    document.getElementById('clubSport').value = org.sport || '';
                    document.getElementById('clubWebsite').value = org.website || '';
                    document.getElementById('clubPhilosophy').value = org.philosophy || '';

                    console.log('‚úÖ Club profile loaded:', org.name);
                } catch (error) {
                    console.error('Failed to load club profile:', error);
                    showNotification('Failed to load club profile', 'error');
                }
            }

            async function saveClubProfile(e) {
                e.preventDefault();

                try {
                    const context = await apiService.getContext();
                    const orgId = context.currentOrganization?.id;

                    if (!orgId) {
                        throw new Error('No organization selected');
                    }

                    const formData = {
                        name: document.getElementById('clubName').value,
                        description: document.getElementById('clubDescription').value,
                        location: document.getElementById('clubLocation').value,
                        sport: document.getElementById('clubSport').value,
                        website: document.getElementById('clubWebsite').value,
                        philosophy: document.getElementById('clubPhilosophy').value
                    };

                    const response = await apiService.makeRequest(`/organizations/${orgId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });

                    if (response.success) {
                        showNotification('Club profile updated successfully!', 'success');
                        // Refresh context to update org switcher
                        await apiService.refreshContext();
                    } else {
                        throw new Error(response.error || 'Failed to update profile');
                    }
                } catch (error) {
                    console.error('Save profile error:', error);
                    showNotification(error.message || 'Failed to save profile', 'error');
                }
            }

            // Bind club profile form
            document.getElementById('clubProfileForm')?.addEventListener('submit', saveClubProfile);


            // Expose globally
            window.loadClubProfile = loadClubProfile;
            window.saveClubProfile = saveClubProfile;
        </script>

        <script src="org-switcher.js"></script>
</body>

</html>