<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ClubHub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="org-switcher.css">
    <style>
        /* CRITICAL: Dashboard section visibility - inline to bypass caching */
        .dashboard-section {
            display: none !important;
        }

        /* Horizontal Scrollable Nav */
        .dashboard-nav {
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            gap: 10px;
            padding-bottom: 5px;
            /* Scrollbar hygiene */
            -webkit-overflow-scrolling: touch;
            /* Smooth scroll on iOS */
            scrollbar-width: thin;
            /* Firefox */
        }

        .dashboard-nav::-webkit-scrollbar {
            height: 4px;
        }

        .dashboard-nav::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .dashboard-nav::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .dashboard-nav::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .dashboard-section.active {
            display: block !important;
        }

        .btn-stripe.connected {
            background: #10b981 !important;
            /* Green */
            color: white !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Feature Gating - Hidden by default unless in Dev/Local */
        .closed-feature {
            display: none !important;
        }

        /* Tournament Card Refinements */
        .tournament-card {
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tournament-card:hover {
            transform: translateY(-4px);
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .tournament-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tournament-trophy {
            font-size: 1.5rem;
        }

        .tournament-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot-success {
            background-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }

        .dot-warning {
            background-color: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
        }
    </style>
    <script>
        // Immediate Environment Check to prevent flash of content
        (function () {
            const hostname = window.location.hostname;
            const isDev = hostname === 'localhost' ||
                hostname === '127.0.0.1' ||
                hostname.startsWith('dev.') ||
                hostname.includes('-dev') ||
                hostname.includes('clubhubsports-dev');

            if (isDev) {
                console.log('üöß ClubHub Dev Mode: Enabling closed features (Polls, Venues)');
                document.write('<style>.closed-feature { display: block !important; }</style>');
            }
        })();
    </script>
    <script src="api-service.js"></script>
    <script src="workspace-manager.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav container">
            <div class="logo" onclick="window.location.href='index.html'">
                <img src="images/logo.png" alt="ClubHub Logo" class="logo-image">
                <span class="logo-text neon-text">ClubHub</span>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle-container">
                <span class="mode-label active" id="club-label">Club</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="mode-toggle" />
                    <span class="toggle-slider"></span>
                </label>
                <span class="mode-label" id="player-label">Player</span>
            </div>

            <!-- Mode Toggle -->
            <div class="user-info">
                <!-- Organization Switcher -->
                <div id="org-switcher-container"></div>

                <span id="adminNameDisplay">Hello, Admin!</span>
                <div class="user-avatar" id="adminAvatar">A</div>
                <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
            </div>
        </nav>
    </header>

    <main class="main">
        <div class="dashboard container dashboard-container">
            <div class="dashboard-header"
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;">
                <div>
                    <h1 class="neon-text display-org-name">Admin Dashboard</h1>
                    <p style="color: var(--text-muted);">Manage your organization with complete control and insights</p>
                </div>
                <div class="stripe-access" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <button id="stripeAccessBtn" class="btn btn-stripe" onclick="accessStripeAccount()">Access Stripe
                        Dashboard</button>
                    <button class="btn btn-primary" onclick="generateShareableInviteLink()">üîó Generate Invite
                        Link</button>
                </div>
            </div>

            <!-- Dashboard Navigation -->
            <!-- Grouped Dashboard Navigation -->
            <div class="dashboard-nav-grouped">
                <button class="nav-item active" onclick="showSection('overview')">
                    üìä Overview
                </button>

                <!-- Management Group -->
                <div class="nav-dropdown-container">
                    <button class="nav-item dropdown-trigger">
                        üë• Management ‚ñæ
                    </button>
                    <div class="nav-dropdown-menu">
                        <button onclick="showSection('players')">üèÉ Players</button>
                        <button onclick="showSection('teams')">üõ°Ô∏è Teams</button>
                        <button onclick="showSection('staff')">üëî Staff</button>
                        <div class="dropdown-divider"></div>
                        <button onclick="showSection('talent-id')">üåü Talent ID</button>
                        <button onclick="showSection('club-profile')">üè¢ Club Profile</button>
                        <button onclick="window.location.href='player-settings.html'">‚öôÔ∏è Account Settings</button>
                    </div>
                </div>

                <!-- Operations Group -->
                <div class="nav-dropdown-container">
                    <button class="nav-item dropdown-trigger">
                        ‚ö° Operations ‚ñæ
                    </button>
                    <div class="nav-dropdown-menu">
                        <button onclick="showSection('events')">üìÖ Events Calendar</button>
                        <button onclick="showSection('tournaments')">üèÜ Tournaments</button>
                        <div class="dropdown-divider"></div>
                        <button onclick="showSection('training-manager')">üéØ Training Manager</button>
                        <button onclick="showSection('venue-booking')" class="closed-feature">üèüÔ∏è Venue Booking</button>
                        <button onclick="showSection('league-management')" class="closed-feature">ü•á Leagues</button>
                    </div>
                </div>

                <!-- Finance Group -->
                <div class="nav-dropdown-container">
                    <button class="nav-item dropdown-trigger">
                        üí∑ Finance ‚ñæ
                    </button>
                    <div class="nav-dropdown-menu">
                        <button onclick="showSection('finances')">üí∞ Financial Overview</button>
                        <button onclick="showSection('shop')">üõí Club Shop</button>
                    </div>
                </div>

                <!-- Growth Group -->
                <div class="nav-dropdown-container">
                    <button class="nav-item dropdown-trigger">
                        üöÄ Growth ‚ñæ
                    </button>
                    <div class="nav-dropdown-menu">
                        <button onclick="showSection('listings')">üìã Recruiting Listings</button>
                        <button onclick="showSection('marketing')">üì¢ Marketing Hub</button>
                        <button onclick="showSection('polls-section')" class="closed-feature">üó≥Ô∏è Polls &
                            Voting</button>
                        <div class="dropdown-divider"></div>
                        <button onclick="showSection('email-campaigns')">üìß Email Campaigns</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-content">
                <!-- Overview Section -->
                <div id="overview" class="dashboard-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="totalPlayers">0</span>
                            <span class="stat-label">Total Players</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalStaff">0</span>
                            <span class="stat-label">Staff Members</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalEvents">0</span>
                            <span class="stat-label">Active Events</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalRevenue">¬£0</span>
                            <span class="stat-label">Monthly Revenue</span>
                        </div>
                    </div>

                    <div class="card-grid">
                        <div class="card">
                            <h3>üìà Recent Activity</h3>
                            <div id="recentActivity">
                                <!-- Populated by JavaScript from database -->
                            </div>
                        </div>

                        <div class="card">
                            <h3>üìÖ Upcoming Events</h3>
                            <div id="upcomingEvents">
                                <!-- Populated by JavaScript from database -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Club Profile Section -->
                <div id="club-profile" class="dashboard-section">
                    <div class="card">
                        <h3>üè¢ Club Profile</h3>
                        <p style="color: var(--text-muted); margin-bottom: 2rem;">Manage your organization's information
                            and branding</p>

                        <form id="clubProfileForm">
                            <div class="premium-form-grid">
                                <!-- LEFT COLUMN: CORE INFO -->
                                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                    <div class="form-section-title" style="margin-top: 0;">üìã Basic Information</div>

                                    <div class="form-group">
                                        <label for="clubName">üè¢ Club Name *</label>
                                        <input type="text" id="clubName" name="name" required
                                            placeholder="Elite Pro Academy">
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label for="clubSport">‚öΩ Sport</label>
                                            <select id="clubSport" name="sport">
                                                <option value="">Select sport</option>
                                                <option value="Football">Football</option>
                                                <option value="Basketball">Basketball</option>
                                                <option value="Rugby">Rugby</option>
                                                <option value="Cricket">Cricket</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="clubEstablished">üìÖ Established</label>
                                            <input type="text" id="clubEstablished" name="established"
                                                placeholder="e.g. 1995" maxlength="4">
                                        </div>
                                    </div>

                                    <div class="form-section-title">üìû Contact & Location</div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div class="form-group">
                                            <label for="clubEmail">‚úâÔ∏è Club Email</label>
                                            <input type="email" id="clubEmail" name="email"
                                                placeholder="contact@club.com">
                                        </div>
                                        <div class="form-group">
                                            <label for="clubPhone">üì± Club Phone</label>
                                            <input type="tel" id="clubPhone" name="phone" placeholder="+44...">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="clubWebsite">üåê Website</label>
                                        <input type="url" id="clubWebsite" name="website"
                                            placeholder="https://yourclub.com">
                                    </div>

                                    <div class="form-group">
                                        <label for="clubLocation">üìç Town / City</label>
                                        <input type="text" id="clubLocation" name="location"
                                            placeholder="e.g. London, UK">
                                    </div>

                                    <div class="form-group">
                                        <label for="clubAddress">üè† Full Address</label>
                                        <input type="text" id="clubAddress" name="address"
                                            placeholder="123 Pitch Street">
                                    </div>
                                </div>

                                <!-- RIGHT COLUMN: BRANDING & DESC -->
                                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                    <div class="form-section-title" style="margin-top: 0;">‚ú® Branding Assets</div>

                                    <div class="branding-preview-box">
                                        <label>Club Official Logo</label>
                                        <img id="clubLogoPreview" src="images/placeholder-logo-profile.png"
                                            onerror="this.src='images/placeholder-logo-profile.png'"
                                            style="width: 100%; height: auto; max-height: 250px; object-fit: contain; border-radius: 12px; border: 2px solid var(--border-color); background: rgba(0,0,0,0.2); padding: 1rem;">
                                        <div style="width: 100%;">
                                            <button type="button" class="btn btn-secondary w-100" style="width: 100%;"
                                                onclick="document.getElementById('clubLogoInput').click()">
                                                Change Logo Image
                                            </button>
                                            <input type="file" id="clubLogoInput" accept="image/*"
                                                style="display: none;" onchange="handleLogoUpload(this)">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="clubDescription">üìù Club Description</label>
                                        <textarea id="clubDescription" name="description" rows="4"
                                            placeholder="Write a brief overview of your club..."></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label for="clubPhilosophy">üéØ Club Philosophy</label>
                                        <textarea id="clubPhilosophy" name="philosophy" rows="3"
                                            placeholder="Values, mission, and style of play..."></textarea>
                                    </div>
                                </div>

                                <!-- FULL WIDTH: GALLERY -->
                                <div class="full-width">
                                    <div class="form-section-title">üñºÔ∏è Club Gallery (Photos)</div>
                                    <div class="upload-zone-premium" id="clubPicturesArea"
                                        onclick="if(!event.target.closest('button')) document.getElementById('clubPictures').click()">
                                        <input type="file" id="clubPictures" name="pictures" accept="image/*" multiple
                                            onchange="handlePictureUpload(this)" style="display: none;">
                                        <div class="upload-placeholder">
                                            <span class="icon">üì∏</span>
                                            <p
                                                style="margin: 0; color: var(--text-main); font-size: 1.1rem; font-weight: 500;">
                                                Drag and drop club photos or click to browse</p>
                                            <p
                                                style="margin: 0.5rem 0 0; font-size: 0.85rem; color: var(--text-muted);">
                                                Max 5 high-quality images (PNG/JPG)</p>
                                        </div>
                                        <div id="uploadedPictures"
                                            style="display: none; margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions"
                                style="display: flex; gap: 1rem; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                                <button type="submit" class="btn btn-primary"
                                    style="padding: 1rem 2.5rem; font-size: 1rem;">üíæ Save Club Profile</button>
                                <button type="button" class="btn btn-secondary" onclick="loadClubProfile()"
                                    style="padding: 1rem 2rem;">üîÑ Reset Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Enhanced Players Section -->
                <div id="players" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                            <h3>üë• Player Management</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-success" onclick="invitePlayerRBAC()">üìß Invite Player</button>
                            </div>
                        </div>

                        <!-- Enhanced Player Filters -->
                        <!-- Enhanced Player Filters -->
                        <div class="player-filters"
                            style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.25rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; margin-bottom: 2rem;">

                            <div style="flex: 1; min-width: 140px;">
                                <label
                                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">View
                                    Type</label>
                                <select id="playerListFilter" onchange="loadPlayers()"
                                    style="width: 100%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                                    <option value="all">Full List</option>
                                    <option value="on-plan">On Plan</option>
                                    <option value="not-on-plan">No Plan</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>

                            <div style="flex: 1; min-width: 140px;">
                                <label
                                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Team</label>
                                <select id="teamFilter" onchange="loadPlayers()"
                                    style="width: 100%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                                    <option value="">All Teams</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>

                            <div style="flex: 1; min-width: 140px;">
                                <label
                                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Sport</label>
                                <select id="sportFilter" onchange="loadPlayers()"
                                    style="width: 100%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                                    <option value="">All Sports</option>
                                    <option value="Football">Football</option>
                                    <option value="Basketball">Basketball</option>
                                    <option value="Tennis">Tennis</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div style="flex: 1.5; min-width: 180px;">
                                <label
                                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Location</label>
                                <input type="text" id="locationFilter" placeholder="Search location..."
                                    onkeyup="loadPlayers()"
                                    style="width: 100%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                            </div>

                            <div style="flex: 1; min-width: 140px;">
                                <label
                                    style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Age
                                    Range</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="minAgeFilter" placeholder="Min" onchange="loadPlayers()"
                                        style="width: 50%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                                    <input type="number" id="maxAgeFilter" placeholder="Max" onchange="loadPlayers()"
                                        style="width: 50%; padding: 0.6rem; border-radius: 8px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-main);">
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-secondary" onclick="resetPlayerFilters()"
                                    style="padding: 0.6rem 1rem; border-radius: 8px;">Reset</button>
                                <button class="btn btn-primary" onclick="exportPlayers()"
                                    style="padding: 0.6rem 1rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem;">
                                    üìä <span class="desktop-only">Export</span>
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Player Cards -->
                        <div id="playersContainer">
                            <!-- Players will be loaded from database via JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Teams Section with Clickable Names -->
                <div id="teams" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>‚öΩ Team Management</h3>
                            <button class="btn btn-primary" onclick="showModal('addTeamModal')">‚ûï Create
                                Team</button>
                        </div>

                        <div class="card-grid" id="teamsContainer">
                            <!-- Team cards with clickable names will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Staff Section with Invite Links -->
                <div id="staff" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üë®‚Äçüíº Staff Management</h3>
                            <button class="btn btn-primary" onclick="showModal('inviteStaffModal')">üìß
                                Invite
                                Staff</button>
                        </div>

                        <div id="staffContainer" style="margin-top: 1rem;">
                            <!-- Staff cards will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Events Section -->
                <div id="events" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üìÖ Event Management</h3>
                            <button class="btn btn-primary" onclick="showModal('addEventModal')">‚ûï Create
                                Event</button>
                        </div>

                        <div class="card-grid" id="eventsContainer">
                            <!-- Events will be loaded from database -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Finances Section with Payment Plans -->
                <div id="finances" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>üí∞ Financial Management</h3>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-danger" onclick="clearDummyData()"
                                    style="padding: 0.5rem 1rem; font-size: 0.8rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">üóëÔ∏è
                                    Clear Data</button>
                                <button class="btn btn-stripe" onclick="accessStripeAccount()">Access
                                    Stripe</button>
                                <button class="btn btn-primary" onclick="showModal('createPaymentPlanModal')">‚ûï Create
                                    Payment Plan</button>
                                <button class="btn btn-secondary" onclick="syncStripePlans()" id="btnSyncStripe"
                                    style="display: flex; align-items: center; gap: 0.5rem;">
                                    üîÑ Sync Plans
                                </button>
                            </div>
                        </div>

                        <div class="finance-overview">
                            <div class="finance-card">
                                <span class="finance-amount" id="monthlyRevenue">¬£0</span>
                                <span class="finance-label">Monthly Revenue</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="overdueAmount">¬£0</span>
                                <span class="finance-label">Outstanding</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="pendingAmount">¬£0</span>
                                <span class="finance-label">Pending</span>
                            </div>
                            <div class="finance-card">
                                <span class="finance-amount" id="totalMembers">0</span>
                                <span class="finance-label">Paying Members</span>
                            </div>
                        </div>

                        <div class="card">
                            <h3>üí≥ Payment Plans</h3>
                            <p>Players should be assigned to payment plans for easier workflow management:
                            </p>
                            <div id="paymentPlansContainer">
                            </div>
                        </div>

                        <div class="card">
                            <h3>Recent Bookings</h3>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Player</th>
                                            <th>Plan/Item</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentBookings">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Listings Section with Indeed-like Interface -->
                <div id="listings" class="dashboard-section">
                    <!-- Listings Header -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.75rem;">üìã Recruitment & Applications</h2>
                            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Manage your club listings and
                                review incoming applications.</p>
                        </div>
                        <button class="btn btn-primary" onclick="showModal('createListingModal')">
                            ‚ûï Create New Listing
                        </button>
                    </div>

                    <!-- Active Listings Section -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 1.25rem;">üìù</span>
                            <h3 style="margin: 0;">Active Listings</h3>
                        </div>
                        <div id="activeListingsContainer">
                            <!-- Populated dynamically via loadListings() -->
                        </div>
                    </div>

                    <!-- Applications Section -->
                    <div class="card">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                            <span style="font-size: 1.25rem;">ü§ù</span>
                            <h3 style="margin: 0;">Application Management</h3>
                        </div>
                        <div id="applicationsContainer">
                            <!-- Populated dynamically via loadClubApplications() -->
                        </div>
                    </div>
                </div>


                <!-- Item Shop Section -->
                <div id="shop" class="dashboard-section">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.75rem;">üõí Item Shop Management</h2>
                            <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Manage your club merchandise,
                                tickets, and other items.</p>
                        </div>
                        <button class="btn btn-primary" onclick="showModal('addProductModal')">
                            ‚ûï Add New Product
                        </button>
                    </div>

                    <div class="card">
                        <div id="productsContainer">
                            <!-- Populated dynamically via loadProducts() -->
                        </div>
                    </div>
                </div>

                <!-- Marketing Hub Section -->
                <div id="marketing" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>üì¢ Marketing Hub</h3>
                            <button class="btn btn-primary" onclick="showModal('createCampaignModal')">üì£
                                New
                                Campaign</button>
                        </div>
                        <div class="card">
                            <h3>‚úâÔ∏è Active Campaigns</h3>
                            <div id="campaignsContainer">
                                <!-- Campaigns will be loaded from database -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Manager Section -->
                <div id="training-manager" class="dashboard-section">
                    <div class="card">
                        <div class="section-header"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h3>üéØ Training Manager</h3>
                                <p style="color: var(--text-muted);">Manage your talent identified players, groups and
                                    bibs.</p>
                            </div>
                        </div>

                        <!-- Event Selector -->
                        <div class="card" style="margin-bottom: 2rem; background: rgba(255,255,255,0.02);">
                            <label><strong>Select Training Event:</strong></label>
                            <select id="adminTrainingEventSelect" onchange="loadAdminTrainingDashboard()"
                                style="width: 100%; margin-top: 0.5rem;">
                                <option value="">-- Select Event --</option>
                            </select>
                        </div>

                        <div id="adminTrainingDashboardContent" style="display: none;">
                            <!-- Stats Overview -->
                            <div class="stats-grid" style="margin-bottom: 2rem;">
                                <div class="stat-card">
                                    <span class="stat-label">Total Registrants</span>
                                    <span class="stat-number" id="adminTotalRegistrants">0</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-label">Checked In</span>
                                    <span class="stat-number" id="adminCheckedIn">0</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-label">Groups</span>
                                    <span class="stat-number" id="adminGroupsCount">0</span>
                                </div>
                                <div class="stat-card">
                                    <span class="stat-label">Bibs Available</span>
                                    <span class="stat-number" id="adminBibsCount">0</span>
                                </div>
                            </div>

                            <!-- Tabs -->
                            <div class="tabs" style="margin-bottom: 2rem;">
                                <button class="tab-btn active"
                                    onclick="showTrainingTab('registrants')">Registrants</button>
                                <button class="tab-btn" onclick="showTrainingTab('groups')">Groups</button>
                                <button class="tab-btn" onclick="showTrainingTab('bibs')">Bibs</button>
                            </div>

                            <!-- Registrants Tab -->
                            <div id="training-registrants-tab" class="training-tab-content">
                                <div style="margin-bottom: 1.5rem;">
                                    <button class="btn btn-primary" onclick="autoAssignTrainingAll()">üéØ Auto-Assign
                                        Bibs & Groups</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Age</th>
                                                <th>Position</th>
                                                <th>Bib</th>
                                                <th>Group</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminTrainingRegistrantsBody">
                                            <!-- Registrants will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Groups Tab -->
                            <div id="training-groups-tab" class="training-tab-content" style="display: none;">
                                <div style="margin-bottom: 1.5rem;">
                                    <button class="btn btn-primary" onclick="showModal('createTrainingGroupModal')">+
                                        Create Group</button>
                                </div>
                                <div id="adminTrainingGroupsContainer" class="card-grid">
                                    <!-- Groups will be loaded here -->
                                </div>
                            </div>

                            <!-- Bibs Tab -->
                            <div id="training-bibs-tab" class="training-tab-content" style="display: none;">
                                <div style="margin-bottom: 1.5rem;">
                                    <button class="btn btn-primary" onclick="showModal('addTrainingBibsModal')">+ Add
                                        Bibs (Batch)</button>
                                </div>
                                <div id="adminTrainingBibsContainer" class="card-grid">
                                    <!-- Bibs will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Venue Booking Section -->
                <div id="venue-booking" class="dashboard-section">
                    <div class="card">
                        <div class="section-header"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h3>üèüÔ∏è Venue Booking</h3>
                                <p style="color: var(--text-muted);">Browse and book sports venues for your club.</p>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs" style="margin-bottom: 2rem;">
                            <button class="tab-btn active" onclick="showVenueTab('browse')">Browse Venues</button>
                            <button class="tab-btn" onclick="showVenueTab('mybookings')">My Bookings</button>
                        </div>

                        <!-- Browse Venues Tab -->
                        <div id="venue-browse-tab" class="venue-tab-content">
                            <div class="filters" style="margin-bottom: 2rem; display: flex; gap: 1rem;">
                                <input type="text" id="adminSearchVenue" placeholder="Search venues..."
                                    style="flex: 1;">
                                <select id="adminLocationFilter" style="width: 200px;">
                                    <option value="">All Locations</option>
                                </select>
                            </div>

                            <div id="adminVenueGrid" class="venue-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                                <!-- Venues will be loaded here -->
                                <p>Loading venues...</p>
                            </div>
                        </div>

                        <!-- My Bookings Tab -->
                        <div id="venue-mybookings-tab" class="venue-tab-content" style="display: none;">
                            <div id="adminMyBookingsList">
                                <!-- Bookings will be loaded here -->
                                <p>Loading your bookings...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- League Management Section -->
                <div id="league-management" class="dashboard-section">
                    <div class="card">
                        <h3>üèÜ Leagues</h3>
                        <p style="color: var(--text-muted); margin-bottom: 2rem;">View and manage league tables and
                            fixtures.</p>
                        <div class="card">
                            <p>Loading league data...</p>
                        </div>
                    </div>
                </div>

                <!-- Email Campaigns Section -->
                <div id="email-campaigns" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3>üìß Email Campaigns</h3>
                            <button class="btn btn-primary" onclick="showModal('createCampaignModal')">+ New
                                Campaign</button>
                        </div>
                        <div id="campaignsContainerFull">
                            <p>Loading email campaigns...</p>
                        </div>
                    </div>
                </div>

                <!-- Team Detail Section -->
                <div id="team-details" class="dashboard-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <button class="btn btn-secondary btn-small" onclick="showSection('teams')">‚Üê Back to
                                    Teams</button>
                                <h3 style="margin: 0;" id="teamDetailName">Team Name</h3>
                            </div>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div class="team-meta-badges" id="teamDetailStats">
                                    <!-- Populated dynamically -->
                                </div>
                                <button class="btn btn-secondary btn-small" onclick="editTeam(currentTeamId)">‚öôÔ∏è Manage
                                    Team</button>
                            </div>
                        </div>

                        <!-- Team Tabs -->
                        <div class="tabs">
                            <button class="tab-btn active" onclick="switchTeamTab('roster')">üë• Roster</button>
                            <button class="tab-btn" onclick="switchTeamTab('events')">üìÖ Events</button>
                            <button class="tab-btn" onclick="switchTeamTab('availability')">‚úÖ Availability</button>
                        </div>

                        <!-- Roster Tab -->
                        <div id="team-tab-roster" class="team-tab-content active">
                            <div class="card">
                                <div class="section-header">
                                    <h3>Team Roster</h3>
                                    <button class="btn btn-primary btn-small" onclick="showAddPlayerToTeamModal()">+ Add
                                        Player</button>
                                    <button class="btn btn-secondary btn-small"
                                        onclick="inviteCoachToTeam(currentTeamId)">‚úâÔ∏è Invite Coach</button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>Position</th>
                                                <th>Age</th>
                                                <th>Status</th>
                                                <th style="text-align: right;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teamRosterBody">
                                            <!-- Populated via JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab -->
                        <div id="team-tab-events" class="team-tab-content" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                                <h4>Team Events</h4>
                                <button class="btn btn-primary btn-small" onclick="showModal('addEventModal')">‚ûï Plan
                                    Event</button>
                            </div>
                            <div id="teamEventsContainer" class="card-grid">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                        <!-- Availability Tab (Spond-like) -->
                        <div id="team-tab-availability" class="team-tab-content" style="display: none;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                                <h4>Availability Tracker</h4>
                                <div class="legend" style="display: flex; gap: 1rem; font-size: 0.9rem;">
                                    <span style="color: var(--success-color);">‚úÖ Going</span>
                                    <span style="color: var(--danger-color);">‚ùå No</span>
                                    <span style="color: var(--warning-color);">‚ùì Maybe</span>
                                    <span style="opacity: 0.5;">‚ö™ No Response</span>
                                </div>
                            </div>
                            <div class="availability-grid" id="availabilityGrid"
                                style="overflow-x: auto; background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
                                <!-- Spond-like grid -->
                                <p style="text-align: center; opacity: 0.7;">Select an upcoming event to view
                                    availability.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Talent ID Manager Tab -->
            <div id="talent-id" class="dashboard-section">
                <div class="section-header">
                    <h2>Talent ID Manager</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportTalentCSV()">Export CSV</button>
                        <button class="btn btn-primary" onclick="showGenerateBibsModal()">+ Generate Bibs</button>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 2rem;">
                    <h3>Active Event Dashboard</h3>
                    <div class="form-group">
                        <label>Select Event</label>
                        <select id="talentEventSelect" onchange="loadTalentDashboard(this.value)">
                            <option value="">Select an event...</option>
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <div class="stats-grid" id="talentStats">
                        <div class="stat-card">
                            <h3>Registrants</h3>
                            <p class="stat-number" id="totalRegistrants">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Bibs Available</h3>
                            <p class="stat-number" id="bibsAvailable">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Groups</h3>
                            <p class="stat-number" id="totalGroups">0</p>
                        </div>
                    </div>
                </div>

                <div class="grid-container" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Left Col: Schedule & Bibs -->
                    <div>
                        <div class="card">
                            <h3>Day Schedule</h3>
                            <div id="scheduleList" class="item-list">
                                <p class="empty-state">No schedule items yet.</p>
                            </div>
                            <button class="btn btn-secondary btn-small" style="width:100%; margin-top:1rem;"
                                onclick="showAddScheduleModal()">+ Add Activity</button>
                        </div>

                        <div class="card" style="margin-top: 2rem;">
                            <h3>Bib Inventory</h3>
                            <div id="bibsList" class="item-list">
                                <!-- Bib ranges -->
                            </div>
                        </div>
                    </div>

                    <!-- Right Col: Groups & Auto Assign -->
                    <div>
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3>Groups</h3>
                                <button class="btn btn-primary btn-small" onclick="autoAssignBibs()">‚ú® Auto-Assign
                                    Bibs</button>
                            </div>
                            <p style="font-size:0.9rem; opacity:0.7; margin-bottom:1rem;">Automatically assign bibs
                                to unassigned players.</p>

                            <div id="groupsList">
                                <!-- Groups rendered here -->
                            </div>

                            <button class="btn btn-secondary btn-small" style="width:100%; margin-top:1rem;"
                                onclick="showCreateGroupModal()">+ Create Group</button>
                        </div>
                    </div>
                </div>
            </div> <!-- End talent-id -->

            <!-- Tournament Manager Tab -->
            <div id="tournaments" class="dashboard-section">
                <!-- Tournament List View -->
                <div id="tournamentListView">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0;">üèÜ Tournament Manager</h3>
                            <button class="btn btn-primary" onclick="openCreateTournamentModal()">+ Create
                                Tournament</button>
                        </div>

                        <div id="tournamentsListContainer"
                            style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));">
                            <!-- Loaded via JS -->
                            <div style="text-align: center; padding: 3rem; opacity: 0.5;">
                                <p>Loading tournaments...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tournament Detail View (Hidden by default) -->
                <div id="tournamentDetailView" style="display: none;">
                    <button class="btn btn-secondary btn-small" onclick="closeTournamentDetail()">‚Üê Back to
                        Tournaments</button>

                    <div class="section-header" style="margin-top: 1rem;">
                        <h2 id="detailTournamentName">Tournament Name</h2>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="generateFixtures()">Generate Next Round</button>
                            <button class="btn btn-small btn-primary"
                                onclick="generateFixtures('regular')">League</button>
                            <button class="btn btn-small btn-primary"
                                onclick="generateFixtures('knockout')">Knockout</button>
                        </div>
                    </div>

                    <div class="dashboard-nav" style="margin-bottom: 1rem;">
                        <button class="active" onclick="switchTournamentTab(this, 'fixtures')">Fixtures</button>
                        <button onclick="switchTournamentTab(this, 'standings')">Standings</button>
                        <button onclick="switchTournamentTab(this, 'teams')">Teams</button>
                    </div>

                    <div id="tab-fixtures" class="tournament-tab">
                        <div class="card">
                            <h3>Upcoming Matches</h3>
                            <div id="tournamentFixturesList"></div>
                        </div>
                    </div>

                    <div id="tab-standings" class="tournament-tab" style="display: none;">
                        <div class="card">
                            <h3>League Table / Bracket</h3>
                            <div id="tournamentStandingsContainer"></div>
                        </div>
                    </div>

                    <div id="tab-teams" class="tournament-tab" style="display: none;">
                        <div class="card">
                            <h3>Participating Teams</h3>
                            <div id="tournamentParticipantsList"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        </div>
        <div id="tournamentMatchesList" class="item-list"></div>
        </div>
        </div>
        </div>

        <!-- Specialized Polls Section -->
        <div id="polls-section" class="dashboard-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3>üó≥Ô∏è Voting & Polls</h3>
                    <button class="btn btn-primary" onclick="showModal('createPollModal')">‚ûï Create
                        Poll</button>
                </div>
                <div id="pollsContainer" class="card-grid">
                    <!-- Polls will be loaded here -->
                </div>
            </div>
        </div>
        </div> <!-- End dashboard-content -->
        </div>
    </main>

    <!-- Enhanced Modals -->

    <!-- Invite Player Modal -->
    <div id="invitePlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìß Invite Player</h2>
                <button class="close" onclick="closeModal('invitePlayerModal')">&times;</button>
            </div>
            <form id="invitePlayerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="inviteFirstName">First Name *</label>
                        <input type="text" id="inviteFirstName" required placeholder="e.g., John">
                    </div>
                    <div class="form-group">
                        <label for="inviteLastName">Last Name *</label>
                        <input type="text" id="inviteLastName" required placeholder="e.g., Smith">
                    </div>
                    <div class="form-group full-width">
                        <label for="inviteEmail">Email Address *</label>
                        <input type="email" id="inviteEmail" required placeholder="player@example.com">
                    </div>
                    <div class="form-group">
                        <label for="inviteRole">Account Type</label>
                        <select id="inviteRole" required>
                            <option value="player">Player (Child Account)</option>
                            <option value="parent">Parent (Adult Account)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inviteTeam">Assign to Team</label>
                        <select id="inviteTeam">
                            <option value="">No team assignment</option>
                            <!-- Populated from database -->
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="inviteMessage">Personal Message</label>
                        <textarea id="inviteMessage" rows="3"
                            placeholder="Welcome to our club! We're excited to have you join our team..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üìß Send Invite</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('invitePlayerModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Invite Staff Modal -->
    <div id="inviteStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìß Invite Team Member</h2>
                <button class="close" onclick="closeModal('inviteStaffModal')">&times;</button>
            </div>
            <form id="inviteStaffForm" onsubmit="handleNewInvite(event)">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="staffInviteEmail">Email Address *</label>
                        <input type="email" id="staffInviteEmail" required placeholder="member@example.com">
                    </div>
                    <div class="form-group full-width">
                        <label for="staffInviteRole">Access Role *</label>
                        <select id="staffInviteRole" required onchange="toggleStaffTeamSelect(this.value)">
                            <option value="">Select Role</option>
                            <option value="admin">Administrator (Full Access)</option>
                            <option value="coach">Coach (Team Management)</option>
                            <option value="assistant_coach">Assistant Coach</option>
                            <option value="staff">Staff Member (Finances & Shop)</option>
                            <option value="viewer">Viewer (Read-only)</option>
                        </select>
                    </div>
                    <div class="form-group full-width" id="staffTeamSelectGroup" style="display: none;">
                        <label for="staffInviteTeam">Assign to Team (Optional)</label>
                        <select id="staffInviteTeam">
                            <option value="">Select Team</option>
                            <!-- Populated via JS -->
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <div class="info-box">
                            <strong>üìã Role Permissions:</strong>
                            <ul>
                                <li><strong>Admin:</strong> Full organization management</li>
                                <li><strong>Coach:</strong> Assigned teams & player oversight</li>
                                <li><strong>Staff:</strong> Shop, Marketing & Transactions</li>
                                <li><strong>Viewer:</strong> Dashboard and data visibility only</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="staffInviteMessage">Personal Message (Optional)</label>
                        <textarea id="staffInviteMessage" rows="3"
                            placeholder="Welcome to our team! We're excited to have you join us."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üìß Send Invitation</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('inviteStaffModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Add Player Modal -->
    <div id="addPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Add New Player</h2>
                <button class="close" onclick="closeModal('addPlayerModal')">&times;</button>
            </div>
            <form id="addPlayerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="playerFirstName">First Name *</label>
                        <input type="text" id="playerFirstName" required placeholder="First Name">
                    </div>
                    <div class="form-group">
                        <label for="playerLastName">Last Name *</label>
                        <input type="text" id="playerLastName" required placeholder="Last Name">
                    </div>
                    <div class="form-group">
                        <label for="playerEmail">Email address</label>
                        <input type="email" id="playerEmail" placeholder="player@example.com">
                    </div>
                    <div class="form-group">
                        <label for="playerPhone">Phone Number</label>
                        <input type="tel" id="playerPhone" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label for="playerDOB">Date of Birth *</label>
                        <input type="date" id="playerDOB" required>
                    </div>
                    <div class="form-group">
                        <label for="playerSport">Sport</label>
                        <select id="playerSport">
                            <option value="">Select Sport...</option>
                            <option value="Football">Football</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="playerPosition" id="playerPositionLabel">Position</label>
                        <input type="text" id="playerPosition" placeholder="e.g., Striker" list="positionOptions">
                        <datalist id="positionOptions"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="playerGender">Gender</label>
                        <select id="playerGender">
                            <option value="">Select Gender...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="playerTeam">Assign to Team</label>
                        <select id="playerTeam">
                            <option value="">No team assignment</option>
                            <!-- Populated from database -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="playerPaymentPlan">Payment Plan</label>
                        <select id="playerPaymentPlan">
                            <option value="">No payment plan</option>
                            <!-- Populated from database -->
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="playerBio">Bio / Achievements</label>
                        <textarea id="playerBio" rows="3" placeholder="Tell us about the player..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">‚ûï Add Player</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addPlayerModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Player Modal -->
    <div id="editPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Player Details</h2>
                <button class="close" onclick="closeModal('editPlayerModal')">&times;</button>
            </div>
            <form id="editPlayerForm">
                <input type="hidden" id="editPlayerId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editPlayerFirstName">First Name *</label>
                        <input type="text" id="editPlayerFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerLastName">Last Name *</label>
                        <input type="text" id="editPlayerLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerEmail">Email address</label>
                        <input type="email" id="editPlayerEmail">
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPhone">Phone Number</label>
                        <input type="tel" id="editPlayerPhone">
                    </div>
                    <div class="form-group">
                        <label for="editPlayerDOB">Date of Birth *</label>
                        <input type="date" id="editPlayerDOB" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerSport">Sport</label>
                        <select id="editPlayerSport">
                            <option value="">Select Sport...</option>
                            <option value="Football">Football</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPosition" id="editPlayerPositionLabel">Position</label>
                        <input type="text" id="editPlayerPosition" placeholder="e.g., Striker"
                            list="editPositionOptions">
                        <datalist id="editPositionOptions"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerGender">Gender</label>
                        <select id="editPlayerGender">
                            <option value="">Select Gender...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerPaymentStatus">Payment Status</label>
                        <select id="editPlayerPaymentStatus">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editPlayerLocation">Location</label>
                        <input type="text" id="editPlayerLocation" placeholder="e.g., London, UK">
                    </div>
                    <div class="form-group full-width">
                        <label for="editPlayerBio">Bio / History (CV)</label>
                        <textarea id="editPlayerBio" rows="3"
                            placeholder="Player history, highlights, etc..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="savePlayerChangesBtn">üíæ Save Changes</button>
                    <button type="button" class="btn btn-success" id="acceptMemberBtn" style="display: none;"
                        onclick="handleAcceptMember()">‚úÖ Accept Member</button>
                    <button type="button" class="btn btn-warning" id="resendInviteBtn" style="display: none;"
                        onclick="handleResendInvite()">üìß Resend Invite</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editPlayerModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Poll Modal -->
    <div id="createPollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üó≥Ô∏è Create New Poll</h2>
                <button class="close" onclick="closeModal('createPollModal')">&times;</button>
            </div>
            <form id="createPollForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="pollTitle">Poll Question / Title</label>
                        <input type="text" id="pollTitle" placeholder="e.g. What color should our new kit be?" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="pollDescription">Description (Optional)</label>
                        <textarea id="pollDescription" rows="2"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Options (One per line)</label>
                        <textarea id="pollOptions" rows="4" placeholder="Red\nBlue\nGreen" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="pollExpires">Expiration Date (Optional)</label>
                        <input type="datetime-local" id="pollExpires">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üöÄ Launch Poll</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createPollModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Team Modal (Enhanced) -->
    <div id="addTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öΩ Create New Team</h2>
                <button class="close" onclick="closeModal('addTeamModal')">&times;</button>
            </div>
            <form id="addTeamForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="teamName">Team Name *</label>
                        <input type="text" id="teamName" required placeholder="e.g., U18 Elite Squad">
                    </div>

                    <div class="form-group">
                        <label for="teamSport">Sport *</label>
                        <select id="teamSport" required>
                            <option value="">Select sport...</option>
                            <option value="Football">Football</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Rugby">Rugby</option>
                            <option value="Cricket">Cricket</option>
                            <option value="Hockey">Hockey</option>
                            <option value="Volleyball">Volleyball</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="teamAgeGroup">Age Group</label>
                        <select id="teamAgeGroup">
                            <option value="">Select age group...</option>
                            <option value="Under 8">Under 8</option>
                            <option value="Under 10">Under 10</option>
                            <option value="Under 12">Under 12</option>
                            <option value="Under 14">Under 14</option>
                            <option value="Under 16">Under 16</option>
                            <option value="Under 18">Under 18</option>
                            <option value="Adult">Adult</option>
                            <option value="Veterans">Veterans</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="teamDescription">Description</label>
                        <textarea id="teamDescription" rows="3"
                            placeholder="Brief description of the team's goals and focus..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTeamModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">‚öΩ Create Team</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Team Modal -->
    <div id="editTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Edit Team Details</h2>
                <button class="close" onclick="closeModal('editTeamModal')">&times;</button>
            </div>
            <form id="editTeamForm">
                <input type="hidden" id="editTeamId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editTeamName">Team Name *</label>
                        <input type="text" id="editTeamName" required>
                    </div>

                    <div class="form-group">
                        <label for="editTeamSport">Sport *</label>
                        <select id="editTeamSport" required>
                            <option value="Football">Football</option>
                            <option value="Basketball">Basketball</option>
                            <option value="Tennis">Tennis</option>
                            <option value="Rugby">Rugby</option>
                            <option value="Cricket">Cricket</option>
                            <option value="Hockey">Hockey</option>
                            <option value="Volleyball">Volleyball</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editTeamAgeGroup">Age Group</label>
                        <select id="editTeamAgeGroup">
                            <option value="">Select age group...</option>
                            <option value="Under 8">Under 8</option>
                            <option value="Under 10">Under 10</option>
                            <option value="Under 12">Under 12</option>
                            <option value="Under 14">Under 14</option>
                            <option value="Under 16">Under 16</option>
                            <option value="Under 18">Under 18</option>
                            <option value="Adult">Adult</option>
                            <option value="Veterans">Veterans</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="editTeamDescription">Description</label>
                        <textarea id="editTeamDescription" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editTeamModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Player to Team Modal -->
    <div id="addPlayerToTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Add Player to Team</h2>
                <button class="close" onclick="closeModal('addPlayerToTeamModal')">&times;</button>
            </div>
            <form id="addPlayerToTeamForm">
                <div class="form-group">
                    <label for="playerSelect">Select Player from Organization</label>
                    <select id="playerSelect" required>
                        <option value="">Loading players...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="playerTeamPosition">Position (Optional)</label>
                    <input type="text" id="playerTeamPosition" placeholder="e.g. striker, defender">
                </div>
                <div class="form-group">
                    <label for="playerJerseyNumber">Jersey Number (Optional)</label>
                    <input type="number" id="playerJerseyNumber">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addPlayerToTeamModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">‚úÖ Add to Team</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Poll Modal -->
    <div id="createPollModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üó≥Ô∏è Create New Poll</h2>
                <button class="close" onclick="closeModal('createPollModal')">&times;</button>
            </div>
            <form id="createPollForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="pollTitle">Poll Question *</label>
                        <input type="text" id="pollTitle" required placeholder="e.g., Player of the Month?">
                    </div>

                    <div class="form-group full-width">
                        <label for="pollDescription">Description (Optional)</label>
                        <textarea id="pollDescription" rows="2" placeholder="Vote for your top performer..."></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label>Poll Options *</label>
                        <div id="pollOptionsContainer">
                            <div class="input-with-button" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="poll-option-input" required placeholder="Option 1">
                            </div>
                            <div class="input-with-button" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="poll-option-input" required placeholder="Option 2">
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addPollOption()">+ Add
                            Optimization</button>
                    </div>

                    <div class="form-group">
                        <label for="pollExpiresAt">Expires At</label>
                        <input type="datetime-local" id="pollExpiresAt">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createPollModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Poll</button>
                </div>

                <!-- Venue Booking Modal -->
                <div id="adminVenueBookingModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>üèüÔ∏è Book Venue Slot</h2>
                            <button class="close" onclick="closeModal('adminVenueBookingModal')">&times;</button>
                        </div>
                        <div id="adminVenueBookingContent" style="padding: 1rem;">
                            <h3 id="adminBookingVenueName" style="margin-bottom: 1.5rem;"></h3>

                            <div class="form-group">
                                <label>Select Date:</label>
                                <input type="date" id="adminBookingDate" style="width: 100%; margin-bottom: 1rem;"
                                    onchange="loadAdminVenueAvailability()">
                            </div>

                            <div id="adminVenueSlots" class="venue-slots-grid"
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 1.5rem;">
                                <!-- Slots loaded via JS -->
                                <p style="color: var(--text-muted);">Select a date to view available slots.</p>
                            </div>

                            <div class="form-group full-width">
                                <label>Booking Notes:</label>
                                <textarea id="adminBookingNotes" rows="2"
                                    placeholder="e.g. U16 Training Session"></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary"
                                    onclick="closeModal('adminVenueBookingModal')">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="confirmAdminBooking()">Confirm
                                    Booking</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Venue Modal -->
    <div id="addVenueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèüÔ∏è Add New Venue</h2>
                <button class="close" onclick="closeModal('addVenueModal')">&times;</button>
            </div>
            <form id="addVenueForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="venueName">Venue Name *</label>
                        <input type="text" id="venueName" required placeholder="e.g., Training Ground A">
                    </div>

                    <div class="form-group full-width">
                        <label for="venueLocation">Location *</label>
                        <input type="text" id="venueLocation" required placeholder="e.g., North London Complex">
                    </div>

                    <div class="form-group">
                        <label for="venueHourlyRate">Hourly Rate (¬£)</label>
                        <input type="number" id="venueHourlyRate" placeholder="0.00" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="venueCapacity">Capacity</label>
                        <input type="number" id="venueCapacity" placeholder="e.g. 22">
                    </div>

                    <div class="form-group full-width">
                        <label>Description</label>
                        <textarea id="venueDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addVenueModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Venue</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Tournament Modal -->
    <div id="createTournamentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèÜ Create New Tournament</h2>
                <button class="close" onclick="closeModal('createTournamentModal')">&times;</button>
            </div>
            <form onsubmit="handleCreateTournament(event)">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Tournament Name</label>
                        <input type="text" id="newTournamentName" required placeholder="e.g. Summer Cup 2026">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="newTournamentType" required>
                            <option value="league">League</option>
                            <option value="knockout">Knockout</option>
                            <option value="group_knockout">Group + Knockout</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="newTournamentStartDate" required>
                    </div>

                    <div class="form-group full-width">
                        <label>Select Participating Teams</label>
                        <div id="tournamentTeamSelector"
                            style="max-height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); padding: 0.5rem; border-radius: 8px; background: rgba(0,0,0,0.2);">
                            <!-- Checkboxes populated via JS -->
                            <p style="opacity: 0.6;">Loading teams...</p>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createTournamentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Tournament</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Match Stats Modal -->
    <div id="matchStatsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>‚öΩ Match Result & Stats</h2>
                <button class="close" onclick="closeModal('matchStatsModal')">&times;</button>
            </div>
            <div style="padding: 1rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px;">
                    <div style="text-align: center; flex: 1;">
                        <h3 id="matchHomeTeamName">Home</h3>
                        <input type="number" id="matchHomeScore" placeholder="0"
                            style="font-size: 2rem; width: 80px; text-align: center; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px;">
                    </div>
                    <div style="font-size: 1.5rem; opacity: 0.5; font-weight: bold;">VS</div>
                    <div style="text-align: center; flex: 1;">
                        <h3 id="matchAwayTeamName">Away</h3>
                        <input type="number" id="matchAwayScore" placeholder="0"
                            style="font-size: 2rem; width: 80px; text-align: center; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px;">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Player Stats (Optional)</label>
                    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 0.5rem;">Enter goals, assists, or rating
                        (1-10).</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <h4
                                style="margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.25rem;">
                                Home Players</h4>
                            <div id="matchHomePlayersStats" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        <div>
                            <h4
                                style="margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.25rem;">
                                Away Players</h4>
                            <div id="matchAwayPlayersStats" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('matchStatsModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveMatchStats()">üíæ Save Result</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Create New Event</h2>
                <button class="close" onclick="closeModal('addEventModal')">&times;</button>
            </div>
            <form id="addEventForm" onsubmit="handleAddEvent(event)">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="eventTitle">Event Title *</label>
                        <input type="text" id="eventTitle" required placeholder="e.g., U16 Weekly Training">
                    </div>
                    <div class="form-group">
                        <label for="eventType">Event Type *</label>
                        <select id="eventType" required>
                            <option value="">Select Type</option>
                            <option value="training">Training Session</option>
                            <option value="match">Match</option>
                            <option value="tournament">Tournament</option>
                            <option value="camp">Training Camp</option>
                            <option value="social">Social Event</option>
                            <option value="trial">Trial Session</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Location</label>
                        <input type="text" id="eventLocation" placeholder="Event venue">
                    </div>
                    <div class="form-group">
                        <label for="eventDate">Date *</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventTime">Time *</label>
                        <input type="time" id="eventTime" required>
                    </div>
                    <div class="form-group">
                        <label for="eventPrice">Price (¬£)</label>
                        <input type="number" id="eventPrice" step="0.01" min="0" value="0">
                        <small>Set to 0 for free events</small>
                    </div>
                    <div class="form-group">
                        <label for="eventCapacity">Capacity</label>
                        <input type="number" id="eventCapacity" min="1" placeholder="Unlimited">
                    </div>
                    <div class="form-group full-width">
                        <label for="eventDescription">Description</label>
                        <textarea id="eventDescription" rows="3"
                            placeholder="Event details and information..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="checkbox-label">
                            <input type="checkbox" id="notifyPlayers" checked>
                            <span>üì® Notify all members via email/app</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üìÖ Create Event</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addEventModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Create Payment Plan Modal -->
    <div id="createPaymentPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Create Payment Plan</h2>
                <button class="close" onclick="closeModal('createPaymentPlanModal')">&times;</button>
            </div>
            <form id="createPaymentPlanForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="planName">Plan Name *</label>
                        <input type="text" id="planName" required placeholder="e.g., Monthly Membership">
                    </div>
                    <div class="form-group">
                        <label for="planAmount">Amount (¬£) *</label>
                        <input type="number" id="planAmount" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="planInterval">Frequency *</label>
                        <select id="planInterval" required>
                            <option value="">Select Frequency</option>
                            <option value="month">Monthly</option>
                            <option value="week">Weekly</option>
                            <option value="year">Annually</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="planDescription">Description</label>
                        <textarea id="planDescription" rows="2"
                            placeholder="Plan details and what's included..."></textarea>
                    </div>
                    <div class="form-group" style="grid-column: span 1;">
                        <label>Billing Cycle Start</label>
                        <select id="planBillingAnchor"
                            onchange="document.getElementById('billingDayContainer').style.display = (this.value === 'fixed_date' ? 'block' : 'none')">
                            <option value="signup_date">Starts on Sign Up</option>
                            <option value="fixed_date">Starts on Specific Day</option>
                        </select>
                    </div>
                    <div class="form-group" id="billingDayContainer" style="display: none; grid-column: span 1;">
                        <label>Day of Month (1-28)</label>
                        <input type="number" id="planBillingDay" min="1" max="28" value="1">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üí≥ Create Plan</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createPaymentPlanModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Payment Plan Modal -->
    <div id="editPaymentPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Payment Plan</h2>
                <button class="close" onclick="closeModal('editPaymentPlanModal')">&times;</button>
            </div>
            <form id="editPaymentPlanForm">
                <input type="hidden" id="editPlanId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editPlanName">Plan Name</label>
                        <input type="text" id="editPlanName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlanAmount">Amount (¬£)</label>
                        <input type="number" id="editPlanAmount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editPlanFrequency">Frequency</label>
                        <select id="editPlanFrequency" required>
                            <option value="month">Monthly</option>
                            <option value="week">Weekly</option>
                            <option value="year">Annually</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editPlanDescription">Description</label>
                        <textarea id="editPlanDescription" rows="3"></textarea>
                    </div>
                </div>
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="editPlanBillingAnchor">Billing Cycle Start</label>
                        <select id="editPlanBillingAnchor"
                            onchange="document.getElementById('editBillingDayContainer').style.display = (this.value === 'fixed_date' ? 'block' : 'none')">
                            <option value="signup_date">Starts on Sign Up</option>
                            <option value="fixed_date">Starts on Specific Day</option>
                        </select>
                    </div>
                    <div class="form-group" id="editBillingDayContainer" style="display: none; margin-bottom: 0;">
                        <label for="editPlanBillingDay">Day of Month (1-28)</label>
                        <input type="number" id="editPlanBillingDay" min="1" max="28" value="1">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editPaymentPlanModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Listing Modal -->
    <div id="createListingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Create Club Listing</h2>
                <button class="close" onclick="closeModal('createListingModal')">&times;</button>
            </div>
            <form id="createListingForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="listingTitle">Listing Title *</label>
                        <input type="text" id="listingTitle" required placeholder="e.g., U16 Midfielder Wanted">
                    </div>
                    <div class="form-group">
                        <label for="listingType">Listing Type *</label>
                        <select id="listingType" required>
                            <option value="">Select Type</option>
                            <option value="player-wanted">Player Wanted</option>
                            <option value="trial-announcement">Trial Announcement</option>
                            <option value="camp-promotion">Camp Promotion</option>
                            <option value="club-promotion">Club Promotion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="listingPosition">Position (if applicable)</label>
                        <input type="text" id="listingPosition" placeholder="e.g., Goalkeeper, Midfielder">
                    </div>
                    <div class="form-group">
                        <label for="listingAgeGroup">Age Group</label>
                        <select id="listingAgeGroup">
                            <option value="">Any Age</option>
                            <option value="U8">Under 8</option>
                            <option value="U10">Under 10</option>
                            <option value="U12">Under 12</option>
                            <option value="U14">Under 14</option>
                            <option value="U16">Under 16</option>
                            <option value="U18">Under 18</option>
                            <option value="Senior">Senior</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="listingDescription">Requirements & Details</label>
                        <textarea id="listingDescription" rows="3"
                            placeholder="Tell applicants what you're looking for, training days, level, etc..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üìã Create Listing</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createListingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Listing Modal -->
    <div id="editListingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Club Listing</h2>
                <button class="close" onclick="closeModal('editListingModal')">&times;</button>
            </div>
            <form id="editListingForm">
                <input type="hidden" id="editListingId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editListingTitle">Listing Title *</label>
                        <input type="text" id="editListingTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editListingType">Listing Type *</label>
                        <select id="editListingType" required>
                            <option value="player-wanted">Player Wanted</option>
                            <option value="trial-announcement">Trial Announcement</option>
                            <option value="camp-promotion">Camp Promotion</option>
                            <option value="club-promotion">Club Promotion</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editListingPosition">Position (if applicable)</label>
                        <input type="text" id="editListingPosition">
                    </div>
                    <div class="form-group">
                        <label for="editListingAgeGroup">Age Group</label>
                        <select id="editListingAgeGroup">
                            <option value="">Any Age</option>
                            <option value="U8">Under 8</option>
                            <option value="U10">Under 10</option>
                            <option value="U12">Under 12</option>
                            <option value="U14">Under 14</option>
                            <option value="U16">Under 16</option>
                            <option value="U18">Under 18</option>
                            <option value="Senior">Senior</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editListingDescription">Requirements & Details</label>
                        <textarea id="editListingDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editListingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Team Management Modal -->
    <div id="teamManagementModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="teamManagementTitle">‚öΩ Team Management</h2>
                <button class="close" onclick="closeModal('teamManagementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Team management tabs -->
                <div
                    style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid rgba(220, 67, 67, 0.2); padding-bottom: 1rem;">
                    <button class="btn btn-primary btn-small active" onclick="showTeamTab('games')">üèüÔ∏è
                        Games</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('trainings')">üèãÔ∏è
                        Trainings</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('players')">üë•
                        Players</button>
                    <button class="btn btn-secondary btn-small" onclick="showTeamTab('votes')">üìä
                        Votes</button>
                </div>

                <!-- Tab content will be populated by JavaScript -->
                <div id="teamTabContent">
                    <!-- Content based on selected tab -->
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div id="applicationDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="applicationDetailsTitle">üë§ Application Details</h2>
                <button class="close" onclick="closeModal('applicationDetailsModal')">&times;</button>
            </div>
            <div id="applicationDetailsContent">
                <!-- Application details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Add New Product</h2>
                <button class="close" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <form id="addProductForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="productName">Product Name *</label>
                        <input type="text" id="productName" required placeholder="e.g., Club Hoodie">
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price (¬£) *</label>
                        <input type="number" id="productPrice" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock Quantity</label>
                        <input type="number" id="productStock" placeholder="Leave empty for unlimited">
                    </div>
                    <div class="form-group full-width">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="2" placeholder="Product details..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Custom Questions (e.g., Size, Initials)</label>
                        <div id="customQuestionsContainer"
                            style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                            <!-- Dynamic question inputs -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addQuestionField()"
                            style="margin-top: 0.5rem;">+ Add Question</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">‚ûï Add Product</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('addProductModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Product</h2>
                <button class="close" onclick="closeModal('editProductModal')">&times;</button>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editProductName">Product Name *</label>
                        <input type="text" id="editProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductPrice">Price (¬£) *</label>
                        <input type="number" id="editProductPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductStock">Stock Quantity</label>
                        <input type="number" id="editProductStock">
                    </div>
                    <div class="form-group full-width">
                        <label for="editProductDescription">Description</label>
                        <textarea id="editProductDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('editProductModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="createCampaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì£ Create Marketing Campaign</h2>
                <button class="close" onclick="closeModal('createCampaignModal')">&times;</button>
            </div>
            <form id="createCampaignForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="campaignTitle">Campaign Title *</label>
                        <input type="text" id="campaignTitle" required placeholder="e.g., Summer Trial Recruitment">
                    </div>
                    <div class="form-group">
                        <label for="campaignSubject">Email Subject *</label>
                        <input type="text" id="campaignSubject" required placeholder="Don't miss out!">
                    </div>
                    <div class="form-group">
                        <label for="campaignTarget">Target Audience</label>
                        <select id="campaignTarget">
                            <option value="all">All Members</option>
                            <option value="players">Current Players</option>
                            <option value="applicants">Club Applicants</option>
                            <option value="staff">Staff Members</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="campaignMessage">Message Content (HTML Supported)</label>
                        <textarea id="campaignMessage" rows="8" required
                            placeholder="Write your message here..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üì® Create & Send Campaign</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('createCampaignModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Record Match Result Modal -->
    <div id="recordResultModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öΩ Record Match Result</h2>
                <button class="close" onclick="closeModal('recordResultModal')">&times;</button>
            </div>
            <form id="recordResultForm">
                <input type="hidden" id="resultGameId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="homeScore">Our Score</label>
                        <input type="number" id="homeScore" min="0" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="awayScore">Opponent Score</label>
                        <input type="number" id="awayScore" min="0" required placeholder="0">
                    </div>
                    <div class="form-group full-width">
                        <label for="matchSummary">Match Summary</label>
                        <textarea id="matchSummary" rows="3"
                            placeholder="Notes about the performance, top scorers, etc..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Save Result</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('recordResultModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- JavaScript Integration -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="stripe-service.js"></script>
    <script src="script.js"></script>
    <script src="enhanced-invite-system.js"></script>

    <script>
        // üîí AUTHENTICATION GUARD - Prevent unauthorized access
        (function () {
            const token = localStorage.getItem('authToken');
            const currentUser = localStorage.getItem('currentUser');

            if (!token || !currentUser) {
                console.warn('üö´ No authentication found, redirecting to login...');
                window.location.href = 'index.html';
                return;
            }

            // Just verify auth exists - let script.js handle redirect logic
            console.log('‚úÖ Admin authentication verified');
        })();

        function hydrateAddPlayerPlanSelect() {
            const sel = document.getElementById('playerPaymentPlan');
            if (!sel) return;

            const current = sel.value;
            const plans = AppState.paymentPlans || [];

            sel.innerHTML = `
                <option value="">No payment plan</option>
                ${plans.map(plan => {
                const priceNum = Number(plan.price ?? plan.amount ?? 0);
                const interval = (plan.interval ?? plan.frequency ?? '').toString();
                return `<option value="${plan.id}">${plan.name} - ¬£${priceNum.toFixed(2)}/${interval}</option>`;
            }).join('')}
            `;

            // Keep previous selection if it still exists
            if ([...sel.options].some(o => o.value === current)) {
                sel.value = current;
            } else {
                sel.value = '';
            }
        }

        function initAddPlayerFeeField() {
            const planSelect = document.getElementById('playerPaymentPlan');
            const feeInput = document.getElementById('playerFee');
            const feeLabel = document.querySelector('label[for="playerFee"]');
            if (!planSelect || !feeInput) return;

            if (feeLabel) feeLabel.textContent = 'Custom Plan Price (¬£) (optional)';

            function syncFeeInputState() {
                const hasPlan = !!planSelect.value;
                feeInput.disabled = !hasPlan;
                if (!hasPlan) {
                    feeInput.value = '';
                    feeInput.placeholder = 'Select a plan first';
                } else {
                    feeInput.placeholder = 'Leave blank to use plan default';
                }
            }

            syncFeeInputState();
            planSelect.addEventListener('change', syncFeeInputState);
        }

        function initAddPlayerModalControls() {
            hydrateAddPlayerPlanSelect();
            initAddPlayerFeeField();
        }
        async function loadProducts() {
            const container = document.getElementById('productsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const products = await apiService.getProducts(clubId);

                if (!products || products.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üõçÔ∏è</div>
                            <h3 style="margin-bottom: 0.5rem;">No products found</h3>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">Add merchandise or tickets to your club shop.</p>
                            <button class="btn btn-primary" onclick="showModal('addProductModal')">‚ûï Add Your First Product</button>
                        </div>
                    `;
                    return;
                }

                AppState.products = products;

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Product Details</th>
                                    <th>Category</th>
                                    <th style="text-align: center;">Price</th>
                                    <th style="text-align: center;">Stock</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr onclick="editProduct('${product.id}')" style="cursor: pointer;">
                                        <td>
                                            <div style="display:flex; align-items:center; gap:1rem;">
                                                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                                                    ${product.category === 'Apparel' ? 'üëï' : product.category === 'Tickets' ? 'üéüÔ∏è' : 'üì¶'}
                                                </div>
                                                <div style="display: flex; flex-direction: column;">
                                                    <span style="font-weight: 600; color: var(--text-main);">${product.name}</span>
                                                    <span style="font-size: 0.75rem; color: var(--text-muted); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                        ${product.description || 'No description'}
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${product.category || 'General'}
                                            </span>
                                        </td>
                                        <td style="text-align: center; font-weight: 600; color: var(--accent-color);">
                                            ¬£${parseFloat(product.price).toFixed(2)}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="badge" style="background: ${product.stock_quantity > 10 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; color: ${product.stock_quantity > 10 ? '#22c55e' : '#ef4444'}; border: 1px solid ${product.stock_quantity > 10 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 0.25rem 0.75rem; border-radius: 20px;">
                                                ${product.stock_quantity !== null ? product.stock_quantity : '‚àû'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon edit" title="Edit Product" onclick="editProduct('${product.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Delete Product" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load products:', error);
                container.innerHTML = '<p style="color:#dc3545; text-align:center; padding: 2rem;">Failed to load products</p>';
            } finally {
                showLoading(false);
            }
        }

        function addQuestionField() {
            const container = document.getElementById('customQuestionsContainer');
            if (!container) return;
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.gap = '0.5rem';
            div.innerHTML = `
                <input type="text" class="custom-question-input" placeholder="e.g. Size" style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                <button type="button" class="btn btn-secondary btn-small" onclick="this.parentElement.remove()" style="background: #444; border: none; align-self: stretch;">√ó</button>
            `;
            container.appendChild(div);
        }

        async function handleAddProduct(e) {
            if (e) e.preventDefault();

            const customFields = Array.from(document.querySelectorAll('.custom-question-input'))
                .map(input => input.value.trim())
                .filter(val => val !== '');

            const payload = {
                name: document.getElementById('productName').value.trim(),
                price: parseFloat(document.getElementById('productPrice').value),
                stock_quantity: document.getElementById('productStock').value ? parseInt(document.getElementById('productStock').value) : null,
                description: document.getElementById('productDescription').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id),
                custom_fields: customFields
            };

            try {
                showLoading(true);
                await apiService.createProduct(payload);
                showNotification('Product added successfully!', 'success');
                closeModal('addProductModal');
                document.getElementById('addProductForm').reset();
                await loadProducts();
            } catch (error) {
                console.error('Failed to add product:', error);
                showNotification('Failed to add product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editProduct(id) {
            const product = AppState.products?.find(p => p.id === id);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductStock').value = product.stock_quantity;
            document.getElementById('editProductDescription').value = product.description || '';

            showModal('editProductModal');
        }

        async function handleUpdateProduct(e) {
            if (e) e.preventDefault();

            const productId = document.getElementById('editProductId').value;
            const payload = {
                name: document.getElementById('editProductName').value.trim(),
                price: parseFloat(document.getElementById('editProductPrice').value),
                stock_quantity: document.getElementById('editProductStock').value ? parseInt(document.getElementById('editProductStock').value) : null,
                description: document.getElementById('editProductDescription').value.trim()
            };

            try {
                showLoading(true);
                await apiService.updateProduct(productId, payload);
                showNotification('Product updated successfully!', 'success');
                closeModal('editProductModal');
                await loadProducts();
            } catch (error) {
                console.error('Failed to update product:', error);
                showNotification('Failed to update product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                showLoading(true);
                await apiService.deleteProduct(id);
                showNotification('Product deleted successfully!', 'success');
                await loadProducts();
            } catch (error) {
                console.error('Failed to delete product:', error);
                showNotification('Failed to delete product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadCampaigns() {
            const container = document.getElementById('campaignsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const campaigns = await apiService.getCampaigns(clubId);

                if (!campaigns || campaigns.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üì¢</div>
                            <h3 style="margin-bottom: 0.5rem;">No campaigns found</h3>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">Create email or notification campaigns to engage your members.</p>
                            <button class="btn btn-primary" onclick="showModal('createCampaignModal')">‚ûï Create Your First Campaign</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Campaign Name</th>
                                    <th>Subject</th>
                                    <th>Target Group</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.map(campaign => `
                                    <tr>
                                        <td>
                                            <div style="display: flex; flex-direction: column;">
                                                <span style="font-weight: 600; color: var(--text-main);">${campaign.name}</span>
                                                <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                                    Created: ${new Date(campaign.created_at).toLocaleDateString()}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <span style="font-size: 0.875rem; color: var(--text-muted);">${campaign.subject || 'No subject'}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${campaign.target_group || 'All Members'}
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="status-badge status-${(campaign.status || 'draft').toLowerCase()}">
                                                ${campaign.status || 'Draft'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon manage" title="Send Now" onclick="sendCampaign('${campaign.id}')" ${campaign.status === 'sent' ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>üöÄ</button>
                                                <button class="btn-icon edit" title="Edit Campaign" onclick="editCampaign('${campaign.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Delete Campaign" onclick="deleteCampaign('${campaign.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load campaigns:', error);
                container.innerHTML = '<p style="color:#dc3545; text-align:center; padding: 2rem;">Failed to load campaigns</p>';
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateCampaign(e) {
            if (e) e.preventDefault();

            const payload = {
                name: document.getElementById('campaignTitle').value.trim(),
                subject: document.getElementById('campaignSubject').value.trim(),
                target_group: document.getElementById('campaignTarget').value,
                content: document.getElementById('campaignMessage').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                const created = await apiService.createCampaign(payload);
                showNotification('Campaign created and queued for sending!', 'success');
                closeModal('createCampaignModal');
                document.getElementById('createCampaignForm').reset();
                await loadCampaigns();
            } catch (error) {
                console.error('Failed to create campaign:', error);
                showNotification('Failed to create campaign: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function sendCampaign(campaignId) {
            if (!confirm('Are you sure you want to send this campaign email to all targeted members?')) return;

            try {
                showLoading(true);
                await apiService.sendCampaignEmail(campaignId);
                showNotification('Campaign sent successfully!', 'success');
                await loadCampaigns();
            } catch (error) {
                console.error('Failed to send campaign:', error);
                showNotification('Failed to send campaign: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editProduct(productId) {
            showNotification('Product editing coming soon!', 'info');
        }



        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üè¢ Enhanced Admin Dashboard Loading...');

            // Populate user info
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user) {
                const nameDisplay = document.getElementById('adminNameDisplay');
                const avatarDisplay = document.getElementById('adminAvatar');
                if (nameDisplay) nameDisplay.innerText = `Hello, ${user.firstName || user.first_name || 'Admin'}!`;
                if (avatarDisplay) avatarDisplay.innerText = (user.firstName || user.first_name || 'A').charAt(0).toUpperCase();
            }

            // Hide any loading indicators
            const hideAllLoading = () => {
                const loadingElements = document.querySelectorAll('.loading, [data-loading="true"]');
                loadingElements.forEach(el => {
                    el.style.display = 'none';
                    el.remove();
                });
                document.body.classList.remove('loading');
                AppState.isLoading = false;
            };

            try {
                // Determine active club ID from session/user if available
                const activeClubId = user?.clubId || user?.currentOrganizationId || null;
                console.log('üìä Fetching dashboard for Club ID:', activeClubId || 'All');

                const dashboardData = await apiService.getAdminDashboardData(activeClubId);

                if (dashboardData) {
                    AppState.clubs = dashboardData.clubs || [];

                    // Priority: activeClubId from user > first club in list
                    AppState.activeClubId = activeClubId || (AppState.clubs[0]?.id);

                    AppState.players = dashboardData.players || [];
                    AppState.staff = dashboardData.staff || [];
                    AppState.events = dashboardData.events || [];
                    AppState.teams = dashboardData.teams || [];
                    AppState.payments = dashboardData.payments || [];
                    updateDashboardStats(dashboardData.statistics);

                    // Initial Gallery Load
                    const activeClub = AppState.clubs.find(c => c.id == AppState.activeClubId);
                    if (activeClub && activeClub.images) {
                        displayClubImages(activeClub.images);
                    }
                }

                // ‚úÖ Load payment plans first so we can enrich players
                await loadPaymentPlans();

                // then render the rest
                loadDashboardStats();
                await loadPlayers();        // ‚Üê now after plans
                loadTeams();
                loadEvents();
                loadFinances();
                initAddPlayerModalControls();
                checkAndConfigureStripe();

                console.log('‚úÖ Admin Dashboard loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load dashboard:', error);
                showNotification('Failed to load dashboard data: ' + (error.message || 'Unknown error'), 'error');
            } finally {
                // Always hide loading, even if there's an error
                hideAllLoading();
            }

            setupEnhancedEventListeners();
        });

        async function checkAndConfigureStripe() {
            const btn = document.getElementById('stripeAccessBtn');
            if (!btn) return;

            try {
                const status = await apiService.makeRequest('/payments/stripe/connect/status');
                AppState.stripeStatus = status;

                if (status.stripeAccountId && status.details_submitted) {
                    btn.innerHTML = '‚úÖ Connected - View Dashboard';
                    btn.classList.add('connected');
                    btn.onclick = accessStripeAccount;

                    // Auto-sync payout schedule
                    console.log('üí≥ Stripe connected, ensuring monthly payout schedule (1st of month)');
                    try {
                        await apiService.makeRequest(`/stripe-payouts/configure-payout/${status.stripeAccountId}`, {
                            method: 'POST'
                        });

                        // If we are connected but have no plans, the backend might have just auto-synced them.
                        // Reload plans to ensure they show up immediately.
                        if (!AppState.paymentPlans || AppState.paymentPlans.length === 0) {
                            console.log('üîÑ Checking for auto-synced plans...');
                            await loadPaymentPlans();
                        }
                    } catch (e) {
                        console.log('Schedule sync skipped');
                    }
                } else {
                    btn.innerHTML = '‚ö†Ô∏è Connect Stripe Account';
                    btn.classList.remove('connected');
                    btn.onclick = startStripeOnboarding;
                    showNotification('Please connect your Stripe account to start accepting payments.', 'info');
                }
            } catch (err) {
                console.log('Stripe status check failed:', err);
                btn.innerHTML = 'Connect Stripe Account';
                btn.onclick = startStripeOnboarding;
            }
        }

        async function startStripeOnboarding() {
            try {
                showLoading(true);
                const result = await apiService.getStripeOnboardLink();
                if (result && result.url) {
                    window.location.href = result.url;
                } else {
                    showNotification('Could not generate onboarding link', 'error');
                }
            } catch (error) {
                showNotification('Failed to start onboarding: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        window.startStripeOnboarding = startStripeOnboarding;




        // Enhanced Event Listeners
        function setupEnhancedEventListeners() {
            /* Redundant listeners removed - they cause double calls since HTML has onclick */


            // Player form
            const addPlayerForm = document.getElementById('addPlayerForm');
            if (addPlayerForm) {
                addPlayerForm.addEventListener('submit', handleAddPlayer);
            }

            const editPlayerForm = document.getElementById('editPlayerForm');
            if (editPlayerForm) {
                editPlayerForm.addEventListener('submit', handleEditPlayer);
            }

            // Team form  
            const addTeamForm = document.getElementById('addTeamForm');
            if (addTeamForm) {
                addTeamForm.addEventListener('submit', handleAddTeam);
            }

            // Event form
            const addEventForm = document.getElementById('addEventForm');
            if (addEventForm) {
                addEventForm.addEventListener('submit', handleAddEvent);
            }

            // Payment plan form
            const createPaymentPlanForm = document.getElementById('createPaymentPlanForm');
            if (createPaymentPlanForm) {
                createPaymentPlanForm.addEventListener('submit', handleCreatePaymentPlan);
            }

            const editPaymentPlanForm = document.getElementById('editPaymentPlanForm');
            if (editPaymentPlanForm) {
                editPaymentPlanForm.addEventListener('submit', handleUpdatePaymentPlan);
            }

            // Staff invite form
            const inviteStaffForm = document.getElementById('inviteStaffForm');
            if (inviteStaffForm) {
                inviteStaffForm.addEventListener('submit', handleStaffInvite);
            }

            // New Team Management Forms
            const editTeamForm = document.getElementById('editTeamForm');
            if (editTeamForm) {
                editTeamForm.addEventListener('submit', handleUpdateTeam);
            }

            const addPlayerToTeamForm = document.getElementById('addPlayerToTeamForm');
            if (addPlayerToTeamForm) {
                addPlayerToTeamForm.addEventListener('submit', handleAddPlayerToTeam);
            }
            // Club profile form
            const clubProfileForm = document.getElementById('clubProfileForm');
            if (clubProfileForm) {
                clubProfileForm.addEventListener('submit', handleClubProfileUpdate);
            }

            // Item Shop form
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', handleAddProduct);
            }

            const editProductForm = document.getElementById('editProductForm');
            if (editProductForm) {
                editProductForm.addEventListener('submit', handleUpdateProduct);
            }

            // Drag and Drop for Club Pictures
            const dropArea = document.getElementById('clubPicturesArea');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
                });

                dropArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handlePictureUpload({ files: files, value: '' });
                }, false);
            }

            // Marketing Hub form
            const createCampaignForm = document.getElementById('createCampaignForm');
            if (createCampaignForm) {
                createCampaignForm.addEventListener('submit', handleCreateCampaign);
            }

            const createListingForm = document.getElementById('createListingForm');
            if (createListingForm) {
                createListingForm.addEventListener('submit', handleCreateListing);
            }

            const editListingForm = document.getElementById('editListingForm');
            if (editListingForm) {
                editListingForm.addEventListener('submit', handleUpdateListing);
            }

            // Results form
            const recordResultForm = document.getElementById('recordResultForm');
            if (recordResultForm) {
                recordResultForm.addEventListener('submit', handleRecordResult);
            }

            // Assign Plan Form
            const assignPlanForm = document.getElementById('assignPlanForm');
            if (assignPlanForm) {
                assignPlanForm.addEventListener('submit', handleAssignPlanSubmit);
            }
        }

        // Enhanced Player Filtering Functions
        // Redundant filtering functions removed to prevent conflicts with loadPlayers()





        async function handleAssignPlanSubmit(e) {
            e.preventDefault();

            const userId = document.getElementById('assignPlanUserId').value;
            const planId = document.getElementById('assignPlanSelect').value;
            const startDate = document.getElementById('assignPlanStartDate').value;

            if (!userId || !planId) return;

            try {
                showLoading(true);
                // Use bulk-assign (which handles single user too via our wrapper)
                await apiService.assignPlanToPlayer(userId, planId, startDate);

                showNotification('Payment plan assigned successfully!', 'success');
                closeModal('assignPlanModal');
                await loadPlayers(); // Refresh list to show badge
            } catch (error) {
                console.error('Failed to assign plan:', error);
                showNotification('Failed to assign plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        // Enhanced Team Management Functions


        async function showTeamTab(tabName, teamId, ev) {
            const tabButtons = document.querySelectorAll('.team-management-tabs button');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            if (ev && ev.currentTarget) {
                ev.currentTarget.classList.add('active');
            } else {
                // when called programmatically, select the matching button
                const btn = Array.from(tabButtons).find(b => b.getAttribute('onclick')?.includes(`'${tabName}'`));
                if (btn) btn.classList.add('active');
            }

            const tabContent = document.getElementById('teamTabContent');
            if (!tabContent) return;

            tabContent.innerHTML = '<div class="spinner"></div> Loading...';

            try {
                if (tabName === 'games') await loadTeamGames(teamId, tabContent);
                else if (tabName === 'trainings') await loadTeamTrainings(teamId, tabContent);
                else if (tabName === 'players') await loadTeamPlayers(teamId, tabContent);
                else if (tabName === 'votes') await loadTeamVotes(teamId, tabContent);
                else if (tabName === 'tactical') await loadTeamTacticalBoard(teamId, tabContent);
            } catch (error) {
                console.error(`Failed to load team ${tabName}:`, error);
                tabContent.innerHTML = `<p style="color: #dc3545;">Failed to load ${tabName}</p>`;
            }
        }

        async function loadTeamGames(teamId, container) {
            const games = await apiService.getTeamEvents(teamId, 'match');

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üèüÔ∏è Team Games & Matches</h4>
            <button class="btn btn-primary" onclick="createTeamGame('${teamId}')">‚ûï Create Game</button>
        </div>
        
        <div id="teamGames">
            ${games.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No games scheduled yet</p>' :
                    games.map(game => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${game.title}</h5>
                            <p><strong>Date:</strong> ${new Date(game.event_date).toLocaleDateString()}</p>
                            <p><strong>Opponent:</strong> ${game.opponent || 'TBA'}</p>
                            <p><strong>Location:</strong> ${game.location || 'TBA'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-success" onclick="openRecordResult('${game.id}')">üèÜ Result</button>
                            <button class="btn btn-small btn-secondary" onclick="editTeamEvent('${game.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTeamEvent('${game.id}')">Delete</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        function openRecordResult(gameId) {
            const hiddenInput = document.getElementById('resultGameId');
            if (hiddenInput) hiddenInput.value = gameId;
            showModal('recordResultModal');
        }

        async function handleRecordResult(e) {
            if (e) e.preventDefault();
            const gameId = document.getElementById('resultGameId').value;
            const payload = {
                score: {
                    home: parseInt(document.getElementById('homeScore').value),
                    away: parseInt(document.getElementById('awayScore').value)
                },
                summary: document.getElementById('matchSummary').value
            };

            try {
                showLoading(true);
                await apiService.submitGameResult(gameId, payload);
                showNotification('Match result recorded!', 'success');
                closeModal('recordResultModal');
                // Could refresh games tab if we store teamId somewhere
            } catch (error) {
                showNotification('Failed to save result: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadTeamTrainings(teamId, container) {
            const trainings = await apiService.getTeamEvents(teamId, 'training');

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üèãÔ∏è Training Sessions</h4>
            <button class="btn btn-primary" onclick="createTeamTraining('${teamId}')">‚ûï Create Training</button>
        </div>
        
        <div id="teamTrainings">
            ${trainings.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No training sessions scheduled</p>' :
                    trainings.map(training => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${training.title}</h5>
                            <p><strong>Date:</strong> ${new Date(training.event_date).toLocaleDateString()}</p>
                            <p><strong>Time:</strong> ${training.event_time || 'TBA'}</p>
                            <p><strong>Location:</strong> ${training.location || 'TBA'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-secondary" onclick="editTeamEvent('${training.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTeamEvent('${training.id}')">Delete</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        async function loadTeamPlayers(teamId, container) {
            const teamDetails = await apiService.getTeamDetails(teamId);
            const players = teamDetails.players || [];

            container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h4>üë• Team Players (${players.length})</h4>
            <button class="btn btn-primary" onclick="addPlayerToTeam('${teamId}')">‚ûï Add Player</button>
        </div>
        
        <div id="teamPlayers">
            ${players.length === 0 ?
                    '<p style="text-align: center; opacity: 0.8;">No players assigned to this team yet</p>' :
                    players.map(player => `
                    <div class="event-item">
                        <div class="event-info">
                            <h5>${player.first_name} ${player.last_name}</h5>
                            <p><strong>Position:</strong> ${player.team_position || 'Not set'}</p>
                            <p><strong>Jersey:</strong> ${player.jersey_number || 'Not assigned'}</p>
                            <p><strong>Email:</strong> ${player.email || 'No email'}</p>
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small btn-secondary" onclick="editPlayerTeamInfo('${teamId}', '${player.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="removePlayerFromTeam('${teamId}', '${player.id}')">Remove</button>
                        </div>
                    </div>
                `).join('')
                }
        </div>
    `;
        }

        async function loadTeamVotes(teamId, container) {
            try {
                const votes = await apiService.getTeamVotes(teamId);
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h4>üìä Team Availability Votes</h4>
                    </div>
                    <div id="teamVotes">
                        ${votes.length === 0 ?
                        '<p style="text-align: center; opacity: 0.8;">No availability votes yet.</p>' :
                        votes.map(v => `
                                <div class="event-item">
                                    <div class="event-info">
                                        <h5>${v.player_name || 'Player'}</h5>
                                        <p><strong>Status:</strong> ${v.available ? '‚úÖ Available' : '‚ùå Unavailable'}</p>
                                        <p><strong>Event:</strong> ${v.event_title || 'Upcoming Event'}</p>
                                    </div>
                                </div>
                            `).join('')
                    }
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:red">Failed to load votes.</p>';
            }
        }

        async function loadTeamTacticalBoard(teamId, container) {
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h4>üìã Team Tactical Board</h4>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <select id="adminFormationSelect" class="btn btn-small btn-secondary" style="width: auto; padding: 0.3rem 1rem;" onchange="setAdminFormation()">
                            <option value="4-4-2">4-4-2</option>
                            <option value="4-3-3">4-3-3</option>
                            <option value="3-5-2">3-5-2</option>
                            <option value="4-2-3-1">4-2-3-1</option>
                        </select>
                        <button class="btn btn-small btn-secondary" onclick="clearAdminBoard()">üßπ Clear</button>
                    </div>
                </div>
                
                <div id="adminTacticalBoard" class="tactical-board" style="height: 500px; position: relative; margin-bottom: 2rem;">
                    <div style="position: absolute; top: 0; left: 25%; width: 50%; height: 15%; border: 2px solid white; border-top: none;"></div>
                    <div style="position: absolute; bottom: 0; left: 25%; width: 50%; height: 15%; border: 2px solid white; border-bottom: none;"></div>
                    <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 0; border-top: 2px solid white;"></div>
                    <div style="position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%);"></div>
                </div>

                <div class="card">
                    <h5>üë• Players to Assign</h5>
                    <div id="adminAvailablePlayers" style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem;">
                    </div>
                </div>
            `;

            window.selectedAdminPosition = undefined;
            setTimeout(() => {
                setAdminFormation();
                loadAdminAvailablePlayers(teamId);
            }, 50);
        }

        function setAdminFormation() {
            const formation = document.getElementById('adminFormationSelect')?.value || '4-4-2';
            const board = document.getElementById('adminTacticalBoard');
            if (!board) return;

            const markers = board.querySelectorAll('.player-position');
            markers.forEach(m => m.remove());

            const formations = {
                '4-4-2': [
                    { x: 50, y: 85 }, { x: 20, y: 65 }, { x: 40, y: 65 }, { x: 60, y: 65 }, { x: 80, y: 65 },
                    { x: 25, y: 45 }, { x: 45, y: 45 }, { x: 55, y: 45 }, { x: 75, y: 45 }, { x: 40, y: 25 }, { x: 60, y: 25 }
                ],
                '4-3-3': [
                    { x: 50, y: 85 }, { x: 20, y: 65 }, { x: 40, y: 65 }, { x: 60, y: 65 }, { x: 80, y: 65 },
                    { x: 30, y: 45 }, { x: 50, y: 45 }, { x: 70, y: 45 }, { x: 25, y: 25 }, { x: 50, y: 25 }, { x: 75, y: 25 }
                ]
            };

            const positions = formations[formation] || formations['4-4-2'];
            positions.forEach((pos, i) => {
                const el = document.createElement('div');
                el.className = 'player-position';
                el.style.left = `${pos.x}%`;
                el.style.top = `${pos.y}%`;
                el.textContent = i + 1;
                el.onclick = () => {
                    document.querySelectorAll('.player-position').forEach(p => p.classList.remove('selected'));
                    el.classList.add('selected');
                    window.selectedAdminPosition = i;
                };
                board.appendChild(el);
            });
        }

        async function loadAdminAvailablePlayers(teamId) {
            const container = document.getElementById('adminAvailablePlayers');
            if (!container) return;

            try {
                const team = await apiService.getTeamDetails(teamId);
                const players = team.players || [];

                if (players.length === 0) {
                    container.innerHTML = '<p style="opacity:0.6; font-size:0.9rem;">No players assigned to this team yet.</p>';
                    return;
                }

                container.innerHTML = players.map(p => `
                    <div class="available-player" onclick="assignPlayerToBoard('${p.id}', '${p.first_name[0]}${p.last_name[0]}')" 
                        style="padding: 0.5rem 1rem; background: rgba(0,0,0,0.05); border-radius: 20px; cursor: pointer; border: 1px solid rgba(220,67,67,0.2); font-size: 0.85rem;">
                        ${p.first_name} ${p.last_name}
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load players for tactical board:', err);
            }
        }

        function assignPlayerToBoard(playerId, initials) {
            if (window.selectedAdminPosition === undefined) {
                return showNotification('Select a position on the board first!', 'warning');
            }

            const markers = document.querySelectorAll('.player-position');
            const target = markers[window.selectedAdminPosition];
            if (target) {
                target.textContent = initials;
                target.classList.add('assigned');
                target.classList.remove('selected');
                window.selectedAdminPosition = undefined;
                showNotification('Player assigned to position!', 'success');
            }
        }

        function clearAdminBoard() {
            setAdminFormation();
            showNotification('Board cleared', 'info');
        }

        function saveAdminFormation() {
            showNotification('Tactical layout saved!', 'success');
        }

        // Enhanced Staff Invite Functions
        function generateStaffInvite(role) {
            console.log('üìß Generating staff invite for role:', role);

            // Pre-fill the invite form based on role
            const roleSelect = document.getElementById('staffInviteRole');
            if (roleSelect) {
                if (role === 'coach') {
                    roleSelect.value = 'coach';
                } else if (role === 'assistant') {
                    roleSelect.value = 'assistant-coach';
                } else if (role === 'admin') {
                    roleSelect.value = 'administrator';
                }
            }

            showModal('inviteStaffModal');
        }

        async function loadPaymentPlans() {
            const container = document.getElementById('paymentPlansContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const plans = await apiService.listPaymentPlans(clubId);

                if (!plans || plans.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: left; padding: 2rem 0; opacity: 0.8;">
                            <p style="font-weight: 600;">No payment plans created yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; color: var(--text-muted);">Create your first payment plan to start managing player subscriptions</p>
                            <button class="btn btn-primary" onclick="showModal('createPaymentPlanModal')" style="margin-top: 1.5rem;">‚ûï Create Your First Plan</button>
                        </div>
                    `;
                    AppState.paymentPlans = [];
                    return;
                }

                AppState.paymentPlans = plans;

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Plan Name</th>
                                    <th>Amount</th>
                                    <th>Billing Frequency</th>
                                    <th>Description</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${plans.map(plan => {
                    const amountNum = Number(plan.amount ?? plan.price ?? 0);
                    let interval = (plan.interval ?? plan.frequency ?? '').toString();
                    interval = interval.charAt(0).toUpperCase() + interval.slice(1);

                    return `
                                    <tr>
                                        <td>
                                            <span style="font-weight: 600; color: var(--text-main);">${plan.name}</span>
                                        </td>
                                        <td><strong>¬£${amountNum.toFixed(2)}</strong></td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${interval}${plan.billing_anchor_type === 'fixed_date' ? ` (on ${plan.billing_anchor_day}${getOrdinal(plan.billing_anchor_day)})` : ' (at signup)'}
                                            </span>
                                        </td>
                                        <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-muted); font-size: 0.9rem;">
                                            ${plan.description || '-'}
                                        </td>
                                        <td style="text-align: right;">
                                            <div class="action-buttons" style="justify-content: flex-end;">
                                                <button class="btn-icon edit" title="Edit Plan" onclick="editPaymentPlan('${plan.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon" title="Bulk Assign" onclick="premiumBulkAssignPlan('${plan.id}')" style="background: rgba(255, 152, 0, 0.1); color: #ff9800; border: 1px solid rgba(255, 152, 0, 0.2);">üë•</button>
                                                <button class="btn-icon delete" title="Delete Plan" onclick="deletePaymentPlan('${plan.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                AppState.paymentPlans = plans;
            } catch (error) {
                console.error('Failed to load payment plans:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <p>Failed to load payment plans</p>
                        <button class="btn btn-primary" onclick="loadPaymentPlans()" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        async function loadFinances() {
            try {
                const clubId = await getActiveClubId();
                if (!clubId) return;

                // Load payments for financial overview
                const payments = await apiService.getPayments({ clubId });

                // Calculate financial statistics
                const monthlyRevenue = payments
                    .filter(p => p.payment_status === 'paid')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const overdueAmount = payments
                    .filter(p => p.payment_status === 'overdue')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const pendingAmount = payments
                    .filter(p => p.payment_status === 'pending')
                    .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);

                const totalMembers = payments.length;

                // Update finance overview
                document.getElementById('monthlyRevenue').textContent = `¬£${monthlyRevenue.toFixed(2)} `;
                document.getElementById('overdueAmount').textContent = `¬£${overdueAmount.toFixed(2)} `;
                document.getElementById('pendingAmount').textContent = `¬£${pendingAmount.toFixed(2)} `;
                document.getElementById('totalMembers').textContent = totalMembers;

                // Load recent payments table
                const paymentsTableBody = document.getElementById('paymentsTableBody');
                if (paymentsTableBody) {
                    paymentsTableBody.innerHTML = payments.slice(0, 10).map(payment => `
                        <tr>
                            <td>${payment.player_first_name} ${payment.player_last_name}</td>
                            <td>¬£${parseFloat(payment.amount || 0).toFixed(2)}</td>
                            <td><span class="status-badge status-${payment.payment_status}">${payment.payment_status}</span></td>
                            <td>${new Date(payment.due_date).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-small btn-secondary" onclick="editPayment('${payment.id}')">Edit</button>
                                <button class="btn btn-small btn-primary" onclick="generatePaymentLink('${payment.id}')">Link</button>
                            </td>
                        </tr>
                    `).join('');
                }

            } catch (error) {
                console.error('Failed to load finances:', error);
            }
        }



        function showLoading(show) {
            const existingLoader = document.querySelector('.global-loader');

            if (show) {
                if (!existingLoader) {
                    const loader = document.createElement('div');
                    loader.className = 'global-loader';
                    loader.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2rem; border-radius: 8px; z-index: 10000; text-align: center;">
                            <div class="spinner"></div>
                            Loading...
                        </div>
                    `;
                    document.body.appendChild(loader);
                }
            } else {
                if (existingLoader) {
                    existingLoader.remove();
                }
            }
        }

        // Enhanced Listings Functions
        async function loadListings() {
            const container = document.getElementById('activeListingsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const listings = await apiService.getListings(clubId);
                const clubApplications = await apiService.getClubApplications(clubId);

                AppState.listings = listings;
                AppState.clubApplications = clubApplications;

                if ((!listings || listings.length === 0) && (!clubApplications || clubApplications.length === 0)) {
                    container.innerHTML = `
                        <div style="text-align: left; padding: 3rem 0; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">üìù</div>
                            <h3 style="margin-bottom: 0.5rem; font-weight: 700;">No active listings or applications</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">Create a listing to start reaching new players and staff.</p>
                            <button class="btn btn-primary" onclick="showModal('createListingModal')">‚ûï Create Your First Listing</button>
                        </div>
                    `;
                    return;
                }

                let html = '';

                // 1. Listings Table
                if (listings && listings.length > 0) {
                    html += `
                     <h3 style="margin-bottom: 1rem;">Active Listings</h3>
                     <div class="table-responsive" style="margin-bottom: 2rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Listing Title / Type</th>
                                    <th>Position</th>
                                    <th style="text-align: center;">Applicants</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${listings.map(listing => `
                                    <tr onclick="viewListingApplications('${listing.id}')" style="cursor: pointer;">
                                        <td>
                                            <div style="display: flex; flex-direction: column;">
                                                <span style="font-weight: 600; color: var(--text-main);">${listing.title}</span>
                                                <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${listing.listing_type}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${listing.position || 'N/A'}
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">
                                                ${listing.application_count || 0} Applicants
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon edit" title="Edit Listing" onclick="editListing('${listing.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Delete Listing" onclick="deleteListing('${listing.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }

                // 2. General Applications Table
                if (clubApplications && clubApplications.length > 0) {
                    html += `
                    <h3 style="margin-bottom: 1rem;">General Club Applications</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Applicant</th>
                                    <th>Position / Level</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clubApplications.map(app => `
                                    <tr onclick="viewApplicationDetails('${app.id}')" style="cursor: pointer;">
                                        <td>
                                            <div class="user-info-cell">
                                                <div class="user-avatar" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                                    ${(app.first_name?.[0] || 'A')}${(app.last_name?.[0] || '')}
                                                </div>
                                                <div class="user-name-group">
                                                    <span class="user-name">${app.first_name || 'Applicant'} ${app.last_name || ''}</span>
                                                    <span class="user-meta">${app.email || 'No email provided'}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display: flex; flex-direction: column;">
                                                <span>${app.preferred_position || 'Any'}</span>
                                                <span style="font-size: 0.75rem; color: var(--text-muted);">${app.experience_level || 'N/A'}</span>
                                            </div>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="status-badge status-${(app.application_status || 'pending').toLowerCase()}">
                                                ${(app.application_status || 'Pending')}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon manage" title="Review" onclick="reviewApplication('${app.id}')">üìã</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }

                container.innerHTML = html;
                return; // Handled


                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Listing Title / Type</th>
                                    <th>Position</th>
                                    <th style="text-align: center;">Applicants</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${listings.map(listing => `
                                    <tr onclick="viewListingApplications('${listing.id}')" style="cursor: pointer;">
                                        <td>
                                            <div style="display: flex; flex-direction: column;">
                                                <span style="font-weight: 600; color: var(--text-main);">${listing.title}</span>
                                                <span style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${listing.listing_type}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${listing.position || 'N/A'}
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="badge" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px;">
                                                ${listing.application_count || 0} Applicants
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon edit" title="Edit Listing" onclick="editListing('${listing.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Delete Listing" onclick="deleteListing('${listing.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('Failed to load listings:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load listings</p>';
            } finally {
                showLoading(false);
            }
        }

        async function viewListingApplications(listingId) {
            const container = document.getElementById('applicationsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const applications = await apiService.getApplications(listingId);
                AppState.currentListingApplications = applications;

                if (!Array.isArray(applications) || applications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ù</div>
                            <h3 style="margin-bottom: 0.5rem;">No applications yet</h3>
                            <p style="color: var(--text-muted);">Applications for this listing will appear here.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Applicant</th>
                                    <th>Preferred Position</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${applications.map(app => {
                    const status = app.status || 'pending';
                    return `
                                    <tr onclick="viewApplicantDetails('${app.id}')" style="cursor: pointer;">
                                        <td>
                                            <div class="user-info-cell">
                                                <div class="user-avatar" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                                    ${(app.first_name?.[0] || 'A')}${(app.last_name?.[0] || '')}
                                                </div>
                                                <div class="user-name-group">
                                                    <span class="user-name">${app.first_name || 'Applicant'} ${app.last_name || ''}</span>
                                                    <span class="user-meta">${app.email || 'No email provided'}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${app.preferred_position || app.position || 'N/A'}
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="status-badge status-${status.toLowerCase()}">
                                                ${status.charAt(0).toUpperCase() + status.slice(1)}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                ${status === 'pending' ? `
                                                    <button class="btn-icon manage" title="Accept & Invite" onclick="acceptApplicant('${app.id}')">‚úÖ</button>
                                                    <button class="btn-icon delete" title="Reject Application" onclick="rejectApplicant('${app.id}')">‚ùå</button>
                                                ` : ''}
                                                <button class="btn-icon edit" title="View Details" onclick="viewApplicantDetails('${app.id}')">üëÅÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('Failed to load applications:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load applications</p>';
            } finally {
                showLoading(false);
            }
        }

        async function acceptApplicant(applicationId) {
            if (!confirm('Accepting this applicant will reveal their contact details and send an invitation. Proceed?')) return;
            try {
                showLoading(true);
                await apiService.acceptApplicant(applicationId);
                showNotification('Applicant accepted! Contact details unlocked.', 'success');
                // Refresh applications view or state
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicationId}"])`);
                if (appItem) {
                    const contact = appItem.querySelector('.contact-details');
                    if (contact) contact.style.display = 'block';
                    appItem.setAttribute('data-status', 'accepted');
                    const btn = appItem.querySelector('.btn-success');
                    if (btn) btn.remove();
                }
            } catch (error) {
                showNotification('Action failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function rejectApplicant(applicationId) {
            const reason = prompt('Please provide a reason for rejection (this will be emailed to the candidate):');
            if (reason === null) return;

            try {
                showLoading(true);
                await apiService.rejectApplicant(applicationId, reason);
                showNotification('Applicant rejected and notified.', 'info');
                // Refresh view or state
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicationId}"])`);
                if (appItem) {
                    appItem.setAttribute('data-status', 'rejected');
                    const actions = appItem.querySelector('.application-actions');
                    if (actions) {
                        actions.querySelectorAll('.btn-success, .btn-danger').forEach(b => b.remove());
                    }
                }
            } catch (error) {
                showNotification('Action failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateListing(e) {
            if (e) e.preventDefault();
            const clubId = await getActiveClubId();
            if (!clubId) return showNotification('No club context found', 'error');

            const payload = {
                title: document.getElementById('listingTitle').value,
                listing_type: document.getElementById('listingType').value,
                position: document.getElementById('listingPosition').value,
                age_group: document.getElementById('listingAgeGroup').value,
                description: document.getElementById('listingDescription').value,
                requirements: document.getElementById('listingRequirements').value,
                clubId: clubId
            };

            try {
                showLoading(true);
                await apiService.createListing(payload);
                showNotification('Listing created successfully!', 'success');
                closeModal('createListingModal');
                loadListings();
            } catch (error) {
                showNotification('Failed to create listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function getActiveClubId() {
            if (AppState.activeClubId) return AppState.activeClubId;
            if (AppState.clubs && AppState.clubs.length > 0) return AppState.clubs[0].id;

            // Fallback to checking apiService context directly or the global currentOrgId
            try {
                if (typeof currentOrgId !== 'undefined' && currentOrgId) return currentOrgId;
                const context = await apiService.getContext();
                if (context.organization?.id) {
                    AppState.activeClubId = context.organization.id;
                    return context.organization.id;
                }
            } catch (e) {
                console.warn('Failed to resolve club ID:', e);
            }
            return null;
        }

        async function viewApplicantDetails(applicationId) {
            const content = document.getElementById('applicationDetailsContent');
            if (!content) return;
            showModal('applicationDetailsModal');
            content.innerHTML = `
                <div class="application-detail">
                    <h4>üë§ Applicant Details</h4>
                    <p><strong>Application ID:</strong> ${applicationId}</p>
                    <p>Status: Under Review</p>
                    <hr style="margin: 1rem 0; opacity: 0.1;">
                    <p>Detailed profile information and contact details are automatically revealed once the applicant is accepted.</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="closeModal('applicationDetailsModal')">Close</button>
                    </div>
                </div>
            `;
        }

        async function shortlistApplicant(applicantId) {
            try {
                showLoading(true);
                await apiService.makeRequest(`/applications/${applicantId}/shortlist`, { method: 'POST' });
                showNotification('Applicant shortlisted!', 'success');

                // Update UI
                const appItem = document.querySelector(`.application-item:has(button[onclick*="${applicantId}"])`);
                if (appItem) {
                    appItem.classList.add('shortlisted');
                    appItem.style.background = 'rgba(255, 215, 0, 0.05)';
                }
            } catch (error) {
                showNotification('Failed to shortlist: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function inviteToSession(applicantId) {
            const sessionDetails = prompt('Enter trial session details (date, time, location):');
            if (!sessionDetails) return;

            try {
                showLoading(true);
                await apiService.makeRequest(`/applications/${applicantId}/invite`, {
                    method: 'POST',
                    body: JSON.stringify({ sessionDetails })
                });
                showNotification('Invitation to trial session sent!', 'success');
            } catch (error) {
                showNotification('Failed to send invitation: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleStaffInvite(e) {
            if (e) e.preventDefault();

            const payload = {
                email: document.getElementById('staffInviteEmail').value.trim(),
                firstName: document.getElementById('staffInviteFirstName').value.trim(),
                lastName: document.getElementById('staffInviteLastName').value.trim(),
                role: document.getElementById('staffInviteRole').value,
                teamId: document.getElementById('staffInviteTeam').value || null,
                permissions: Array.from(document.querySelectorAll('input[name="staffPermissions"]:checked')).map(cb => cb.value)
            };

            try {
                showLoading(true);
                // In demo session, just simulate success
                if (localStorage.getItem('isDemoSession') === 'true') {
                    await new Promise(r => setTimeout(r, 800));
                    showNotification(`Demo: Staff invite sent to ${payload.email}`, 'success');
                } else {
                    await apiService.generateClubInvite({
                        email: payload.email,
                        firstName: payload.firstName,
                        lastName: payload.lastName,
                        clubRole: payload.role,
                        message: `You have been invited to join our staff as a ${payload.role}.`,
                        sendEmail: true
                    });
                    showNotification('Staff invitation sent successfully!', 'success');
                }
                closeModal('inviteStaffModal');
                document.getElementById('inviteStaffForm').reset();
            } catch (error) {
                console.error('Failed to invite staff:', error);
                showNotification('Failed to send invitation: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load Staff Members
        async function loadStaff() {
            const container = document.getElementById('staffContainer');
            if (!container) {
                console.error('‚ùå staffContainer not found!');
                return;
            }
            container.classList.remove('card-grid');

            console.log('üë®‚Äçüíº Loading staff members...');

            // Show loading state immediately
            container.innerHTML = '<p style="text-align: center; padding: 2rem;">Loading staff members...</p>';

            try {
                showLoading(true);
                const clubId = await getActiveClubId();

                if (!clubId) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                            <p>No club ID found. Please select a club first.</p>
                        </div>
                    `;
                    return;
                }

                // Use the consolidated getStaff method with demo fallback support
                const staff = await apiService.getStaff(clubId);

                if (!staff || staff.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: left; padding: 3rem 0; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">üëî</div>
                            <h3 style="margin-bottom: 0.5rem; font-weight: 700;">No staff members yet</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">Invite coaches and assistants to help manage your club.</p>
                            <button class="btn btn-primary" onclick="showModal('inviteStaffModal')">‚ûï Invite Staff Member</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 25%;">Staff Member</th>
                                    <th>Role</th>
                                    <th>Assigned Team</th>
                                    <th>Email</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${staff.map(member => {
                    const isCoach = ['coach', 'assistant-coach'].includes(member.role);
                    let teamDisplay = '-';
                    if (isCoach) {
                        teamDisplay = member.team_name ?
                            `<span style="color: var(--primary-color);">‚öΩ ${member.team_name}</span>` :
                            '<span style="opacity: 0.5;">Unassigned</span>';
                    }

                    return `
                                    <tr onclick="editStaffMember('${member.id}')" style="cursor: pointer;">
                                        <td>
                                            <div class="user-info-cell">
                                                <div class="user-avatar">${(member.first_name?.[0] || '')}${(member.last_name?.[0] || '')}</div>
                                                <div class="user-name-group">
                                                    <span class="user-name">${member.first_name} ${member.last_name}</span>
                                                    <span class="user-meta">Staff ID: ${member.id.substring(0, 8)}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span style="font-weight:500; text-transform: capitalize;">${member.role.replace('-', ' ')}</span>
                                        </td>
                                        <td>${teamDisplay}</td>
                                        <td>${member.email || 'N/A'}</td>
                                        <td style="text-align: center;">
                                            <span class="status-badge status-${(member.status || 'active').toLowerCase()}">${member.status || 'Active'}</span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon edit" title="Edit Staff" onclick="editStaffMember('${member.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Remove Staff" onclick="removeStaffMember('${member.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;


                console.log(`‚úÖ Loaded ${staff.length} staff members`);

            } catch (error) {
                console.error('Failed to load staff:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color:#dc3545">Failed to load staff members</p>
                        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">${error.message}</p>
                        <button class="btn btn-secondary" onclick="loadStaff()" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        // Load Talent ID Dashboard
        async function loadTalentIdDashboard() {
            console.log('üìä Loading Talent ID Dashboard...');
            const container = document.getElementById('talentEventSelect');
            if (!container) {
                console.error('‚ùå talentEventSelect not found!');
                return;
            }

            container.innerHTML = '<option value="">Loading events...</option>';

            try {
                const clubId = await getActiveClubId();
                if (!clubId) {
                    container.innerHTML = '<option value="">No club selected</option>';
                    return;
                }

                const events = await apiService.getEvents(clubId);
                const talentEvents = events.filter(e => e.event_type === 'talent-id');

                if (talentEvents.length === 0) {
                    container.innerHTML = '<option value="">No talent ID events found</option>';
                } else {
                    container.innerHTML = '<option value="">Select an event...</option>' +
                        talentEvents.map(e => `<option value="${e.id}">${e.title} - ${new Date(e.event_date).toLocaleDateString()}</option>`).join('');
                    console.log(`‚úÖ Loaded ${talentEvents.length} talent ID events`);
                }
            } catch (error) {
                console.error('Failed to load talent events:', error);
                container.innerHTML = '<option value="">Error loading events</option>';
            }
        }

        // Load Tournaments Dashboard
        async function loadTournamentsDashboard() {
            console.log('üèÜ Loading Tournaments Dashboard...');
            const container = document.getElementById('tournamentSelect');
            if (!container) {
                console.error('‚ùå tournamentSelect not found!');
                return;
            }

            container.innerHTML = '<option value="">Loading tournaments...</option>';

            try {
                const clubId = await getActiveClubId();
                if (!clubId) {
                    container.innerHTML = '<option value="">No club selected</option>';
                    return;
                }

                const events = await apiService.getEvents(clubId);
                const tournaments = events.filter(e => e.event_type === 'tournament');

                if (tournaments.length === 0) {
                    container.innerHTML = '<option value="">No tournaments found - Create one in Events!</option>';
                } else {
                    container.innerHTML = '<option value="">Select a tournament...</option>' +
                        tournaments.map(e => `<option value="${e.id}">${e.title} - ${new Date(e.event_date).toLocaleDateString()}</option>`).join('');
                    console.log(`‚úÖ Loaded ${tournaments.length} tournaments`);
                }
            } catch (error) {
                console.error('Failed to load tournaments:', error);
                container.innerHTML = '<option value="">Error loading tournaments</option>';
            }
        }

        // Load and display club applications for approval/rejection
        async function loadClubApplications() {
            const container = document.getElementById('applicationsContainer');
            if (!container) {
                console.error('‚ùå applicationsContainer not found!');
                return;
            }

            console.log('üìã Loading club applications...');

            try {
                showLoading(true);
                const clubId = await getActiveClubId();

                if (!clubId) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; opacity: 0.8;">
                            <p>No club ID found. Please select a club first.</p>
                        </div>
                    `;
                    return;
                }

                let applications;
                try {
                    applications = await apiService.makeRequest(`/clubs/${clubId}/applications`);
                } catch (e) {
                    if (localStorage.getItem('isDemoSession') === 'true') {
                        applications = [
                            { id: 'app1', first_name: 'David', last_name: 'Beckham', email: 'david@example.com', application_status: 'pending', preferred_position: 'Midfielder', experience_level: 'professional', created_at: new Date().toISOString() },
                            { id: 'app2', first_name: 'Wayne', last_name: 'Rooney', email: 'wayne@example.com', application_status: 'pending', preferred_position: 'Forward', experience_level: 'professional', created_at: new Date().toISOString() }
                        ];
                    } else {
                        throw e;
                    }
                }

                if (!applications || applications.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ü§ù</div>
                            <h3 style="margin-bottom: 0.5rem;">No applications yet</h3>
                            <p style="color: var(--text-muted);">New club applications will appear here once players apply through your club profile.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Applicant</th>
                                    <th>Preferred Position</th>
                                    <th>Experience</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${applications.map(app => `
                                    <tr onclick="viewApplicationDetails('${app.id}')" style="cursor: pointer;">
                                        <td>
                                            <div class="user-info-cell">
                                                <div class="user-avatar" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                                    ${(app.first_name?.[0] || 'A')}${(app.last_name?.[0] || '')}
                                                </div>
                                                <div class="user-name-group">
                                                    <span class="user-name">${app.first_name || 'Applicant'} ${app.last_name || ''}</span>
                                                    <span class="user-meta">${app.email}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge" style="background: rgba(255,255,255,0.05); color: var(--text-main); border: 1px solid var(--border-color);">
                                                ${app.preferred_position || 'N/A'}
                                            </span>
                                        </td>
                                        <td>
                                            <span style="font-size: 0.875rem; color: var(--text-muted);">${app.experience_level || 'N/A'}</span>
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="status-badge status-${(app.application_status || 'pending').toLowerCase()}">
                                                ${app.application_status || 'Pending'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                ${app.application_status === 'pending' ? `
                                                    <button class="btn-icon manage" title="Approve & Create Player" onclick="approveApplication('${app.id}')">‚úÖ</button>
                                                    <button class="btn-icon delete" title="Reject Application" onclick="rejectApplication('${app.id}')">‚ùå</button>
                                                ` : ''}
                                                <button class="btn-icon edit" title="View Details" onclick="viewApplicationDetails('${app.id}')">üëÅÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error('Failed to load applications:', error);
                container.innerHTML = `<p style="color:#dc3545; text-align:center; padding: 2rem;">Failed to load applications. ${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }



        // Approve application - this will create a player automatically via backend
        async function approveApplication(applicationId) {
            if (!confirm('Approve this application? This will automatically create a player record and add them to your club.')) return;

            try {
                showLoading(true);
                await apiService.makeRequest(`/clubs/applications/${applicationId}/review`, {
                    method: 'POST',
                    body: JSON.stringify({
                        decision: 'approved',
                        notes: 'Application approved via admin dashboard'
                    })
                });

                showNotification('‚úÖ Application approved! Player has been created and added to your club.', 'success');

                // Reload applications and players
                await loadClubApplications();
                if (typeof loadPlayers === 'function') {
                    await loadPlayers();
                }

            } catch (error) {
                console.error('Failed to approve application:', error);
                showNotification('Failed to approve application: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Reject application
        async function rejectApplication(applicationId) {
            const notes = prompt('Please provide a reason for rejection (optional):');
            if (notes === null) return;

            try {
                showLoading(true);
                await apiService.makeRequest(`/clubs/applications/${applicationId}/review`, {
                    method: 'POST',
                    body: JSON.stringify({
                        decision: 'rejected',
                        notes: notes || 'Application rejected'
                    })
                });

                showNotification('Application rejected', 'info');
                await loadClubApplications();

            } catch (error) {
                console.error('Failed to reject application:', error);
                showNotification('Failed to reject application: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // View application details
        async function viewApplicationDetails(applicationId) {
            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const applications = await apiService.makeRequest(`/clubs/${clubId}/applications`);
                const app = applications.find(a => a.id === applicationId);

                if (!app) {
                    showNotification('Application not found', 'error');
                    return;
                }

                const content = document.getElementById('applicationDetailsContent');
                if (content) {
                    content.innerHTML = `
                        <div class="application-detail">
                            <h4>üë§ Application Details</h4>
                            <hr style="margin: 1rem 0; opacity: 0.1;">
                            <p><strong>Name:</strong> ${app.first_name} ${app.last_name}</p>
                            <p><strong>Email:</strong> ${app.email}</p>
                            <p><strong>Phone:</strong> ${app.phone || 'N/A'}</p>
                            <p><strong>Date of Birth:</strong> ${app.date_of_birth ? new Date(app.date_of_birth).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Preferred Position:</strong> ${app.preferred_position || 'N/A'}</p>
                            <p><strong>Experience Level:</strong> ${app.experience_level || 'N/A'}</p>
                            <p><strong>Previous Clubs:</strong> ${app.previous_clubs || 'N/A'}</p>
                            <p><strong>Medical Conditions:</strong> ${app.medical_conditions || 'None reported'}</p>
                            <p><strong>Emergency Contact:</strong> ${app.emergency_contact_name || 'N/A'} - ${app.emergency_contact_phone || 'N/A'}</p>
                            <p><strong>Status:</strong> <span class="status-badge status-${app.application_status}">${app.application_status}</span></p>
                            <p><strong>Applied:</strong> ${new Date(app.created_at).toLocaleDateString()}</p>
                            ${app.reviewed_at ? `<p><strong>Reviewed:</strong> ${new Date(app.reviewed_at).toLocaleDateString()}</p>` : ''}
                            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                                ${app.application_status === 'pending' ? `
                                    <button class="btn btn-success" onclick="closeModal('applicationDetailsModal'); approveApplication('${app.id}')">‚úÖ Approve</button>
                                    <button class="btn btn-danger" onclick="closeModal('applicationDetailsModal'); rejectApplication('${app.id}')">‚ùå Reject</button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="closeModal('applicationDetailsModal')">Close</button>
                            </div>
                        </div>
                    `;
                    showModal('applicationDetailsModal');
                }

            } catch (error) {
                console.error('Failed to load application details:', error);
                showNotification('Failed to load details: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateListing(e) {
            if (e) e.preventDefault();

            const payload = {
                title: document.getElementById('listingTitle').value.trim(),
                listing_type: document.getElementById('listingType').value,
                position: document.getElementById('listingPosition').value.trim(),
                description: document.getElementById('listingDescription').value.trim(),
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                await apiService.createListing(payload);
                showNotification('Listing created successfully!', 'success');
                closeModal('createListingModal');
                document.getElementById('createListingForm').reset();
                await loadListings();
            } catch (error) {
                console.error('Failed to create listing:', error);
                showNotification('Failed to create listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editListing(listingId) {
            const listing = AppState.listings?.find(l => l.id === listingId);
            if (!listing) return;

            document.getElementById('editListingId').value = listing.id;
            document.getElementById('editListingTitle').value = listing.title;
            document.getElementById('editListingType').value = listing.listing_type;
            document.getElementById('editListingPosition').value = listing.position || '';
            document.getElementById('editListingDescription').value = listing.description || '';

            showModal('editListingModal');
        }

        async function handleUpdateListing(e) {
            if (e) e.preventDefault();

            const listingId = document.getElementById('editListingId').value;
            const payload = {
                title: document.getElementById('editListingTitle').value.trim(),
                listing_type: document.getElementById('editListingType').value,
                position: document.getElementById('editListingPosition').value.trim(),
                description: document.getElementById('editListingDescription').value.trim()
            };

            try {
                showLoading(true);
                await apiService.updateListing(listingId, payload);
                showNotification('Listing updated successfully!', 'success');
                closeModal('editListingModal');
                await loadListings();
            } catch (error) {
                console.error('Failed to update listing:', error);
                showNotification('Failed to update listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteListing(listingId) {
            if (!confirm('Are you sure you want to delete this listing?')) return;

            try {
                showLoading(true);
                await apiService.deleteListing(listingId);
                showNotification('Listing deleted successfully!', 'success');
                await loadListings();
            } catch (error) {
                console.error('Failed to delete listing:', error);
                showNotification('Failed to delete listing: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editPayment(paymentId) {
            console.log('Editing payment:', paymentId);
            showNotification('Payment editing coming soon!', 'info');
        }

        async function generatePaymentLink(paymentId) {
            try {
                const response = await apiService.generatePaymentLink(paymentId);

                navigator.clipboard.writeText(response.paymentLink);
                showNotification('Payment link copied to clipboard!', 'success');

            } catch (error) {
                console.error('Failed to generate payment link:', error);
                showNotification('Failed to generate payment link: ' + error.message, 'error');
            }
        }



        async function showPlayerTeamAssignment(playerId) {
            try {
                showLoading(true);
                // Get active club ID to filter teams suitable for this club
                const clubId = await getActiveClubId();
                const teams = await apiService.getTeams(clubId);

                // Remove existing modal
                const existing = document.getElementById('assignTeamModal');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.id = 'assignTeamModal';
                modal.style.display = 'block';

                modal.innerHTML = `
                    <div class="application-detail">
                        <div class="detail-header">
                            <h2>Assign to Team</h2>
                            <button class="close" onclick="closeModal('assignTeamModal')">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 1.5rem;">
                            <div class="form-group">
                                <label for="assignTeamSelect">Select Team</label>
                                <select id="assignTeamSelect" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: white;">
                                    <option value="">Select a team...</option>
                                    ${teams.map(t => `<option value="${t.id}">${t.name} (${t.sport || 'General'})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="assignTeamRole">Role</label>
                                <select id="assignTeamRole" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: white;">
                                    <option value="Player">Player</option>
                                    <option value="Captain">Captain</option>
                                    <option value="Vice Captain">Vice Captain</option>
                                    <option value="Goalkeeper">Goalkeeper</option>
                                </select>
                            </div>
                             <div class="form-group" style="margin-top: 1rem;">
                                <label for="assignTeamPosition">Position (Optional)</label>
                                <input type="text" id="assignTeamPosition" placeholder="e.g. Forward, Striker" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: white;">
                            </div>
                            <div class="form-actions" style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="closeModal('assignTeamModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="confirmTeamAssignment('${playerId}')">Assign to Team</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

            } catch (error) {
                console.error('Failed to load teams for assignment:', error);
                showNotification('Failed to load teams: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function confirmTeamAssignment(playerId) {
            const teamId = document.getElementById('assignTeamSelect').value;
            const role = document.getElementById('assignTeamRole').value;
            const position = document.getElementById('assignTeamPosition').value;

            if (!teamId) {
                showNotification('Please select a team', 'error');
                return;
            }

            try {
                showLoading(true);
                await apiService.assignPlayerToTeam(teamId, {
                    playerId,
                    role,
                    position
                });

                showNotification('Player assigned to team successfully!', 'success');
                closeModal('assignTeamModal');

                // Refresh player list
                if (typeof loadPlayers === 'function') loadPlayers();
                // Refresh teams list if visible
                if (typeof loadTeams === 'function') loadTeams();

            } catch (error) {
                console.error('Failed to assign player to team:', error);
                showNotification('Failed to assign team: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editTeam(teamId) {
            console.log('Editing team:', teamId);
            try {
                showLoading(true);
                const team = await apiService.getTeamById(teamId);

                document.getElementById('editTeamId').value = team.id;
                document.getElementById('editTeamName').value = team.name;
                document.getElementById('editTeamSport').value = team.sport || '';
                document.getElementById('editTeamAgeGroup').value = team.age_group || '';
                document.getElementById('editTeamDescription').value = team.description || '';

                showModal('editTeamModal');
            } catch (error) {
                console.error('Failed to load team for editing:', error);
                showNotification('Failed to load team details', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleUpdateTeam(e) {
            if (e) e.preventDefault();
            const id = document.getElementById('editTeamId').value;
            const data = {
                name: document.getElementById('editTeamName').value,
                sport: document.getElementById('editTeamSport').value,
                ageGroup: document.getElementById('editTeamAgeGroup').value,
                description: document.getElementById('editTeamDescription').value
            };

            try {
                showLoading(true);
                await apiService.updateTeam(id, data);
                showNotification('Team updated successfully!', 'success');
                closeModal('editTeamModal');

                // Refresh views
                if (currentSection === 'team-details') {
                    await loadTeamDetails(id);
                } else {
                    loadTeams();
                }
            } catch (error) {
                console.error('Update team failed:', error);
                showNotification('Update failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function showAddPlayerToTeamModal() {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">Loading players...</option>';
            showModal('addPlayerToTeamModal');

            try {
                const clubId = await getActiveClubId();
                const players = await apiService.getPlayers(clubId);

                if (players.length === 0) {
                    select.innerHTML = '<option value="">No players found in organization</option>';
                    return;
                }

                // Filter out players already in the team if we have the list
                const currentRosterIds = new Set(AppState.currentTeamRoster?.map(p => p.id) || []);

                select.innerHTML = '<option value="">-- Select Player --</option>' +
                    players.map(p => `
                        <option value="${p.id}" ${currentRosterIds.has(p.id) ? 'disabled' : ''}>
                            ${p.first_name} ${p.last_name} ${currentRosterIds.has(p.id) ? '(Already in team)' : ''}
                        </option>
                    `).join('');
            } catch (error) {
                console.error('Failed to load players for selection:', error);
                select.innerHTML = '<option value="">Error loading players</option>';
            }
        }

        async function handleAddPlayerToTeam(e) {
            if (e) e.preventDefault();
            const playerId = document.getElementById('playerSelect').value;
            const position = document.getElementById('playerTeamPosition').value;
            const jerseyNumber = document.getElementById('playerJerseyNumber').value;

            if (!playerId) {
                showNotification('Please select a player', 'error');
                return;
            }

            try {
                showLoading(true);
                await apiService.assignPlayerToTeam(currentTeamId, {
                    playerId,
                    position,
                    jerseyNumber
                });

                showNotification('Player added to team!', 'success');
                closeModal('addPlayerToTeamModal');
                document.getElementById('addPlayerToTeamForm').reset();

                // Refresh roster
                await loadTeamDetails(currentTeamId);
            } catch (error) {
                console.error('Assign player failed:', error);
                showNotification('Failed to add player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this team?')) {
                try {
                    showLoading(true);
                    await apiService.deleteTeam(teamId);
                    showNotification('Team deleted successfully!', 'success');
                    loadTeams();
                } catch (error) {
                    console.error('Failed to delete team:', error);
                    showNotification('Failed to delete team: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
        }


        async function assignPaymentPlan(playerId) {
            try {
                // Find player to check current plan
                const player = AppState.players?.find(p => p.id === playerId);
                const currentPlanId = player?.payment_plan_id ?? player?.plan_id;

                // Load available payment plans
                const plans = await apiService.listPaymentPlans();

                if (!plans || plans.length === 0) {
                    showNotification('No payment plans available. Create a payment plan first.', 'error');
                    return;
                }

                // Remove existing modal if it exists
                const existingModal = document.getElementById('assignPlanModal');
                if (existingModal) existingModal.remove();

                // Create selection modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'assignPlanModal';

                modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: rgba(18, 18, 22, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;">
        <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 1.5rem 2rem;">
          <h2 style="font-size: 1.5rem; background: linear-gradient(135deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Assign Payment Plan</h2>
          <button class="close" onclick="closeModal('assignPlanModal')" style="background: rgba(255,255,255,0.05); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 2rem;">
          ${player ? `
          <div style="margin-bottom: 1.5rem; background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
            <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 0.5rem;">Player Information</div>
            <div style="font-weight: 600; color: white;">${player.display_name}</div>
            <div style="font-size: 0.85rem; color: var(--text-muted);">Current Plan: <span style="color: ${player.payment_plan ? 'var(--primary-color)' : 'inherit'}">${player.payment_plan ? player.payment_plan.name : 'None'}</span></div>
          </div>
          ` : ''}
          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="selectPlan" style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); font-weight: 600;">Choose Payment Plan</label>
            <select id="selectPlan" required style="width: 100%; background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 0.75rem 1rem; font-size: 1rem; outline: none;">
                <option value="">Select a plan...</option>
                ${plans.map(plan => {
                    const amt = Number(plan.amount ?? plan.price ?? 0).toFixed(2);
                    const intv = (plan.interval ?? plan.frequency ?? '').toString();
                    const isSelected = String(plan.id) === String(currentPlanId);
                    return `<option value="${plan.id}" ${isSelected ? 'selected' : ''}>${plan.name} - ¬£${amt}/${intv} ${isSelected ? '(Current)' : ''}</option>`;
                }).join('')}
            </select>
          </div>
          <div class="form-group">
  <label for="planCustomPrice">Custom Price (¬£) (optional)</label>
  <input type="number" id="planCustomPrice" step="0.01" min="0" placeholder="Leave blank to use plan default">
</div>
          <div class="form-group">
            <label for="planStartDate">Start Date</label>
            <input type="date" id="planStartDate" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="confirmPlanAssignment('${playerId}')">Assign Plan</button>
            <button class="btn btn-secondary" onclick="closeModal('assignPlanModal')">Cancel</button>
          </div>
        </div>
      </div>
                `;

                document.body.appendChild(modal);

            } catch (error) {
                console.error('Failed to load payment plans:', error);
                showNotification('Failed to load payment plans', 'error');
            }
        }

        async function confirmPlanAssignment(playerId) {
            const planId = document.getElementById('selectPlan').value;
            const startDate = document.getElementById('planStartDate').value || new Date().toISOString().split('T')[0];
            const priceVal = (document.getElementById('planCustomPrice')?.value || '').trim();
            const customPrice = priceVal !== '' ? parseFloat(priceVal) : null;
            const clubId = AppState.activeClubId || AppState.clubs?.[0]?.id || null;

            if (!planId) {
                showNotification('Please select a payment plan', 'error');
                return;
            }

            try {
                showLoading(true);

                // Call the (now robust) API function
                await apiService.assignPlayerToPaymentPlan(playerId, planId, startDate, customPrice, clubId);

                // Optimistic local update so UI flips immediately
                const p = (AppState.players || []).find(x => String(x.id) === String(playerId));
                if (p) {
                    p.has_payment_plan = true;
                    p.payment_plan_id = planId;
                    p.plan_price = (customPrice != null ? customPrice : null);

                    const selectedPlan = (AppState.paymentPlans || []).find(pl => String(pl.id) === String(planId));
                    if (selectedPlan) p.payment_plan = selectedPlan;

                    p.payment_status = p.payment_status || 'active';
                    delete p.monthly_fee;
                }

                showNotification('Payment plan assigned successfully!', 'success');
                if (typeof closeModal === 'function') closeModal('assignPlanModal');

                await loadPaymentPlans();
                await loadPlayers();
                if (typeof loadDashboardStats === 'function') loadDashboardStats();
            } catch (error) {
                console.error('Failed to assign payment plan:', error);
                showNotification('Failed to assign payment plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleSelectAllDocs(source, className) {
            const checkboxes = document.querySelectorAll('.' + className);
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function premiumBulkAssignPlan(planId) {
            console.log('üöÄ Opening Premium Bulk Assign Modal for plan:', planId);
            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const players = await apiService.getPlayers({ clubId });
                const plan = AppState.paymentPlans?.find(p => p.id === planId);
                const planName = plan ? plan.name : 'Selected Plan';

                // Remove existing modal if any
                if (document.getElementById('bulkAssignModal')) document.getElementById('bulkAssignModal').remove();

                const modal = document.createElement('div');
                modal.id = 'bulkAssignModal';
                modal.className = 'modal';
                modal.style.display = 'block';

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 650px; background: rgba(18, 18, 22, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
                        <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 1.5rem 2rem;">
                            <h2 style="font-size: 1.5rem; background: linear-gradient(135deg, #fff 0%, #aaa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Bulk Assign: ${planName}</h2>
                            <button class="close" onclick="closeModal('bulkAssignModal')" style="background: rgba(255,255,255,0.05); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; background: rgba(255,255,255,0.03); padding: 0.75rem 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <div style="flex: 1; display: flex; align-items: center; gap: 0.75rem;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                    <input type="text" id="playerModalFilter" placeholder="Search players..." style="background: transparent; border: none; outline: none; color: white; width: 100%; font-size: 0.95rem;">
                                </div>
                            </div>

                            <div style="margin-bottom: 0.75rem; display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">Select players to assign plan to:</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none;" onclick="document.getElementById('selectAllPlayers').click()">
                                    <input type="checkbox" id="selectAllPlayers" onchange="toggleSelectAllDocs(this, 'player-select-check')" style="cursor: pointer; width: 16px; height: 16px;">
                                    <span style="font-size: 0.85rem; color: white; font-weight: 600;">Select All</span>
                                </div>
                            </div>
                            
                            <div id="modalPlayerList" style="max-height: 280px; overflow-y: auto; background: rgba(0, 0, 0, 0.2); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); padding: 0.5rem;" class="custom-scrollbar">
                                ${players.map(p => `
                                    <div class="modal-player-row" data-name="${p.first_name} ${p.last_name}" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.03); transform: translateZ(0); transition: all 0.2s;">
                                        <input type="checkbox" class="player-select-check" value="${p.id}" id="chk_${p.id}" style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="chk_${p.id}" style="cursor: pointer; display: flex; align-items: center; gap: 1rem; flex: 1;">
                                            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color) 0%, #833ab4 100%); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 0.85rem;">
                                                ${(p.first_name?.charAt(0) || '') + (p.last_name?.charAt(0) || '')}
                                            </div>
                                            <div style="display: flex; flex-direction: column;">
                                                <span style="font-weight: 600; color: white; font-size: 0.95rem;">${p.first_name} ${p.last_name}</span>
                                                <span style="font-size: 0.8rem; color: var(--text-muted);">${p.email || 'No email'}</span>
                                            </div>
                                        </label>
                                    </div>
                                `).join('')}
                                
                                ${players.length === 0 ? '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No players available for assignment.</div>' : ''}
                            </div>
                            
                            <style>
                                .modal-player-row:hover { background: rgba(255,255,255,0.05); }
                                .modal-player-row:last-child { border-bottom: none; }
                                .custom-scrollbar::-webkit-scrollbar { width: 6px; }
                                .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
                                .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
                                .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
                            </style>

                            <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">Start Date</label>
                                    <input type="date" id="bulkStartDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 0.75rem 1rem; font-size: 1rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-color)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                                </div>
                            </div>

                            <div class="form-actions" style="margin-top: 2.5rem; display: flex; gap: 1rem;">
                                <button class="btn btn-secondary" onclick="closeModal('bulkAssignModal')" style="flex: 1; height: 50px; border-radius: 12px; font-weight: 600; font-size: 1rem; border: 1px solid rgba(255,255,255,0.1);">Cancel</button>
                                <button class="btn btn-primary" onclick="confirmBulkAssign('${planId}')" style="flex: 1.5; height: 50px; border-radius: 12px; font-weight: 600; font-size: 1rem; background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%); box-shadow: 0 10px 15px -3px rgba(255, 78, 80, 0.3);">Assign Plan</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Add filter logic
                document.getElementById('playerModalFilter').addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('.modal-player-row');
                    rows.forEach(row => {
                        const name = row.getAttribute('data-name').toLowerCase();
                        row.style.display = name.includes(val) ? 'flex' : 'none';
                    });
                });

            } catch (error) {
                console.error('Failed to load players for bulk assign:', error);
                showNotification('Failed to load players', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function confirmBulkAssign(planId) {
            const checks = document.querySelectorAll('.player-select-check:checked');
            const playerIds = Array.from(checks).map(cb => cb.value);
            const startDate = document.getElementById('bulkStartDate').value;

            if (playerIds.length === 0) {
                showNotification('Please select at least one player', 'warning');
                return;
            }

            if (!confirm(`Assign plan to ${playerIds.length} players?`)) return;

            try {
                showLoading(true);
                if (apiService.bulkAssignPaymentPlan) {
                    await apiService.bulkAssignPaymentPlan(playerIds, planId, startDate, AppState.activeClubId);
                } else {
                    // Fallback
                    const clubId = AppState.activeClubId;
                    const promises = playerIds.map(pid => apiService.assignPlayerToPaymentPlan(pid, planId, startDate, null, clubId));
                    await Promise.allSettled(promises);
                }

                showNotification('Bulk assignment completed!', 'success');
                closeModal('bulkAssignModal');
                loadPlayers();
            } catch (error) {
                console.error('Bulk assign failed:', error);
                showNotification('Bulk assignment failed partially or fully', 'error');
            } finally {
                showLoading(false);
            }
        }

        function filterPlayersByView() {
            if (typeof loadPlayers === 'function') {
                loadPlayers();
            }
        }
        function filterPlayersByTeam() {
            const teamId = document.getElementById('teamFilter').value;
            console.log('üîç Filtering players by team:', teamId);
            // Implement team filtering logic
        }

        function filterPlayersByPayment() {
            const status = document.getElementById('paymentStatusFilter').value;
            console.log('üîç Filtering players by payment:', status);
            // Implement payment status filtering logic
        }

        function resetPlayerFilters() {
            document.getElementById('playerListFilter').value = 'all';
            document.getElementById('teamFilter').value = '';
            if (document.getElementById('sportFilter')) document.getElementById('sportFilter').value = '';
            if (document.getElementById('locationFilter')) document.getElementById('locationFilter').value = '';
            if (document.getElementById('minAgeFilter')) document.getElementById('minAgeFilter').value = '';
            if (document.getElementById('maxAgeFilter')) document.getElementById('maxAgeFilter').value = '';

            if (typeof loadPlayers === 'function') {
                loadPlayers();
            }
        }

        function exportPlayers() {
            console.log('üìä Exporting players data...');
            showNotification('Export functionality coming soon!', 'info');
        }

        // Enhanced Form Handlers
        async function handleAddPlayer(e) {
            e.preventDefault();

            const payment_plan_id = document.getElementById('playerPaymentPlan').value || null;
            const feeRaw = (document.getElementById('playerFee').value || '').trim();
            const plan_price = (payment_plan_id && feeRaw !== '' && Number.isFinite(Number(feeRaw)))
                ? Number(feeRaw)
                : null;

            const club_id = await getActiveClubId();

            const payload = {
                first_name: document.getElementById('playerFirstName').value.trim(),
                last_name: document.getElementById('playerLastName').value.trim(),
                email: (document.getElementById('playerEmail').value || '').trim() || null,
                phone: (document.getElementById('playerPhone').value || '').trim() || null,
                date_of_birth: document.getElementById('playerDOB').value,
                sport: document.getElementById('playerSport').value || null,
                gender: document.getElementById('playerGender').value || null,
                position: (document.getElementById('playerPosition').value || '').trim() || null,
                location: (document.getElementById('playerLocation').value || '').trim() || null,
                bio: (document.getElementById('playerBio').value || '').trim() || null,
                club_id,
                ...(payment_plan_id ? { payment_plan_id } : {}),
                ...(plan_price != null ? { plan_price } : {})
            };

            try {
                showLoading(true);
                await apiService.createPlayer(payload);
                showNotification('Player added successfully!', 'success');
                closeModal('addPlayerModal');
                document.getElementById('addPlayerForm').reset();
                await loadPlayers();
            } catch (error) {
                console.error('Failed to add player:', error);
                showNotification('Failed to add player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle real team creation
        async function handleAddTeam(e) {
            e.preventDefault();

            // Robust Club ID Resolution
            let clubId = AppState.activeClubId || AppState.clubs?.[0]?.id;

            // If not in AppState, try to get from context directly (async check if needed, but for now assuming context is cached or we might need to await it?)
            // Since this function is async, we can safely await getContext if needed, but let's check AppState first.
            if (!clubId) {
                try {
                    // Since we are inside an async function, we can await
                    const context = await apiService.getContext();
                    clubId = context.currentOrganization?.id || context.currentUser?.clubId;
                } catch (err) {
                    console.error("Failed to fetch context for Club ID", err);
                }
            }

            if (!clubId) {
                showNotification('Error: Could not determine Organization/Club ID. Please refresh the page.', 'error');
                return;
            }

            const formData = {
                name: document.getElementById('teamName').value,
                ageGroup: document.getElementById('teamAgeGroup').value,
                sport: document.getElementById('teamSport').value,
                description: document.getElementById('teamDescription').value,
                clubId: clubId
            };

            try {
                showLoading(true);
                const response = await apiService.createTeam(formData);
                showNotification('Team created successfully!', 'success');
                closeModal('addTeamModal');
                document.getElementById('addTeamForm').reset();
                loadTeams(); // Reload teams
            } catch (error) {
                console.error('Failed to create team:', error);
                showNotification('Failed to create team: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle real event creation with capacity tracking
        async function handleAddEvent(e) {
            e.preventDefault();

            // Robust Club ID Resolution
            let clubId = AppState.activeClubId || AppState.clubs?.[0]?.id;

            if (!clubId) {
                try {
                    const context = await apiService.getContext();
                    clubId = context.currentOrganization?.id || context.currentUser?.clubId;
                } catch (err) {
                    console.error("Failed to fetch context for Club ID", err);
                }
            }

            if (!clubId) {
                showNotification('Error: Could not determine Organization/Club ID.', 'error');
                return;
            }

            const formData = {
                title: document.getElementById('eventTitle').value,
                eventType: document.getElementById('eventType').value,
                eventDate: document.getElementById('eventDate').value,
                eventTime: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value,
                price: parseFloat(document.getElementById('eventPrice').value) || 0,
                capacity: parseInt(document.getElementById('eventCapacity').value) || null,
                description: document.getElementById('eventDescription').value,
                clubId: clubId
            };

            try {
                showLoading(true);
                const eventResult = await apiService.createEvent(formData);
                showNotification('Event created successfully!', 'success');

                // Automated notifications logic
                const shouldNotify = document.getElementById('notifyPlayers')?.checked;
                if (shouldNotify && eventResult && eventResult.id) {
                    try {
                        await apiService.sendEventNotification(eventResult.id);
                        showNotification('Notification emails sent to all players!', 'success');
                    } catch (notifyErr) {
                        console.error('Failed to send automated notification:', notifyErr);
                        showNotification('Event created, but notifications failed to send.', 'warning');
                    }
                }

                closeModal('addEventModal');
                document.getElementById('addEventForm').reset();
                loadEvents(); // Reload events
            } catch (error) {
                console.error('Failed to create event:', error);
                showNotification('Failed to create event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleClubProfileUpdate(e) {
            e.preventDefault();

            const form = e.currentTarget;

            const profileData = {
                name: form.querySelector('#clubName')?.value?.trim(),
                description: form.querySelector('#clubDescription')?.value?.trim(),
                location: form.querySelector('#clubLocation')?.value?.trim(),
                philosophy: form.querySelector('#clubPhilosophy')?.value?.trim(),
                website: form.querySelector('#clubWebsite')?.value?.trim(),
            };

            try {
                if (typeof apiService !== 'undefined' && apiService.updateClubProfile) {
                    await apiService.updateClubProfile(profileData);
                }

                showNotification('‚úÖ Club profile saved successfully!', 'success');
            } catch (err) {
                console.error('Failed to save club profile:', err);
                showNotification('‚ùå Failed to save club profile: ' + err.message, 'error');
            }
        }




        // Stripe Integration
        async function accessStripeAccount() {
            console.log('üí≥ Initiating Stripe dashboard access...');
            try {
                showLoading(true);
                // Try to get dynamic management link first
                const response = await apiService.getStripeManageLink();
                if (response && response.url) {
                    console.log('‚úÖ Found dynamic Stripe management link:', response.url);
                    window.open(response.url, '_blank');
                } else {
                    console.warn('‚ö†Ô∏è No dynamic link found, falling back to standard Stripe dashboard');
                    window.open('https://dashboard.stripe.com/', '_blank');
                }
            } catch (error) {
                console.error('‚ùå Failed to get dynamic Stripe link:', error);
                console.log('‚ÑπÔ∏è Falling back to standard Stripe dashboard URL');
                window.open('https://dashboard.stripe.com/', '_blank');
            } finally {
                showLoading(false);
            }
        }




        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            if (!container) return;
            container.classList.remove('card-grid');

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const events = await apiService.getEvents(clubId);

                if (events.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                            <h3 style="margin-bottom: 0.5rem;">No events scheduled</h3>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">Plan matches, training sessions, and club events.</p>
                            <button class="btn btn-primary" onclick="showModal('addEventModal')">‚ûï Create Event</button>
                        </div>
                `;
                    return;
                }

                container.innerHTML = `
                <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 30%;">Event Details</th>
                            <th>Date & Time</th>
                            <th>Location</th>
                            <th style="text-align: center;">Access / Fee</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.map(event => `
                                    <tr onclick="editEvent('${event.id}')" style="cursor: pointer;">
                                        <td>
                                            <div class="event-info-cell">
                                                <div class="team-icon" style="background: rgba(124, 58, 237, 0.1); color: var(--neon-purple);">
                                                    ${event.event_type === 'match' ? '‚öΩ' : event.event_type === 'training' ? 'üèÉ' : 'üéØ'}
                                                </div>
                                                <div class="event-name-group">
                                                    <span class="event-name">${event.title}</span>
                                                    <span class="event-meta" style="text-transform: capitalize;">${event.event_type}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div style="display:flex; flex-direction:column;">
                                                <span style="font-weight:500;">${new Date(event.event_date).toLocaleDateString()}</span>
                                                <span style="font-size:0.75rem; color:var(--text-muted);">${event.event_time || 'TBA'}</span>
                                            </div>
                                        </td>
                                        <td>${event.location || 'TBA'}</td>
                                        <td style="text-align: center;">
                                            <div style="font-size: 0.85rem; opacity: 0.8;">
                                                <span style="color: ${event.price > 0 ? '#fbbf24' : '#4ade80'}; font-weight: 600;">
                                                    ${event.price > 0 ? `¬£${event.price}` : 'Free'}
                                                </span><br>
                                                ${event.capacity ? `Limit: ${event.capacity}` : 'Open'}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="action-buttons" onclick="event.stopPropagation()">
                                                <button class="btn-icon notify" title="Notify Members" onclick="notifyEventMembers('${event.id}')">üîî</button>
                                                <button class="btn-icon edit" title="Edit Event" onclick="editEvent('${event.id}')">‚úèÔ∏è</button>
                                                <button class="btn-icon delete" title="Delete Event" onclick="deleteEvent('${event.id}')">üóëÔ∏è</button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                    </tbody>
                </table>
                    </div >
                `;


                AppState.events = events;

            } catch (error) {
                console.error('Failed to load events:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load events</p>';
            } finally {
                showLoading(false);
            }
        }

        async function notifyEventMembers(eventId) {
            if (!confirm('Send a notification to all members associated with this event?')) return;

            try {
                showLoading(true);
                const response = await apiService.sendEventNotification(eventId);
                showNotification(response.message || 'Notifications sent successfully!', 'success');
            } catch (error) {
                console.error('Failed to send event notifications:', error);
                showNotification('Failed to send notifications: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) return;

            try {
                showLoading(true);
                await apiService.deleteEvent(eventId);
                showNotification('Event deleted successfully!', 'success');
                await loadEvents();
            } catch (error) {
                console.error('Failed to delete event:', error);
                showNotification('Failed to delete event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function editEvent(eventId) {
            showNotification('Event editing feature coming soon!', 'info');
        }

        // Fallback data loading
        // Fallback data loading
        async function loadDashboardStats() {
            try {
                const clubId = await getActiveClubId();
                const stats = clubId ? await apiService.getAdminDashboardData(clubId) : null;

                if (stats) {
                    if (stats.statistics) {
                        updateDashboardStats(stats.statistics);
                    }
                    // Also update title if we have the club info
                    if (stats.club) {
                        updateDashboardTitle(stats.club.name);
                    } else if (clubId) {
                        // Try to find name from AppState or Context
                        const club = (AppState.clubs || []).find(c => c.id === clubId);
                        if (club) updateDashboardTitle(club.name);
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        function updateDashboardTitle(name) {
            const titleEl = document.querySelector('.display-org-name');
            if (titleEl && name) {
                titleEl.textContent = name;
                console.log(`‚úÖ Updated Dashboard Title: ${name}`);
            }
        }

        // Add this function after updateDashboardStats
        function updateDashboardStats(statistics) {
            if (statistics) {
                document.getElementById('totalPlayers').textContent = statistics.total_players || '0';
                document.getElementById('totalStaff').textContent = statistics.total_staff || '0';
                document.getElementById('totalEvents').textContent = statistics.total_events || '0';
                document.getElementById('totalRevenue').textContent = `¬£${statistics.monthly_revenue || 0} `;
            }
        }

        async function loadPlayers() {
            const container = document.getElementById('playersContainer');
            if (!container) return;
            container.classList.remove('card-grid');

            try {
                showLoading(true);
                const clubId = await getActiveClubId();

                if (!clubId) {
                    container.innerHTML = '<p>No club found. Please create a club first.</p>';
                    return;
                }

                // Collect advanced filters
                const filters = {
                    clubId,
                    viewType: document.getElementById('playerListFilter')?.value || 'all',
                    teamId: document.getElementById('teamFilter')?.value || null,
                    sport: document.getElementById('sportFilter')?.value || null,
                    location: document.getElementById('locationFilter')?.value || null,
                    minAge: document.getElementById('minAgeFilter')?.value || null,
                    maxAge: document.getElementById('maxAgeFilter')?.value || null
                };

                const players = await apiService.getPlayers(filters);
                console.log('üë• Players Loaded:', players);

                // Attach plan objects
                const plansById = Object.fromEntries((AppState.paymentPlans || []).map(pl => [String(pl.id), pl]));

                players.forEach(p => {
                    const planId = p.payment_plan_id ?? p.plan_id ?? p.payment_plan?.id ?? p.plan?.id;
                    if (planId != null && String(planId).trim() !== '' && String(planId) !== '0') {
                        // Always use the latest plan object from our global state
                        p.payment_plan = plansById[String(planId)] || p.payment_plan || p.plan || undefined;
                        p.has_payment_plan = !!p.payment_plan;
                    }
                });

                if (!players || players.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üèÉ</div>
                            <h3 style="margin-bottom: 0.5rem;">No players found</h3>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">Add players to your club manually or invite them via email.</p>
                            <button class="btn btn-primary" onclick="showModal('addPlayerModal')">‚ûï Add Your First Player</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Player</th>
                                <th>Team / Sport</th>
                                <th>Position</th>
                                <th style="text-align: center;">Payment</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${players.map(player => `
                                <tr onclick="editPlayer('${player.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="user-info-cell">
                                            <div class="user-avatar" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                                                ${(player.first_name?.[0] || '?')}${(player.last_name?.[0] || '')}
                                            </div>
                                            <div class="user-name-group">
                                                <span class="user-name">${player.display_name}</span>
                                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                                    <span class="user-meta">${player.email || 'No email linked'}</span>
                                                    <span class="badge ${player.account_status === 'Active' ? 'badge-success' : 'badge-warning'}" style="font-size: 0.65rem; padding: 2px 6px;">
                                                        ${player.account_status}
                                                    </span>
                                                    ${player.role === 'parent' ? '<span class="badge badge-secondary" style="font-size: 0.65rem; padding: 2px 6px;">Parent</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display:flex; flex-direction:column;">
                                            <span style="font-weight:500;">${player.team_name || 'Unassigned'}</span>
                                            <span style="font-size:0.75rem; color:var(--text-muted);">${player.team_sport || player.sport || 'Mixed'}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="status-badge" style="background:rgba(255,255,255,0.05); color:var(--text-main); border:1px solid var(--border-color);">
                                            ${player.position || 'N/A'}
                                        </span>
                                    </td>
                                    <td style="text-align: center;">
                                        <div style="display:flex; flex-direction:column; align-items:center;">
                                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                                <span class="status-badge status-${(player.payment_status || 'pending').toLowerCase()}">
                                                    ${player.payment_status || 'Pending'}
                                                </span>
                                                ${player.stripe_customer_id ? `
                                                    <span title="Synced with Stripe" style="color: #6366f1; font-size: 0.9rem; cursor: help;">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                                    </span>
                                                ` : ''}
                                            </div>
                                            ${player.payment_plan ? `<span style="font-size: 0.7rem; color: var(--text-muted); font-weight: 500;">${player.payment_plan.name}</span>` : '<span style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.5;">No Plan</span>'}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons" onclick="event.stopPropagation()">
                                            <button class="btn-icon manage" title="Manage Plans" onclick="assignPaymentPlan('${player.id}')">üí≥</button>
                                            <button class="btn-icon edit" title="Edit Player" onclick="editPlayer('${player.id}')">‚úèÔ∏è</button>
                                            <button class="btn-icon delete" title="Remove Player" onclick="removePlayer('${player.id}')">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    </div>
                `;
                AppState.players = players;
            } catch (error) {
                console.error('Failed to load players:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load players: ' + (error?.message || error) + '</p>';
            } finally {
                showLoading(false);
            }
        }

        async function loadTeams() {
            const container = document.getElementById('teamsContainer');
            if (!container) return;
            container.classList.remove('card-grid');

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const teams = await apiService.getTeams(clubId);

                if (teams.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 4rem 2rem; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚öΩ</div>
                            <h3 style="margin-bottom: 0.5rem;">No teams created yet</h3>
                            <p style="color: var(--text-muted); margin-bottom: 2rem;">Get started by creating your first team to manage players and events.</p>
                            <button class="btn btn-primary" onclick="showModal('addTeamModal')">‚ûï Create Your First Team</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Team Details</th>
                                <th>Players</th>
                                <th style="text-align: center;">Performance</th>
                                <th>Coach</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teams.map(team => `
                                <tr onclick="openTeamManagement('${team.id}', '${team.name}')" style="cursor: pointer;">
                                    <td>
                                        <div class="team-info-cell">
                                            <div class="team-icon">‚öΩ</div>
                                            <div class="team-name-group">
                                                <span class="team-name">${team.name}</span>
                                                <span class="team-meta">${team.sport} ‚Ä¢ ${team.age_group || 'No Age Group'}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="text-align: left;">
                                        <span class="badge" style="background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                            üë• ${team.player_count} Players
                                        </span>
                                    </td>
                                    <td>
                                        <div class="stats-cell">
                                            <div class="stat-pill">
                                                <span class="stat-value win-stat">${team.wins || 0}</span>
                                                <span class="stat-label">Wins</span>
                                            </div>
                                            <div class="stat-pill">
                                                <span class="stat-value loss-stat">${team.losses || 0}</span>
                                                <span class="stat-label">Loss</span>
                                            </div>
                                            <div class="stat-pill">
                                                <span class="stat-value draw-stat">${team.draws || 0}</span>
                                                <span class="stat-label">Draw</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="coach-cell">
                                            ${team.coach_first_name ?
                        `<div class="coach-avatar">${team.coach_first_name[0]}${team.coach_last_name[0]}</div>
                                                <div style="display:flex; flex-direction:column;">
                                                <span style="font-weight:500;">${team.coach_first_name} ${team.coach_last_name}</span>
                                                <span style="font-size:0.75rem; color:var(--text-muted);">Head Coach</span>
                                                </div>`
                        : `<span style="color: var(--text-muted); font-style: italic; opacity: 0.6; font-size: 0.9rem;">No Coach Assigned</span>`}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="action-buttons" onclick="event.stopPropagation()">
                                            <button class="btn-icon manage" title="Manage Team" onclick="openTeamManagement('${team.id}', '${team.name}')">‚öôÔ∏è</button>
                                            <button class="btn-icon edit" title="Edit Team" onclick="editTeam('${team.id}')">‚úèÔ∏è</button>
                                            <button class="btn-icon delete" title="Delete Team" onclick="deleteTeam('${team.id}')">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    </div>
                `;

                AppState.teams = teams;
                populateTeamDropdowns();
            } catch (error) {
                console.error('Failed to load teams:', error);
                container.innerHTML = '<p style="color:#dc3545">Failed to load teams</p>';
            } finally {
                showLoading(false);
            }
        }

        function populateTeamDropdowns() {
            const teams = AppState.teams || [];
            if (teams.length === 0) return;

            const selectorIds = ['teamFilter', 'playerTeam', 'editPlayerTeam'];

            selectorIds.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;

                // specific logic: Keep the first option (default), remove others
                const defaultOption = select.firstElementChild;
                select.innerHTML = '';
                if (defaultOption) select.appendChild(defaultOption);

                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    select.appendChild(option);
                });
            });
            console.log('‚úÖ Team dropdowns populated');
        }

        // Club Gallery Functions
        async function handlePictureUpload(input) {
            if (!input.files || input.files.length === 0) return;

            const files = Array.from(input.files);
            const clubId = await getActiveClubId();

            if (!clubId) {
                showNotification('No active organization/club found. Please select or create one first.', 'error');
                input.value = '';
                return;
            }

            // Get current images to check limit
            const currentSection = document.getElementById('uploadedPictures');
            const currentImagesCount = currentSection.querySelectorAll('.gallery-item').length;

            if (currentImagesCount + files.length > 5) {
                showNotification(`Maximum 5 images allowed.You already have ${currentImagesCount}.`, 'error');
                input.value = '';
                return;
            }

            try {
                showLoading(true);
                let successCount = 0;
                let failCount = 0;

                for (const file of files) {
                    try {
                        const result = await apiService.uploadClubImage(clubId, file);
                        if (result.images) {
                            displayClubImages(result.images);
                        }
                        successCount++;
                    } catch (err) {
                        console.error('File upload failed:', file.name, err);
                        failCount++;
                    }
                }

                if (successCount > 0) {
                    showNotification(`${successCount} image(s) uploaded successfully!`, 'success');
                }
                if (failCount > 0) {
                    showNotification(`${failCount} image(s) failed to upload.`, 'error');
                }

                // Final refresh to be sure
                await loadClubProfileImages();

            } catch (error) {
                console.error('Upload process failed:', error);
                showNotification('Upload failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
                input.value = ''; // Reset input
            }
        }

        function displayClubImages(images) {
            const container = document.getElementById('uploadedPictures');
            if (!container) return;

            if (!images || images.length === 0) {
                container.innerHTML = '<p style="opacity:0.6; font-style:italic;">No images uploaded yet.</p>';
                return;
            }

            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
            container.style.gap = '15px';
            container.style.marginTop = '15px';

            container.innerHTML = images.map(imgUrl => `
            <div class="gallery-item" style="position: relative; width: 100%; aspect-ratio: 1/1; overflow: visible;">
            <img src="${imgUrl}" style="height: 100%; width: 100%; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color, #444);">
                <button onclick="deleteClubImage('${imgUrl}')" style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 5;">&times;</button>
            </div>
            `).join('');
        }

        async function deleteClubImage(imgUrl) {
            if (!confirm('Delete this image?')) return;

            const clubId = await getActiveClubId();
            try {
                showLoading(true);
                const result = await apiService.deleteClubImage(clubId, imgUrl);
                showNotification('Image deleted', 'success');
                displayClubImages(result.images);
            } catch (e) {
                showNotification('Failed to delete: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadClubProfileImages() {
            try {
                const activeClubId = await getActiveClubId();
                if (!activeClubId) return;

                const dashboardData = await apiService.getAdminDashboardData(activeClubId);
                const club = dashboardData.clubs?.find(c => c.id == activeClubId);
                if (club && club.images) {
                    displayClubImages(club.images);
                }
            } catch (e) {
                console.warn('Failed to load images', e);
            }
        }

        // Expose new functions
        window.deleteClubImage = deleteClubImage;

        // =========================== POLLS & VOTING ===========================
        async function loadPolls() {
            const container = document.getElementById('pollsContainer');
            if (!container) return;

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const polls = await apiService.getPolls(clubId);

                if (!polls || polls.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.7;"><h3>No Active Polls</h3><p>Engage your members by creating a poll.</p><button class="btn btn-primary" onclick="showModal(\'createPollModal\')">Create Poll</button></div>';
                    return;
                }

                container.innerHTML = polls.map(p => `
                    <div class="card" style="margin-bottom: 1rem; position: relative;">
                         <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem;">
                            <h4 style="margin:0;">${p.title}</h4>
                            <span class="badge">${p.total_votes || 0} Votes</span>
                         </div>
                         <p style="color: var(--text-muted); font-size: 0.9rem;">${p.description || ''}</p>
                         <div class="poll-options" style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                            ${(p.options || []).map(opt => {
                    const pct = p.total_votes ? Math.round((opt.votes / p.total_votes) * 100) : 0;
                    return `
                                <div onclick="voteOnPoll('${p.id}', '${opt.id}')" style="cursor: pointer; position: relative; background: rgba(255,255,255,0.05); border-radius: 4px; padding: 0.75rem; overflow: hidden;">
                                    <div style="position: absolute; top:0; left:0; bottom:0; width:${pct}%; background: rgba(59,130,246,0.2); transition: width 0.3s ease;"></div>
                                    <div style="position: relative; display: flex; justify-content: space-between; font-size: 0.9rem;">
                                        <span>${opt.text}</span>
                                        <span>${pct}% (${opt.votes})</span>
                                    </div>
                                </div>`;
                }).join('')}
                         </div>
                    </div>
                `).join('');

            } catch (err) {
                console.warn('Load polls failed', err);
                container.innerHTML = '<p>Failed to load polls.</p>';
            } finally {
                showLoading(false);
            }
        }

        async function voteOnPoll(pollId, optionId) {
            try {
                showLoading(true);
                await apiService.voteOnPoll(pollId, optionId);
                showNotification('Vote cast successfully!', 'success');
                loadPolls();
            } catch (e) {
                showNotification('Vote failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        // =========================== TOURNAMENTS ===========================
        async function loadTournamentsDashboard() {
            const container = document.getElementById('tournamentsListContainer');
            if (!container) return;

            // Ensure UI is in List view
            const listView = document.getElementById('tournamentListView');
            const detailView = document.getElementById('tournamentDetailView');
            if (listView) listView.style.display = 'block';
            if (detailView) detailView.style.display = 'none';

            try {
                showLoading(true);
                const clubId = await getActiveClubId();
                const tourneys = await apiService.getTournaments(clubId);

                if (!tourneys || tourneys.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: left; padding: 3rem 0; opacity: 0.8; background: rgba(255,255,255,0.02); border-radius: 16px;">
                            <div style="font-size: 2.5rem; margin-bottom: 1rem;">üèÜ</div>
                            <h3 style="margin-bottom: 0.5rem; font-weight: 700;">No active tournaments</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">Host leagues, knockouts, and cup competitions for your club.</p>
                            <button class="btn btn-primary" onclick="openCreateTournamentModal()">‚ûï Create Your First Tournament</button>
                        </div>`;
                } else {
                    container.innerHTML = tourneys.map(t => `
                        <div class="card tournament-card" onclick="viewTournament('${t.id}')">
                            <div class="tournament-card-header">
                                <span class="badge badge-primary">${(t.type || 'Tournament').toUpperCase()}</span>
                                <span class="tournament-trophy">üèÜ</span>
                            </div>
                            <div class="tournament-card-body">
                                <h3>${t.name}</h3>
                                <div class="tournament-meta">
                                    <span>üë• ${t.teams_count || 0} Teams</span>
                                    <span class="status-dot ${t.status === 'active' ? 'dot-success' : 'dot-warning'}"></span>
                                    <span>${t.status || 'Active'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p>Error loading tournaments.</p>';
            } finally {
                showLoading(false);
            }
        }

        async function viewTournament(id) {
            currentTournamentId = id;
            try {
                showLoading(true);
                const details = await apiService.getTournamentDetails(id);

                document.getElementById('tournamentListView').style.display = 'none';
                document.getElementById('tournamentDetailView').style.display = 'block';

                document.getElementById('detailTournamentName').textContent = details.name;

                // Render Fixtures
                renderFixtures(details.fixtures || []);

                // Render Standings
                renderStandings(details.standings || [], details.type);

                // Render Teams
                renderParticipants(details.participants || details.teams || []);

                // Switch to Fixtures tab by default
                const navBtn = document.querySelector('.dashboard-nav button');
                if (navBtn) switchTournamentTab(navBtn, 'fixtures');

            } catch (e) {
                showNotification('Failed to load tournament details: ' + e.message, 'error');
                closeTournamentDetail();
            } finally {
                showLoading(false);
            }
        }

        function closeTournamentDetail() {
            document.getElementById('tournamentListView').style.display = 'block';
            document.getElementById('tournamentDetailView').style.display = 'none';
            currentTournamentId = null;
        }

        function switchTournamentTab(btn, tabName) {
            // Update buttons
            if (btn && btn.parentElement) {
                const nav = btn.parentElement;
                nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            // Update tabs
            document.querySelectorAll('.tournament-tab').forEach(t => t.style.display = 'none');
            const target = document.getElementById('tab-' + tabName);
            if (target) target.style.display = 'block';
        }

        function renderFixtures(fixtures) {
            const container = document.getElementById('tournamentFixturesList');
            if (!fixtures || fixtures.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; opacity: 0.6;">No fixtures scheduled yet.</p>';
                return;
            }

            container.innerHTML = fixtures.map(f => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); margin-bottom: 0.5rem; border-radius: 8px;">
                    <div style="flex: 1; text-align: right; font-weight: 600; font-size: 1.1rem;">${f.home_team || 'Home'}</div>
                    <div style="padding: 0 1.5rem; font-weight: bold; font-size: 1.5rem; text-align: center; min-width: 100px;">
                        <span style="color: ${f.played ? 'white' : 'gray'};">${f.home_score !== null ? f.home_score : '-'}</span> 
                        <span style="opacity: 0.5; margin: 0 5px;">:</span> 
                        <span style="color: ${f.played ? 'white' : 'gray'};">${f.away_score !== null ? f.away_score : '-'}</span>
                    </div>
                    <div style="flex: 1; text-align: left; font-weight: 600; font-size: 1.1rem;">${f.away_team || 'Away'}</div>
                    <div style="margin-left: 1rem;">
                        <button class="btn btn-small ${f.played ? 'btn-secondary' : 'btn-primary'}" onclick="openMatchStatsModal('${f.id}', '${f.home_team}', '${f.away_team}')">
                            ${f.played ? 'Edit' : 'Result'}
                        </button>
                    </div>
                </div>
             `).join('');
        }

        function renderStandings(standings, type) {
            const container = document.getElementById('tournamentStandingsContainer');
            if (!standings || standings.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; opacity: 0.6;">No standings available.</p>';
                return;
            }

            // Simple Table Concept
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Team</th>
                                <th style="text-align:center;">P</th>
                                <th style="text-align:center;">W</th>
                                <th style="text-align:center;">D</th>
                                <th style="text-align:center;">L</th>
                                <th style="text-align:center;">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${standings.map((s, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${s.team}</td>
                                    <td style="text-align:center;">${s.p}</td>
                                    <td style="text-align:center;">${s.w}</td>
                                    <td style="text-align:center;">${s.d}</td>
                                    <td style="text-align:center;">${s.l}</td>
                                    <td style="text-align:center; font-weight: bold;">${s.pts}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderParticipants(teams) {
            const container = document.getElementById('tournamentParticipantsList');
            if (!teams || teams.length === 0) return;

            container.innerHTML = `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                ${teams.map(t => `<div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;"><b>${t.name}</b></div>`).join('')}
             </div>`;
        }

        async function openCreateTournamentModal() {
            showModal('createTournamentModal');
            // Populate Teams
            const container = document.getElementById('tournamentTeamSelector');
            container.innerHTML = 'Loading...';

            try {
                const clubId = await getActiveClubId();
                const teams = await apiService.getTeams(clubId);

                if (teams.length === 0) {
                    container.innerHTML = '<p>No teams available.</p>';
                    return;
                }

                container.innerHTML = teams.map(t => `
                    <div style="margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                        <label style="display: flex; align-items: center; padding: 0.75rem; cursor: pointer; width: 100%; gap: 12px; margin: 0;">
                            <input type="checkbox" value="${t.id}" name="tournamentTeam" style="width: 18px; height: 18px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05);">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-weight: 600; font-size: 0.95rem;">${t.name}</span>
                                <span style="font-size: 0.8rem; color: var(--text-muted);">${t.age_group || 'Mixed Age Group'}</span>
                            </div>
                        </label>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p>Error loading teams.</p>';
            }
        }

        async function handleCreateTournament(e) {
            e.preventDefault();
            const name = document.getElementById('newTournamentName').value;
            const type = document.getElementById('newTournamentType').value;
            // Get selected teams
            const checkboxes = document.querySelectorAll('input[name="tournamentTeam"]:checked');
            const teamIds = Array.from(checkboxes).map(cb => cb.value);

            if (teamIds.length < 2) {
                showNotification('Please select at least 2 teams.', 'error');
                return;
            }

            try {
                showLoading(true);
                await apiService.createTournament({ name, type, teams: teamIds });
                closeModal('createTournamentModal');
                showNotification('Tournament created!', 'success');
                loadTournamentsDashboard();
            } catch (e) {
                showNotification('Failed to create tournament.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function openMatchStatsModal(matchId, homeName, awayName) {
            currentMatchId = matchId;
            document.getElementById('matchHomeTeamName').textContent = homeName;
            document.getElementById('matchAwayTeamName').textContent = awayName;
            document.getElementById('matchHomeScore').value = '';
            document.getElementById('matchAwayScore').value = '';

            // Populate Dummy Players (or fetch real roster if available)
            const playerListHTML = (prefix) => `
                <div style="display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9rem;">
                    <span style="flex: 1;">Player Name</span>
                    <input type="number" placeholder="G" title="Goals" style="width: 30px; margin-right: 2px; padding: 2px;">
                    <input type="number" placeholder="A" title="Assists" style="width: 30px; margin-right: 2px; padding: 2px;">
                    <select title="Rating" style="width: 40px; padding: 0;">
                        <option value="">-</option>
                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(n => `<option value="${n}">${n}</option>`).join('')}
                    </select>
                </div>
                <!-- Repeat for demo -->
                <div style="display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9rem; opacity: 0.5;">
                    <span style="flex: 1;">(More players...)</span>
                </div>
            `;

            document.getElementById('matchHomePlayersStats').innerHTML = playerListHTML();
            document.getElementById('matchAwayPlayersStats').innerHTML = playerListHTML();

            showModal('matchStatsModal');
        }

        async function saveMatchStats() {
            const hScore = document.getElementById('matchHomeScore').value;
            const aScore = document.getElementById('matchAwayScore').value;

            if (hScore === '' || aScore === '') {
                showNotification('Please enter the score.', 'warning');
                return;
            }

            try {
                showLoading(true);
                await apiService.updateMatchStats(currentMatchId, { home_score: hScore, away_score: aScore });
                showNotification('Match result saved!', 'success');
                closeModal('matchStatsModal');
                // Refresh details
                if (currentTournamentId) viewTournament(currentTournamentId);
            } catch (e) {
                showNotification('Failed to save result.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function generateFixtures() {
            showNotification('Generating next round fixtures... (Coming Soon)', 'info');
        }

        // Export new functions
        window.loadPolls = loadPolls;
        window.voteOnPoll = voteOnPoll;
        window.loadTournamentsDashboard = loadTournamentsDashboard;
        window.openCreateTournamentModal = openCreateTournamentModal;
        window.handleCreateTournament = handleCreateTournament;
        window.viewTournament = viewTournament;
        window.closeTournamentDetail = closeTournamentDetail;
        window.switchTournamentTab = switchTournamentTab;
        window.openMatchStatsModal = openMatchStatsModal;
        window.saveMatchStats = saveMatchStats;
        window.generateFixtures = generateFixtures;



        function calculateAge(dob) {
            if (!dob) return 'N/A';
            const birth = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function hasPlan(player) {
            const flag = player?.has_payment_plan;
            const flagTrue =
                flag === true ||
                flag === 1 ||
                flag === '1' ||
                (typeof flag === 'string' && flag.toLowerCase() === 'true');

            const id =
                player?.payment_plan_id ??
                player?.plan_id ??
                player?.payment_plan?.id ??
                player?.plan?.id;

            const hasId = id != null && String(id).trim() !== '' && String(id) !== '0';
            const hasObj = !!player?.payment_plan || !!player?.plan;

            return flagTrue || hasId || hasObj;
        }

        // Utility Functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';

                // Focus first input
                const firstInput = modal.querySelector('input[type="email"], input[type="text"]');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';

                // Clear form if it exists
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        }

        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"],
                v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        window.toggleBillingDay = function (val) {
            const el = document.getElementById('billingDayContainer');
            if (el) el.style.display = val === 'fixed_date' ? 'block' : 'none';
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#007bff'
            };

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
            `;

            notification.innerHTML = `
                <span>${icons[type] || icons.info}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;margin-left:auto;padding:0;opacity:0.8;">√ó</button>
            `;

            document.body.appendChild(notification);
            setTimeout(() => notification.style.transform = 'translateX(0)', 10);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        // Enhanced showSection function
        function showSection(sectionId) {
            console.log('üìç Switching to section:', sectionId);

            // Correct potential ID mismatches
            let finalId = sectionId;
            if (sectionId === 'marketing-hub') finalId = 'marketing';
            if (sectionId === 'item-shop') finalId = 'shop';

            // Remove active class and hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Force hide
            });

            // Remove active class from all nav buttons in the new grouped structure
            const allNavButtons = document.querySelectorAll('.dashboard-nav-grouped button');
            allNavButtons.forEach(btn => btn.classList.remove('active'));

            // Add active class and show target section
            const targetSection = document.getElementById(finalId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block'; // Force show
                console.log(`‚úÖ Section '${finalId}' is now active`);
            } else {
                console.error(`‚ùå Section '${finalId}' not found in DOM!`);
                // Fallback: Try original ID
                const fallbackSection = document.getElementById(sectionId);
                if (fallbackSection) {
                    fallbackSection.classList.add('active');
                    fallbackSection.style.display = 'block';
                }
                return;
            }

            // Set active button (supporting both direct buttons and dropdown items)
            // We search for the button that triggers this section
            const clickedButton = document.querySelector(`.dashboard-nav-grouped button[onclick*="'${sectionId}'"]`) ||
                document.querySelector(`.dashboard-nav-grouped button[onclick*='"${sectionId}"']`);

            if (clickedButton) {
                clickedButton.classList.add('active');

                // If inside a dropdown, also highlight the parent trigger
                const dropdownContainer = clickedButton.closest('.nav-dropdown-container');
                if (dropdownContainer) {
                    const trigger = dropdownContainer.querySelector('.dropdown-trigger');
                    if (trigger) trigger.classList.add('active');
                }
            } else {
                console.warn(`‚ö†Ô∏è Nav button for '${sectionId}' not found`);
            }

            // Handle data loading for specific sections
            switch (sectionId) {
                case 'overview':
                    console.log('Loading overview stats...');
                    if (typeof loadDashboardStats === 'function') loadDashboardStats();
                    break;
                case 'players':
                    console.log('Loading players...');
                    if (typeof loadPlayers === 'function') loadPlayers();
                    break;
                case 'teams':
                    console.log('Loading teams...');
                    if (typeof loadTeams === 'function') loadTeams();
                    break;
                case 'staff':
                    console.log('Loading staff...');
                    if (typeof loadStaff === 'function') loadStaff();
                    break;
                case 'events':
                    console.log('Loading events...');
                    if (typeof loadEvents === 'function') loadEvents();
                    break;
                case 'club-profile':
                    console.log('Loading club profile...');
                    if (typeof loadClubProfile === 'function') loadClubProfile();
                    if (typeof loadClubProfileImages === 'function') loadClubProfileImages();
                    break;
                case 'finances':
                    console.log('Loading finances...');
                    if (typeof loadFinances === 'function') loadFinances();
                    if (typeof loadPaymentPlans === 'function') loadPaymentPlans();
                    break;
                case 'listings':
                    console.log('Loading listings and applications...');
                    if (typeof loadListings === 'function') loadListings();
                    if (typeof loadClubApplications === 'function') loadClubApplications();
                    break;
                case 'item-shop':
                    console.log('Loading shop products...');
                    if (typeof loadProducts === 'function') loadProducts();
                    break;
                case 'marketing-hub':
                    console.log('Loading marketing campaigns...');
                    if (typeof loadCampaigns === 'function') loadCampaigns();
                    break;
                case 'talent-id':
                    console.log('Loading talent ID dashboard...');
                    if (typeof loadTalentIdDashboard === 'function') loadTalentIdDashboard();
                    break;
                case 'tournaments':
                    console.log('Loading tournaments dashboard...');
                    if (typeof loadTournamentsDashboard === 'function') loadTournamentsDashboard();
                    break;
                case 'polls-section':
                    console.log('Loading polls...');
                    if (typeof loadPolls === 'function') loadPolls();
                    break;
                case 'training-manager':
                    console.log('Loading training manager...');
                    if (typeof loadTraining === 'function') loadTraining();
                    break;
                case 'venue-booking':
                    console.log('Loading venue booking...');
                    if (typeof loadVenues === 'function') loadVenues();
                    break;
                case 'league-management':
                    console.log('Loading league management...');
                    if (typeof loadLeagues === 'function') loadLeagues();
                    break;
                case 'email-campaigns':
                    console.log('Loading email campaigns...');
                    if (typeof loadCampaigns === 'function') loadCampaigns();
                    break;
                default:
                    console.log(`No specific loader for section: ${sectionId} `);
            }
        }

        // Make functions globally available
        window.showSection = showSection;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.showNotification = showNotification;
        window.openTeamManagement = openTeamManagement;
        window.showTeamTab = showTeamTab;
        window.generateStaffInvite = generateStaffInvite;
        window.shortlistApplicant = shortlistApplicant;
        window.viewApplicantDetails = viewApplicantDetails;
        window.inviteToSession = inviteToSession;
        window.rejectApplicant = rejectApplicant;
        window.accessStripeAccount = accessStripeAccount;
        window.handlePictureUpload = handlePictureUpload;
        window.filterPlayersByView = filterPlayersByView;


        // Team Management Functions
        let currentTeamId = null;

        async function openTeamManagement(teamId, teamName) {
            currentTeamId = teamId;
            document.getElementById('teamDetailName').textContent = teamName;

            showSection('team-details');
            await loadTeamDetails(teamId);
        }

        async function loadTeamDetails(teamId) {
            console.log('DEBUG: RUNNING NEW VERSION 4765');
            try {
                showLoading(true);
                const team = await apiService.getTeamById(teamId);

                console.log('Team Details Loaded:', team);
                AppState.currentTeamRoster = team.players || [];

                // Populate Stats
                const statsContainer = document.getElementById('teamDetailStats');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <span class="status-badge" style="background:#4caf50; color:white;">${team.wins || 0} Wins</span>
                        <span class="status-badge" style="background:#f44336; color:white;">${team.losses || 0} Losses</span>
                        <span class="status-badge" style="background:#ff9800; color:white;">${team.draws || 0} Draws</span>
                    `;
                }

                // Populate Roster
                renderRoster(AppState.currentTeamRoster);

                // Populate Events
                renderTeamEvents(team.upcoming_events || team.events || []);

                // Initialize Availability (Placeholder for now)

            } catch (error) {
                console.error('Failed to load team details:', error);
                showNotification('Failed to load team details', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderRoster(players) {
            const tbody = document.getElementById('teamRosterBody');
            if (!tbody) return;

            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">No players in this team yet.</td></tr>';
                return;
            }

            tbody.innerHTML = players.map(p => `
                <tr>
                    <td>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:bold;">${p.first_name} ${p.last_name}</span>
                            <span style="font-size:0.8rem; opacity:0.7;">#${p.jersey_number || '-'}</span>
                        </div>
                    </td>
                    <td>${p.team_position || p.position || '-'}</td>
                    <td>${calculateAge(p.date_of_birth)}</td>
                    <td>
                        <span class="status-badge status-${p.payment_status || 'pending'}">
                            ${p.payment_status || 'Active'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="removePlayerFromTeam('${p.id}', '${currentTeamId}')">
                            ‚ùå Remove
                        </button>
                    </td>
                </tr>
                `).join('');
        }

        function renderTeamEvents(events) {
            const container = document.getElementById('teamEventsContainer');
            if (!container) return;

            if (events.length === 0) {
                container.innerHTML = '<p style="padding:1rem;">No upcoming events scheduled.</p>';
                return;
            }

            container.innerHTML = events.map(e => `
                <div class="card event-card" style="border-left: 4px solid var(--accent-color);">
                    <h4>${e.title}</h4>
                    <p>üìÖ ${new Date(e.event_date).toLocaleDateString()} at ${e.event_time}</p>
                    <p>üìç ${e.location || 'TBA'}</p>
                    <button class="btn btn-small btn-secondary_outline" onclick="viewEventAvailability('${e.id}')">View Availability</button>
                </div>
                `).join('');
        }

        // Feature: Switch Tabs
        window.switchTeamTab = function (tabName) {
            document.querySelectorAll('.team-tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tabs .tab-btn').forEach(btn => btn.classList.remove('active'));

            const targetSection = document.getElementById(`team-tab-${tabName}`);
            if (targetSection) {
                targetSection.style.display = 'block';
            } else {
                console.error('Target tab content not found:', `team-tab-${tabName}`);
            }

            // Highlighting tab button
            const buttons = document.querySelectorAll('.tabs .tab-btn');
            if (tabName === 'roster') buttons[0].classList.add('active');
            if (tabName === 'events') buttons[1].classList.add('active');
            if (tabName === 'availability') {
                buttons[2].classList.add('active');
                if (typeof loadTeamAvailability === 'function') loadTeamAvailability(currentTeamId);
            }
        };

        // Feature: Remove Player from Team (Fixing the reported broken X)
        async function removePlayerFromTeam(playerId, teamId) {
            if (!confirm('Are you sure you want to remove this player from the team roster?')) return;

            try {
                showLoading(true);
                await apiService.makeRequest(`/teams/${teamId}/players/${playerId}`, {
                    method: 'DELETE'
                });

                showNotification('Player removed from team', 'success');
                // Refresh data
                await loadTeamDetails(teamId);
            } catch (error) {
                console.error('Failed to remove player from team:', error);
                showNotification('Failed to remove player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }


        async function loadTeamAvailability(teamId) {
            try {
                const data = await apiService.makeRequest(`/teams/${teamId}/availability`);
                renderAvailabilityGrid(data);
            } catch (error) {
                console.error('Failed to load availability:', error);
                document.getElementById('availabilityGrid').innerHTML = '<p style="color:red">Failed to load availability data</p>';
            }
        }

        function renderAvailabilityGrid(data) {
            const container = document.getElementById('availabilityGrid');
            if (!container) return;

            const { events, players, responses } = data;

            if (events.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 2rem; opacity: 0.7;">No upcoming events found.</p>';
                return;
            }

            // Create Grid Table
            let html = `
                <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                    <thead>
                        <tr>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #444; position: sticky; left: 0; background: var(--bg-secondary); z-index: 2;">Player</th>
                            ${events.map(e => `
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #444; min-width: 80px;">
                                    <div style="font-size: 0.8rem; opacity: 0.8;">${new Date(e.event_date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.6;">${e.event_time ? e.event_time.slice(0, 5) : ''}</div>
                                    <div style="font-size: 1.2rem;" title="${e.title}">
                                        ${e.event_type === 'match' ? '‚öΩ' : e.event_type === 'training' ? 'üèãÔ∏è' : 'üìÖ'}
                                    </div>
                                </th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            players.forEach(player => {
                html += `
                    <tr>
                        <td style="padding: 10px; border-bottom: 1px solid #444; position: sticky; left: 0; background: var(--bg-secondary); z-index: 1;">
                            <div style="font-weight: 500;">${player.first_name} ${player.last_name}</div>
                            <div style="font-size: 0.7rem; opacity: 0.6;">#${player.jersey_number || '-'}</div>
                        </td>
                        ${events.map(event => {
                    const response = responses.find(r => r.event_id === event.id && r.player_id === player.id);
                    const status = response ? response.availability : 'none';
                    const icon = {
                        'yes': '‚úÖ',
                        'no': '‚ùå',
                        'maybe': '‚ùì',
                        'none': '‚ö™'
                    }[status];

                    return `
                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #444; cursor: pointer; border-left: 1px solid #444;" 
                                    onclick="toggleAvailability('${event.id}', '${player.id}', '${status}')"
                                    title="${response?.notes || status}">
                                    <span style="font-size: 1.2rem;">${icon}</span>
                                </td>
                            `;
                }).join('')}
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        async function toggleAvailability(eventId, playerId, currentStatus) {
            // Admin override logic (simple cycle: yes -> no -> maybe -> none)
            const newStatus = {
                'yes': 'no',
                'no': 'maybe',
                'maybe': 'yes', // Skip 'none' for easier cycling, but available if needed
                'none': 'yes'
            }[currentStatus] || 'yes';

            try {
                showLoading(true);
                await apiService.overrideAvailability(eventId, playerId, newStatus);
                showNotification('Availability updated', 'success');
                // Refresh grid
                await loadTeamAvailability(currentTeamId);
            } catch (error) {
                console.error('Failed to update availability:', error);
                showNotification('Update failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function viewEventAvailability(eventId) {
            switchTeamTab('availability');
        }

        window.handleRecordResult = handleRecordResult;
        window.setAdminFormation = setAdminFormation;
        window.clearAdminBoard = clearAdminBoard;
        window.saveAdminFormation = saveAdminFormation;
        window.assignPlayerToBoard = assignPlayerToBoard;

        // Dashboard section switching

        // Close modal when clicking outside
        window.addEventListener('click', function (e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        console.log('‚úÖ Admin Dashboard Ready!');

        // OVERRIDE: Hide unfinished Shop and Polls section with Coming Soon page
        setTimeout(() => {
            const sectionsToHide = ['shop', 'polls-section', 'venue-booking'];

            sectionsToHide.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.innerHTML = `
                        <div class="card" style="padding: 0; overflow: hidden; height: 85vh; border:none; background: transparent;">
                            <iframe src="coming-soon.html" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    `;
                } else {
                    // If section is missing from HTML but navigation exists, create it
                    const dashboardContent = document.querySelector('.dashboard-content');
                    if (dashboardContent) {
                        const newSection = document.createElement('div');
                        newSection.id = id;
                        newSection.className = 'dashboard-section';
                        newSection.style.display = 'none';
                        newSection.innerHTML = `
                            <div class="card" style="padding: 0; overflow: hidden; height: 85vh; border:none; background: transparent;">
                                <iframe src="coming-soon.html" style="width: 100%; height: 100%; border: none;"></iframe>
                            </div>
                         `;
                        dashboardContent.appendChild(newSection);
                    }
                }
            });
        }, 800);

        // Dynamic Sport Fields Logic
        // Dynamic Sport Fields Logic
        const sportConfigs = {
            'Football': { label: 'Position', options: ['Goalkeeper', 'Defender', 'Midfielder', 'Forward', 'Striker', 'Winger', 'Full Back'] },
            'Basketball': { label: 'Position', options: ['Point Guard', 'Shooting Guard', 'Small Forward', 'Power Forward', 'Center'] },
            'Rugby': { label: 'Position', options: ['Prop', 'Hooker', 'Lock', 'Flanker', 'Number 8', 'Scrum Half', 'Fly Half', 'Center', 'Winger', 'Full Back'] },
            'Cricket': { label: 'Role', options: ['Batsman', 'Bowler', 'Wicket Keeper', 'All Rounder'] },
            'Tennis': { label: 'Play Style', options: ['Right-Handed', 'Left-Handed'] },
            'Hockey': { label: 'Position', options: ['Goalkeeper', 'Defense', 'Forward', 'Center'] },
            'Volleyball': { label: 'Position', options: ['Setter', 'Libero', 'Outside Hitter', 'Opposite Hitter', 'Middle Blocker'] }
        };

        function initAddPlayerModalControls() {
            const sportSelect = document.getElementById('playerSport');
            if (sportSelect) {
                sportSelect.addEventListener('change', () => updateSportFields('playerSport', 'playerPosition', 'positionOptions', 'playerPositionLabel'));
            }
            const editSportSelect = document.getElementById('editPlayerSport');
            if (editSportSelect) {
                editSportSelect.addEventListener('change', () => updateSportFields('editPlayerSport', 'editPlayerPosition', 'editPositionOptions', 'editPlayerPositionLabel'));
            }
        }

        function updateSportFields(sportSelectId, inputId, datalistId, labelId) {
            const sport = document.getElementById(sportSelectId).value;
            const input = document.getElementById(inputId);
            const datalist = document.getElementById(datalistId);
            const label = document.getElementById(labelId);

            if (!input || !datalist) return;

            const config = sportConfigs[sport] || { label: 'Position', options: [] };

            // Update Label
            if (label) label.textContent = config.label;

            // Update Options
            datalist.innerHTML = config.options.map(opt => `<option value="${opt}">`).join('');

            // Update Placeholder
            input.placeholder = config.options.length > 0 ? `Select or type ${config.label}...` : `Enter ${config.label}`;

            // Clear input if switching sports? Maybe annoying if fixing a typo. Let's keep it.
        }

        // Exposed Function for Edit Form (Legacy support if called elsewhere)
        window.updateEditPositionPlaceholder = function () {
            updateSportFields('editPlayerSport', 'editPlayerPosition', 'editPositionOptions', 'editPlayerPositionLabel');
        };

        window.initAddPlayerModalControls = initAddPlayerModalControls;

        // Initialize controls once script runs
        setTimeout(initAddPlayerModalControls, 1000);

        // Team Player Management
        async function openAddTeamPlayerModal() {
            showModal('addTeamPlayerModal');
            document.getElementById('teamPlayerSearchResults').innerHTML = '';
            document.getElementById('teamPlayerSearch').value = '';
            // Load available players immediately
            searchTeamPlayers();
        }

        async function searchTeamPlayers() {
            const query = document.getElementById('teamPlayerSearch').value.toLowerCase();
            const container = document.getElementById('teamPlayerSearchResults');
            container.innerHTML = '<p>Searching...</p>';

            try {
                // Fetch all club players (filtered)
                const players = await apiService.getClubPlayers(AppState.activeClubId || (AppState.clubs && AppState.clubs[0] ? AppState.clubs[0].id : null));

                // Fetch current team roster to filter out
                // Using global currentTeamId set in openTeamManagement
                if (!currentTeamId) {
                    console.error('No current team ID');
                    return;
                }

                // Ideally we should cache team data or fetch just the roster IDs to be efficient
                // For now, let's just make a quick request or rely on what we might have in memory if we stored it in loadTeamDetails
                const teamData = await apiService.makeRequest(`/teams/${currentTeamId}`);
                const teamPlayerIds = new Set((teamData.players || []).map(p => p.id));

                const available = players.filter(p => !teamPlayerIds.has(p.id) &&
                    (p.first_name.toLowerCase().includes(query) || p.last_name.toLowerCase().includes(query) || p.email.toLowerCase().includes(query))
                );

                if (available.length === 0) {
                    container.innerHTML = '<p style="opacity:0.7;">No matching players found available.</p>';
                    return;
                }

                container.innerHTML = available.map(p => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #444;">
                        <div>
                            <div style="font-weight: bold;">${p.first_name} ${p.last_name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">${p.email}</div>
                        </div>
                        <button class="btn btn-small btn-primary" onclick="addExistingPlayerToTeam('${p.id}')">Add</button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Search failed:', error);
                container.innerHTML = '<p style="color: red;">Search failed</p>';
            }
        }

        async function addExistingPlayerToTeam(playerId) {
            const position = prompt("Enter Position (optional):") || "";
            const number = prompt("Enter Jersey Number (optional):") || "";

            try {
                showLoading(true);
                await apiService.makeRequest(`/teams/${currentTeamId}/players`, {
                    method: 'POST',
                    body: JSON.stringify({ playerId, position, jerseyNumber: number ? parseInt(number) : null })
                });
                showNotification('Player added to team!', 'success');
                closeModal('addTeamPlayerModal');
                loadTeamDetails(currentTeamId); // Refresh
            } catch (error) {
                showNotification('Failed to add player: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle Quick Add Form
        const addTeamPlayerForm = document.getElementById('addTeamPlayerForm');
        if (addTeamPlayerForm) {
            addTeamPlayerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentTeamId) return;

                const firstName = document.getElementById('newTeamPlayerFirstName')?.value;
                const lastName = document.getElementById('newTeamPlayerLastName')?.value;
                const email = document.getElementById('newTeamPlayerEmail').value;
                const position = document.getElementById('newTeamPlayerPosition').value;
                const number = document.getElementById('newTeamPlayerNumber').value;

                try {
                    showLoading(true);
                    await apiService.makeRequest(`/teams/${currentTeamId}/players`, {
                        method: 'POST',
                        body: JSON.stringify({
                            firstName,
                            lastName,
                            playerEmail: email,
                            position,
                            jerseyNumber: number ? parseInt(number) : null
                        })
                    });
                    showNotification('Player added/invited to team!', 'success');
                    closeModal('addTeamPlayerModal');
                    if (typeof loadTeamDetails === 'function') loadTeamDetails(currentTeamId);
                    if (typeof loadPlayers === 'function') loadPlayers();
                    if (typeof loadDashboardStats === 'function') loadDashboardStats();
                } catch (error) {
                    showNotification('Failed to add player: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            });
        }

        window.openAddTeamPlayerModal = openAddTeamPlayerModal;
        window.searchTeamPlayers = searchTeamPlayers;
        window.addExistingPlayerToTeam = addExistingPlayerToTeam;

        // Payment Plans & Stripe Logic
        async function accessStripeAccount() {
            try {
                showLoading(true);
                const result = await apiService.getStripeManageLink();
                if (result && result.url) {
                    window.open(result.url, '_blank');
                } else {
                    showNotification('Could not generate Stripe Dashboard link', 'error');
                }
            } catch (error) {
                console.error('Access Stripe error:', error);
                showNotification('Failed to access Stripe: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editPaymentPlan(planId) {
            const plan = AppState.paymentPlans?.find(p => p.id === planId);
            if (!plan) return;

            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanName').value = plan.name;
            document.getElementById('editPlanAmount').value = Number(plan.amount ?? plan.price ?? 0);
            document.getElementById('editPlanFrequency').value = plan.interval ?? plan.frequency ?? 'month';
            document.getElementById('editPlanDescription').value = plan.description || '';

            // Billing Anchor fields
            const anchorSelect = document.getElementById('editPlanBillingAnchor');
            const anchorDay = document.getElementById('editPlanBillingDay');
            const dayContainer = document.getElementById('editBillingDayContainer');

            if (anchorSelect) {
                anchorSelect.value = plan.billing_anchor_type || 'signup_date';
                if (dayContainer) dayContainer.style.display = (anchorSelect.value === 'fixed_date' ? 'block' : 'none');
            }
            if (anchorDay) anchorDay.value = plan.billing_anchor_day || 1;

            showModal('editPaymentPlanModal');
        }

        async function handleCreatePaymentPlan(e) {
            e.preventDefault();

            // Validation: Ensure Stripe is connected
            if (!AppState.stripeStatus || !AppState.stripeStatus.details_submitted) {
                showNotification('Cannot create payment plan: Stripe account is not fully connected. Please click "Connect Stripe Account" above.', 'error');
                return;
            }

            const name = document.getElementById('planName').value;
            const amount = document.getElementById('planAmount').value;
            const interval = document.getElementById('planInterval').value;
            const description = document.getElementById('planDescription').value;

            try {
                showLoading(true);
                const billingAnchorType = document.getElementById('planBillingAnchor')?.value || 'signup_date';
                const billingAnchorDay = document.getElementById('planBillingDay')?.value || null;

                await apiService.createPaymentPlan({
                    name,
                    amount,
                    interval,
                    description,
                    billingAnchorType,
                    billingAnchorDay: billingAnchorDay ? parseInt(billingAnchorDay) : null,
                    clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
                });
                showNotification('Payment Plan created successfully!', 'success');
                closeModal('createPaymentPlanModal');
                document.getElementById('createPaymentPlanForm').reset();
                if (document.getElementById('createPaymentPlanFormTop')) document.getElementById('createPaymentPlanFormTop').reset();
                loadPaymentPlans(); // Refresh list
            } catch (error) {
                console.error('Create Plan Error:', error);
                showNotification('Failed to create plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleUpdatePaymentPlan(e) {
            e.preventDefault();
            const id = document.getElementById('editPlanId').value;
            const name = document.getElementById('editPlanName').value;
            const amount = document.getElementById('editPlanAmount').value;
            const interval = document.getElementById('editPlanFrequency').value;
            const description = document.getElementById('editPlanDescription').value;
            const billingAnchorType = document.getElementById('editPlanBillingAnchor')?.value || 'signup_date';
            const billingAnchorDay = document.getElementById('editPlanBillingDay')?.value || null;

            try {
                showLoading(true);
                await apiService.updatePaymentPlan(id, {
                    name,
                    amount,
                    interval,
                    description,
                    billingAnchorType,
                    billingAnchorDay: billingAnchorDay ? parseInt(billingAnchorDay) : null
                });
                showNotification('Payment Plan updated successfully!', 'success');
                closeModal('editPaymentPlanModal');
                loadPaymentPlans();
                if (typeof hydrateAddPlayerPlanSelect === 'function') hydrateAddPlayerPlanSelect();
            } catch (error) {
                console.error('Update Plan Error:', error);
                showNotification('Failed to update plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deletePaymentPlan(planId) {
            if (!confirm('Are you sure you want to delete this payment plan?')) return;
            try {
                showLoading(true);
                await apiService.deletePaymentPlan(planId);
                showNotification('Payment plan deleted', 'success');
                loadPaymentPlans();
            } catch (error) {
                showNotification('Failed to delete plan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Wire up listener
        const createPlanForm = document.getElementById('createPaymentPlanForm');
        if (createPlanForm) {
            createPlanForm.addEventListener('submit', handleCreatePaymentPlan);
        }

        async function clearDummyData() {
            if (!confirm('üö® Are you sure? This will PERMANENTLY delete all payment plans, invoices, and payment records for this organization. This cannot be undone.')) return;

            try {
                showLoading(true);
                const result = await apiService.makeRequest('/payments/cleanup', { method: 'POST' });
                showNotification(result.message || 'Dummy data cleared!', 'success');

                // Refresh all relevant sections
                await Promise.all([
                    loadPaymentPlans(),
                    loadFinances(),
                    loadDashboardStats()
                ]);
            } catch (error) {
                console.error('Cleanup error:', error);
                showNotification('Failed to clear data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        window.accessStripeAccount = accessStripeAccount;
        window.handleCreatePaymentPlan = handleCreatePaymentPlan;
        window.handleUpdatePaymentPlan = handleUpdatePaymentPlan;
        window.editPaymentPlan = editPaymentPlan;
        window.deletePaymentPlan = deletePaymentPlan;
        window.clearDummyData = clearDummyData;


        // Shop & Event Custom Logic
        function handleEventTypeChange() {
            const type = document.getElementById('eventType').value;
            const opponentGroup = document.getElementById('eventOpponentGroup');
            if (type === 'match') {
                opponentGroup.style.display = 'block';
                document.getElementById('eventOpponent').setAttribute('required', 'true');
            } else {
                opponentGroup.style.display = 'none';
                document.getElementById('eventOpponent').removeAttribute('required');
                document.getElementById('eventOpponent').value = '';
            }
        }

        function addCustomFieldInput() {
            const container = document.getElementById('productCustomFieldsList');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'custom-field-row';
            div.style.marginBottom = '0.5rem';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '2fr 1fr auto';
            div.style.gap = '0.5rem';
            div.innerHTML = `
                <input type="text" class="field-label" placeholder="Question Label (e.g. Size)" required>
                <select class="field-type">
                    <option value="text">Text</option>
                    <option value="select">Selection</option>
                    <option value="number">Number</option>
                </select>
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">X</button>
                <input type="text" class="field-options" placeholder="Options if selection (comma separated: S,M,L)" style="grid-column: 1 / -1; display: none;">
            `;

            // Show options input if 'select' is chosen
            const typeSelect = div.querySelector('.field-type');
            const optionsInput = div.querySelector('.field-options');
            typeSelect.onchange = () => {
                optionsInput.style.display = typeSelect.value === 'select' ? 'block' : 'none';
                if (typeSelect.value === 'select') optionsInput.setAttribute('required', 'true');
                else optionsInput.removeAttribute('required');
            };

            container.appendChild(div);
        }

        async function handleAddProduct(e) {
            e.preventDefault();

            // Collect Custom Fields
            const customFields = [];
            document.querySelectorAll('#productCustomFieldsList .custom-field-row').forEach(row => {
                const label = row.querySelector('.field-label').value;
                const type = row.querySelector('.field-type').value;
                const options = row.querySelector('.field-options').value;

                if (label) {
                    customFields.push({
                        label,
                        type,
                        options: type === 'select' ? options.split(',').map(s => s.trim()) : null
                    });
                }
            });

            const payload = {
                name: document.getElementById('productName').value,
                price: document.getElementById('productPrice').value,
                stock_quantity: document.getElementById('productStock').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                custom_fields: customFields,
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                // Call API (assumed existing or generic)
                await apiService.makeRequest('/products', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showNotification('Product created successfully!', 'success');
                closeModal('addProductModal');
                // Refresh shop
                if (window.loadShopProducts) window.loadShopProducts();
                else showNotification('Refresh to see new product.', 'info');
            } catch (error) {
                console.error('Create product error:', error);
                showNotification('Failed to create product: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function handleCreateEvent(e) {
            e.preventDefault();

            const payload = {
                title: document.getElementById('eventTitle').value,
                event_type: document.getElementById('eventType').value,
                event_date: document.getElementById('eventDate').value,
                event_time: document.getElementById('eventTime').value,
                location: document.getElementById('eventLocation').value,
                latitude: document.getElementById('eventLat').value || null,
                longitude: document.getElementById('eventLng').value || null,
                description: document.getElementById('eventDescription').value,
                team_id: document.getElementById('eventTeam').value || null,
                opponent: document.getElementById('eventOpponent').value || null,
                clubId: AppState.activeClubId || (AppState.clubs?.[0]?.id)
            };

            try {
                showLoading(true);
                await apiService.createEvent(payload);
                showNotification('Event created successfully!', 'success');
                closeModal('addEventModal');
                if (window.loadEvents) window.loadEvents();
            } catch (error) {
                console.error('Create event error:', error);
                showNotification('Failed to create event: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Application Review Functions
        function reviewApplication(appId) {
            // Find in current listing applications OR general club applications
            const app = (AppState.currentListingApplications?.find(a => a.id === appId)) ||
                (AppState.clubApplications?.find(a => a.id === appId));

            if (!app) {
                console.error('Application not found locally:', appId);
                return;
            }

            const content = document.getElementById('reviewApplicationContent');
            const statusColor = app.application_status === 'approved' ? 'green' : (app.application_status === 'rejected' ? 'red' : 'orange');

            content.innerHTML = `
                <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;">
                    <div class="user-avatar" style="width:60px; height:60px; font-size:1.5rem; background:#3b82f6;">
                        ${(app.first_name?.[0] || 'A')}${(app.last_name?.[0] || '')}
                    </div>
                    <div>
                        <h3 style="margin:0;">${app.first_name} ${app.last_name}</h3>
                        <p style="margin:0; color:var(--text-muted);">${app.email}</p>
                        <span class="status-badge" style="margin-top:0.5rem; display:inline-block; border: 1px solid ${statusColor}; color: ${statusColor};">
                            ${app.application_status || 'Pending'}
                        </span>
                    </div>
                </div>

                <div class="card" style="background: rgba(255,255,255,0.03); margin-bottom: 1rem;">
                    <h4 style="margin-top:0;">Details</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem; margin-bottom:1rem;">
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Position</span>
                            <div style="font-weight:500;">${app.preferred_position || app.position || 'Any'}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Experience</span>
                            <div style="font-weight:500;">${app.experience_level || 'N/A'}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Age</span>
                            <div style="font-weight:500;">${app.player_age || 'N/A'}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-muted); font-size:0.8rem;">Height</span>
                            <div style="font-weight:500;">${app.player_height || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom:0.5rem;">Message</h4>
                    <p style="background: rgba(0,0,0,0.2); padding:1rem; border-radius:8px; line-height:1.5; font-style: italic;">
                        "${app.message || 'No message provided.'}"
                    </p>
                </div>

                ${app.availability && app.availability.length > 0 ? `
                    <div class="card" style="background: rgba(255,255,255,0.03);">
                        <h4 style="margin-top:0;">Availability</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:0.5rem;">
                            ${app.availability.map(day => `<span class="badge">${day}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Wire up buttons
            const approveBtn = document.getElementById('approveAppBtn');
            const rejectBtn = document.getElementById('rejectAppBtn');

            approveBtn.onclick = () => updateApplicationStatus(app.id, 'approved');
            rejectBtn.onclick = () => updateApplicationStatus(app.id, 'rejected');

            // Show/Hide buttons based on current status
            if (app.application_status === 'approved') {
                approveBtn.style.display = 'none';
                rejectBtn.style.display = 'block';
            } else if (app.application_status === 'rejected') {
                rejectBtn.style.display = 'none';
                approveBtn.style.display = 'block';
            } else {
                approveBtn.style.display = 'block';
                rejectBtn.style.display = 'block';
            }

            showModal('reviewApplicationModal');
        }

        // Alias for table row click
        function viewApplicationDetails(appId) {
            reviewApplication(appId);
        }

        async function updateApplicationStatus(appId, status) {
            if (!confirm(`Mark this application as ${status.toUpperCase()}?`)) return;

            try {
                showLoading(true);
                // Check if it's a listing app or general app
                const isListingApp = AppState.currentListingApplications?.some(a => a.id === appId);
                const endpoint = isListingApp
                    ? `/listings/applications/${appId}/status`
                    : `/clubs/applications/${appId}/status`;

                await apiService.makeRequest(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });

                showNotification(`Application marked as ${status}`, 'success');
                closeModal('reviewApplicationModal');

                // Refresh
                if (isListingApp) {
                    const app = AppState.currentListingApplications.find(a => a.id === appId);
                    if (app && app.listing_id) viewListingApplications(app.listing_id);
                } else {
                    loadListings(); // Refreshes general list
                }

            } catch (error) {
                console.error('Update status failed:', error);

                // Fallback attempt
                try {
                    await apiService.makeRequest(`/clubs/applications/${appId}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ status })
                    });
                    showNotification(`Application marked as ${status}`, 'success');
                    closeModal('reviewApplicationModal');
                    loadListings();
                } catch (nestedErr) {
                    showNotification('Failed to update status', 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        window.reviewApplication = reviewApplication;
        window.viewApplicationDetails = viewApplicationDetails;

        // Wire up listeners
        window.handleEventTypeChange = handleEventTypeChange;
        window.addCustomFieldInput = addCustomFieldInput;
        window.handleAddProduct = handleAddProduct;

        const addProdForm = document.getElementById('addProductForm');
        if (addProdForm) addProdForm.addEventListener('submit', handleAddProduct);

        window.filterPlayersByTeam = typeof filterPlayersByTeam !== 'undefined' ? filterPlayersByTeam : null;
        window.filterPlayersByPayment = typeof filterPlayersByPayment !== 'undefined' ? filterPlayersByPayment : null;
        window.resetPlayerFilters = typeof resetPlayerFilters !== 'undefined' ? resetPlayerFilters : null;
        window.handleAcceptMember = typeof handleAcceptMember !== 'undefined' ? handleAcceptMember : null;
        window.handleResendInvite = typeof handleResendInvite !== 'undefined' ? handleResendInvite : null;
        window.editPlayer = typeof editPlayer !== 'undefined' ? editPlayer : null;
        window.removePlayer = typeof removePlayer !== 'undefined' ? removePlayer : null;
        window.exportPlayers = typeof exportPlayers !== 'undefined' ? exportPlayers : null;

        const createEventForm = document.getElementById('createEventForm');
        if (createEventForm) createEventForm.addEventListener('submit', handleCreateEvent);
    </script>

    <!-- Assign Payment Plan Modal -->
    <div id="assignPlanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí≥ Assign Payment Plan</h2>
                <button class="close" onclick="closeModal('assignPlanModal')">&times;</button>
            </div>
            <form id="assignPlanForm">
                <input type="hidden" id="assignPlanUserId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="assignPlanSelect">Select Plan</label>
                        <select id="assignPlanSelect" required class="form-control">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assignPlanStartDate">Start Date</label>
                        <input type="date" id="assignPlanStartDate" class="form-control" required>
                        <script>
                            document.getElementById('assignPlanStartDate').value = new Date().toISOString().split('T')[0];
                        </script>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Assign Plan</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('assignPlanModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Team Player Modal -->
    <div id="addTeamPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Add Player to Team</h2>
                <button class="close" onclick="closeModal('addTeamPlayerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Option 1: Existing Player -->
                <div class="card" style="margin-bottom: 2rem;">
                    <h3>Find Existing Player</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem;">Search for a player in your club
                        who isn't in this team yet.</p>
                    <div style="display: flex; gap: 1rem;">
                        <input type="text" id="teamPlayerSearch" placeholder="Search by name or email..."
                            style="flex:1;">
                        <button class="btn btn-primary" onclick="searchTeamPlayers()">Search</button>
                    </div>
                    <div id="teamPlayerSearchResults" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                        <!-- Results -->
                    </div>
                </div>

                <!-- Option 2: Quick Invite -->
                <div class="card">
                    <h3>Or Quick Add New Player</h3>
                    <form id="addTeamPlayerForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="newTeamPlayerFirstName">First Name</label>
                                <input type="text" id="newTeamPlayerFirstName" placeholder="John" required>
                            </div>
                            <div class="form-group">
                                <label for="newTeamPlayerLastName">Last Name</label>
                                <input type="text" id="newTeamPlayerLastName" placeholder="Doe" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newTeamPlayerEmail">Email Address</label>
                            <input type="email" id="newTeamPlayerEmail" placeholder="Player's email" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="newTeamPlayerPosition">Position</label>
                                <input type="text" id="newTeamPlayerPosition" placeholder="e.g. Striker">
                            </div>
                            <div class="form-group">
                                <label for="newTeamPlayerNumber">Jersey Number</label>
                                <input type="number" id="newTeamPlayerNumber" min="0" max="99">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-secondary">Add to Roster</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add Product Modal with Custom Fields -->
        <div id="addProductModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚ûï Add Shop Product</h2>
                    <button class="close" onclick="closeModal('addProductModal')">&times;</button>
                </div>
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" required placeholder="e.g. Club Training Kit">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="productPrice">Price (¬£)</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productStock">Stock Quantity</label>
                            <input type="number" id="productStock" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Category</label>
                        <select id="productCategory">
                            <option value="apparel">Apparel</option>
                            <option value="equipment">Equipment</option>
                            <option value="accessory">Accessory</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="2"></textarea>
                    </div>

                    <!-- Custom Fields Builder -->
                    <div class="form-group" style="border: 1px solid #333; padding: 1rem; border-radius: 8px;">
                        <label style="margin-bottom: 0.5rem; display: block;">Customization Fields (e.g. Size,
                            Initials)</label>
                        <div id="productCustomFieldsList">
                            <!-- Dynamic fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addCustomFieldInput()"
                            style="margin-top: 0.5rem;">+ Add Field</button>
                        <p style="font-size: 0.8rem; color: #aaa; margin-top: 0.5rem;">These are questions players must
                            answer when buying.</p>
                    </div>

                    <div class="form-group">
                        <label>Product Image</label>
                        <input type="file" id="productImageFile" accept="image/*">
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Save Product</button>
                </form>
            </div>
        </div>

        <!-- Create Event Modal with Dynamic Type Logic -->
        <div id="addEventModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÖ Create New Event</h2>
                    <button class="close" onclick="closeModal('addEventModal')">&times;</button>
                </div>
                <form id="createEventForm">
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" required placeholder="e.g. Weekly Training">
                    </div>
                    <div class="form-group">
                        <label for="eventType">Event Type</label>
                        <select id="eventType" required onchange="handleEventTypeChange()">
                            <option value="training">Training Session</option>
                            <option value="match">Match / Game</option>
                            <option value="tournament">Tournament</option>
                            <option value="camp">Camp</option>
                            <option value="social">Social Event</option>
                            <option value="talent-id">Talent ID / Trial</option>
                        </select>
                    </div>

                    <!-- Dynamic Field: Opponent (Match only) -->
                    <div class="form-group" id="eventOpponentGroup" style="display: none;">
                        <label for="eventOpponent">Opponent Name</label>
                        <input type="text" id="eventOpponent" placeholder="e.g. Manchester City U15">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" required>
                        </div>
                        <div class="form-group">
                            <label for="eventTime">Time</label>
                            <input type="time" id="eventTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="eventLocation">Location Name</label>
                        <input type="text" id="eventLocation" required placeholder="e.g. Training Ground Pitch 1">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="eventLat">Latitude (for Geofencing)</label>
                            <input type="number" id="eventLat" step="any" placeholder="e.g. 51.5074">
                        </div>
                        <div class="form-group">
                            <label for="eventLng">Longitude (for Geofencing)</label>
                            <input type="number" id="eventLng" step="any" placeholder="e.g. -0.1278">
                        </div>
                    </div>

                    <!-- Dynamic Field: Team Selection -->
                    <div class="form-group">
                        <label for="eventTeam">Assign to Team</label>
                        <select id="eventTeam">
                            <option value="">All Club (No Specific Team)</option>
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eventDescription">Description / Notes</label>
                        <textarea id="eventDescription" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">üìÖ Create Event</button>
                </form>
            </div>
        </div>
        <script>
            // Tournament Logic
            async function loadTournamentDashboard(eventId) {
                if (!eventId) return;
                try {
                    const data = await apiService.makeRequest(`/tournaments/${eventId}/dashboard`);
                    const teamsList = document.getElementById('tournamentTeamsList');
                    const matchesList = document.getElementById('tournamentMatchesList');

                    // Render Teams
                    teamsList.innerHTML = data.teams.map(t => `
                <div class="item-list-item">
                    <div class="item-info">
                        <h4>${t.team_name}</h4>
                        <p>${t.contact_email}</p>
                    </div>
                    <button class="btn btn-small ${t.status === 'checked_in' ? 'btn-primary' : 'btn-secondary'}" 
                            onclick="toggleTeamCheckIn('${t.id}', '${t.status}')">
                        ${t.status === 'checked_in' ? 'Checked In' : 'Check In'}
                    </button>
                </div>
            `).join('');

                    // Render Matches
                    matchesList.innerHTML = data.matches.map(m => {
                        const homeName = data.teams.find(t => t.id === m.home_team_id)?.team_name || 'TBD';
                        const awayName = data.teams.find(t => t.id === m.away_team_id)?.team_name || 'TBD';
                        return `
                <div class="item-list-item" style="border-left: 4px solid ${m.status === 'completed' ? '#4caf50' : '#ffa000'};">
                    <div class="item-info">
                        <h4>${homeName} vs ${awayName}</h4>
                        <p>${m.stage_id ? 'Stage Match' : 'Match'}</p>
                    </div>
                    <div style="display:flex; gap:0.5rem; align-items:center;">
                        <input type="number" style="width:50px; padding:4px;" value="${m.home_score}" id="score_home_${m.id}">
                        <span>-</span>
                        <input type="number" style="width:50px; padding:4px;" value="${m.away_score}" id="score_away_${m.id}">
                        <button class="btn btn-small btn-primary" onclick="updateMatchResult('${m.id}')">Save</button>
                    </div>
                </div>
            `}).join('');

                } catch (err) {
                    console.error(err);
                }
            }

            async function toggleTeamCheckIn(teamId, currentStatus) {
                const newStatus = currentStatus === 'checked_in' ? 'approved' : 'checked_in';
                await apiService.makeRequest(`/tournaments/teams/${teamId}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status: newStatus })
                });
                loadTournamentDashboard(document.getElementById('tournamentSelect').value);
            }

            async function generateFixtures(type) {
                const eventId = document.getElementById('tournamentSelect').value;
                if (!eventId) return;
                if (!confirm(`Generate ${type} fixtures? This cannot be undone.`)) return;

                await apiService.makeRequest(`/tournaments/${eventId}/generate-fixtures`, {
                    method: 'POST',
                    body: JSON.stringify({ type })
                });
                loadTournamentDashboard(eventId);
            }

            async function updateMatchResult(matchId) {
                const home = document.getElementById(`score_home_${matchId}`).value;
                const away = document.getElementById(`score_away_${matchId}`).value;
                await apiService.makeRequest(`/tournaments/matches/${matchId}/result`, {
                    method: 'POST',
                    body: JSON.stringify({ homeScore: home, awayScore: away })
                });
                loadTournamentDashboard(document.getElementById('tournamentSelect').value);
            }

            // ========================================
            // PLAYER FILTERS - WIRED UP ‚úÖ
            // ========================================


            function resetPlayerFilters() {
                document.getElementById('playerListFilter').value = 'all';
                document.getElementById('teamFilter').value = '';
                document.getElementById('sportFilter').value = '';
                document.getElementById('locationFilter').value = '';
                document.getElementById('minAgeFilter').value = '';
                document.getElementById('maxAgeFilter').value = '';
                loadPlayers();
            }

            async function deletePlayer(playerId) {
                if (!confirm('Are you sure you want to remove this player? This action cannot be undone.')) {
                    return;
                }

                try {
                    await apiService.makeRequest(`/players/${playerId}`, {
                        method: 'DELETE'
                    });

                    showNotification('Player removed successfully', 'success');
                    loadPlayers();
                } catch (error) {
                    console.error('Delete player error:', error);
                    showNotification('Failed to delete player: ' + error.message, 'error');
                }
            }

            async function editPlayer(playerId) {
                try {
                    showLoading(true);
                    const player = await apiService.getPlayerById(playerId);

                    // Store current player object for context
                    AppState.editingPlayer = player;

                    document.getElementById('editPlayerId').value = player.id;
                    document.getElementById('editPlayerFirstName').value = player.first_name || '';
                    document.getElementById('editPlayerLastName').value = player.last_name || '';
                    document.getElementById('editPlayerEmail').value = player.email || '';
                    document.getElementById('editPlayerPhone').value = player.phone || '';
                    document.getElementById('editPlayerDOB').value = player.date_of_birth ? player.date_of_birth.split('T')[0] : '';

                    document.getElementById('editPlayerSport').value = player.sport || '';
                    document.getElementById('editPlayerGender').value = player.gender || '';
                    document.getElementById('editPlayerLocation').value = player.location || '';
                    document.getElementById('editPlayerBio').value = player.bio || '';

                    document.getElementById('editPlayerPosition').value = player.position || '';
                    document.getElementById('editPlayerPaymentStatus').value = player.payment_status || 'pending';

                    // Toggle "Accept Member" button if it's an invited member
                    const acceptBtn = document.getElementById('acceptMemberBtn');
                    const resendBtn = document.getElementById('resendInviteBtn');

                    if (player.join_status === 'invited') {
                        if (acceptBtn) acceptBtn.style.display = 'inline-block';
                        if (resendBtn) resendBtn.style.display = 'inline-block';
                    } else {
                        if (acceptBtn) acceptBtn.style.display = 'none';
                        if (resendBtn) resendBtn.style.display = 'none';
                    }

                    showModal('editPlayerModal');
                } catch (error) {
                    console.error('Fetch player error:', error);
                    showNotification('Failed to load player data', 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function handleAcceptMember() {
                const playerId = document.getElementById('editPlayerId').value;
                if (!confirm('Are you sure you want to manually accept this member? They will be promoted to a full player.')) return;

                try {
                    showLoading(true);
                    const result = await apiService.acceptMember(playerId);
                    showNotification(result.message || 'Member accepted successfully', 'success');
                    closeModal('editPlayerModal');
                    loadPlayers();
                    loadDashboardStats();
                } catch (error) {
                    console.error('Accept member error:', error);
                    showNotification('Failed to accept member: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function handleResendInvite() {
                const player = AppState.editingPlayer;
                if (!player || !player.email) return;

                try {
                    showLoading(true);
                    // Re-trigger invite via generateClubInvite logic
                    const inviteData = {
                        email: player.email,
                        clubRole: player.role || 'player',
                        message: `Reminder: You've been invited to join our organization.`,
                        organizationId: AppState.currentOrganization?.id,
                        clubId: AppState.currentOrganization?.id,
                        isPublic: false
                    };

                    const response = await apiService.generateClubInvite(inviteData);
                    if (response.success) {
                        showNotification('Invitation resent successfully!', 'success');
                    } else {
                        throw new Error(response.error || 'Failed to resend invitation');
                    }
                } catch (error) {
                    console.error('Resend invite error:', error);
                    showNotification('Failed to resend invite: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function handleEditPlayer(e) {
                e.preventDefault();
                const playerId = document.getElementById('editPlayerId').value;

                const payload = {
                    firstName: document.getElementById('editPlayerFirstName').value.trim(),
                    lastName: document.getElementById('editPlayerLastName').value.trim(),
                    email: document.getElementById('editPlayerEmail').value.trim(),
                    phone: document.getElementById('editPlayerPhone').value.trim(),
                    dateOfBirth: document.getElementById('editPlayerDOB').value,

                    // CV Fields
                    sport: document.getElementById('editPlayerSport').value,
                    gender: document.getElementById('editPlayerGender').value,
                    location: document.getElementById('editPlayerLocation').value.trim(),
                    bio: document.getElementById('editPlayerBio').value.trim(),

                    position: document.getElementById('editPlayerPosition').value.trim(),
                    paymentStatus: document.getElementById('editPlayerPaymentStatus').value,
                    clubId: AppState.currentOrganization?.id || (AppState.clubs?.[0]?.id)
                };



                try {
                    showLoading(true);
                    await apiService.makeRequest(`/players/${playerId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });

                    showNotification('Player updated successfully', 'success');
                    closeModal('editPlayerModal');
                    loadPlayers();
                } catch (error) {
                    console.error('Update player error:', error);
                    showNotification('Failed to update player: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            function exportPlayers() {
                try {
                    const players = PlayerDashboardState?.players || [];

                    if (players.length === 0) {
                        showNotification('No players to export', 'warning');
                        return;
                    }

                    // Create CSV header
                    const headers = ['First Name', 'Last Name', 'Email', 'Position', 'Age', 'Location', 'Sport', 'Status'];
                    const csvRows = [headers.join(',')];

                    // Add player data
                    players.forEach(player => {
                        const row = [
                            player.first_name || '',
                            player.last_name || '',
                            player.email || '',
                            player.position || '',
                            player.age || '',
                            player.location || '',
                            player.sport || '',
                            player.has_payment_plan ? 'On Plan' : 'No Plan'
                        ];
                        csvRows.push(row.map(field => `"${field}"`).join(','));
                    });

                    // Create and download CSV
                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `players_export_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);

                    showNotification('Players exported successfully!', 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showNotification('Failed to export players', 'error');
                }
            }

            // ========================================
            // POLLS & VOTING ‚úÖ
            // ========================================
            async function loadPolls() {
                try {
                    const orgId = AppState.currentOrganization?.id;
                    const polls = await apiService.makeRequest(`/polls?organizationId=${orgId}`);
                    displayPolls(polls);
                } catch (error) {
                    console.error('Load polls error:', error);
                    document.getElementById('pollsContainer').innerHTML = '<p>Error loading polls.</p>';
                }
            }

            function displayPolls(polls) {
                const container = document.getElementById('pollsContainer');
                if (!polls || polls.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No active polls found.</p>';
                    return;
                }

                container.innerHTML = polls.map(poll => {
                    const options = JSON.parse(poll.options);
                    const totalVotes = poll.results.reduce((sum, r) => sum + parseInt(r.count), 0);

                    return `
                        <div class="card" style="border: 1px solid var(--border-color);">
                            <h4>${poll.title}</h4>
                            <p style="opacity: 0.7; font-size: 0.9rem;">${poll.description || ''}</p>
                            <div class="poll-options" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                                ${options.map(opt => {
                        const voteData = poll.results.find(r => r.selection === opt);
                        const count = voteData ? parseInt(voteData.count) : 0;
                        const percent = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
                        const isUserVote = poll.userVote === opt;

                        return `
                                        <div class="poll-option-row" onclick="voteOnPoll('${poll.id}', '${opt}')" 
                                             style="cursor: pointer; position: relative; background: var(--bg-secondary); border-radius: 8px; overflow: hidden; border: 1px solid ${isUserVote ? 'var(--primary)' : 'transparent'};">
                                            <div class="poll-bar" style="position: absolute; left: 0; top: 0; bottom: 0; width: ${percent}%; background: rgba(220, 67, 67, 0.1);"></div>
                                            <div style="position: relative; z-index: 1; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center;">
                                                <span>${isUserVote ? '‚óè ' : ''}${opt}</span>
                                                <span style="font-weight: bold;">${Math.round(percent)}% (${count})</span>
                                            </div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.5;">Total Votes: ${totalVotes} ‚Ä¢ Status: ${poll.status}</p>
                        </div>
                    `;
                }).join('');
            }

            async function createPoll(e) {
                e.preventDefault();
                const title = document.getElementById('pollTitle').value;
                const description = document.getElementById('pollDescription').value;
                const optionsRaw = document.getElementById('pollOptions').value;
                const expiresAt = document.getElementById('pollExpires').value;

                const options = optionsRaw.split('\n').map(o => o.trim()).filter(o => o.length > 0);

                if (options.length < 2) {
                    alert('Please provide at least 2 options.');
                    return;
                }

                try {
                    await apiService.makeRequest('/polls', {
                        method: 'POST',
                        body: JSON.stringify({
                            title,
                            description,
                            options,
                            expiresAt: expiresAt || null,
                            organizationId: AppState.currentOrganization.id
                        })
                    });

                    closeModal('createPollModal');
                    document.getElementById('createPollForm').reset();
                    loadPolls();
                    showNotification('Poll launched successfully!', 'success');
                } catch (error) {
                    console.error('Create poll error:', error);
                    alert('Failed to launch poll: ' + error.message);
                }
            }

            async function voteOnPoll(pollId, selection) {
                try {
                    await apiService.makeRequest(`/polls/${pollId}/vote`, {
                        method: 'POST',
                        body: JSON.stringify({ selection })
                    });
                    loadPolls();
                } catch (error) {
                    console.error('Vote error:', error);
                    showNotification(error.message, 'error');
                }
            }

            // Bind forms
            document.getElementById('createPollForm')?.addEventListener('submit', createPoll);

            // Expose globally
            window.loadPolls = loadPolls;
            window.voteOnPoll = voteOnPoll;

            // Updated showSection switcher for Polls
            const originalShowSection = window.showSection;
            window.showSection = function (sectionId) {
                if (originalShowSection) originalShowSection(sectionId);
                if (sectionId === 'polls-section') loadPolls();
            };

            // Expose functions globally
            window.deletePlayer = deletePlayer;
            window.editPlayer = editPlayer;
            window.exportPlayers = exportPlayers;

            // ============================================================================
            // NEW RBAC INVITATION SYSTEM
            // ============================================================================

            /**
             * Handle new role-based invitation
             */
            async function toggleStaffTeamSelect(role) {
                const teamGroup = document.getElementById('staffTeamSelectGroup');
                const teamSelect = document.getElementById('staffInviteTeam');
                if (!teamGroup || !teamSelect) return;

                if (role === 'coach' || role === 'assistant_coach') {
                    teamGroup.style.display = 'block';
                    // Populate if empty
                    if (teamSelect.options.length <= 1) {
                        try {
                            const context = await apiService.getContext();
                            const orgId = context?.currentOrganization?.id;
                            if (orgId) {
                                const teams = await apiService.makeRequest(`/teams?organizationId=${orgId}`);
                                if (Array.isArray(teams)) {
                                    teams.forEach(team => {
                                        const option = document.createElement('option');
                                        option.value = team.id;
                                        option.textContent = team.name;
                                        teamSelect.appendChild(option);
                                    });
                                }
                            }
                        } catch (e) {
                            console.error('Failed to load teams for staff invite', e);
                        }
                    }
                } else {
                    teamGroup.style.display = 'none';
                    teamSelect.value = "";
                }
            }

            async function handleNewInvite(e) {
                e.preventDefault();

                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥ Sending...';
                btn.disabled = true;

                const email = document.getElementById('staffInviteEmail').value.trim();
                const role = document.getElementById('staffInviteRole').value;
                const message = document.getElementById('staffInviteMessage').value.trim();
                const teamId = document.getElementById('staffInviteTeam')?.value || null;

                if (!email || !role) {
                    showNotification('Please fill in all required fields', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                try {
                    // Get current organization ID
                    const context = await apiService.getContext();
                    const orgId = context?.currentOrganization?.id;

                    if (!orgId) {
                        throw new Error('No organization context found');
                    }

                    // Use generateClubInvite (from invites.js) which supports teamId
                    // Mapping checks: invites.js expects 'clubRole', 'teamId'
                    const inviteData = {
                        email,
                        clubRole: role,
                        message: message || `You've been invited to join our organization as a ${role}.`,
                        teamId: teamId, // Optional, null if not selected
                        organizationId: orgId,
                        clubId: orgId, // Ensure clubId is passed for backend compatibility
                        isPublic: false
                    };

                    console.log('Sending Invite Data:', inviteData);

                    // We use generateClubInvite which calls /invites/generate
                    const response = await apiService.generateClubInvite(inviteData);

                    if (response.success) {
                        showNotification(`‚úÖ Invitation sent to ${email}!`, 'success');
                        closeModal('inviteStaffModal');
                        e.target.reset();

                        // Shareable link logic (if returned)
                        if (response.inviteLink) {
                            // ... existing logic if needed ...
                        }
                    } else {
                        throw new Error(response.error || 'Failed to send invitation');
                    }
                } catch (error) {
                    console.error('Failed to send invitation:', error);
                    showNotification(`Failed to send invitation: ${error.message}`, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // Expose globally
            window.handleNewInvite = handleNewInvite;
            window.toggleStaffTeamSelect = toggleStaffTeamSelect;

            /**
             * Quick invite helpers - Pre-fill modal with specific role
             */
            async function invitePlayerRBAC() {
                // 1. Populate Team Select if needed
                const teamSelect = document.getElementById('inviteTeam');
                if (teamSelect && teamSelect.options.length <= 1) {
                    try {
                        const context = await apiService.getContext();
                        const orgId = context?.currentOrganization?.id;
                        const teams = await apiService.makeRequest(`/teams?organizationId=${orgId}`);
                        if (Array.isArray(teams)) {
                            teams.forEach(team => {
                                const option = document.createElement('option');
                                option.value = team.id;
                                option.textContent = team.name;
                                teamSelect.appendChild(option);
                            });
                        }
                    } catch (e) {
                        console.error('Failed to load teams for invite modal', e);
                    }
                }

                // 2. Open Correct Modal
                showModal('invitePlayerModal');
            }

            async function handlePlayerInvite(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚è≥ Sending...';
                btn.disabled = true;

                try {
                    const context = await apiService.getContext();
                    const orgId = context?.currentOrganization?.id;

                    const data = {
                        firstName: document.getElementById('inviteFirstName').value,
                        lastName: document.getElementById('inviteLastName').value,
                        email: document.getElementById('inviteEmail').value,
                        clubRole: document.getElementById('inviteRole').value,
                        teamId: document.getElementById('inviteTeam').value || null,
                        message: document.getElementById('inviteMessage').value,
                        isPublic: false, // Specific invite via email
                        organizationId: orgId,
                        clubId: orgId
                    };

                    await apiService.generateClubInvite(data);

                    showNotification('Invite sent successfully! üìß', 'success');
                    closeModal('invitePlayerModal');
                    e.target.reset();

                    // Auto-refresh data
                    if (typeof loadPlayers === 'function') loadPlayers();
                    if (typeof loadDashboardStats === 'function') loadDashboardStats();
                } catch (error) {
                    console.error('Invite Error:', error);
                    showNotification(error.message || 'Failed to send invite', 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // Bind Invite Player Form
            document.addEventListener('DOMContentLoaded', () => {
                const invitePlayerForm = document.getElementById('invitePlayerForm');
                if (invitePlayerForm) invitePlayerForm.addEventListener('submit', handlePlayerInvite);
            });

            function quickInvite(role) {
                document.getElementById('staffInviteRole').value = role;
                showModal('inviteStaffModal');
            }

            // Expose globally
            window.invitePlayerRBAC = invitePlayerRBAC;
            window.quickInvite = quickInvite;

            async function inviteCoachToTeam(teamId) {
                // 1. Set Role
                const roleSelect = document.getElementById('staffInviteRole');
                if (roleSelect) roleSelect.value = 'coach';

                // 2. Trigger toggle to show/populate team select
                await toggleStaffTeamSelect('coach');

                // 3. Set Team
                const teamSelect = document.getElementById('staffInviteTeam');
                if (teamSelect && teamId) {
                    let attempts = 0;
                    const checkOptions = setInterval(() => {
                        attempts++;
                        if (teamSelect.options.length > 1) {
                            teamSelect.value = teamId;
                            clearInterval(checkOptions);
                        } else if (attempts > 50) { // 5 seconds timeout
                            clearInterval(checkOptions);
                        }
                    }, 100);
                }

                // 4. Show Modal
                showModal('inviteStaffModal');
            }
            window.inviteCoachToTeam = inviteCoachToTeam;

            // ============================================================================
            // CLUB PROFILE MANAGEMENT
            // ============================================================================

            let currentOrgId = null; // Store the org ID when profile loads

            async function loadClubProfile() {
                try {
                    const context = await apiService.getContext();
                    let org = context.currentOrganization;

                    console.log('üìñ Loading profile section. Org from context:', org);

                    if (!org) {
                        console.warn('‚ö†Ô∏è No organization found in context');
                        return;
                    }

                    // If we have an org but it's missing profile fields, it's partial data.
                    if (org && org.id && (org.description === undefined || org.images === undefined)) {
                        console.log('üîÑ Context data looks partial. Attempting deep fetch via getClub...');

                        try {
                            // Try to fetch full details using the clubs/organizations endpoint
                            // (Since we updated clubs.js to query organizations, this should work)
                            const fullOrg = await apiService.getClubById(org.id);

                            if (fullOrg && fullOrg.id) {
                                console.log('‚úÖ Deep fetch successful:', fullOrg);
                                // Merge the full data into our org object
                                org = { ...org, ...fullOrg };
                            } else {
                                // Fallback to refresh context if deep fetch fails
                                await apiService.refreshContext();
                                const freshContext = await apiService.getContext();
                                org = freshContext.currentOrganization;
                            }
                        } catch (err) {
                            console.warn('‚ö†Ô∏è Deep fetch failed, falling back to refresh:', err);
                            await apiService.refreshContext();
                            const freshContext = await apiService.getContext();
                            org = freshContext.currentOrganization;
                        }
                    }

                    if (!org) return;

                    console.log('‚ú® Data used for population:', {
                        name: org.name,
                        description: org.description ? 'present' : 'missing/empty',
                        images: org.images ? `count: ${org.images.length}` : 'missing',
                        philosophy: org.philosophy ? 'present' : 'missing'
                    });

                    // Store the org ID
                    currentOrgId = org.id;

                    // Populate fields ONLY if the data exists in the object (avoid overwriting with empty if partial)
                    if (org.name !== undefined) document.getElementById('clubName').value = org.name || '';
                    if (org.description !== undefined) document.getElementById('clubDescription').value = org.description || '';
                    if (org.location !== undefined) document.getElementById('clubLocation').value = org.location || '';
                    if (org.sport !== undefined) document.getElementById('clubSport').value = org.sport || '';
                    if (org.website !== undefined) document.getElementById('clubWebsite').value = org.website || '';
                    if (org.philosophy !== undefined) document.getElementById('clubPhilosophy').value = org.philosophy || '';
                    if (org.email !== undefined) document.getElementById('clubEmail').value = org.email || '';
                    if (org.phone !== undefined) document.getElementById('clubPhone').value = org.phone || '';
                    if (org.established !== undefined) document.getElementById('clubEstablished').value = org.established || '';
                    if (org.address !== undefined) document.getElementById('clubAddress').value = org.address || '';

                    // Display logo if exists or show placeholder
                    const rawBaseUrl = apiService.baseURL.replace('/api', '');
                    const backendUrl = rawBaseUrl.endsWith('/') ? rawBaseUrl : rawBaseUrl + '/';
                    let logoUrl = 'images/placeholder-logo-profile.png';

                    if (org.logo_url) {
                        if (org.logo_url.startsWith('http')) {
                            logoUrl = org.logo_url;
                        } else {
                            // Ensure no double slashes and no missing slashes
                            const sanitizedLogoPath = org.logo_url.startsWith('/') ? org.logo_url.substring(1) : org.logo_url;
                            logoUrl = `${backendUrl}${sanitizedLogoPath}`;
                        }
                    }

                    const logoPreview = document.getElementById('clubLogoPreview');
                    if (logoPreview) logoPreview.src = logoUrl;

                    // Display images
                    const uploadedPicturesDiv = document.getElementById('uploadedPictures');
                    const uploadPlaceholder = document.querySelector('.upload-placeholder');

                    // Handle potential stringified PG arrays just in case
                    let orgImages = org.images || [];
                    if (typeof orgImages === 'string') {
                        try {
                            orgImages = orgImages.replace(/{/g, '').replace(/}/g, '').split(',').filter(i => i);
                        } catch (e) { orgImages = []; }
                    }

                    if (orgImages.length > 0) {
                        console.log('üñºÔ∏è Rendering ' + orgImages.length + ' images');
                        if (uploadPlaceholder) uploadPlaceholder.style.display = 'none';
                        if (uploadedPicturesDiv) {
                            uploadedPicturesDiv.style.display = 'block';
                            const rawBaseUrl = apiService.baseURL.replace('/api', '');
                            const backendUrl = rawBaseUrl.endsWith('/') ? rawBaseUrl : rawBaseUrl + '/';
                            uploadedPicturesDiv.innerHTML = orgImages.map(img => {
                                const sanitizedPath = img.startsWith('/') ? img.substring(1) : img;
                                const fullImageUrl = img.startsWith('http') ? img : `${backendUrl}${sanitizedPath}`;
                                return `
                                    <div style="display: inline-block; margin: 0.5rem; position: relative;">
                                        <img src="${fullImageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                        <button type="button" onclick="event.stopPropagation(); deleteClubImage('${org.id}', '${img}')" 
                                                style="position: absolute; top: -8px; right: -8px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 10;">√ó</button>
                                    </div>
                                `;
                            }).join('');
                        }
                    } else {
                        console.log('‚ÑπÔ∏è No images to render');
                        if (uploadPlaceholder) uploadPlaceholder.style.display = 'block';
                        if (uploadedPicturesDiv) {
                            uploadedPicturesDiv.style.display = 'none';
                            uploadedPicturesDiv.innerHTML = '';
                        }
                    }
                } catch (error) {
                    console.error('Failed to load club profile:', error);
                }
            }

            async function saveClubProfile(e) {
                e.preventDefault();

                try {
                    showLoading(true);

                    // Use the stored org ID from when profile was loaded
                    const orgId = currentOrgId;
                    console.log('üíæ Saving with org ID:', orgId);

                    if (!orgId) {
                        console.error('‚ùå No organization ID available.');
                        showNotification('‚ùå No active organization found.', 'error');
                        return;
                    }

                    const formData = {
                        name: document.getElementById('clubName').value.trim(),
                        description: document.getElementById('clubDescription').value.trim(),
                        location: document.getElementById('clubLocation').value.trim(),
                        sport: document.getElementById('clubSport').value.trim(),
                        philosophy: document.getElementById('clubPhilosophy').value.trim(),
                        email: document.getElementById('clubEmail').value.trim(),
                        phone: document.getElementById('clubPhone').value.trim(),
                        established: document.getElementById('clubEstablished').value.trim(),
                        address: document.getElementById('clubAddress').value.trim(),
                        website: document.getElementById('clubWebsite').value.trim()
                    };

                    console.log('üì§ Sending update request:', formData);

                    // Use the organizations endpoint
                    const response = await apiService.updateClub(orgId, formData);
                    console.log('üì• Save response:', response);

                    if (!response.success) {
                        throw new Error(response.error || 'Failed to save profile');
                    }

                    showNotification('‚úÖ Club profile updated successfully!', 'success');

                    // Force refresh context so next getContext() gets fresh data
                    await apiService.refreshContext();

                    // Reload the entire profile to refresh images and all data
                    await loadClubProfile();
                } catch (error) {
                    console.error('Save profile error:', error);
                    showNotification('‚ùå ' + (error.message || 'Failed to save profile'), 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Logo upload handler
            window.handleLogoUpload = async function (input) {
                if (!input.files || input.files.length === 0) return;

                if (!currentOrgId) {
                    showNotification('‚ùå Please wait for profile to load', 'error');
                    return;
                }

                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('‚ùå File too large (max 5MB)', 'error');
                    return;
                }

                try {
                    showLoading(true);

                    // Demo mode handling
                    if (localStorage.getItem('isDemoSession') === 'true' || String(currentOrgId).startsWith('demo-')) {
                        console.log('‚ú® Demo mode: Simulating logo upload');
                        await new Promise(resolve => setTimeout(resolve, 800)); // Simulate delay

                        // Just update preview with a local object URL for the demo session
                        const objectUrl = URL.createObjectURL(file);
                        document.getElementById('clubLogoPreview').src = objectUrl;
                        showNotification('‚úÖ Logo updated (Demo Mode)', 'success');
                        return;
                    }

                    const response = await apiService.uploadClubLogo(currentOrgId, file);

                    if (response.success && response.logo_url) {
                        // Update preview immediately
                        const rawBaseUrl = apiService.baseURL.replace('/api', '');
                        const backendUrl = rawBaseUrl.endsWith('/') ? rawBaseUrl : rawBaseUrl + '/';
                        const sanitizedLogoPath = response.logo_url.startsWith('/') ? response.logo_url.substring(1) : response.logo_url;
                        const fullUrl = response.logo_url.startsWith('http') ? response.logo_url : `${backendUrl}${sanitizedLogoPath}`;

                        document.getElementById('clubLogoPreview').src = fullUrl;
                        showNotification('‚úÖ Logo uploaded successfully!', 'success');

                        // Update Org Switcher immediately
                        if (window.orgSwitcher) {
                            console.log('üîÑ Refreshing Org Switcher with new logo...');
                            window.orgSwitcher.init();
                        }
                    }
                } catch (error) {
                    console.error('Logo upload error:', error);
                    showNotification('‚ùå Failed to upload logo', 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Image upload handler
            async function handlePictureUpload(input) {
                if (!input.files || input.files.length === 0) return;

                if (!currentOrgId) {
                    showNotification('‚ùå Please wait for the profile to load before uploading images.', 'error');
                    return;
                }

                const uploadedPicturesDiv = document.getElementById('uploadedPictures');
                const uploadPlaceholder = document.querySelector('.upload-placeholder');

                // Show container immediately if hidden
                if (uploadedPicturesDiv) uploadedPicturesDiv.style.display = 'block';
                if (uploadPlaceholder) uploadPlaceholder.style.display = 'none';

                // Check limit (Max 5)
                const currentImages = uploadedPicturesDiv.querySelectorAll('img').length;
                if (currentImages + input.files.length > 5) {
                    showNotification(`‚ùå Limit reached! You can only have 5 images. (Current: ${currentImages})`, 'error');
                    input.value = '';
                    return;
                }

                let successCount = 0;

                for (const file of input.files) {
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification(`‚ùå ${file.name} is too large (max 5MB)`, 'error');
                        continue;
                    }

                    try {
                        showLoading(true);
                        const response = await apiService.uploadClubImage(currentOrgId, file);

                        if (response.images) {
                            successCount++;
                            // Immediate update using the response images array
                            const backendUrl = apiService.baseURL.replace('/api', '');

                            // Re-render the gallery with the updated list from server
                            uploadedPicturesDiv.innerHTML = response.images.map(img => {
                                const fullImageUrl = img.startsWith('http') ? img : `${backendUrl}${img}`;
                                return `
                                    <div style="display: inline-block; margin: 0.5rem; position: relative;">
                                        <img src="${fullImageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button onclick="deleteClubImage('${currentOrgId}', '${img}', event)" 
                                                style="position: absolute; top: -8px; right: -8px; background: red; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">√ó</button>
                                    </div>
                                `;
                            }).join('');
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        showNotification(`‚ùå Failed to upload ${file.name}: ${error.message}`, 'error');
                    }
                }

                showLoading(false);
                if (successCount > 0) {
                    showNotification(`‚úÖ ${successCount} image(s) uploaded successfully!`, 'success');
                }

                // Clear input to allow re-uploading same file if needed
                input.value = '';
            }

            // Delete image handler
            async function deleteClubImage(orgId, imageUrl) {
                if (!confirm('Are you sure you want to delete this image?')) return;

                try {
                    showLoading(true);
                    await apiService.deleteClubImage(orgId, imageUrl);
                    showNotification('‚úÖ Image deleted successfully!', 'success');

                    // Reload profile to refresh images
                    await loadClubProfile();
                } catch (error) {
                    console.error('Delete image error:', error);
                    showNotification('‚ùå Failed to delete image: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Bind club profile form
            document.getElementById('clubProfileForm')?.addEventListener('submit', saveClubProfile);




            // Expose globally
            window.loadClubProfile = loadClubProfile;
            window.saveClubProfile = saveClubProfile;
            window.handlePictureUpload = handlePictureUpload;
            window.loadPlayers = loadPlayers;
            window.accessStripeAccount = accessStripeAccount;
            window.deleteClubImage = deleteClubImage;
        </script>

        <script src="org-switcher.js"></script>
        <!-- Edit Payment Plan Modal -->
        <div id="editPaymentPlanModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úèÔ∏è Edit Payment Plan</h2>
                    <button class="close" onclick="closeModal('editPaymentPlanModal')">&times;</button>
                </div>
                <form id="editPaymentPlanForm">
                    <input type="hidden" id="editPlanId">
                    <div class="form-group">
                        <label for="editPlanName">Plan Name *</label>
                        <input type="text" id="editPlanName" required placeholder="e.g. Annual Membership 2025">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label for="editPlanAmount">Amount (¬£) *</label>
                            <input type="number" id="editPlanAmount" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="editPlanInterval">Billing Frequency *</label>
                            <select id="editPlanInterval" required>
                                <option value="month">Monthly</option>
                                <option value="year">Yearly</option>
                                <option value="week">Weekly</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editPlanDescription">Description</label>
                        <textarea id="editPlanDescription" rows="3" placeholder="What does this plan cover?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                </form>
            </div>
        </div>

        <script>
            // Edit Payment Plan Logic
            window.editPaymentPlan = function (planId) {
                console.log('Editing plan:', planId);
                const plan = AppState.paymentPlans ? AppState.paymentPlans.find(p => p.id === planId) : null;

                if (!plan) {
                    showNotification('Plan details not found. Please refresh.', 'error');
                    return;
                }

                document.getElementById('editPlanId').value = plan.id;
                document.getElementById('editPlanName').value = plan.name;
                document.getElementById('editPlanAmount').value = plan.amount ?? plan.price;

                // Normalize interval match
                let interval = (plan.interval || plan.frequency || 'month').toLowerCase();
                if (interval === 'monthly') interval = 'month';
                if (interval === 'yearly') interval = 'year';
                if (interval === 'weekly') interval = 'week';
                document.getElementById('editPlanInterval').value = interval;

                document.getElementById('editPlanDescription').value = plan.description || '';

                showModal('editPaymentPlanModal');
            };

            // Handle Edit Submit
            const editPlanForm = document.getElementById('editPaymentPlanForm');
            if (editPlanForm) {
                editPlanForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const planId = document.getElementById('editPlanId').value;
                    const updates = {
                        name: document.getElementById('editPlanName').value,
                        amount: document.getElementById('editPlanAmount').value,
                        interval: document.getElementById('editPlanInterval').value,
                        description: document.getElementById('editPlanDescription').value
                    };

                    try {
                        showLoading(true);

                        // Direct API call since apiService might not have updatePaymentPlan explicit method
                        await apiService.makeRequest(`/payments/plans/${planId}`, {
                            method: 'PUT',
                            body: JSON.stringify(updates)
                        });

                        showNotification('Plan updated successfully', 'success');
                        closeModal('editPaymentPlanModal');
                        loadPaymentPlans(); // Refresh the table
                    } catch (error) {
                        console.error('Update failed:', error);
                        showNotification('Failed to update plan: ' + error.message, 'error');
                    } finally {
                        showLoading(false);
                    }
                });
            }
        </script>
        <!-- Review Application Modal -->
        <div id="reviewApplicationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìã Review Application</h2>
                    <button class="close" onclick="closeModal('reviewApplicationModal')">&times;</button>
                </div>
                <div id="reviewApplicationContent">
                    <!-- Populated dynamically -->
                </div>
                <div class="modal-footer"
                    style="padding-top: 1rem; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-danger" id="rejectAppBtn">Reject</button>
                    <button class="btn btn-success" id="approveAppBtn"
                        style="background-color: #10b981; color: white;">Approve & Shortlist</button>
                </div>
            </div>
        </div>
        <!-- Edit Staff Modal -->
        <!-- Edit Staff Modal -->
        <div id="editStaffModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>‚úèÔ∏è Edit Staff Member</h2>
                    <button class="close" onclick="closeModal('editStaffModal')">&times;</button>
                </div>
                <form id="editStaffForm">
                    <input type="hidden" id="editStaffId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="editStaffName" disabled
                                style="opacity: 0.7; cursor: not-allowed; background: rgba(255,255,255,0.05);">
                        </div>

                        <div class="form-group">
                            <label for="editStaffStatus">Status *</label>
                            <select id="editStaffStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editStaffRole">Role *</label>
                        <select id="editStaffRole" required onchange="toggleTeamSelect()">
                            <option value="admin">Admin</option>
                            <option value="coach">Head Coach</option>
                            <option value="assistant-coach">Assistant Coach</option>
                            <option value="staff">General Staff</option>
                            <option value="treasurer">Treasurer</option>
                            <option value="secretary">Secretary</option>
                            <option value="welfare-officer">Welfare Officer</option>
                        </select>
                    </div>

                    <div class="form-group" id="teamSelectGroup">
                        <label for="editStaffTeam">Assigned Team</label>
                        <select id="editStaffTeam">
                            <option value="">-- No Team Assigned --</option>
                            <!-- Populated dynamically -->
                        </select>
                        <p class="form-hint">For Head Coaches, this will set the team's coach.</p>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="closeModal('editStaffModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            function toggleTeamSelect() {
                const role = document.getElementById('editStaffRole').value;
                const teamGroup = document.getElementById('teamSelectGroup');
                if (['coach', 'assistant-coach'].includes(role)) {
                    teamGroup.style.display = 'block';
                } else {
                    teamGroup.style.display = 'none';
                }
            }

            // Staff Management Functions
            async function editStaffMember(id) {
                try {
                    showLoading(true);

                    const clubId = AppState.activeClubId || (AppState.clubs?.[0]?.id);
                    if (!clubId) throw new Error('No active club');

                    // Fetch staff and teams in parallel
                    const [staffList, teams] = await Promise.all([
                        apiService.getStaff(clubId),
                        apiService.getTeams(clubId)
                    ]);

                    const member = staffList.find(s => s.id === id);
                    if (!member) throw new Error('Staff member not found');

                    // Populate form
                    document.getElementById('editStaffId').value = member.id;
                    document.getElementById('editStaffName').value = `${member.first_name} ${member.last_name}`;
                    document.getElementById('editStaffRole').value = member.role;
                    document.getElementById('editStaffStatus').value = (member.status || 'active').toLowerCase();

                    // Populate Teams
                    const teamSelect = document.getElementById('editStaffTeam');
                    teamSelect.innerHTML = '<option value="">-- No Team Assigned --</option>';

                    teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name + (team.coach_id && team.coach_id !== member.id ? ' (Has Coach)' : '');
                        teamSelect.appendChild(option);
                    });

                    // Set selected team
                    // Note: API returns `team_id` for this member if they are assigned
                    if (member.team_id) {
                        teamSelect.value = member.team_id;
                    } else {
                        teamSelect.value = "";
                    }

                    // Handle visibility
                    toggleTeamSelect();

                    showModal('editStaffModal');

                } catch (error) {
                    console.error('Edit staff error:', error);
                    showNotification('Failed to load staff details: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function handleEditStaff(e) {
                e.preventDefault();
                const id = document.getElementById('editStaffId').value;
                const role = document.getElementById('editStaffRole').value;
                const status = document.getElementById('editStaffStatus').value;
                const teamId = document.getElementById('editStaffTeam').value;

                try {
                    showLoading(true);

                    // Call update method
                    // Pass teamId only if it's relevant for the role, or always pass it and let backend handle
                    await apiService.updateStaff(id, { role, status, teamId });

                    showNotification('Staff member updated successfully', 'success');
                    closeModal('editStaffModal');
                    loadStaff(); // Refresh list to show changes
                } catch (error) {
                    console.error('Update staff error:', error);
                    showNotification('Failed to update staff: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function removeStaffMember(id) {
                if (!confirm('Are you sure you want to remove this staff member? They will lose access to the club dashboard.')) {
                    return;
                }

                try {
                    showLoading(true);
                    await apiService.removeStaff(id);
                    showNotification('Staff member removed successfully', 'success');
                    loadStaff();
                } catch (error) {
                    console.error('Remove staff error:', error);
                    showNotification('Failed to remove staff: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            // Bind the form
            const staffForm = document.getElementById('editStaffForm');
            if (staffForm) staffForm.addEventListener('submit', handleEditStaff);

            // Expose globally
            window.editStaffMember = editStaffMember;
            window.removeStaffMember = removeStaffMember;

            let adminVenues = [];
            let selectedAdminVenue = null;
            let selectedAdminSlot = null;

            async function loadVenues() {
                const grid = document.getElementById('adminVenueGrid');
                if (!grid) return;

                try {
                    showLoading(true);
                    const venues = await apiService.makeRequest('/venues');
                    adminVenues = venues;
                    displayAdminVenues(venues);
                } catch (error) {
                    console.error('Load venues error:', error);
                } finally {
                    showLoading(false);
                }
            }


            function displayAdminVenues(venueList) {
                const grid = document.getElementById('adminVenueGrid');
                if (venueList.length === 0) {
                    grid.innerHTML = '<p>No venues available</p>';
                    return;
                }

                grid.innerHTML = venueList.map(venue => `
                    <div class="venue-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 1.5rem; transition: transform 0.2s; cursor: pointer;" onclick="openAdminBookingModal('${venue.id}')">
                        ${venue.image_url ? `<img src="${venue.image_url}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;" alt="${venue.name}">` : '<div style="width: 100%; height: 150px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üèüÔ∏è</div>'}
                        <h4 style="margin-bottom: 0.5rem;">${venue.name}</h4>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;"><strong>Location:</strong> ${venue.location || 'N/A'}</p>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;"><strong>Rate:</strong> ¬£${venue.hourly_rate || 0}/hour</p>
                        <button class="btn btn-primary btn-small" style="width: 100%;">Book Now</button>
                    </div>
                `).join('');
            }

            function showVenueTab(tabName) {
                document.querySelectorAll('.venue-tab-content').forEach(t => t.style.display = 'none');
                document.getElementById(`venue-${tabName}-tab`).style.display = 'block';

                const tabs = document.querySelectorAll('#venue-booking .tab-btn');
                tabs.forEach(t => t.classList.remove('active'));

                const targetTab = Array.from(tabs).find(t => t.textContent.toLowerCase().includes(tabName === 'browse' ? 'browse' : 'booking'));
                if (targetTab) targetTab.classList.add('active');

                if (tabName === 'mybookings') loadAdminMyBookings();
            }

            async function openAdminBookingModal(venueId) {
                selectedAdminVenue = adminVenues.find(v => v.id === venueId);
                if (!selectedAdminVenue) return;

                document.getElementById('modalVenueName').textContent = selectedAdminVenue.name;
                document.getElementById('modalVenueDetails').innerHTML = `
                    <div>
                        <p><strong>Location:</strong> ${selectedAdminVenue.location || 'N/A'}</p>
                        <p><strong>Capacity:</strong> ${selectedAdminVenue.capacity || 'N/A'} people</p>
                        <p><strong>Hourly Rate:</strong> ¬£${selectedAdminVenue.hourly_rate}</p>
                    </div>
                    <div>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">${selectedAdminVenue.description || 'No description provided.'}</p>
                    </div>
                `;

                const dateInput = document.getElementById('adminBookingDate');
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
                dateInput.value = today;

                showModal('bookingModal');
                loadAdminVenueAvailability();
            }

            async function loadAdminVenueAvailability() {
                const date = document.getElementById('adminBookingDate').value;
                if (!date || !selectedAdminVenue) return;

                try {
                    const data = await apiService.makeRequest(`/venues/${selectedAdminVenue.id}/availability?date=${date}`);
                    const container = document.getElementById('adminAvailabilitySlots');

                    const slots = [];
                    for (let hour = 9; hour <= 21; hour++) {
                        const startTime = `${hour.toString().padStart(2, '0')}:00`;
                        const endTime = `${(hour + 1).toString().padStart(2, '0')}:00`;
                        const isBooked = data.bookings.some(b => new Date(b.start_time).getHours() === hour);
                        slots.push({ startTime, endTime, available: !isBooked });
                    }

                    container.innerHTML = slots.map(slot => `
                        <div class="time-slot ${slot.available ? 'available' : 'booked'}" 
                             style="padding: 0.75rem; border: 1px solid ${slot.available ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 8px; cursor: ${slot.available ? 'pointer' : 'not-allowed'}; background: ${slot.available ? 'rgba(var(--primary-rgb), 0.05)' : 'rgba(0,0,0,0.2)'}; opacity: ${slot.available ? '1' : '0.5'};"
                             onclick="${slot.available ? `selectAdminSlot('${slot.startTime}', '${slot.endTime}')` : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span>${slot.startTime} - ${slot.endTime}</span>
                                <span style="font-size: 0.8rem;">${slot.available ? '‚úì Available' : '‚úó Booked'}</span>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error('Load availability error:', e);
                }
            }

            function selectAdminSlot(startTime, endTime) {
                selectedAdminSlot = { startTime, endTime };
                document.getElementById('adminSelectedTime').textContent = `${startTime} - ${endTime}`;
                document.getElementById('adminBookingCost').textContent = `¬£${selectedAdminVenue.hourly_rate}.00`;
                document.getElementById('adminBookingConfirmation').style.display = 'block';
            }

            async function confirmAdminBooking() {
                if (!selectedAdminVenue || !selectedAdminSlot) return;
                const date = document.getElementById('adminBookingDate').value;
                const notes = document.getElementById('adminBookingNotes').value;
                const startTime = `${date}T${selectedAdminSlot.startTime}:00`;
                const endTime = `${date}T${selectedAdminSlot.endTime}:00`;

                try {
                    showLoading(true);
                    await apiService.makeRequest(`/venues/${selectedAdminVenue.id}/book`, {
                        method: 'POST',
                        body: JSON.stringify({ startTime, endTime, notes })
                    });
                    showNotification('Booking confirmed successfully!', 'success');
                    closeModal('bookingModal');
                    showVenueTab('mybookings');
                } catch (error) {
                    showNotification('Booking failed: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }

            async function loadAdminMyBookings() {
                const container = document.getElementById('adminMyBookingsList');
                if (!container) return;

                try {
                    showLoading(true);
                    const data = await apiService.makeRequest('/venues/bookings/my');
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">No bookings yet.</p>';
                    } else {
                        container.innerHTML = data.map(b => `
                            <div class="card" style="margin-bottom: 1rem; background: rgba(255,255,255,0.02);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="margin: 0;">${b.venue_name}</h4>
                                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${new Date(b.start_time).toLocaleDateString()} | ${new Date(b.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${new Date(b.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                    <span class="status-badge ${b.status === 'confirmed' ? 'status-active' : ''}">${b.status}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (e) {
                    console.error('Load bookings error:', e);
                } finally {
                    showLoading(false);
                }
            }

            async function loadTraining() {
                try {
                    showLoading(true);
                    const orgId = localStorage.getItem('currentOrganizationId');
                    const events = await apiService.makeRequest(`/events?organizationId=${orgId}&eventType=talent-id`);

                    const select = document.getElementById('adminTrainingEventSelect');
                    if (select) {
                        select.innerHTML = '<option value="">-- Select Event --</option>' +
                            events.map(event => `<option value="${event.id}">${event.title} - ${new Date(event.event_date).toLocaleDateString()}</option>`).join('');
                    }
                } catch (error) {
                    console.error('Load training events error:', error);
                } finally {
                    showLoading(false);
                }
            }

            async function loadAdminTrainingDashboard() {
                const eventId = document.getElementById('adminTrainingEventSelect').value;
                if (!eventId) {
                    document.getElementById('adminTrainingDashboardContent').style.display = 'none';
                    return;
                }

                try {
                    showLoading(true);
                    const data = await apiService.makeRequest(`/talent-id/events/${eventId}/dashboard`);

                    document.getElementById('adminTotalRegistrants').textContent = data.registrants.length;
                    document.getElementById('adminCheckedIn').textContent = data.registrants.filter(r => r.status === 'checked_in').length;
                    document.getElementById('adminGroupsCount').textContent = data.groups.length;
                    document.getElementById('adminBibsCount').textContent = data.bibs.filter(b => b.status === 'available').length;

                    displayAdminTrainingRegistrants(data.registrants);
                    displayAdminTrainingGroups(data.groups);
                    displayAdminTrainingBibs(data.bibs);

                    document.getElementById('adminTrainingDashboardContent').style.display = 'block';
                } catch (error) {
                    console.error('Load training dashboard error:', error);
                } finally {
                    showLoading(false);
                }
            }

            function showTrainingTab(tabName) {
                document.querySelectorAll('.training-tab-content').forEach(t => t.style.display = 'none');
                document.getElementById(`training-${tabName}-tab`).style.display = 'block';

                const tabs = document.querySelectorAll('#training-manager .tab-btn');
                tabs.forEach(t => t.classList.remove('active'));

                const targetTab = Array.from(tabs).find(t => t.textContent.toLowerCase().includes(tabName));
                if (targetTab) targetTab.classList.add('active');
            }

            function displayAdminTrainingRegistrants(registrants) {
                const tbody = document.getElementById('adminTrainingRegistrantsBody');
                if (!tbody) return;

                if (registrants.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No registrants yet</td></tr>';
                    return;
                }

                tbody.innerHTML = registrants.map(reg => `
                    <tr>
                        <td><strong>${reg.first_name} ${reg.last_name}</strong></td>
                        <td>${calculateAge(reg.date_of_birth)}</td>
                        <td>${reg.position || 'N/A'}</td>
                        <td>${reg.bib_number ? `<span style="padding: 2px 8px; border-radius: 4px; background: ${getBibColor(reg.bib_color)}; color: white; font-weight: 600;">${reg.bib_number}</span>` : '-'}</td>
                        <td>${reg.group_name || '-'}</td>
                        <td><span class="status-badge ${reg.status === 'checked_in' ? 'status-active' : ''}">${reg.status === 'checked_in' ? 'Checked In' : 'Registered'}</span></td>
                        <td>
                            ${reg.status !== 'checked_in' ? `<button class="btn btn-small" onclick="checkInTraining('${reg.id}')">Check In</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            }

            function calculateAge(dob) {
                if (!dob) return 'N/A';
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                return age;
            }

            function getBibColor(color) {
                const colors = { 'Red': '#ef4444', 'Blue': '#3b82f6', 'Yellow': '#eab308', 'Green': '#22c55e', 'Orange': '#f97316' };
                return colors[color] || '#6b7280';
            }

            async function checkInTraining(registrationId) {
                try {
                    await apiService.makeRequest(`/talent-id/registrations/${registrationId}/checkin`, {
                        method: 'POST',
                        body: JSON.stringify({ status: 'checked_in' })
                    });
                    loadAdminTrainingDashboard();
                } catch (error) {
                    showNotification('Check-in failed: ' + error.message, 'error');
                }
            }

            function loadLeagues() {
                const container = document.getElementById('league-management');
                if (!container) return;
                const content = container.querySelector('.card > div:last-child');
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <p style="color: var(--text-muted);">League management is being integrated into this dashboard.</p>
                        <button class="btn btn-primary" onclick="window.location.href='league-management.html'" style="margin-top: 1rem;">Open Legacy League Manager</button>
                    </div>
                `;
            }

            // --- POLLS SYSTEM ---
            async function loadPolls() {
                const container = document.getElementById('pollsContainer');
                if (!container) return;

                try {
                    const orgId = apiService.getContext().orgId;
                    const polls = await apiService.makeRequest(`/polls?organizationId=${orgId}`);

                    if (polls.length === 0) {
                        container.innerHTML = '<p class="text-muted" style="grid-column: 1/-1; text-align: center;">No active polls found.</p>';
                        return;
                    }

                    container.innerHTML = polls.map(poll => {
                        const totalVotes = poll.results?.reduce((sum, r) => sum + parseInt(r.count), 0) || 0;
                        return `
                        <div class="card" style="background: rgba(255,255,255,0.03);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <h3>${poll.title}</h3>
                                <span class="badge ${poll.status === 'active' ? 'badge-success' : 'badge-secondary'}">${poll.status}</span>
                            </div>
                            <p>${poll.description || ''}</p>
                            
                            <div class="poll-results" style="margin: 1rem 0;">
                                ${poll.options.map((opt, i) => {
                            const count = poll.results?.find(r => r.selection === i.toString())?.count || 0;
                            const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                            return `
                                    <div style="margin-bottom: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 2px;">
                                            <span>${opt}</span>
                                            <span>${percent}% (${count})</span>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div style="background: var(--primary-color); width: ${percent}%; height: 100%;"></div>
                                        </div>
                                    </div>`;
                        }).join('')}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); text-align: right;">
                                Total Votes: ${totalVotes} ‚Ä¢ Expires: ${poll.expires_at ? new Date(poll.expires_at).toLocaleDateString() : 'Never'}
                            </div>
                        </div>`;
                    }).join('');
                } catch (error) {
                    console.error('Load polls error:', error);
                    container.innerHTML = '<p class="error-text">Failed to load polls.</p>';
                }
            }

            function addPollOption() {
                const container = document.getElementById('pollOptionsContainer');
                const div = document.createElement('div');
                div.className = 'input-with-button';
                div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
                div.innerHTML = `
                    <input type="text" class="poll-option-input" required placeholder="Option ${container.children.length + 1}">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
                `;
                container.appendChild(div);
            }

            async function handleCreatePoll(e) {
                e.preventDefault();
                const inputs = document.querySelectorAll('.poll-option-input');
                const options = Array.from(inputs).map(input => input.value).filter(val => val.trim() !== '');

                if (options.length < 2) {
                    showNotification('Please provide at least 2 options', 'error');
                    return;
                }

                const data = {
                    organizationId: apiService.getContext().orgId,
                    title: document.getElementById('pollTitle').value,
                    description: document.getElementById('pollDescription').value,
                    expiresAt: document.getElementById('pollExpiresAt').value,
                    options: options
                };

                try {
                    await apiService.makeRequest('/polls', { method: 'POST', body: JSON.stringify(data) });
                    showNotification('Poll created successfully', 'success');
                    closeModal('createPollModal');
                    loadPolls();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }

            // --- VENUE BOOKING SYSTEM ---
            async function loadVenues() {
                const container = document.getElementById('adminVenueGrid');
                if (!container) return;

                try {
                    container.innerHTML = '<p>Loading venues...</p>';
                    const orgId = apiService.getContext().orgId;
                    const venues = await apiService.makeRequest(`/venues?organizationId=${orgId}`);

                    if (venues.length === 0) {
                        container.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                                <p style="color: var(--text-muted);">No venues found.</p>
                                <button class="btn btn-primary" onclick="showModal('addVenueModal')">Add Your First Venue</button>
                            </div>`;
                        return;
                    }

                    container.innerHTML = venues.map(venue => `
                        <div class="card venue-card" style="display: flex; flex-direction: column;">
                            <img src="${venue.image_url || 'images/pitch-placeholder.jpg'}" 
                                 style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px 8px 0 0; margin: -1.25rem -1.25rem 1rem -1.25rem;" 
                                 onerror="this.src='images/pitch-placeholder.jpg'">
                            <h3 style="margin-bottom: 0.5rem;">${venue.name}</h3>
                            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">üìç ${venue.location}</p>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                ${(venue.facilities || []).map(f => `<span class="badge badge-secondary">${f}</span>`).join('')}
                            </div>
                            <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold; color: var(--primary-color);">¬£${venue.hourly_rate}/hr</span>
                                <button class="btn btn-primary btn-small" onclick="openAdminBookingModal('${venue.id}', '${venue.name}')">Book Now</button>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Load venues error:', error);
                    container.innerHTML = '<p class="error-text">Failed to load venues.</p>';
                }
            }

            // Bind Poll Form
            document.addEventListener('DOMContentLoaded', () => {
                const pollForm = document.getElementById('createPollForm');
                if (pollForm) pollForm.addEventListener('submit', handleCreatePoll);
            });

            async function loadCampaigns() {
                const container = document.getElementById('campaignsContainerFull');
                if (!container) return;
                try {
                    const campaigns = await apiService.makeRequest('/notifications?type=email_campaign').catch(() => []);
                    if (!campaigns || campaigns.length === 0) {
                        container.innerHTML = `<div class="card" style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.02);"><p style="color: var(--text-muted);">No email campaigns sent yet.</p></div>`;
                    } else {
                        container.innerHTML = campaigns.map(c => `
                            <div class="card" style="margin-bottom: 1rem; background: rgba(255,255,255,0.03);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div><h4 style="margin: 0;">${c.title}</h4><p style="font-size: 0.85rem; color: var(--text-muted);">Sent to: ${c.segment || 'All Members'}</p></div>
                                    <span style="font-size: 0.8rem; color: var(--text-muted);">${new Date(c.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>`).join('');
                    }
                } catch (e) {
                    console.error('Load campaigns error:', e);
                }
            }

            function openCreateCampaign() { showModal('createCampaignModal'); }

            async function sendCampaign(event) {
                event.preventDefault();
                const title = document.getElementById('campaignTitle')?.value || document.getElementById('campaignSubject')?.value;
                const message = document.getElementById('campaignMessage')?.value;
                const segment = document.getElementById('campaignTarget')?.value;
                try {
                    showLoading(true);
                    await apiService.makeRequest('/notifications', { method: 'POST', body: JSON.stringify({ title, message, notification_type: 'general', segment }) });
                    showNotification('Campaign sent successfully!', 'success');
                    closeModal('createCampaignModal');
                    if (typeof loadCampaigns === 'function') loadCampaigns();
                } catch (error) { showNotification('Failed to send: ' + error.message, 'error'); } finally { showLoading(false); }
            }

            async function handleAddVenue(e) {
                e.preventDefault();

                const data = {
                    organizationId: apiService.getContext().orgId,
                    name: document.getElementById('venueName').value,
                    location: document.getElementById('venueLocation').value,
                    hourlyRate: parseFloat(document.getElementById('venueHourlyRate').value) || 0,
                    capacity: parseInt(document.getElementById('venueCapacity').value) || 0,
                    description: document.getElementById('venueDescription').value
                };

                try {
                    await apiService.makeRequest('/venues', { method: 'POST', body: JSON.stringify(data) });
                    showNotification('Venue created successfully!', 'success');
                    closeModal('addVenueModal');
                    loadVenues();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }

            // Bind the campaign form
            document.addEventListener('DOMContentLoaded', () => {
                const campaignForm = document.getElementById('createCampaignForm');
                if (campaignForm) campaignForm.addEventListener('submit', sendCampaign);

                const venueForm = document.getElementById('addVenueForm');
                if (venueForm) venueForm.addEventListener('submit', handleAddVenue);

                // Load Polls and Venues when their sections are shown
                // This is handled by showSection() calling the global function, which we need to register
                window.loadPolls = loadPolls;

                // Add showSection hook for Polls
                const originalShowSection = window.showSection;
                window.showSection = function (sectionId) {
                    originalShowSection(sectionId);
                    if (sectionId === 'polls-section') loadPolls();
                    if (sectionId === 'venue-booking') loadVenues();
                    if (sectionId === 'league-management') loadLeagues();
                };
            });

            let currentVenueId = null;
            let selectedTimeSlot = null;

            function showVenueTab(tabId) {
                document.querySelectorAll('.venue-tab-content').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

                document.getElementById(`venue-${tabId}-tab`).style.display = 'block';
                // Find and activate the correct button (simplified logic)
                const buttons = document.querySelectorAll('.tab-btn');
                if (tabId === 'browse') buttons[0].classList.add('active');
                if (tabId === 'mybookings') buttons[1].classList.add('active'); // Assumption based on HTML order
            }

            function openAdminBookingModal(venueId, venueName) {
                currentVenueId = venueId;
                document.getElementById('adminVenueBookingModal').style.display = 'block';
                document.getElementById('adminBookingVenueName').textContent = venueName;
                document.getElementById('adminBookingDate').value = new Date().toISOString().split('T')[0];
                loadAdminVenueAvailability();
            }

            async function loadAdminVenueAvailability() {
                const date = document.getElementById('adminBookingDate').value;
                const container = document.getElementById('adminVenueSlots');
                if (!date || !currentVenueId) return;

                container.innerHTML = '<p>Checking availability...</p>';

                try {
                    const result = await apiService.makeRequest(`/venues/${currentVenueId}/availability?date=${date}`);
                    const bookedTimes = result.bookings.map(b => new Date(b.start_time).getHours());

                    let slotsHtml = '';
                    // Standard 9am - 9pm operating hours
                    for (let hour = 9; hour < 21; hour++) {
                        const isBooked = bookedTimes.includes(hour);
                        const timeString = `${hour}:00`;
                        const slotClass = isBooked ? 'slot-booked' : (selectedTimeSlot === hour ? 'slot-selected' : 'slot-available');
                        const style = isBooked ? 'background: #fee2e2; color: #ef4444; border: 1px solid #f87171;' :
                            (selectedTimeSlot === hour ? 'background: var(--primary-color); color: white;' : 'background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); cursor: pointer;');

                        slotsHtml += `
                            <div onclick="${isBooked ? '' : `selectAdminSlot(${hour})`}" 
                                 style="padding: 10px; text-align: center; border-radius: 8px; ${style}">
                                ${timeString}
                            </div>
                        `;
                    }
                    container.innerHTML = slotsHtml;
                } catch (error) {
                    console.error(error);
                    container.innerHTML = '<p class="error-text">Failed to load slots.</p>';
                }
            }

            function selectAdminSlot(hour) {
                selectedTimeSlot = hour;
                loadAdminVenueAvailability(); // Re-render to show selection
            }

            async function confirmAdminBooking() {
                if (!selectedTimeSlot || !currentVenueId) {
                    showNotification('Please select a time slot', 'error');
                    return;
                }

                const date = document.getElementById('adminBookingDate').value;
                const notes = document.getElementById('adminBookingNotes').value;

                // Construct Date Objects
                const startTime = new Date(`${date}T${selectedTimeSlot.toString().padStart(2, '0')}:00:00`);
                const endTime = new Date(startTime);
                endTime.setHours(startTime.getHours() + 1); // 1 hour slots for now

                try {
                    await apiService.makeRequest(`/venues/${currentVenueId}/book`, {
                        method: 'POST',
                        body: JSON.stringify({
                            startTime: startTime.toISOString(),
                            endTime: endTime.toISOString(),
                            notes: notes
                        })
                    });

                    showNotification('Venue booked successfully!', 'success');
                    closeModal('adminVenueBookingModal');
                    loadVenues(); // Refresh view
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }

            // Expose globally
            window.loadVenues = loadVenues;
            window.showVenueTab = showVenueTab;
            window.openAdminBookingModal = openAdminBookingModal;
            window.selectAdminSlot = selectAdminSlot;
            window.confirmAdminBooking = confirmAdminBooking;
            window.loadAdminVenueAvailability = loadAdminVenueAvailability;
            window.loadTraining = loadTraining;
            window.loadAdminTrainingDashboard = loadAdminTrainingDashboard;
            window.showTrainingTab = showTrainingTab;
            window.checkInTraining = checkInTraining;
            window.loadLeagues = loadLeagues;
            window.loadPolls = loadPolls;
            window.addPollOption = addPollOption;
            window.handleCreatePoll = handleCreatePoll;
            window.loadCampaigns = loadCampaigns;
            window.sendCampaign = sendCampaign;
            window.openCreateCampaign = openCreateCampaign;

            async function syncStripePlans() {
                try {
                    const btn = document.getElementById('btnSyncStripe');
                    if (!btn) return;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'üîÑ Syncing...';
                    btn.disabled = true;

                    const response = await apiService.makeRequest('/payments/plans/import', { method: 'POST' });

                    btn.innerHTML = '‚úÖ Done';
                    showNotification('Sync Complete: ' + response.message, 'success');

                    // Reload plans
                    loadPaymentPlans();

                    setTimeout(() => {
                        btn.innerHTML = 'üîÑ Sync Plans';
                        btn.disabled = false;
                    }, 2000);

                } catch (error) {
                    console.error('Sync failed:', error);
                    showNotification('Sync Failed: ' + (error.message || 'Could not sync plans'), 'error');
                    const btn = document.getElementById('btnSyncStripe');
                    if (btn) {
                        btn.innerHTML = '‚ùå Error';
                        setTimeout(() => {
                            btn.innerHTML = 'üîÑ Sync Plans';
                            btn.disabled = false;
                        }, 2000);
                    }
                }
            }

            // All-in-one exposure to ensure no ReferenceErrors
            const globalFuncs = {
                logout, loadListings, viewListingApplications, assignPaymentPlan,
                showPlayerTeamAssignment, editTeam, deleteTeam, loadProducts,
                loadCampaigns, sendCampaign, editProduct, loadStaff,
                loadTalentIdDashboard, loadTournamentsDashboard, loadClubApplications,
                approveApplication, rejectApplication, viewApplicationDetails,
                handleResendInvite, resetPlayerFilters, exportPlayers,
                removePlayer, editPlayer, filterPlayersByTeam, filterPlayersByPayment,
                handleCreatePaymentPlan, handleUpdatePaymentPlan, editPaymentPlan, deletePaymentPlan,
                loadPaymentPlans, accessStripeAccount, syncStripePlans, premiumBulkAssignPlan, confirmBulkAssign, filterPlayersByView
            };

            Object.entries(globalFuncs).forEach(([name, func]) => {
                if (typeof func !== 'undefined') {
                    window[name] = func;
                }
            });
        </script>

        <!-- Mode Toggle Handler -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const toggle = document.getElementById('mode-toggle');
                if (toggle) {
                    toggle.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            console.log('üîÑ Admin ‚Üí Player toggle activated');

                            // Ensure AppState exists
                            if (!window.AppState) {
                                window.AppState = {};
                            }

                            // Initialize currentUser if it doesn't exist
                            if (!AppState.currentUser) {
                                const storedUser = localStorage.getItem('currentUser');
                                if (storedUser) {
                                    try {
                                        AppState.currentUser = JSON.parse(storedUser);
                                        console.log('‚úÖ Loaded user from localStorage:', AppState.currentUser.email);
                                    } catch (e) {
                                        console.error('‚ùå Failed to parse user from localStorage');
                                        return; // Don't proceed if we can't load user
                                    }
                                } else {
                                    console.error('‚ùå No user data in localStorage');
                                    return; // Don't proceed if there's no user
                                }
                            }

                            // Initialize userType if it doesn't exist
                            if (!AppState.userType) {
                                AppState.userType = localStorage.getItem('userType') ||
                                    AppState.currentUser.account_type ||
                                    'organization';
                            }

                            console.log('Before role change:', AppState.currentUser.role);
                            console.log('User type:', AppState.userType);

                            // Switch to Player mode
                            AppState.currentUser.role = 'player';
                            console.log('After role change:', AppState.currentUser.role);

                            // CRITICAL: Persist to localStorage so the next page loads the correct role
                            localStorage.setItem('currentUser', JSON.stringify(AppState.currentUser));

                            // Redirect will happen immediately, no need to restore role
                            if (typeof redirectToDashboard === 'function') {
                                console.log('Calling redirectToDashboard()...');
                                redirectToDashboard();
                            } else {
                                console.log('redirectToDashboard not found, using direct navigation');
                                window.location.href = 'player-dashboard.html';
                            }
                        }
                    });
                }
            });
        </script>
</body>

</html>