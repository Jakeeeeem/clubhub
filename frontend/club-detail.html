<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Details - ClubHub</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: #0a0a0b;
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(10, 10, 11, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
        }

        .club-header {
            background: radial-gradient(circle at top, rgba(220, 67, 67, 0.15) 0%, rgba(13, 13, 13, 0) 70%);
            padding: 120px 0 3rem;
            /* Height of header (80px) + 40px gap */
            position: relative;
        }

        .club-logo-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
        }

        .club-logo {
            width: 140px;
            height: 140px;
            border-radius: 24px;
            object-fit: cover;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 40px rgba(220, 67, 67, 0.2);
            background: var(--bg-card);
        }

        .club-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .info-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            transition: transform 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .info-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        .info-value {
            color: var(--text-main);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .application-form {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 24px;
            border: 1px solid var(--border-color);
            margin-top: 4rem;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(220, 67, 67, 0.1);
        }

        .badge {
            background: rgba(220, 67, 67, 0.1);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(220, 67, 67, 0.2);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content"
                style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
                <div class="logo" onclick="window.location.href='index.html'"
                    style="cursor: pointer; display: flex; align-items: center; gap: 0.75rem;">
                    <img src="images/logo.png" alt="ClubHub" style="width: 32px; height: 32px;">
                    <span class="logo-text"
                        style="font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px;">Club<span
                            style="color: var(--primary);">Hub</span></span>
                </div>
                <nav class="nav">
                    <a href="index.html" class="nav-link"
                        style="color: var(--text-muted); text-decoration: none; font-size: 0.85rem; font-weight: 500;">‚Üê
                        Back</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Club Header -->
    <section class="club-header">
        <div class="container" style="text-align: center;">
            <div class="club-logo-wrapper">
                <img id="clubLogo" src="images/logo.png" alt="Club Logo" class="club-logo">
            </div>
            <h1 id="clubName" class="neon-text" style="font-size: 3.5rem; margin-bottom: 1rem; line-height: 1;">
                Loading...</h1>
            <p id="clubTagline"
                style="color: var(--text-muted); font-size: 1.25rem; max-width: 700px; margin: 0 auto 2rem; line-height: 1.6;">
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <span class="badge" id="clubSport">‚öΩ Sport</span>
                <span class="badge" id="clubLocation">üìç Location</span>
            </div>
        </div>
    </section>

    <!-- Club Details -->
    <section style="padding: 4rem 0;">
        <div class="container" style="max-width: 900px;">

            <!-- Application Form -->
            <div class="application-form">
                <div style="text-align: center; margin-bottom: 3rem;">
                    <h2 style="font-size: 2.25rem; margin-bottom: 0.5rem;">üìù Submit Application</h2>
                    <p style="color: var(--text-muted);">Fill in your details below to express interest in joining.</p>
                </div>

                <div class="success-message" id="successMessage">
                    ‚úÖ Application submitted successfully! Welcome to the club.
                </div>

                <div class="error-message" id="errorMessage"></div>

                <form id="applicationForm">
                    <div id="personalDetails">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label for="playerName">Full Name *</label>
                                <input type="text" id="playerName" name="playerName" required placeholder="John Doe">
                            </div>

                            <div class="form-group">
                                <label for="playerPhone">Phone Number</label>
                                <input type="tel" id="playerPhone" name="playerPhone" placeholder="+44 7700 900000">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <div class="form-group">
                                <label for="playerEmail">Email Address *</label>
                                <input type="email" id="playerEmail" name="playerEmail" required
                                    placeholder="john@example.com">
                            </div>

                            <div class="form-group" id="passwordGroup">
                                <label for="playerPassword">Account Password *</label>
                                <input type="password" id="playerPassword" name="playerPassword"
                                    placeholder="Min 6 characters">
                            </div>
                        </div>
                    </div>


                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label for="playerHeight">Height (cm)</label>
                            <input type="number" id="playerHeight" name="playerHeight" placeholder="e.g. 180">
                        </div>

                        <div class="form-group">
                            <label for="playerPosition">Preferred Position</label>
                            <input type="text" id="playerPosition" name="playerPosition" placeholder="e.g. Forward">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label for="playerAge">Age</label>
                            <input type="number" id="playerAge" name="playerAge" min="5" max="100"
                                placeholder="e.g. 18">
                        </div>

                        <div class="form-group">
                            <label for="playerExperience">Experience Level</label>
                            <select id="playerExperience" name="playerExperience">
                                <option value="">Select experience level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                                <option value="professional">Professional</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="playerMessage">Why do you want to join? *</label>
                        <textarea id="playerMessage" name="playerMessage" required
                            placeholder="Tell us about yourself and why you'd like to join this club..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn"
                        style="width: 100%; padding: 1.25rem; font-weight: 700; font-size: 1.1rem; border-radius: 12px; margin-top: 1rem;">
                        üì® Submit Application & Join ClubHub
                    </button>
                </form>
            </div>
        </div>
    </section>

    <script src="api-service.js"></script>
    <script>
        // Get club ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const clubId = urlParams.get('id');

        if (!clubId) {
            window.location.href = 'index.html';
        }

        // Load club details
        async function loadClubDetails() {
            try {
                // Use the consolidated getClub method with demo fallback support
                const club = await apiService.getClub(clubId);
                if (club) {
                    populateClubUI(club);
                } else {
                    throw new Error('Club not found');
                }

            } catch (error) {
                console.error('Failed to load club:', error);
                document.getElementById('errorMessage').textContent = '‚ùå Club not found. Redirecting to home...';
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        }

        function populateClubUI(club) {
            document.getElementById('clubName').textContent = club.name || 'Unknown Club';
            document.getElementById('clubTagline').textContent = club.description ? club.description.substring(0, 100) + '...' : '';
            document.getElementById('clubDescription').textContent = club.description || 'No description available.';
            document.getElementById('clubSport').textContent = club.sport ? `‚öΩ ${club.sport}` : '';
            if (!club.sport) document.getElementById('clubSport').style.display = 'none';

            document.getElementById('clubLocation').textContent = club.location ? `üìç ${club.location}` : '';
            if (!club.location) document.getElementById('clubLocation').style.display = 'none';

            document.getElementById('clubLocationFull').textContent = club.location || '-';
            document.getElementById('clubSportFull').textContent = club.sport || '-';
            document.getElementById('clubPhilosophy').textContent = club.philosophy || '-';

            if (club.website) {
                document.getElementById('clubWebsite').href = club.website;
                document.getElementById('clubWebsite').textContent = 'Visit Website';
            } else {
                document.getElementById('clubWebsite').textContent = '-';
                document.getElementById('clubWebsite').removeAttribute('href');
            }

            if (club.logo_url) {
                document.getElementById('clubLogo').src = club.logo_url;
            }

            document.title = `${club.name} - ClubHub`;
        }

        // Check if user is logged in to hide password field
        async function checkInitialAuth() {
            try {
                const token = localStorage.getItem('authToken');
                if (token) {
                    // Try to get user info if token exists
                    const user = await apiService.makeRequest('/auth/me');
                    if (user) {
                        document.getElementById('passwordGroup').style.display = 'none';
                        document.getElementById('playerName').value = (user.first_name || '') + ' ' + (user.last_name || '');
                        document.getElementById('playerEmail').value = user.email || '';
                        document.getElementById('playerName').readOnly = true;
                        document.getElementById('playerEmail').readOnly = true;
                    }
                }
            } catch (e) {
                console.log('User not logged in or session expired');
            }
        }

        // Handle application submission
        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                const token = localStorage.getItem('authToken');

                // 1. Register if not logged in
                if (!token) {
                    const password = document.getElementById('playerPassword').value;
                    if (!password || password.length < 6) {
                        throw new Error('Please create a password (at least 6 characters) to secure your account.');
                    }

                    const fullName = document.getElementById('playerName').value.split(' ');
                    const firstName = fullName[0];
                    const lastName = fullName.slice(1).join(' ') || 'Player';

                    const registerResponse = await apiService.makeRequest('/auth/register', {
                        method: 'POST',
                        body: JSON.stringify({
                            firstName,
                            lastName,
                            email: document.getElementById('playerEmail').value,
                            password: password,
                            accountType: 'adult' // Default for players applying via web
                        })
                    });

                    if (registerResponse.token) {
                        localStorage.setItem('authToken', registerResponse.token);
                        localStorage.setItem('currentUser', JSON.stringify(registerResponse.user));
                    }
                }

                // 2. Submit application
                const formData = {
                    organizationId: clubId,
                    playerName: document.getElementById('playerName').value,
                    playerEmail: document.getElementById('playerEmail').value,
                    playerPhone: document.getElementById('playerPhone').value,
                    playerAge: document.getElementById('playerAge').value,
                    playerHeight: document.getElementById('playerHeight').value,
                    playerPosition: document.getElementById('playerPosition').value,
                    playerExperience: document.getElementById('playerExperience').value,
                    playerMessage: document.getElementById('playerMessage').value
                };

                const response = await apiService.makeRequest('/applications', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.success) {
                    successMessage.style.display = 'block';
                    document.getElementById('applicationForm').innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h3 style="color: #22c55e;">‚úÖ All Set!</h3>
                            <p>Your application has been sent. You can now access your player dashboard to track your status.</p>
                            <button class="btn btn-primary" onclick="window.location.href='player-dashboard.html'" style="margin-top: 1rem;">Go to Dashboard</button>
                        </div>
                    `;
                    successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    throw new Error(response.error || 'Failed to submit application');
                }

            } catch (error) {
                console.error('Process error:', error);
                errorMessage.textContent = `‚ùå ${error.message || 'Failed to process request. Please try again.'}`;
                errorMessage.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì® Submit Application & Join ClubHub';
            }
        });

        // Initialize
        loadClubDetails();
        checkInitialAuth();
    </script>
</body>

</html>