<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player Dashboard - ClubHub</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
  <header class="header">
    <nav class="nav container">
      <div class="logo" onclick="window.location.href='index.html'">
        <img src="images/logo.png" alt="ClubHub Logo" class="logo-image">
        <span class="logo-text">ClubHub</span>
      </div>
      <div class="nav-buttons" id="loggedInNav">
        <!-- Populated by JS -->
      </div>
    </nav>
  </header>

  <main class="main">
    <div class="dashboard container dashboard-container">
      <div class="dashboard-header">
        <h1 class="neon-text">Player Dashboard</h1>
        <p>Manage your sports activities, subscriptions, and bookings</p>
      </div>

      <!-- Dashboard Navigation -->
      <div class="dashboard-nav">
        <button class="active" onclick="showPlayerSection('overview')">Overview</button>
        <button onclick="showPlayerSection('my-clubs')">My Clubs</button>
        <button onclick="showPlayerSection('teams')">Teams</button>
        <button onclick="showPlayerSection('subscriptions')">Subscriptions</button>
        <button onclick="showPlayerSection('payments')">Payments</button>
        <button onclick="showPlayerSection('item-shop')">ðŸ›’ Item Shop</button>
        <button onclick="showPlayerSection('club-finder')">Find Clubs</button>
        <button onclick="showPlayerSection('event-finder')">Find Events</button>
        <button onclick="showPlayerSection('documents')">Documents</button>
      </div>

      <div class="dashboard-content">
        <!-- Overview -->
        <div id="player-overview" class="dashboard-section active">
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-number" id="playerClubs">0</span>
              <span class="stat-label">Active Clubs</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="playerTeams">0</span>
              <span class="stat-label">Teams</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="playerEvents">0</span>
              <span class="stat-label">Upcoming Events</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="playerAttendance">0</span>
              <span class="stat-label">Attendance</span>
            </div>
          </div>

          <div class="card-grid">
            <div class="card">
              <h3>Recent Activity</h3>
              <div id="playerRecentActivity"></div>
            </div>

            <div class="card">
              <h3>Upcoming Events</h3>
              <div id="playerUpcomingEvents"></div>
            </div>
          </div>

          <div class="card">
            <h3>Performance Summary</h3>
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-number" id="playerMatchesPlayed">0</span>
                <span class="stat-label">Matches Played</span>
              </div>
              <div class="stat-card">
                <span class="stat-number" id="playerAverageRating">0.0</span>
                <span class="stat-label">Average Rating</span>
              </div>
              <div class="stat-card">
                <span class="stat-number" id="playerTrainingSessions">0</span>
                <span class="stat-label">Training Sessions</span>
              </div>
              <div class="stat-card">
                <span class="stat-number" id="playerPosition">Not Set</span>
                <span class="stat-label">Position</span>
              </div>
            </div>
          </div>
        </div>

        <!-- My Clubs -->
        <div id="player-my-clubs" class="dashboard-section">
          <div class="card">
            <h3>My Clubs</h3>
            <div class="card-grid" id="playerClubsContainer"></div>
          </div>

          <div class="card">
            <h3>Club Staff</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Contact</th>
                  <th>Club</th>
                </tr>
              </thead>
              <tbody id="clubStaffTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Teams -->
        <div id="player-teams" class="dashboard-section">
          <div class="card">
            <h3>My Teams</h3>
            <div class="card-grid" id="playerTeamsContainer"></div>
          </div>

          <div class="card">
            <h3>Team Events & Availability</h3>
            <div id="teamEventsContainer"></div>
          </div>
        </div>

        <!-- Subscriptions -->
        <div id="player-subscriptions" class="dashboard-section">
          <div class="card">
            <h3>My Subscription</h3>
            <div id="currentPlanInfo" style="margin-bottom: 2rem;"></div>

            <div class="subscription-benefits"></div>
          </div>

          <div class="card">
            <h3>Change Subscription Plan</h3>
            <div id="planAssignRow" class="search-filters" style="align-items:flex-end">
              <div class="form-group">
                <label for="planSelector">Choose Plan</label>
                <select id="planSelector"></select>
              </div>
              <div class="form-group">
                <label for="planStartDate">Start Date</label>
                <input type="date" id="planStartDate" />
              </div>
              <button class="btn btn-primary" id="assignPlanBtn">Update Subscription</button>
            </div>
          </div>

          <!-- Stripe Connect Account -->
          <div class="card">
            <h3>Payout Account Setup</h3>
            <p>Set up your payout account to receive payments and refunds.</p>
            <div id="stripeAccountStatus">
              <div class="item-actions" style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-primary" id="stripeOnboardBtn">Create / Link Stripe Account</button>
                <button class="btn btn-secondary" id="stripeManageBtn" disabled>Manage Account</button>
                <button class="btn" id="stripeRefreshBtn">Refresh Status</button>
              </div>
              <div id="stripeAccountInfo" style="margin-top:8px;color:#666"></div>
            </div>
          </div>
        </div>

        <!-- Payments -->
        <div id="player-payments" class="dashboard-section">
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-number" id="totalDue">Â£0</span>
              <span class="stat-label">Total Due</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="nextPayment">Â£0</span>
              <span class="stat-label">Next Payment</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="paymentStatus">Up to Date</span>
              <span class="stat-label">Status</span>
            </div>
            <div class="stat-card">
              <span class="stat-number" id="totalPaid">Â£0</span>
              <span class="stat-label">Total Paid</span>
            </div>
          </div>

          <div class="card">
            <h3>Payment History</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="paymentHistoryTableBody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>Outstanding Payments</h3>
            <div id="outstandingPayments"></div>
          </div>
        </div>

        <!-- Club Finder -->
        <div id="player-club-finder" class="dashboard-section">
          <div class="card">
            <h3>Find Clubs</h3>
            <div class="search-filters">
              <div class="form-group">
                <label for="clubSearchInput">Search Clubs</label>
                <input type="text" id="clubSearchInput" placeholder="Search by name or location..."
                  onkeyup="filterClubs()">
              </div>
              <div class="form-group">
                <label for="clubTypeFilter">Club Type</label>
                <select id="clubTypeFilter" onchange="filterClubs()">
                  <option value="">All Types</option>
                  <option value="club">Club</option>
                  <option value="event">Event Organizer</option>
                  <option value="tournament">Tournament Organizer</option>
                </select>
              </div>
              <div class="form-group">
                <label for="clubSportFilter">Sport</label>
                <select id="clubSportFilter" onchange="filterClubs()">
                  <option value="">All Sports</option>
                  <option value="football">Football</option>
                  <option value="basketball">Basketball</option>
                  <option value="tennis">Tennis</option>
                  <option value="rugby">Rugby</option>
                  <option value="cricket">Cricket</option>
                </select>
              </div>
            </div>
            <div class="card-grid" id="availableClubsContainer"></div>
          </div>
        </div>

        <!-- Event Finder -->
        <div id="player-event-finder" class="dashboard-section">
          <div class="card">
            <h3>Find and Book Events</h3>
            <div class="search-filters">
              <div class="form-group">
                <label for="eventSearchInput">Search Events</label>
                <input type="text" id="eventSearchInput" placeholder="Search events..." onkeyup="filterPlayerEvents()">
              </div>
              <div class="form-group">
                <label for="playerEventTypeFilter">Event Type</label>
                <select id="playerEventTypeFilter" onchange="filterPlayerEvents()">
                  <option value="">All Types</option>
                  <option value="camp">Holiday Camps</option>
                  <option value="tournament">Tournaments</option>
                  <option value="talent-id">Talent ID</option>
                  <option value="training">Training</option>
                  <option value="match">Matches</option>
                </select>
              </div>
              <div class="form-group">
                <label for="playerEventDateFilter">Date From</label>
                <input type="date" id="playerEventDateFilter" onchange="filterPlayerEvents()">
              </div>
            </div>
            <div class="card-grid" id="availablePlayerEventsContainer"></div>
          </div>
        </div>

        <!-- Documents -->
        <div id="player-documents" class="dashboard-section">
          <div class="card">
            <h3>My Documents</h3>
            <table class="table">
              <thead>
                <tr>
                  <th>Document Name</th>
                  <th>Type</th>
                  <th>Club</th>
                  <th>Last Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="playerDocumentsTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Item Shop -->
        <div id="player-item-shop" class="dashboard-section">
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
              <h3>ðŸ›’ Club Merchandise</h3>
              <div id="shopFilters">
                <select id="shopClubFilter" onchange="loadPlayerProducts()">
                  <option value="">All My Clubs</option>
                </select>
              </div>
            </div>
            <div id="shopProducts" class="card-grid">
              <!-- Products will be loaded by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div id="applyClubModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Apply to Club</h2>
        <button class="close" onclick="closeModal('applyClubModal')">&times;</button>
      </div>
      <form id="applyClubForm">
        <input type="hidden" id="applyClubId">
        <div class="form-group">
          <label for="applicationMessage">Application Message</label>
          <textarea id="applicationMessage" rows="4" placeholder="Tell the club why you'd like to join..."
            required></textarea>
        </div>
        <div class="form-group">
          <label for="playerPosition">Preferred Position</label>
          <input type="text" id="appPlayerPosition" placeholder="e.g., Midfielder, Forward, Defender">
        </div>

        <div class="form-group">
          <label for="playerExperience">Experience Level</label>
          <select id="playerExperience" required>
            <option value="">Select experience</option>
            <option value="beginner">Beginner</option>
            <option value="intermediate">Intermediate</option>
            <option value="advanced">Advanced</option>
            <option value="professional">Professional</option>
          </select>
        </div>

        <div class="form-group">
          <label>Availability</label>
          <div class="checkbox-group">
            <label><input type="checkbox" name="availability" value="weekdays"> Weekdays</label>
            <label><input type="checkbox" name="availability" value="weekends"> Weekends</label>
            <label><input type="checkbox" name="availability" value="evenings"> Evenings</label>
            <label><input type="checkbox" name="availability" value="mornings"> Mornings</label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Submit Application</button>
      </form>
    </div>
  </div>

  <!-- Event Booking Modal -->
  <div id="eventBookingModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Book Event</h2>
        <button class="close" onclick="closeModal('eventBookingModal')">&times;</button>
      </div>
      <div id="eventBookingContent">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Availability Modal -->
  <div id="availabilityModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Submit Availability</h2>
        <button class="close" onclick="closeModal('availabilityModal')">&times;</button>
      </div>
      <form id="availabilityForm">
        <input type="hidden" id="availabilityEventId">
        <div class="form-group">
          <label>Can you attend this event?</label>
          <div class="checkbox-group">
            <label><input type="radio" name="availability" value="yes"> Yes, I can attend</label>
            <label><input type="radio" name="availability" value="no"> No, I cannot attend</label>
            <label><input type="radio" name="availability" value="maybe"> Maybe</label>
          </div>
        </div>
        <div class="form-group">
          <label for="availabilityNotes">Additional Notes</label>
          <textarea id="availabilityNotes" rows="3" placeholder="Any additional information..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Availability</button>
      </form>
    </div>
  </div>

  <!-- Manage Account Modal -->
  <div id="accountModal" class="modal" style="display:none">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h2>Manage Account</h2>
        <button class="close" onclick="closeModal('accountModal')">&times;</button>
      </div>
      <form id="accountForm">
        <div class="form-group">
          <label for="accFirstName">First name</label>
          <input type="text" id="accFirstName" required>
        </div>
        <div class="form-group">
          <label for="accLastName">Last name</label>
          <input type="text" id="accLastName" required>
        </div>
        <div class="form-group">
          <label for="accLocation">Location</label>
          <input type="text" id="accLocation">
        </div>
        <div class="form-group">
          <label for="accSport">Primary sport</label>
          <input type="text" id="accSport">
        </div>
        <div class="form-group">
          <label for="accBio">Bio</label>
          <textarea id="accBio" rows="3"></textarea>
        </div>
        <div class="item-actions" style="margin-top:.5rem;">
          <button type="submit" class="btn btn-primary">Save changes</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('accountModal')">Cancel</button>
        </div>

        <div style="margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-main);">Data & Privacy (GDPR)</h3>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h4 style="font-size: 0.9rem; margin-bottom: 4px; color: var(--text-main);">Data Portability</h4>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Download all your personal data in
                  JSON format.</p>
              </div>
              <button type="button" class="btn btn-secondary btn-small" onclick="exportUserData()">Export Data</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
              <div>
                <h4 style="font-size: 0.9rem; margin-bottom: 4px; color: var(--primary);">Delete Account</h4>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 0;">Permanently delete your account and
                  all associated data.</p>
              </div>
              <button type="button" class="btn btn-danger btn-small" onclick="deleteUserAccount()"
                style="background: rgba(220, 38, 38, 0.1); color: var(--primary); border: 1px solid var(--primary);">Delete
                Permanently</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Core services -->
  <script src="api-service.js"></script>

  <script>
    // Initialize AppState safely
    window.AppState = window.AppState || {};
    try {
      AppState.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
    } catch (_) {
      AppState.currentUser = null;
    }

    // Fallback functions for missing script.js functions
    window.showLoading = window.showLoading || function (show) {
      console.log('Loading:', show);
    };

    window.showNotification = window.showNotification || function (msg, type = 'info') {
      console.log(`${type.toUpperCase()}: ${msg}`);
      // Create a simple notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        padding: 12px 20px; border-radius: 4px; color: white; font-weight: bold;
        background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'};
      `;
      notification.textContent = msg;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 5000);
    };

    window.showModal = window.showModal || function (id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'block';
    };

    window.closeModal = window.closeModal || function (id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    };

    // Safe logout function
    window.logout = function () {
      try {
        if (typeof apiService !== 'undefined' && apiService.logout) {
          apiService.logout().catch(console.warn);
        }
      } catch (e) {
        console.warn('API logout failed:', e);
      }

      // Clear everything
      AppState.currentUser = null;
      localStorage.removeItem('currentUser');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userType');

      window.location.href = 'index.html';
    };
  </script>

  <!-- Stripe service -->
  <script src="stripe-service.js"></script>

  <!-- Optional script.js - load without breaking if missing -->
  <script>
    const scriptEl = document.createElement('script');
    scriptEl.src = 'script.js';
    scriptEl.onerror = function () {
      console.warn('script.js failed to load - using fallback functions');
    };
    document.head.appendChild(scriptEl);
  </script>

  <!-- Player dashboard -->
  <script src="player-dashboard.js"></script>

  <!-- Initialize -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof initializePlayerDashboard === 'function') {
        initializePlayerDashboard();
      } else {
        console.error('initializePlayerDashboard() not found');
      }
    });
  </script>
</body>

</html>