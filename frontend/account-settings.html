<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - ClubHub</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header class="header">
        <nav class="nav container">
            <div class="logo" onclick="window.location.href='index.html'">
                <img src="images/logo.png" alt="ClubHub Logo" class="logo-image">
                <span class="logo-text">ClubHub</span>
            </div>
            <button class="btn btn-secondary" onclick="history.back()">‚Üê Back</button>
        </nav>
    </header>

    <main class="main">
        <div class="container" style="max-width: 800px; padding: 2rem 0;">
            <h1>Account Settings</h1>

            <!-- Profile Settings -->
            <div class="card" style="margin-bottom: 2rem;">
                <h3>Profile Information</h3>
                <form id="profileForm">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" name="email" required disabled>
                        <small style="color: var(--text-muted);">Email cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Profile</button>
                </form>
            </div>

            <!-- Change Password -->
            <div class="card" style="margin-bottom: 2rem;">
                <h3>Change Password</h3>
                <form id="passwordForm">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" name="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </form>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="border: 1px solid #ef4444;">
                <h3 style="color: #ef4444;">Danger Zone</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Once you delete your account, there is no going back. Please be certain.
                </p>
                <button class="btn btn-danger" onclick="deleteAccount()">Delete Account</button>
            </div>
        </div>
    </main>

    <script src="api-service.js"></script>
    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            loadUserData();
        });

        function loadUserData() {
            document.getElementById('firstName').value = currentUser.first_name || currentUser.firstName || '';
            document.getElementById('lastName').value = currentUser.last_name || currentUser.lastName || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('phone').value = currentUser.phone || '';
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                const formData = new FormData(e.target);

                const response = await apiService.makeRequest('/auth/profile', {
                    method: 'PUT',
                    body: JSON.stringify({
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        phone: formData.get('phone')
                    })
                });

                // Update local storage
                currentUser.first_name = formData.get('firstName');
                currentUser.lastName = formData.get('lastName');
                currentUser.phone = formData.get('phone');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                alert('Profile updated successfully!');
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            try {
                const formData = new FormData(e.target);

                await apiService.makeRequest('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        currentPassword: formData.get('currentPassword'),
                        newPassword: formData.get('newPassword')
                    })
                });

                alert('Password changed successfully!');
                e.target.reset();
            } catch (error) {
                alert('Failed to change password: ' + error.message);
            }
        });

        async function deleteAccount() {
            if (!confirm('Are you ABSOLUTELY sure? This action cannot be undone!')) {
                return;
            }

            if (!confirm('This will permanently delete all your data. Continue?')) {
                return;
            }

            try {
                await apiService.makeRequest('/auth/gdpr/delete', {
                    method: 'DELETE'
                });

                localStorage.clear();
                alert('Account deleted successfully');
                window.location.href = 'index.html';
            } catch (error) {
                alert('Failed to delete account: ' + error.message);
            }
        }
    </script>
</body>

</html>