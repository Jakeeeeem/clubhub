# Mock Data Control System

## Overview
This system ensures that **mock/demo data only appears when explicitly requested** and never pollutes live production data.

## How It Works

### 1. Database Layer
- Added `is_mock` column to key tables: `users`, `organizations`, `plans`, `payments`, `clubs`
- All demo data generated by `seed-demo-users.js` is marked with `is_mock = true`
- Migration file: `backend/migrations/sqls/20260208000000-add-is-mock-up.sql`

### 2. Backend API Filtering
All platform-admin routes now support an `includeMock` query parameter:
- **Default**: `includeMock=false` (filters out all mock data)
- **Explicit**: `includeMock=true` (shows all data including mock)

**Affected Routes:**
- `/api/platform-admin/stats`
- `/api/platform-admin/organizations`
- `/api/platform-admin/users`
- `/api/platform-admin/stripe/overview`
- `/api/platform-admin/activity`

### 3. Frontend Control
The Super Admin dashboard reads from `localStorage.getItem('includeMockData')`:
- **Default**: `'false'` - Shows only real production data
- **When set to `'true'`**: Shows all data including mock

### 4. Test Login Page (`test-direct-login.html`)
Two-step opt-in for mock data generation:

**Step 1**: Enable Demo/Offline Mode
- Checkbox: "Enable Demo / Offline Mode"
- Allows bypass login without hitting live API

**Step 2**: Generate Mock Data (only visible when Step 1 is checked)
- Checkbox: "✨ Generate Mock Data on Login"
- Only available for Super Admin login
- Triggers `/api/platform-admin/generate-mock-data` endpoint
- All generated data is marked with `is_mock = true`

## Usage Scenarios

### ✅ Live Production (Clean Data)
1. Regular users log in via normal login flow
2. No demo mode enabled
3. Super Admin dashboard shows only real data
4. **Result**: Clean, production-only data

### ✅ Demo Account Without Mock Data
1. Use test login page
2. Check "Enable Demo / Offline Mode"
3. **Do NOT check** "Generate Mock Data"
4. Login as any demo user
5. **Result**: Demo account exists, but dashboard shows clean data (no mock clutter)

### ✅ Demo Account With Mock Data
1. Use test login page
2. Check "Enable Demo / Offline Mode"
3. **Check** "✨ Generate Mock Data on Login"
4. Login as Super Admin
5. Mock data is generated and marked as `is_mock = true`
6. **Result**: Dashboard shows mock data for testing/demo purposes

### ✅ Toggling Mock Data Visibility (Future Enhancement)
To add a toggle in the Super Admin dashboard:
```javascript
// Set this in localStorage to show mock data
localStorage.setItem('includeMockData', 'true');
// Reload data
loadStats();
loadOrganizations();
loadUsers();
```

## Key Files Modified

### Backend
- `backend/routes/platform-admin.js` - Added `includeMock` filtering
- `backend/routes/auth.js` - Updated JWT to include `isPlatformAdmin`
- `backend/middleware/auth.js` - Updated `requirePlatformAdmin` check
- `backend/scripts/seed-demo-users.js` - Marks all generated data as mock
- `backend/migrations/sqls/20260208000000-add-is-mock-up.sql` - Database migration

### Frontend
- `frontend/test-direct-login.html` - Added mock data generation checkbox
- `frontend/super-admin-dashboard.html` - Reads `includeMockData` from localStorage

## Database Migration

To apply the migration:
```bash
cd backend
node apply_mock_migration.js
```

Or via Docker:
```bash
docker-compose exec backend node apply_mock_migration.js
```

## Testing

### Test 1: Live Data is Clean
1. Login normally (not via test page)
2. Navigate to Super Admin dashboard
3. Verify no demo accounts appear

### Test 2: Demo Login Without Mock
1. Go to `test-direct-login.html`
2. Enable Demo Mode (first checkbox)
3. Do NOT check "Generate Mock Data"
4. Login as Super Admin
5. Verify dashboard shows clean data

### Test 3: Demo Login With Mock
1. Go to `test-direct-login.html`
2. Enable Demo Mode
3. Check "✨ Generate Mock Data on Login"
4. Login as Super Admin
5. Verify mock data appears (Demo Club, demo users, etc.)

## Security Notes

- Mock data generation requires `isPlatformAdmin = true`
- The `requirePlatformAdmin` middleware protects the generation endpoint
- Mock data is clearly separated in the database via `is_mock` flag
- Production deployments should never have `includeMockData` set to `'true'`

## Future Enhancements

1. **Dashboard Toggle**: Add a visible toggle in Super Admin dashboard to show/hide mock data
2. **Bulk Cleanup**: Add endpoint to delete all `is_mock = true` records
3. **Visual Indicators**: Show badges on mock data entries (e.g., "DEMO" badge)
4. **Audit Trail**: Log when mock data is generated and by whom
